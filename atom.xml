<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jerry Chan</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2023-04-22T05:07:49.668Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Jerry Chan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring @Validated å¤±æ•ˆåˆ†æ</title>
    <link href="http://example.com/2023/04/22/Spring-Validated-%E5%A4%B1%E6%95%88%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2023/04/22/Spring-Validated-%E5%A4%B1%E6%95%88%E5%88%86%E6%9E%90/</id>
    <published>2023-04-21T17:41:36.000Z</published>
    <updated>2023-04-22T05:07:49.668Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åœ¨è½åœ° DDDï¼Œå¸Œæœ›å¯¹ command è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç”±äºéƒ¨åˆ†æµé‡å…¥å£æ˜¯ MQï¼Œæ‰€ä»¥å¸Œæœ›åœ¨åº”ç”¨å±‚æ˜¯ç”¨ @Validated è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç»“æœã€‚ã€‚ã€‚</p></blockquote><h3 id="Controller-ä¸­ä½¿ç”¨-Validated"><a href="#Controller-ä¸­ä½¿ç”¨-Validated" class="headerlink" title="Controller ä¸­ä½¿ç”¨ @Validated"></a>Controller ä¸­ä½¿ç”¨ @Validated</h3><p>@Validated æ³¨è§£çš„ä½œç”¨è¿™é‡Œå°±ä¸å¤šåšä»‹ç»äº†ï¼Œå…·ä½“ç”¨æ³•åœ¨ç½‘ä¸Šåº”è¯¥æœ‰ä¸å°‘ã€‚</p><p>åœ¨ä¹‹å‰ä½¿ç”¨ MVC æ¶æ„ç¼–ç æ—¶ï¼Œé€šå¸¸æ˜¯å°† @Validated æ³¨è§£æˆ–è€… @Valid é…ç½®åœ¨ Controller çš„æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"common/set"</span>)</span><br><span class="line"><span class="keyword">public</span> Response&lt;?&gt; setCommonSetting(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> SetCommonSettingReqVO reqVO) &#123;</span><br><span class="line">    <span class="comment">//doSomeThings</span></span><br><span class="line">    <span class="keyword">return</span> Response.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨é…ç½®åº”ç”¨å±‚æ ¡éªŒæ—¶ï¼Œå°±æƒ³å½“ç„¶çš„æŒ‰ç…§ç±»ä¼¼çš„å†™æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addClueTrack</span><span class="params">(@Validated AddClueTrackCommand command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//doSomeThings</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¯æƒ³è€ŒçŸ¥ï¼Œ@Validated æ³¨è§£å¹¶ä¸ç”Ÿæ•ˆã€‚</p><h3 id="Validated-æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ"><a href="#Validated-æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ" class="headerlink" title="@Validated æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ"></a>@Validated æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ</h3><p>ç«Ÿç„¶ä¸ç”Ÿæ•ˆï¼Œé‚£ä¹ˆå°±å¼€å§‹åˆ†æåŸå› ã€‚</p><p>é¦–å…ˆå¯ä»¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œç«Ÿç„¶èƒ½åœ¨æ–¹æ³•æ‰§è¡Œå‰å°±æ‹¦æˆªè¿›è¡Œæ ¡éªŒï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯ä½¿ç”¨<strong>åŠ¨æ€ä»£ç†</strong>ã€‚å°±å’Œ @Transactional äº‹åŠ¡æ³¨è§£ä¸€æ ·ï¼Œåº•å±‚éƒ½æ˜¯åŸºäº AOP å®ç°åŠ¨æ€ä»£ç†ã€‚</p><p>æ¥ä¸‹æ¥ä¸ºäº†å°è¯è¿™ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯éœ€è¦æ·±å…¥çœ‹çœ‹ Spring å®ç°çš„ã€‚é€šè¿‡ IDE å¯ä»¥å¾ˆæ–¹ä¾¿çœ‹åˆ°æœ‰å“ªäº›åœ°æ–¹å¼•ç”¨äº† @Validated æ³¨è§£ï¼š</p><img src="/images/95f16571e945fb66855e76053273ccd1.png" alt="æˆªå›¾" style="zoom:100%;" /><p>å…¶ä¸­ä¸€ä¸ªç±»åä¸€ä¸‹å°±å¼•èµ·äº†æˆ‘çš„æ³¨æ„ <strong>MethodValidationPostProcessor</strong>ï¼Œç†Ÿæ‚‰ Spring çš„å°ä¼™ä¼´åº”è¯¥çŸ¥é“ï¼ŒSpring ä¸­æœ‰å¾ˆå¤š BeanPostProcessor ç”¨äºæ‰©å±• Beanï¼ŒAop ä¾¿æ˜¯åŸºäºæ­¤å®ç°åŠ¨æ€ä»£ç†çš„ã€‚ç‚¹è¿›å»ä¸€çœ‹ï¼Œæœä¸å…¶ç„¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodValidationPostProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactoryAwareAdvisingPostProcessor</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Annotation&gt; validatedAnnotationType = Validated<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Validator validator;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//åˆ›å»ºåˆ‡ç‚¹</span></span><br><span class="line">        Pointcut pointcut = <span class="keyword">new</span> AnnotationMatchingPointcut(<span class="keyword">this</span>.validatedAnnotationType, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.advisor = <span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, createMethodValidationAdvice(<span class="keyword">this</span>.validator));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Advice <span class="title">createMethodValidationAdvice</span><span class="params">(@Nullable Validator validator)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//åˆ›å»ºæ‹¦æˆªå™¨</span></span><br><span class="line">        <span class="keyword">return</span> (validator != <span class="keyword">null</span> ? <span class="keyword">new</span> MethodValidationInterceptor(validator) : <span class="keyword">new</span> MethodValidationInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationMatchingPointcut</span> <span class="keyword">implements</span> <span class="title">Pointcut</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassFilter classFilter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodMatcher methodMatcher;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationMatchingPointcut</span><span class="params">(Class&lt;? extends Annotation&gt; classAnnotationType, <span class="keyword">boolean</span> checkInherited)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ‡ç‚¹åªé’ˆå¯¹ç±»çº§åˆ«</span></span><br><span class="line">        <span class="keyword">this</span>.classFilter = <span class="keyword">new</span> AnnotationClassFilter(classAnnotationType, checkInherited);</span><br><span class="line">        <span class="keyword">this</span>.methodMatcher = MethodMatcher.TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MethodValidationPostProcessor ä¸­åˆ›å»ºäº†ä¸€ä¸ªåˆ‡ç‚¹ï¼Œè¿‡æ»¤ç±»ä¸Šæ·»åŠ äº† @Validated çš„ Beanï¼Œåªè¦æ»¡è¶³æ­¤æ¡ä»¶ï¼Œå°±ä¼šæ ¹æ® MethodValidationInterceptor ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»ã€‚å—¯ï¼Œå’Œ @Transactional çš„å®ç°åŸç†å·®ä¸å¤šã€‚</p><p>okï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘å°±åœ¨åº”ç”¨æœåŠ¡å®ç°ä¸Šæ·»åŠ äº† @Validated æ³¨è§£ï¼Œé‚£ä¹ˆæ­¤æ—¶æ³¨è§£ç”Ÿæ•ˆäº†å—ï¼Ÿå“ˆå“ˆï¼Œè¿›åº¦æ¡è¿˜æ²¡è¿‡åŠå‘¢ğŸ˜‚</p><p>ç†è®ºä¸Šç±»ä¸ŠåŠ ä¸Š @Validated æ³¨è§£ï¼Œåº”è¯¥ä¼šç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„ï¼Œç«Ÿç„¶æ²¡æˆåŠŸè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œæˆ‘èƒ½æƒ³åˆ°çš„åŸå› æœ‰äºŒï¼š</p><p><strong>1. MethodValidationPostProcessor æ²¡æ³¨å…¥åˆ° BeanFactory ä¸­ï¼Œæ‰€ä»¥æ²¡ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»</strong><br><strong>2. MethodValidationInterceptor å¯¹è¿˜æœ‰å…¶ä»–éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼Œè€Œç›®å‰è¿˜æœªæ»¡è¶³</strong></p><p>è¿™é‡Œå…ˆå‰§é€ä¸€ä¸‹ï¼Œç­”æ¡ˆæ˜¯ 2 ğŸŒ</p><h3 id="MethodValidationInterceptor-éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶"><a href="#MethodValidationInterceptor-éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶" class="headerlink" title="MethodValidationInterceptor éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶"></a>MethodValidationInterceptor éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶</h3><p>ç«Ÿç„¶ç­”æ¡ˆæ˜¯2ï¼Œé‚£è¿™é‡Œå°±å…ˆè®²ä¸€ä¸‹ MethodValidationInterceptorï¼ŒMethodValidationPostProcessor æ˜¯æ€ä¹ˆæ³¨å†Œåˆ°å®¹å™¨çš„å’±ä»¬åé¢å†æ¥è®²ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ExecutableValidatorpublic <span class="class"><span class="keyword">class</span> <span class="title">MethodValidationInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Validator validator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Standard Bean Validation 1.1 API</span></span><br><span class="line">        ExecutableValidator execVal = <span class="keyword">this</span>.validator.forExecutables();</span><br><span class="line">        Method methodToValidate = invocation.getMethod();</span><br><span class="line">        Set&lt;ConstraintViolation&lt;Object&gt;&gt; result;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–ç±»æœ¬èº«çš„å®ä¾‹ï¼ˆéä»£ç†ç±»ï¼‰ï¼Œè¯·è®°ä½è¿™é‡Œï¼Œè¿™é‡Œå°±æ˜¯å’Œ Controller æœ€å¤§çš„åŒºåˆ«</span></span><br><span class="line">        Object target = invocation.getThis();</span><br><span class="line">        Assert.state(target != <span class="keyword">null</span>, <span class="string">"Target must not be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æ‰§è¡Œå‚æ•°æ ¡éªŒï¼Œæ ¡éªŒçš„æ˜¯å½“å‰ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æ ¡éªŒçš„æ˜¯ Bean å¯¹åº”çš„ç±»</span></span><br><span class="line">            result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            <span class="comment">//doSomeThings</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">        Object returnValue = invocation.proceed();</span><br><span class="line">        <span class="comment">//æ ¡éªŒè¿”å›å€¼</span></span><br><span class="line">        result = execVal.validateReturnValue(target, methodToValidate, returnValue, groups);</span><br><span class="line">        <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¦çœ‹çœ‹ <strong>ExecutableValidator.validateParameters</strong> è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œè¿™é‡Œæˆ‘åªä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ã€‚<strong>æ ¹æ®åŒ…åæˆ‘ä»¬å¤§æ¦‚ä¹Ÿèƒ½çŒœåˆ° ExecutableValidator.validateParameters æ˜¯ hibernate-validator åŒ…æä¾›çš„æ–¹æ³•ï¼Œè€Œ @Validated æ³¨è§£æ˜¯ç”± Spring æä¾›çš„ï¼Œæ‰€ä»¥ä¸ç”Ÿæ•ˆä¹Ÿå°±æ­£å¸¸äº†ã€‚</strong>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œæˆ‘è¿™é‡Œåªè´´éƒ¨åˆ†æ ¸å¿ƒçš„ä»£ç ï¼Œä¸­é—´çš„æ ˆè·¯å¾„å¯ä»¥æ ¹æ®ä»¥ä¸‹è¿™ä¸ªè·¯å¾„å¾€ä¸‹èµ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.engine.ValidatorImpl#validateParameters  </span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManager#getBeanMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManagerImpl#createBeanMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManagerImpl#getBeanConfigurationForHierarchy</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.MetaDataProvider#getBeanConfiguration</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#retrieveBeanConfiguration</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getFieldMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findPropertyMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findConstraints</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findCascadingMetaData</span></span><br><span class="line"><span class="comment"> *  &lt;-- ...</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getMethodMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getConstructorMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getClassLevelConstraints</span></span><br><span class="line"><span class="comment"> *  &lt;-- ...</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.aggregated.BeanMetaData#hasConstraints</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.engine.ValidatorImpl#validateParametersInContext</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorImpl</span> <span class="keyword">implements</span> <span class="title">Validator</span>, <span class="title">ExecutableValidator</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateValue(Class&lt;T&gt; beanType, String propertyName, Object value, Class&lt;?&gt;... groups) &#123;</span><br><span class="line">        Contracts.assertNotNull( beanType, MESSAGES.beanTypeCannotBeNull() );</span><br><span class="line">        sanityCheckPropertyPath( propertyName );</span><br><span class="line">        sanityCheckGroups( groups );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å– bean åŠå…¶çˆ¶ç±»ã€è¶…ç±»çš„</span></span><br><span class="line">        BeanMetaData&lt;T&gt; rootBeanMetaData = beanMetaDataManager.getBeanMetaData( beanType );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­è¯¥ bean æ˜¯å¦æœ‰çº¦æŸ</span></span><br><span class="line">        <span class="keyword">if</span> ( !rootBeanMetaData.hasConstraints() ) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PathImpl propertyPath = PathImpl.createPathFromString( propertyName );</span><br><span class="line">        BaseBeanValidationContext&lt;T&gt; validationContext = getValidationContextBuilder().forValidateValue( beanType, rootBeanMetaData, propertyPath );</span><br><span class="line"></span><br><span class="line">        ValidationOrder validationOrder = determineGroupValidationOrder( groups );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ ¡éªŒå‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> validateValueInContext(</span><br><span class="line">                validationContext,</span><br><span class="line">                value,</span><br><span class="line">                propertyPath,</span><br><span class="line">                validationOrder</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘è°ƒè¯•åˆ°** rootBeanMetaData.hasConstraints()** æ—¶ï¼Œåˆ¤æ–­æ²¡æœ‰çº¦æŸï¼Œç„¶åå°±ç›´æ¥è¿”å›äº†æ²¡æœ‰è¿›è¡Œå‚æ•°æ ¡éªŒã€‚æˆ‘å°±æƒ³è¯´çœ‹çœ‹æ˜¯å¦‚ä½•åˆ¤æ–­ Bean æ˜¯å¦æœ‰çº¦æŸçš„ï¼Œäºæ˜¯å°±è¿”å›ä¸Šå±‚è¿›å…¥ beanMetaDataManager.getBeanMetaData ä¸­çœ‹ï¼Œç»“æœå‘ç°é‡Œé¢çš„ä»£ç æœ‰å¤Ÿå¤æ‚çš„ğŸŒš</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationMetaDataProvider</span> <span class="keyword">implements</span> <span class="title">MetaDataProvider</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è·å–ç±»ä¸Šæ‰€æœ‰çš„çº¦æŸæ¡ä»¶</span></span><br><span class="line">  <span class="keyword">private</span> &lt;T&gt; <span class="function">BeanConfiguration&lt;T&gt; <span class="title">retrieveBeanConfiguration</span><span class="params">(Class&lt;T&gt; beanClass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–å­—æ®µä¸Šçš„çº¦æŸæ¡ä»¶</span></span><br><span class="line">Set&lt;ConstrainedElement&gt; constrainedElements = getFieldMetaData( beanClass );</span><br><span class="line"><span class="comment">//è·å–æ–¹æ³•ä¸Šçš„çº¦æŸæ¡ä»¶ï¼ˆåŒ…æ‹¬å‚æ•°ã€è¿”å›å€¼ï¼‰</span></span><br><span class="line">constrainedElements.addAll( getMethodMetaData( beanClass ) );</span><br><span class="line"><span class="comment">//è·å–æ„é€ å‡½æ•°</span></span><br><span class="line">constrainedElements.addAll( getConstructorMetaData( beanClass ) );</span><br><span class="line">    <span class="comment">//è·å–ç±»ä¸Šçš„çº¦æŸæ¡ä»¶</span></span><br><span class="line">Set&lt;MetaConstraint&lt;?&gt;&gt; classLevelConstraints = getClassLevelConstraints( beanClass );</span><br><span class="line"><span class="keyword">if</span> ( !classLevelConstraints.isEmpty() ) &#123;</span><br><span class="line">ConstrainedType classLevelMetaData =</span><br><span class="line"><span class="keyword">new</span> ConstrainedType(</span><br><span class="line">ConfigurationSource.ANNOTATION,</span><br><span class="line">beanClass,</span><br><span class="line">classLevelConstraints</span><br><span class="line">);</span><br><span class="line">constrainedElements.add( classLevelMetaData );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> BeanConfiguration&lt;&gt;(</span><br><span class="line">ConfigurationSource.ANNOTATION,</span><br><span class="line">beanClass,</span><br><span class="line">constrainedElements,</span><br><span class="line">getDefaultGroupSequence( beanClass ),</span><br><span class="line">getDefaultGroupSequenceProvider( beanClass )</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥æ‰¾çº¦æŸæ³¨è§£</span></span><br><span class="line"><span class="keyword">protected</span> &lt;A extends Annotation&gt; List&lt;ConstraintDescriptorImpl&lt;?&gt;&gt; findConstraintAnnotations(</span><br><span class="line">Constrainable constrainable,</span><br><span class="line">A annotation,</span><br><span class="line">ConstraintLocationKind type) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœåŒ…å« "jdk.internal" and "java" ä¸‹çš„æ³¨è§£ï¼Œåˆ™ç›´æ¥ä¸è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line"><span class="keyword">if</span> ( constraintCreationContext.getConstraintHelper().isJdkAnnotation( annotation.annotationType() ) ) &#123;</span><br><span class="line"><span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Annotation&gt; constraints = newArrayList();</span><br><span class="line">Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType();</span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰çº¦æŸæ¡ä»¶ï¼Œä¹Ÿå°±æˆ‘ä»¬ç»å¸¸é…ç½®çš„ @NotNullï¼Œ@Min è¿™ç±»æ³¨è§£</span></span><br><span class="line"><span class="keyword">if</span> ( constraintCreationContext.getConstraintHelper().isConstraintAnnotation( annotationType ) ) &#123;</span><br><span class="line">constraints.add( annotation );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™ä¸ªæ²¡ç”¨è¿‡ï¼Œæš‚æ—¶è·³è¿‡</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( constraintCreationContext.getConstraintHelper().isMultiValueConstraint( annotationType ) ) &#123;</span><br><span class="line">constraints.addAll( constraintCreationContext.getConstraintHelper().getConstraintsFromMultiValueConstraint( annotation ) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> constraints.stream()</span><br><span class="line">.map( c -&gt; buildConstraintDescriptor( constrainable, c, type ) )</span><br><span class="line">.collect( Collectors.toList() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„å»ºçº§è”å…ƒæ•°æ®æ„é€ å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ @Validï¼Œåœ¨ Bean ä¸­å¦‚æœæˆ‘ä»¬è¦å¯¹å¯¹è±¡å±æ€§è¿›è¡Œæ ¡éªŒï¼Œ</span></span><br><span class="line"><span class="comment">//éœ€è¦åœ¨è¯¥å±æ€§ä¸Šæ·»åŠ  @Validï¼Œæ­¤å¤„ä¾¿æ˜¯å¦‚æ­¤</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> CascadingMetaDataBuilder <span class="title">getCascadingMetaData</span><span class="params">(JavaBeanAnnotatedElement annotatedElement,</span></span></span><br><span class="line"><span class="function"><span class="params">Map&lt;TypeVariable&lt;?&gt;, CascadingMetaDataBuilder&gt; containerElementTypesCascadingMetaData)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> CascadingMetaDataBuilder.annotatedObject( annotatedElement.getType(), annotatedElement.isAnnotationPresent( Valid<span class="class">.<span class="keyword">class</span> ),</span></span><br><span class="line"><span class="class"><span class="title">containerElementTypesCascadingMetaData</span>, <span class="title">getGroupConversions</span>( <span class="title">annotatedElement</span>.<span class="title">getAnnotatedType</span>() ) )</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¡ºç€ä¸Šé¢çš„æ ˆè·¯å¾„ä¸€ç›´å¾€ä¸‹èµ°ï¼Œæœ€ç»ˆå‘ç°æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ–¹æ³•æ˜¯ <strong>getFieldMetaData</strong>ã€<strong>getMethodMetaData</strong>ã€<strong>getConstructorMetaData</strong>ã€<strong>getClassLevelConstraints</strong>ï¼Œè¿™ä¸ªå‡ æ–¹æ³•éƒ½æ˜¯ç”¨äºè·å–çº¦æŸå’Œçº§è”å…ƒæ•°æ®ã€‚é‚£ä¹ˆé‡Œé¢åˆ°åº•æ˜¯æ€ä¹ˆè·å–çº¦æŸå…ƒæ•°æ®çš„å‘¢ï¼Œå’±ç»§ç»­å¾€é‡Œé’»ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨äº† <strong>findConstraintAnnotations</strong> è·å–çº¦æŸå…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„ @NotNullï¼Œ@Min ç­‰æ³¨è§£ï¼Œé€šè¿‡ <strong>getCascadingMetaData</strong> è·å–çº§è”å…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯ @Valid æ³¨è§£ã€‚çœ‹åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼ŒçŸ¥é“æˆ‘åŠ ä¸Š @Valid å°±èƒ½æˆåŠŸæ ¡éªŒäº†å‘¢ï¼Ÿ</p><p>äºæ˜¯æˆ‘å°è¯•äº†ä¸€æ³¢ï¼Œæœç„¶æ²¡é—®é¢˜ã€‚å—¯~ é•¿è§è¯†äº†ğŸ˜‚ã€‚ç”±äºæ—¶é—´æœ‰é™ï¼ŒValidatorImpl.validateParametersInContext() æ–¹æ³•æˆ‘å°±æ²¡æœ‰æ·±å…¥è¿›å»çœ‹äº†ã€‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œå»çœ‹çœ‹ï¼ï¼ğŸŒ</p><h3 id="é‚£ä¹ˆ-Controller-ä¸ºå•¥ç›´æ¥æ·»åŠ -Validated-æˆ–è€…-Valid-å°±å¯ä»¥å‘¢ï¼Ÿ"><a href="#é‚£ä¹ˆ-Controller-ä¸ºå•¥ç›´æ¥æ·»åŠ -Validated-æˆ–è€…-Valid-å°±å¯ä»¥å‘¢ï¼Ÿ" class="headerlink" title="é‚£ä¹ˆ Controller ä¸ºå•¥ç›´æ¥æ·»åŠ  @Validated æˆ–è€… @Valid å°±å¯ä»¥å‘¢ï¼Ÿ"></a>é‚£ä¹ˆ Controller ä¸ºå•¥ç›´æ¥æ·»åŠ  @Validated æˆ–è€… @Valid å°±å¯ä»¥å‘¢ï¼Ÿ</h3><p>æ˜ç™½äº†åœ¨åº”ç”¨æœåŠ¡å®ç°ï¼Œå‡†ç¡®çš„è¯´åº”è¯¥æ˜¯æ™®é€š Bean ä¸­åº”è¯¥æ€ä¹ˆé…ç½®ä¹‹ @Validated å’Œ @Valid ä½¿å…¶ç”Ÿæ•ˆä¹‹åï¼Œæˆ‘å°±å¾ˆå¥½å¥‡ä¸ºå•¥ Controller åªéœ€è¦å•ç‹¬åœ¨æ–¹æ³•ä¸Šé…ç½® @Validated æˆ–è€… @Valid å°±èƒ½æˆåŠŸæ ¡éªŒå‘¢ï¼Ÿ</p><p>è¿˜è®°å¾—ä¸Šé¢é€šè¿‡ IDE æŸ¥çœ‹åº”ç”¨ @Validated æ³¨è§£çš„ç±»æ—¶ï¼Œæˆ‘ä»¬å‘ç°äº† MethodValidationPostProcessorï¼Œè¿˜æœ‰å¦å¤–å‡ ä¸ªç±»ä¸€çœ‹å°±å¾ˆåƒ Controller å‚æ•°è§£æç›¸å…³çš„ç±»ï¼š</p><img src="/images/6a453dcb7830c8ba9ebead61cb4942d9.png" alt="æˆªå›¾" style="zoom:100%;" /><p>æˆ‘åœ¨è¿™å‡ ä¸ªç±»ä¸Šå„æ‰“äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œæœ€ç»ˆè¿›å…¥çš„æ˜¯ AbstractMessageConverterMethodArgumentResolverã€‚</p><p>okï¼Œé‚£å°±çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œåªè´´äº†å¾ˆå‚æ•°æ ¡éªŒç›¸å…³çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMessageConverterMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">validateIfApplicable</span><span class="params">(WebDataBinder binder, MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">        Annotation[] annotations = parameter.getParameterAnnotations();</span><br><span class="line">        <span class="keyword">for</span> (Annotation ann : annotations) &#123;</span><br><span class="line">          <span class="comment">//è·å–åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">            Object[] validationHints = ValidationAnnotationUtils.determineValidationHints(ann);</span><br><span class="line">            <span class="keyword">if</span> (validationHints != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line">                binder.validate(validationHints);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationAnnotationUtils</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object[] determineValidationHints(Annotation ann) &#123;</span><br><span class="line">        Class&lt;? extends Annotation&gt; annotationType = ann.annotationType();</span><br><span class="line">        String annotationName = annotationType.getName();</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ @valid æ³¨è§£ç›´æ¥è¿”å›ä¸€ä¸ªç©ºæ•°ç»„</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"javax.validation.Valid"</span>.equals(annotationName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> EMPTY_OBJECT_ARRAY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ @validated åˆ™è¿”å›å…¶åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">        Validated validatedAnn = AnnotationUtils.getAnnotation(ann, Validated<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (validatedAnn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object hints = validatedAnn.value();</span><br><span class="line">            <span class="keyword">return</span> convertValidationHints(hints);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (annotationType.getSimpleName().startsWith(<span class="string">"Valid"</span>)) &#123;</span><br><span class="line">            Object hints = AnnotationUtils.getValue(ann);</span><br><span class="line">            <span class="keyword">return</span> convertValidationHints(hints);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinder</span> <span class="keyword">implements</span> <span class="title">PropertyEditorRegistry</span>, <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object... validationHints)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ­¤å¤„æ˜¯å…³é”®æ‰€åœ¨ï¼Œè¿™é‡Œè·å–çš„æ˜¯å‚æ•°ï¼ï¼ï¼å’Œæ™®é€šçš„ Bean è·å–åˆ°çš„å´æ˜¯ Bean æœ¬èº«</span></span><br><span class="line">Object target = getTarget();</span><br><span class="line">Assert.state(target != <span class="keyword">null</span>, <span class="string">"No target to validate"</span>);</span><br><span class="line">BindingResult bindingResult = getBindingResult();</span><br><span class="line"><span class="comment">// Call each validator with the same binding result</span></span><br><span class="line"><span class="keyword">for</span> (Validator validator : getValidators()) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ObjectUtils.isEmpty(validationHints) &amp;&amp; validator <span class="keyword">instanceof</span> SmartValidator) &#123;</span><br><span class="line">((SmartValidator) validator).validate(target, bindingResult, validationHints);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (validator != <span class="keyword">null</span>) &#123;</span><br><span class="line">validator.validate(target, bindingResult);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº Controller ä¸è®ºæ˜¯ç›´æ¥åœ¨å‚æ•°ä¸ŠåŠ ä¸Š @Validated æˆ–è€… @Valid æ³¨è§£ï¼Œéƒ½ä¼šè¿›å…¥åˆ°æ ¡éªŒæ–¹æ³•ï¼Œ<strong>è€Œä¸”æ ¡éªŒçš„å°±æ˜¯å‚æ•°ï¼ï¼ï¼è€Œ Bean æ ¡éªŒçš„å´æ˜¯ Bean æœ¬èº«ï¼ï¼ï¼</strong></p><h3 id="MethodValidationPostProcessor-å’Œ-AbstractMessageConverterMethodArgumentResolver-æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ°-BeanFactory-çš„ï¼Ÿ"><a href="#MethodValidationPostProcessor-å’Œ-AbstractMessageConverterMethodArgumentResolver-æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ°-BeanFactory-çš„ï¼Ÿ" class="headerlink" title="MethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ï¼Ÿ"></a>MethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ï¼Ÿ</h3><p>æ˜ç™½äº† @Validated çš„æ‹¦æˆªå®ç°çš„åŸç†åï¼Œé‚£ä¹ˆå°±åªå‰©æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼ŒMethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ã€‚</p><p>å…¶å®ä¸ç”¨çœ‹æºç å¤§æ¦‚æœ‰ä¹Ÿèƒ½çŒœåˆ°æ˜¯ Spring Boot è‡ªåŠ¨è£…é…çš„ã€‚ä¸ºäº†å°è¯ä¸€ä¸‹ï¼Œæˆ‘è¿˜æ˜¯è´´ä¸€ä¸‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(ExecutableValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnResource</span>(<span class="title">resources</span> </span>= <span class="string">"classpath:META-INF/services/javax.validation.spi.ValidationProvider"</span>)</span><br><span class="line"><span class="meta">@Import</span>(PrimaryDefaultValidatorPostProcessor<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ValidationAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodValidationPostProcessor <span class="title">methodValidationPostProcessor</span><span class="params">(Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Lazy Validator validator, ObjectProvider&lt;MethodValidationExcludeFilter&gt; excludeFilters)</span> </span>&#123;</span><br><span class="line">        FilteredMethodValidationPostProcessor processor = <span class="keyword">new</span> FilteredMethodValidationPostProcessor(</span><br><span class="line">                excludeFilters.orderedStream());</span><br><span class="line">        <span class="keyword">boolean</span> proxyTargetClass = environment.getProperty(<span class="string">"spring.aop.proxy-target-class"</span>, Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">true</span>)</span>;</span><br><span class="line">        processor.setProxyTargetClass(proxyTargetClass);</span><br><span class="line">        processor.setValidator(validator);</span><br><span class="line">        <span class="keyword">return</span> processor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–å°±æ˜¯ AbstractMessageConverterMethodArgumentResolver çš„å‡ ä¸ªå®ç°ç±»ï¼Œå‡ç”± RequestMappingHandlerAdapter å®ä¾‹åŒ–ï¼Œè€Œ RequestMappingHandlerAdapter å¤§å®¶çŸ¥é“æœ‰ WebMvcAutoConfiguration è‡ªåŠ¨è£…é…ï¼Œæ—¶é—´åŸå› ï¼Œè¿™å°±ä¸çœ‹äº†ã€‚</p><img src="/images/2848df20caae7fcdd6277d991b9f98d2.png" alt="æˆªå›¾" style="zoom:100%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMethodAdapter</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class="title">getDefaultArgumentResolvers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Annotation-based argument resolution</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">false</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PathVariableMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PathVariableMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MatrixVariableMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MatrixVariableMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">false</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestPartMethodArgumentResolver(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestHeaderMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> SessionAttributeMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestAttributeMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Type-based argument resolution</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletRequestMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletResponseMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RedirectAttributesMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ModelMethodProcessor());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MapMethodProcessor());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ErrorsMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> SessionStatusMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> UriComponentsBuilderMethodArgumentResolver());</span><br><span class="line">        <span class="keyword">if</span> (KotlinDetector.isKotlinPresent()) &#123;</span><br><span class="line">            resolvers.add(<span class="keyword">new</span> ContinuationHandlerMethodArgumentResolver());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Custom arguments</span></span><br><span class="line">        <span class="keyword">if</span> (getCustomArgumentResolvers() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvers.addAll(getCustomArgumentResolvers());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Catch-all</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PrincipalMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">true</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resolvers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>1ã€åœ¨æ™®é€š Bean ä¸­å¦‚æœè¦é€šè¿‡æ³¨è§£çš„æ–¹å¼ä½¿ç”¨ hibernate-validator è¿›è¡Œæ ¡éªŒçš„è¯ï¼Œéœ€è¦åœ¨ç±»ä¸Šæ·»åŠ  @Validated æ³¨è§£ï¼ŒåŒæ—¶åœ¨æ–¹æ³•ä¸Šæ·»åŠ  @Valid æ³¨è§£ã€‚æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ @NotNull ç­‰æ³¨è§£ã€‚</p><p>2ã€æ™®é€š Bean ä½¿ç”¨ @Validated æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆçš„ã€‚å…·ä½“çš„æ‹¦æˆªå™¨ä¾¿æ˜¯ä»– MethodValidationInterceptorã€‚</p><p>3ã€Controller å±‚ä¹‹æ‰€ä»¥èƒ½ @Validated å’Œ @Valid äºŒé€‰ä¸€ï¼Œæ˜¯å› ä¸ºæ ¡éªŒçš„æ˜¯å‚æ•°æœ¬èº«ï¼Œè€Œæ™®é€š Bean æ ¡éªŒçš„æ˜¯ Bean æœ¬èº«ã€‚</p><p>4ã€è‡³æ­¤ï¼Œç›¸ä¿¡å¤§å®¶å°±ä¸ä¼šæ²¡é…ç½®å¥½ @Validated å¯¼è‡´å¤±æ•ˆäº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åœ¨è½åœ° DDDï¼Œå¸Œæœ›å¯¹ command è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç”±äºéƒ¨åˆ†æµé‡å…¥å£æ˜¯ MQï¼Œæ‰€ä»¥å¸Œæœ›åœ¨åº”ç”¨å±‚æ˜¯ç”¨ @Validated è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç»“æœã€‚ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;Controller-ä¸­ä½¿ç”¨-Valida</summary>
      
    
    
    
    
    <category term="spring" scheme="http://example.com/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>kafka æ¶ˆè´¹è€…é«˜ cpu é—®é¢˜æ’æŸ¥</title>
    <link href="http://example.com/2023/04/14/kafka-%E6%B6%88%E8%B4%B9%E8%80%85%E9%AB%98-cpu-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    <id>http://example.com/2023/04/14/kafka-%E6%B6%88%E8%B4%B9%E8%80%85%E9%AB%98-cpu-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</id>
    <published>2023-04-14T15:31:22.000Z</published>
    <updated>2023-04-14T15:48:38.289Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©æœ¬æ¥æ‰“ç®—æ„‰å¿«çš„åˆ’æ°´ï¼Œè¿ç»´å°å“¥çªç„¶æ‰¾æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåº”ç”¨ cpu ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œæˆ‘ä¸€çœ‹å‘Šè­¦è¿˜çœŸæ˜¯â€¦</p></blockquote><h3 id="cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯"><a href="#cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯" class="headerlink" title="cpu é«˜é—®é¢˜æ’æŸ¥æ€è·¯"></a>cpu é«˜é—®é¢˜æ’æŸ¥æ€è·¯</h3><h4 id="é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š"><a href="#é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š" class="headerlink" title="é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š"></a>é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š</h4><ol><li>å…ˆæŸ¥çœ‹ cpu é«˜çš„çº¿ç¨‹æ˜¯å“ªäº›</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -Hp &lt;pid&gt;</span><br></pre></td></tr></table></figure><img src="/images/9a05c976-5255-48db-918a-2cf6e7f8047d.png" alt="æˆªå›¾" style="zoom:100%"><ol start="2"><li>æŸ¥çœ‹çº¿ç¨‹çš„å †æ ˆä¿¡æ¯</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//å°†çº¿ç¨‹ id è½¬æ¢ä¸º 16 è¿›åˆ¶</span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> &lt;tid&gt;</span><br><span class="line"></span><br><span class="line">//è·å–çº¿ç¨‹å·å 50 è¡Œå †æ ˆä¿¡æ¯</span><br><span class="line">jstack &lt;pid&gt; | grep &lt;tid&gt; -A 50</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å°±ç›´æ¥ç”¨çº¿ç¨‹åç§°å»æŸ¥äº†ã€‚</p><img src="/images/dccda0a5-30a3-443e-a5b7-62ba3f83d12d.png" alt="æˆªå›¾" style="zoom:100%"><p>çœ‹å †æ ˆä¿¡æ¯å®šä½åˆ°æ˜¯ kafka æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¯¼è‡´ cpu å±…é«˜ä¸ä¸‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ kafka æ¶ˆè´¹è€… cpu é£šé«˜éƒ½æ˜¯æœ‰å¤§é‡çš„æ¶ˆæ¯ï¼Œæˆ‘ç¬¬ä¸€ä¸ªæ„Ÿè§‰å°±æ˜¯æµ‹è¯•åœ¨è¿›è¡Œå‹æµ‹ï¼Œç»“æœä¸€çœ‹ï¼Œæ‰“è„¸äº†ğŸ¤”ã€‚</p><img src="/images/2ebfeb48-41ce-460f-bd4e-14ef2824b82e.png" alt="æˆªå›¾" style="zoom:100%"><p>å¯ä»¥çœ‹åˆ°ï¼Œlag æ˜¯ 0 æˆ–è€…è´Ÿæ•°ï¼Œæˆ‘åˆåˆ·æ–°äº†å‡ æ¬¡åŸºæœ¬ä¸Šæ²¡æœ‰å¤šå°‘æ¶ˆæ¯ï¼Œ<strong>è¿™é‡Œç•™ä¸ªå¿ƒçœ¼ï¼Œåé¢æˆ‘ä»¬åœ¨å¥½å¥½å” å” </strong>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ²¡æœ‰æ¶ˆæ¯ä¸ºå•¥æ¶ˆè´¹è€… cpu ä¼šé£šé«˜â€¦ çªç„¶çµæœºä¸€åŠ¨ï¼Œä¼šä¸ä¼šæ˜¯æ¶ˆè´¹è€…æ•°å¤ªå¤šäº†ï¼Œå¯¼è‡´å¾ªç¯å»è°ƒç”¨ poll æ–¹æ³•ï¼Œé€ æˆæ•´ä¸ªèŠ‚ç‚¹ cpu é£šé«˜ã€‚ç„¶åå°±å±é¢ å±é¢ çš„æŠŠæ‰€æœ‰ä¸»é¢˜çš„æ¶ˆè´¹è€…æ•°è°ƒå°äº†ï¼Œç„¶é¹…æƒ³æƒ³å¾ˆç¾å¥½ï¼Œç°å®å¾ˆéª¨æ„Ÿâ€¦ é‡å¯åèŠ‚ç‚¹çš„ cpu ä¾ç„¶å±…é«˜ä¸ä¸‹ã€‚</p><h4 id="é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜"><a href="#é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜" class="headerlink" title="é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜"></a>é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜</h4><p>åœ¨ç½‘ä¸Šé€›äº†ä¸€åœˆï¼Œçœ‹åˆ°è®¸å¤šç›¸ä¼¼çš„åœºæ™¯ï¼Œå„ç§æ“ä½œéƒ½è¯•äº†ä¸€éï¼Œè¿˜æ˜¯æ²¡ä»€ä¹ˆç”¨ğŸ™ƒï¼Œkafka çš„ github ä»“åº“æˆ‘ä¹Ÿå»é€›äº†ä¸€åœˆï¼Œå‘ç°ä¹Ÿæœ‰å¾ˆå¤š cpu é«˜å¾—åœºæ™¯ï¼Œå¤§å¤šæ•°éƒ½æ˜¯å»ºè®®å‡çº§å®¢æˆ·ç«¯ç‰ˆæœ¬ï¼Œå¿˜äº†è¯´æˆ‘å¸ç›®å‰ç”¨çš„è¿˜æ˜¯ <strong>0.11.2</strong>ï¼Œæ€»ä¹‹é€›äº†ä¸€åœˆæ²¡æœ‰èµ·åˆ°å¤ªå¤§çš„å¸®åŠ©ã€‚</p><p>æ¥ç€å°±æ˜¯ä¸€æ³¢è™¾çš®æ“ä½œï¼Œæ˜¾ç¤ºç”Ÿæˆäº†ç«ç„°å›¾ï¼Œçœ‹çœ‹ consumer poll åˆ°åº•ä¸ºå•¥ä¸€ç›´å ç”¨ cpuï¼Œä¸‹é¢æ˜¯ä¸€å¼ ç«ç„°å›¾ï¼š</p><img src="/images/6a2a9517-818a-4a3e-a9be-2b5b40dac23e.png" alt="æˆªå›¾" style="zoom:100%"><p>è™½ç„¶ poll æ–¹æ³•å ç”¨ cpu è€—æ—¶å¾ˆé•¿ï¼Œä½†æ˜¯ä»”ç»†çœ‹åˆè§‰å¾—æ²¡å•¥é—®é¢˜ï¼Œæ˜¯æ­£å¸¸çš„åœ¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ç”šè‡³ä¸€åº¦æ€€ç–‘æ˜¯ kafka å®¢æˆ·ç«¯çš„ bug ğŸ˜‚ã€‚</p><h3 id="æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³"><a href="#æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³" class="headerlink" title="æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³"></a>æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³</h3><p>è¿˜è®°çš„æˆ‘ä»¬ä¹‹å‰æäº†ä¸€å˜´é‚£å¼ æˆªå›¾å—ï¼Œæ²¡é”™å°±æ˜¯ä¸‹é¢è¿™å¼ </p><img src="/images/2ebfeb48-41ce-460f-bd4e-14ef2824b82e.png" alt="æˆªå›¾" style="zoom:100%"><p>å›¾ä¸­ lag å‡ºç°è´Ÿæ•°ï¼Œå…¶å® lag å‡ºç°è´Ÿæ•°è¿˜æ˜¯å¾ˆå¸¸è§çš„ï¼Œä½†é—®é¢˜å°±å‡ºåœ¨æˆ‘æ’æŸ¥äº†è¿™ä¹ˆä¹…å›¾ä¸­çš„ lag å¥½åƒæ²¡å˜åŒ–è¿‡ï¼Œè€Œä¸”ä¸€ç›´æ˜¯è´Ÿæ•°ï¼Œé‚£å°±å¾ˆå€¼å¾—æ³¨æ„äº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯å…ˆè¯´è¯´ lag æ˜¯æ€ä¹ˆè®¡ç®—çš„</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lag = HW - consumerOffset</span><br></pre></td></tr></table></figure><p><strong>HW: é«˜æ°´ä½ï¼Œé€šå¸¸ç­‰äºæ‰€æœ‰ ISR ä¸­æœ€å°çš„ LEOï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹çœ‹<a href="https://www.cnblogs.com/koktlzz/p/14580109.html" target="_blank" rel="noopener">å¤§ä½¬çš„åšå®¢</a></strong></p><p><strong>consumerOffset: è¡¨ç¤ºæ¶ˆè´¹è€…æäº¤çš„æ¶ˆè´¹ä½ç§»</strong></p><p>é‚£ä¹ˆ lag ä¸ºå•¥ä¼šå‡ºç°è´Ÿæ•°å‘¢ï¼Œç”±äºæˆ‘æœ¬èº«å¹¶æœªçœ‹è¿‡æºç ï¼Œæ‰€ä»¥ä»ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒæ˜¯èƒ½è¯´çš„é€šçš„è§£é‡Š:</p><blockquote><p>Producer çš„ offset æ˜¯é€šè¿‡ JMX è½®è¯¢è·å¾—çš„ï¼ŒConsumer çš„ offset æ˜¯ä» kafka å†…çš„ __consumer_offsets çš„ topic ä¸­ç›´æ¥è¯»å–åˆ°çš„ï¼Œå¾ˆæ˜æ˜¾è½®è¯¢è·å– offset æ¯” ç›´æ¥ä» topic æ‹¿ offset æ…¢ä¸€ç‚¹ï¼Œä¹Ÿå°±å¯èƒ½ä¼šå‡ºç° Lag è®¡ç®—åä¸ºè´Ÿæ•°çš„æƒ…å†µã€‚</p></blockquote><p>OKï¼Œå›åˆ°æ­£é¢˜ï¼Œlag é•¿æ—¶é—´æ˜¯è´Ÿæ•°è¯´æ˜ consumerOffset ä¸€ç›´å¤§äº HWï¼Œé‚£ä¹ˆå‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› å¤§æ¦‚ç‡æ˜¯ HW ä¸€ç›´ä¸æ›´æ–°ï¼Œå› ä¸º HW åªè¦æ›´æ–°å…¶å® lag å¾ˆå¿«å°±èƒ½å˜å› 0ã€‚é‚£ä¹ˆ HW æ˜¯ä»€ä¹ˆæ—¶å€™æ›´æ–°çš„å‘¢ï¼Œ<strong>å…¶å®æ˜¯ Follower å‰¯æœ¬åŒæ­¥ Leader å‰¯æœ¬æ•°æ®æ—¶ï¼ŒLeader å‰¯æœ¬ä¼šå¯¹æ¯” Follower æ‹‰å–æ•°æ®çš„ offset å’Œ Leader è‡ªèº«çš„ LEO å»æ›´æ–° HWï¼Œæ‰€ä»¥é€šå¸¸ HW éœ€è¦ Follower å¤šåŒæ­¥ä¸€è½®æ‰ä¼šæ›´æ–°</strong>ã€‚</p><p><strong>é‚£ä¹ˆ HW ä¸æ›´æ–°ï¼Œåªèƒ½è¯´æ˜ Follower æ²¡æœ‰å»åŒæ­¥æ•°æ®</strong>ï¼Œæƒ³åˆ°è¿™ï¼Œæˆ‘ç«‹é©¬å»çœ‹äº†ä¸‹æ¶ˆè´¹ç»„çš„å‰¯æœ¬çŠ¶æ€ï¼Œå‘ç°æœ‰ä¸€ä¸ª broker æ‰€æœ‰çš„åˆ†åŒºå‰¯æœ¬éƒ½ä¸åœ¨ ISR ä¸­ã€‚é‚£ä¹ˆåŸºæœ¬ä¸Šç¡®å®šè¿™ä¸ª broker æ˜¯å‡ºç°é—®é¢˜äº†ï¼Œä½†æ˜¯è¿™å’Œæˆ‘æ¶ˆè´¹è€… cpu é«˜æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p><img src="/images/382ce5cb-4dfe-481f-88ca-fc2cd9313431.png" alt="æˆªå›¾" style="zoom:100%"><p>è¿™æ—¶è¿ç»´å°å“¥å‘Šè¯‰æˆ‘ï¼Œpoll å¹³å‡æ¯ 3ms å°±è¯·æ±‚ä¸€æ¬¡ï¼Œå¯¼è‡´ cpu é£šé«˜ã€‚çº³å°¼ï¼Ÿï¼Ÿï¼Ÿæˆ‘çš„ poll timeout æ˜æ˜æ˜¯ 100msï¼Œæ€ä¹ˆ 3ms ä¸€æ¬¡å‘¢ï¼Œè¿™æ˜æ˜¾æœ‰é—®é¢˜å‘€ï¼Œè¿ç»´å°å“¥å‘äº†ä¸€ä¸‹æŠ“åŒ…çš„æˆªå›¾ç»™æˆ‘ï¼š</p><img src="/images/16814578551784.png" alt="æˆªå›¾" style="zoom:100%"><p><strong>kafka broker response ä¸­æç¤º Not Leader For Partition</strong>ï¼Œè¿™ä¸å°±å’Œä¸Šé¢çš„çŒœæƒ³å¯¹ä¸Šäº†å—ï¼Œçœ‹çœ‹ chatgpt ç»™å‡ºçš„è§£é‡Š:</p><img src="/images/16b2e8bc-06a3-4166-bf25-6815077beb93.png" alt="æˆªå›¾" style="zoom:100%"><p>è‡³æ­¤é—®é¢˜å°±æ’æŸ¥äº†å·®ä¸å¤šäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è§£å†³ã€‚ç”±äºæ˜¯åœ¨æµ‹è¯•ç¯å¢ƒå‘ç°çš„ï¼Œè§£å†³æ–¹å¼ä¹Ÿå¾ˆç²—æš´ï¼Œå°±æ˜¯ç›´æ¥æŠŠ topic ç›´æ¥åˆ é™¤äº†ï¼Œç„¶åé‡æ–°åˆ›å»ºã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ol><li>é‡åˆ°æ¶‰åŠç½‘ç»œç›¸å…³çš„é—®é¢˜ï¼Œå¯ä»¥æŠ“ä¸ªåŒ…ç§ç§ï¼Œè¯´ä¸å®šæ€è·¯ä¸€ä¸‹å°±æ‰“å¼€äº†ã€‚</li><li>å¦‚æœå®åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°è¿™ç±»é—®é¢˜ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆå¤„ç† broker å‘¢ï¼Œè¿™ä¸ªå¾—å¥½å¥½ç¢ç£¨ç¢ç£¨ï¼Œç›®å‰æ€è·¯æ˜¯ä» controller ä¸‹æ‰‹ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä»Šå¤©æœ¬æ¥æ‰“ç®—æ„‰å¿«çš„åˆ’æ°´ï¼Œè¿ç»´å°å“¥çªç„¶æ‰¾æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåº”ç”¨ cpu ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œæˆ‘ä¸€çœ‹å‘Šè­¦è¿˜çœŸæ˜¯â€¦&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯&quot;&gt;&lt;a href=&quot;#cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯&quot; class=&quot;header</summary>
      
    
    
    
    
    <category term="kafka" scheme="http://example.com/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>wireshark æŠ“åŒ… javaåº”ç”¨ä¸­çš„ https è¯·æ±‚</title>
    <link href="http://example.com/2023/04/03/wireshark-%E6%8A%93%E5%8C%85-java%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84-https-%E8%AF%B7%E6%B1%82/"/>
    <id>http://example.com/2023/04/03/wireshark-%E6%8A%93%E5%8C%85-java%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84-https-%E8%AF%B7%E6%B1%82/</id>
    <published>2023-04-03T07:08:41.000Z</published>
    <updated>2023-04-03T07:12:39.504Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘ç”Ÿäº§ä¸­è¯·æ±‚ç¬¬ä¸‰æ–¹æ¥å£çš„æœåŠ¡é¢‘ç¹å‘Šè­¦ï¼Œæ¥å£å“åº”è¿‡æ…¢ï¼Œæˆ‘ä»¬è¿™è¾¹ä½¿ç”¨çš„ httpclient è¿æ¥æ± ï¼Œå„é¡¹é…ç½®çœ‹èµ·æ¥éƒ½æ²¡å¤ªå¤§çš„é—®é¢˜ï¼Œäºæ˜¯å°±æƒ³ç€è¯´æŠ“åŒ…çœ‹çœ‹æ˜¯å¦æœ‰ç½‘ç»œå±‚é¢çš„é—®é¢˜è¿˜æ˜¯çš„ç¡®æ˜¯ç¬¬ä¸‰æ–¹æ¥å£æ…¢ã€‚</p></blockquote><h2 id="é€šè¿‡-jsslkeylog-è·å–-sslkeylog"><a href="#é€šè¿‡-jsslkeylog-è·å–-sslkeylog" class="headerlink" title="é€šè¿‡ jsslkeylog è·å– sslkeylog"></a>é€šè¿‡ <a href="https://github.com/jsslkeylog/jsslkeylog" target="_blank" rel="noopener">jsslkeylog</a> è·å– sslkeylog</h2><h3 id="wireshark-ä¸­-https-æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­"><a href="#wireshark-ä¸­-https-æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­" class="headerlink" title="wireshark ä¸­ https æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­"></a>wireshark ä¸­ https æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­</h3><p>æœ‰ç”¨è¿‡ wireshark æŠ“åŒ… https çš„å¤§ä½¬åº”è¯¥éƒ½çŸ¥é“ï¼Œhttps æ˜¯æœ‰åŠ å¯†çš„ï¼Œç›´æ¥ç”¨ wireshark æŠ“åŒ…å±•ç¤ºçš„å…¨éƒ½æ˜¯å¯†æ–‡ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/images/9e5440f2db4de1185099e8c1e91edfc.png" alt="æˆªå›¾" style="zoom:100%"><br>å¯ä»¥çœ‹åˆ°ï¼Œå…·ä½“çš„ https è¯·æ±‚æ•°æ®éƒ½è¢«åŠ å¯†äº†ã€‚</p><h3 id="å¦‚ä½•è®©-https-åœ¨-wireshark-æ˜¾ç¤ºæ˜æ–‡"><a href="#å¦‚ä½•è®©-https-åœ¨-wireshark-æ˜¾ç¤ºæ˜æ–‡" class="headerlink" title="å¦‚ä½•è®© https åœ¨ wireshark æ˜¾ç¤ºæ˜æ–‡"></a>å¦‚ä½•è®© https åœ¨ wireshark æ˜¾ç¤ºæ˜æ–‡</h3><p>wireshark ä¸­è§£å¯† https è¯·æ±‚çš„<a href="https://www.google.com.hk/search?q=wireshark+%E8%A7%A3%E5%AF%86+https&newwindow=1&sxsrf=APwXEdfQwqHE-Fyw3B1hnQNyxby131_KyA:1680505936629&ei=UHwqZJj6Je3f2roPovmx8A4&ved=0ahUKEwiY4pS7lI3-AhXtr1YBHaJ8DO4Q4dUDCA8&uact=5&oq=wireshark+%E8%A7%A3%E5%AF%86+https&gs_lcp=Cgxnd3Mtd2l6LXNlcnAQAzIHCAAQgAQQDDIHCAAQgAQQDDIHCAAQgAQQDDoECCMQJzoFCAAQgAQ6CAgAEAgQBBAeSgQIQRgAUABYowpgtgxoAHABeACAAc4CiAH5DJIBBzAuMS41LjGYAQCgAQHAAQE&sclient=gws-wiz-serp" target="_blank" rel="noopener">æ–¹å¼</a>æœ‰å¤šç§ï¼Œè¿™é‡Œä½¿ç”¨çš„æ–¹å¼æ˜¯è·å– https è¯·æ±‚æ—¶çš„ sslkeylogï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª javaagent å·¥å…· <a href="https://github.com/jsslkeylog/jsslkeylog" target="_blank" rel="noopener">jsslkeylog</a>ï¼Œé€šè¿‡ä¿®æ”¹å­—èŠ‚ç è¾¾åˆ°å‘é€ https è¯·æ±‚æ—¶å°†ä½¿ç”¨åˆ°çš„ sslkeylog å†™å…¥åˆ°æœ¬åœ°ç£ç›˜çš„æ•ˆæœã€‚<br>å…·ä½“æµç¨‹ä¹Ÿå¾ˆç®€å•ï¼š<br>1ã€ä¸‹è½½ jsslkeylog jar åŒ…<br>2ã€å¯åŠ¨å‘½ä»¤ä¸­åŠ å…¥ -javaagent:/path_to_jar/jSSLKeyLog.jar=/path_to_log/sslkeylog.log<br>3ã€å¯åŠ¨åº”ç”¨å‘èµ· https è¯·æ±‚<br>4ã€ä¹‹ååº”è¯¥å°±ä¼šåœ¨é…ç½®çš„ /path_to_log ä¸­çœ‹åˆ°å¯¹åº”çš„ sslkeylog<br><img src="/images/05a6bf5febf9f1b4673920a5d1697bdc.png" alt="æˆªå›¾" style="zoom:100%"><br>5ã€ä¹‹åå°† log é…ç½®åˆ° wireshark ä¸­ï¼Œprfferences -&gt; protocols -&gt; tls<br><img src="/images/3b0485a52fcfe450902e8cb06b8b3ca1.png" alt="æˆªå›¾" style="zoom:100%"><br>é…ç½®å®Œæˆä¹‹åï¼Œå°±èƒ½çœ‹åˆ°åŸæœ¬çš„å¯†æ–‡å·²ç»å˜æˆæ˜æ–‡äº†ï¼Œä¹‹åå°±èƒ½æ„‰å¿«çš„åˆ†æäº†ğŸŒ<br><img src="/images/ba3709b43b60602fc22efe0525515d0e.png" alt="æˆªå›¾" style="zoom:100%"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘ç”Ÿäº§ä¸­è¯·æ±‚ç¬¬ä¸‰æ–¹æ¥å£çš„æœåŠ¡é¢‘ç¹å‘Šè­¦ï¼Œæ¥å£å“åº”è¿‡æ…¢ï¼Œæˆ‘ä»¬è¿™è¾¹ä½¿ç”¨çš„ httpclient è¿æ¥æ± ï¼Œå„é¡¹é…ç½®çœ‹èµ·æ¥éƒ½æ²¡å¤ªå¤§çš„é—®é¢˜ï¼Œäºæ˜¯å°±æƒ³ç€è¯´æŠ“åŒ…çœ‹çœ‹æ˜¯å¦æœ‰ç½‘ç»œå±‚é¢çš„é—®é¢˜è¿˜æ˜¯çš„ç¡®æ˜¯ç¬¬ä¸‰æ–¹æ¥å£æ…¢ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;</summary>
      
    
    
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="http://example.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>k8s æ­å»º</title>
    <link href="http://example.com/2023/03/31/k8s-%E6%90%AD%E5%BB%BA/"/>
    <id>http://example.com/2023/03/31/k8s-%E6%90%AD%E5%BB%BA/</id>
    <published>2023-03-31T15:45:37.000Z</published>
    <updated>2023-03-31T15:46:40.276Z</updated>
    
    <content type="html"><![CDATA[<h2 id="k8sæ­å»º"><a href="#k8sæ­å»º" class="headerlink" title="k8sæ­å»º"></a>k8sæ­å»º</h2><h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><p>æœ¬æ–‡ç³»æ­å»º kubernetes v1.21.3 ç‰ˆæœ¬é›†ç¾¤ç¬”è®°ï¼Œä½¿ç”¨ä¸‰å°è™šæ‹Ÿæœºä½œä¸º CentOS7.9 ç³»ç»Ÿæµ‹è¯•æœºï¼Œå®‰è£… kubeadmã€kubeletã€kubectl å‡ä½¿ç”¨ yum å®‰è£…ï¼Œç½‘ç»œç»„ä»¶é€‰ç”¨çš„æ˜¯ flannelã€‚</p><hr><h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>éƒ¨ç½²é›†ç¾¤æ²¡æœ‰ç‰¹æ®Šè¯´æ˜å‡ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ã€‚</p><p>2.1 ç¡¬ä»¶ä¿¡æ¯</p><table><thead><tr><th>ip</th><th>hostname</th><th>mem</th><th>disk</th><th>explain</th></tr></thead><tbody><tr><td>192.168.85.2</td><td>192.168.85.2</td><td>2G</td><td>40GB</td><td>k8s æ§åˆ¶å¹³é¢èŠ‚ç‚¹</td></tr><tr><td>192.168.85.3</td><td>192.168.85.3</td><td>2G</td><td>40GB</td><td>k8s æ‰§è¡ŒèŠ‚ç‚¹1</td></tr><tr><td>192.168.85.4</td><td>192.168.85.4</td><td>2G</td><td>40GB</td><td>k8s æ‰§è¡ŒèŠ‚ç‚¹2</td></tr></tbody></table><p>2.2 è½¯ä»¶ä¿¡æ¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">software    version</span><br><span class="line">CentOS    CentOS Linux release 7.9.2009 (Core)</span><br><span class="line">Kubernetes    1.21.3</span><br><span class="line">Docker    20.10.8</span><br><span class="line">Kernel    5.4.138-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure><p>2.3 ç¦ç”¨ swap<br>swap ä»…å½“å†…å­˜ä¸å¤Ÿæ—¶ä¼šä½¿ç”¨ç¡¬ç›˜å—å……å½“é¢å¤–å†…å­˜ï¼Œç¡¬ç›˜çš„ io è¾ƒå†…å­˜å·®è·æå¤§ï¼Œç¦ç”¨ swap ä»¥æé«˜æ€§èƒ½å„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a </span><br><span class="line">cp /etc/fstab  /etc/fstab.bak</span><br><span class="line">cat /etc/fstab.bak | grep -v swap &gt; /etc/fstab</span><br></pre></td></tr></table></figure><p>2.4 å…³é—­ SELinux</p><p>å…³é—­ SELinuxï¼Œå¦åˆ™ kubelet æŒ‚è½½ç›®å½•æ—¶å¯èƒ½æŠ¥é”™ Permission deniedï¼Œå¯ä»¥è®¾ç½®ä¸º permissive æˆ– disabledï¼Œpermissive ä¼šæç¤º warn ä¿¡æ¯å„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 </span><br><span class="line">sed -i <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><p>2.5 è®¾ç½®æ—¶åŒºã€åŒæ­¥æ—¶é—´</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai </span><br><span class="line">systemctl <span class="built_in">enable</span> --now chronyd</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹åŒæ­¥çŠ¶æ€ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl status</span><br></pre></td></tr></table></figure><p>2.6 å…³é—­é˜²ç«å¢™</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><br/><h3 id="å®‰è£…å¿…è¦ä¾èµ–"><a href="#å®‰è£…å¿…è¦ä¾èµ–" class="headerlink" title="å®‰è£…å¿…è¦ä¾èµ–"></a>å®‰è£…å¿…è¦ä¾èµ–</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure><p>3.1 æ·»åŠ  aliyun docker-ce yum æº </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p> é‡å»º yum ç¼“å­˜ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><p>3.2 å®‰è£… Docker</p><p>æŸ¥çœ‹å¯ç”¨ docker ç‰ˆæœ¬ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce.x86_64 --showduplicates | sort -r</span><br></pre></td></tr></table></figure><p><strong>==å®‰è£…æŒ‡å®šç‰ˆæœ¬ Docker==</strong></p><p>yum install -y docker-ce-20.10.14-3.el7</p><p>è¿™é‡Œä»¥å®‰è£… 20.10.14 ç‰ˆæœ¬ä¸¾ä¾‹ï¼Œæ³¨æ„ç‰ˆæœ¬å·ä¸åŒ…å« : ä¸ä¹‹å‰çš„æ•°å­—ã€‚</p><p>3.3 ç¡®ä¿ç½‘ç»œæ¨¡å—å¼€æœºè‡ªåŠ¨åŠ è½½</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep overlay </span><br><span class="line">lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure><p>è‹¥ä¸Šé¢å‘½ä»¤æ— è¿”å›å€¼è¾“å‡ºæˆ–æç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/docker.conf &lt;&lt;EOF </span><br><span class="line">overlay </span><br><span class="line">br_netfilter </span><br><span class="line">EOF</span><br><span class="line">modprobe overlay </span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure><p>3.4 ä½¿æ¡¥æ¥æµé‡å¯¹ iptables å¯è§<br>å„ä¸ªèŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF </span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><p>éªŒè¯æ˜¯å¦ç”Ÿæ•ˆï¼Œå‡è¿”å› 1 å³æ­£ç¡®ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl -n net.bridge.bridge-nf-call-iptables </span><br><span class="line">sysctl -n net.bridge.bridge-nf-call-ip6tables</span><br></pre></td></tr></table></figure><p>3.5 é…ç½® Docker</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ cgroup é©±åŠ¨ä¸º systemd [k8så®˜æ–¹æ¨è]ã€é™åˆ¶å®¹å™¨æ—¥å¿—é‡ã€ä¿®æ”¹å­˜å‚¨ç±»å‹ï¼Œæœ€åçš„ docker å®¶ç›®å½•å¯ä¿®æ”¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">  <span class="string">"storage-opts"</span>: [</span><br><span class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://gp8745ui.mirror.aliyuncs.com"</span>],</span><br><span class="line">  <span class="string">"data-root"</span>: <span class="string">"/data/docker"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>æœåŠ¡è„šæœ¬ç¬¬ 13 è¡Œä¿®æ”¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --default-ulimit core=0:0</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>æ·»åŠ å¼€æœºè‡ªå¯ï¼Œç«‹å³å¯åŠ¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure><p>3.6 éªŒè¯ Docker æ˜¯å¦æ­£å¸¸</p><p>æŸ¥çœ‹dockerä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦ä¸é…ç½®ä¸€è‡´</p><br/><h3 id="éƒ¨ç½²-Kubernetes-é›†ç¾¤"><a href="#éƒ¨ç½²-Kubernetes-é›†ç¾¤" class="headerlink" title="éƒ¨ç½² Kubernetes é›†ç¾¤"></a>éƒ¨ç½² Kubernetes é›†ç¾¤</h3><p>å¦‚æœªè¯´æ˜ï¼Œå„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š</p><p>4.1 æ·»åŠ  kubernetes æº</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>é‡å»ºyumç¼“å­˜ï¼Œè¾“å…¥yæ·»åŠ è¯ä¹¦è®¤è¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><p>4.2 å®‰è£… kubeadmã€kubeletã€kubectl<br>å„èŠ‚ç‚¹å‡éœ€å®‰è£… kubeadmã€kubelet</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce.x86_64 --showduplicates | sort -r</span><br><span class="line">version=1.21.3-0</span><br><span class="line">yum install -y kubelet-v1.21.0 kubeadm-v1.21.0 kubectl-v1.21.0</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet --now</span><br></pre></td></tr></table></figure><p>4.3 é…ç½®è‡ªåŠ¨è¡¥å…¨å‘½ä»¤</p><p>å®‰è£… bash è‡ªåŠ¨è¡¥å…¨æ’ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br></pre></td></tr></table></figure><p>è®¾ç½® kubectl ä¸ kubeadm å‘½ä»¤è¡¥å…¨ï¼Œä¸‹æ¬¡ login ç”Ÿæ•ˆ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl completion bash &gt;/etc/bash_completion.d/kubectl</span><br><span class="line">kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br></pre></td></tr></table></figure><p>4.4 ä¸º Docker è®¾å®šä½¿ç”¨çš„ä»£ç†æœåŠ¡(æš‚è·³è¿‡è¯¥æ­¥éª¤ï¼Œç”±é˜¿é‡Œäº‘é•œåƒè§£å†³)<br>Kubeadm éƒ¨ç½² Kubernetes é›†ç¾¤çš„è¿‡ç¨‹ä¸­ï¼Œé»˜è®¤ä½¿ç”¨ Google çš„ Registry æœåŠ¡ k8s.gcr.io ä¸Šçš„é•œåƒï¼Œä¾‹å¦‚k8s.grc.io/kube-apiserver ç­‰ï¼Œä½†å›½å†…æ— æ³•è®¿é—®åˆ°è¯¥æœåŠ¡ã€‚å¿…è¦æ—¶ï¼Œå¯è‡ªè¡Œè®¾ç½®åˆé€‚çš„ä»£ç†æ¥è·å–ç›¸å…³é•œåƒï¼Œæˆ–è€…ä» Dockerhub ä¸Šä¸‹è½½é•œåƒè‡³æœ¬åœ°åè‡ªè¡Œå¯¹é•œåƒæ‰“æ ‡ç­¾ã€‚</p><p>è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹è®¾ç½®ä»£ç†æœåŠ¡çš„æ–¹æ³•ã€‚ç¼–è¾‘ /lib/systemd/system/docker.service æ–‡ä»¶ï¼Œåœ¨ [Service] é…ç½®æ®µä¸­æ·»åŠ ç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼Œå…¶ä¸­çš„ PROXY_SERVER_IP å’Œ PROXY_PORT è¦æŒ‰ç…§å®é™…æƒ…å†µä¿®æ”¹ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Environment=<span class="string">"HTTP_PROXY=http://<span class="variable">$PROXY_SERVER_IP</span>:<span class="variable">$PROXY_PORT</span>"</span></span><br><span class="line">Environment=<span class="string">"HTTPS_PROXY=https://<span class="variable">$PROXY_SERVER_IP</span>:<span class="variable">$PROXY_PORT</span>"</span></span><br><span class="line">Environment=<span class="string">"NO_PROXY=192.168.4.0/24"</span></span><br></pre></td></tr></table></figure><p>é…ç½®å®Œæˆåéœ€è¦é‡è½½ systemdï¼Œå¹¶é‡æ–°å¯åŠ¨ docker æœåŠ¡ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure><p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œç”± kubeadm éƒ¨ç½²çš„ Kubernetes é›†ç¾¤ä¸Šï¼Œé›†ç¾¤æ ¸å¿ƒç»„ä»¶ kube-apiserverã€kube-controller-managerã€kube-scheduler å’Œ etcd ç­‰å‡ä¼šä»¥é™æ€ Pod çš„å½¢å¼è¿è¡Œï¼Œå®ƒä»¬æ‰€ä¾èµ–çš„é•œåƒæ–‡ä»¶é»˜è®¤æ¥è‡ªäº k8s.gcr.io è¿™ä¸€ Registry æœåŠ¡ä¹‹ä¸Šã€‚ä½†æˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®è¯¥æœåŠ¡ï¼Œå¸¸ç”¨çš„è§£å†³åŠæ³•æœ‰å¦‚ä¸‹ä¸¤ç§ï¼Œæœ¬ç¤ºä¾‹å°†é€‰æ‹©ä½¿ç”¨æ›´æ˜“äºä½¿ç”¨çš„å‰ä¸€ç§æ–¹å¼ï¼š</p><p>ä½¿ç”¨èƒ½å¤Ÿåˆ°è¾¾è¯¥æœåŠ¡çš„ä»£ç†æœåŠ¡<br>ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡å™¨ä¸Šçš„æœåŠ¡ï¼Œä¾‹å¦‚ gcr.azk8s.cn/google_containers å’Œ registry.aliyuncs.com/google_containers ç­‰ï¼ˆç»æµ‹è¯•ï¼Œv1.22.0 ç‰ˆæœ¬å·²åœç”¨ï¼‰<br>4.5 æŸ¥çœ‹æŒ‡å®š k8s ç‰ˆæœ¬éœ€è¦å“ªäº›é•œåƒ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list --kubernetes-version v1.21.0</span><br><span class="line"></span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.21.0</span><br><span class="line">k8s.gcr.io/pause:3.4.1</span><br><span class="line">k8s.gcr.io/etcd:3.4.13-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.0</span><br></pre></td></tr></table></figure><p>4.6 æ‹‰å–é•œåƒ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim pullimages.sh</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># pull images</span></span><br><span class="line"> </span><br><span class="line">ver=v1.21.0</span><br><span class="line">registry=registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">images=`kubeadm config images list --kubernetes-version=<span class="variable">$ver</span> |awk -F <span class="string">'/'</span> <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$images</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$image</span> != coredns ];<span class="keyword">then</span></span><br><span class="line">    docker pull <span class="variable">$&#123;registry&#125;</span>/<span class="variable">$image</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        docker tag <span class="variable">$&#123;registry&#125;</span>/<span class="variable">$image</span> k8s.gcr.io/<span class="variable">$image</span></span><br><span class="line">        docker rmi <span class="variable">$&#123;registry&#125;</span>/<span class="variable">$image</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ERROR: ä¸‹è½½é•œåƒæŠ¥é”™ï¼Œ<span class="variable">$image</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    docker pull coredns/coredns:1.8.0</span><br><span class="line">    docker tag coredns/coredns:1.8.0  k8s.gcr.io/coredns/coredns:v1.8.0</span><br><span class="line">    docker rmi coredns/coredns:1.8.0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>4.7 ä¿®æ”¹ kubelet é…ç½®é»˜è®¤ cgroup driver</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/kubelet</span><br><span class="line">cat &gt; /var/lib/kubelet/config.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>4.8 åˆå§‹åŒ– master èŠ‚ç‚¹<br>ä»… 192.168.85.2 èŠ‚ç‚¹éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤ã€‚</p><p>4.8.1 ç”Ÿæˆ kubeadm åˆå§‹åŒ–é…ç½®æ–‡ä»¶<br>[å¯é€‰] ä»…å½“éœ€è‡ªå®šä¹‰åˆå§‹åŒ–é…ç½®æ—¶ç”¨ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm-config.yaml</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 1.2.3.4</span><br></pre></td></tr></table></figure><p> æ›¿æ¢ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.85.2</span><br><span class="line">  name: 192.168.85.2</span><br><span class="line">kubernetesVersion: 1.21.0</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br></pre></td></tr></table></figure><p>æ›¿æ¢ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubernetesVersion: 1.21.0</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: <span class="string">"10.244.0.0/16"</span></span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br></pre></td></tr></table></figure><p>4.8.2 æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­£å¸¸</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init phase preflight</span><br></pre></td></tr></table></figure><p>4.8.3 åˆå§‹åŒ– master<br>10.244.0.0/16 æ˜¯ flannel å›ºå®šä½¿ç”¨çš„ IP æ®µï¼Œè®¾ç½®å–å†³äºç½‘ç»œç»„ä»¶è¦æ±‚ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-config.yaml --ignore-preflight-errors=2 --upload-certs | tee kubeadm-init.log</span><br></pre></td></tr></table></figure><p>4.8.4 ä¸ºæ—¥å¸¸ä½¿ç”¨é›†ç¾¤çš„ç”¨æˆ·æ·»åŠ  kubectl ä½¿ç”¨æƒé™</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">su - iuskye</span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/admin.conf</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/admin.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export KUBECONFIG=<span class="variable">$HOME</span>/.kube/admin.conf"</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>4.8.5 é…ç½® master è®¤è¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export KUBECONFIG=/etc/kubernetes/admin.conf'</span> &gt;&gt; /etc/profile </span><br><span class="line">. /etc/profile</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸é…ç½®è¿™ä¸ªï¼Œä¼šæç¤ºå¦‚ä¸‹è¾“å‡ºï¼šThe connection to the server localhost:8080 was refused - did you specify the right host or port?<br>æ­¤æ—¶ master èŠ‚ç‚¹å·²ç»åˆå§‹åŒ–æˆåŠŸï¼Œä½†æ˜¯è¿˜æœªå®‰è£…ç½‘ç»œç»„ä»¶ï¼Œè¿˜æ— æ³•ä¸å…¶ä»–èŠ‚ç‚¹é€šè®¯ã€‚</p><p>4.8.6 å®‰è£…ç½‘ç»œç»„ä»¶<br>ä»¥ flannel ä¸ºä¾‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -o kube-flannel.yml https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml    <span class="comment"># è¿™é‡Œä¸‹è½½é•œåƒéå¸¸æ…¢ï¼Œæˆ‘è¿˜æ˜¯å…ˆæ‰‹åŠ¨æ‹‰ä¸‹æ¥å§ï¼Œä¸è¡Œå°±å¤šè¯•å‡ æ¬¡</span></span><br><span class="line">docker pull quay.io/coreos/flannel:v0.14.0</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p>4.8.7 æŸ¥çœ‹ 192.168.85.2 èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">192.168.85.2   Ready    control-plane,master   15d   v1.21.0</span><br><span class="line">192.168.85.3   Ready    &lt;none&gt;                 15d   v1.21.0</span><br><span class="line">192.168.85.4   Ready    &lt;none&gt;                 15d   v1.21.0</span><br></pre></td></tr></table></figure><p>å¦‚æœ STATUS æç¤º NotReadyï¼Œå¯ä»¥é€šè¿‡ kubectl describe node 192.168.85.2 æŸ¥çœ‹å…·ä½“çš„æè¿°ä¿¡æ¯ï¼Œæ€§èƒ½å·®çš„æœåŠ¡å™¨åˆ°è¾¾ Ready çŠ¶æ€æ—¶é—´ä¼šé•¿äº›ã€‚</p><p>4.9 åˆå§‹åŒ– node èŠ‚ç‚¹å¹¶åŠ å…¥é›†ç¾¤<br>4.9.1 è·å–åŠ å…¥ kubernetes çš„å‘½ä»¤<br>è®¿é—® 192.168.85.2 è¾“å…¥åˆ›å»ºæ–° token å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br></pre></td></tr></table></figure><p>åŒæ—¶è¾“å‡ºåŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.85.2:6443 --token zukr14.dg1pxt9k9gndzqkl --discovery-token-ca-cert-hash sha256:0b57947ccd86cea8b7af2490fde858f3870e63bf35bbb0a567c702029376e9e5</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª token ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šè¿° master ä¸Šæ‰§è¡Œçš„åˆå§‹åŒ–è¾“å‡ºç»“æœã€‚</p><p>4.9.2 åœ¨ node èŠ‚ç‚¹ä¸Šæ‰§è¡ŒåŠ å…¥é›†ç¾¤çš„å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.85.2:6443 --token zukr14.dg1pxt9k9gndzqkl --discovery-token-ca-cert-hash sha256:0b57947ccd86cea8b7af2490fde858f3870e63bf35bbb0a567c702029376e9e5</span><br></pre></td></tr></table></figure><p>4.10 æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">192.168.85.2   Ready    control-plane,master   15d   v1.21.0</span><br><span class="line">192.168.85.3   Ready    &lt;none&gt;                 15d   v1.21.0</span><br><span class="line">192.168.85.4   Ready    &lt;none&gt;                 15d   v1.21.0</span><br></pre></td></tr></table></figure><p>4.11 éƒ¨ç½² Dashboard<br>4.11.1 éƒ¨ç½²</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o recommended.yaml https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><p>é»˜è®¤ Dashboard åªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹ Service ä¸º NodePort ç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vi recommended.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30001</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f recommended.yaml    <span class="comment"># è¿™é‡Œä¸‹è½½é•œåƒéå¸¸æ…¢ï¼Œæˆ‘è¿˜æ˜¯å…ˆæ‰‹åŠ¨æ‹‰ä¸‹æ¥å§ï¼Œä¸è¡Œå°±å¤šè¯•å‡ æ¬¡</span></span><br><span class="line">docker pull kubernetesui/dashboard:v2.3.1</span><br><span class="line">docker pull kubernetesui/metrics-scraper:v1.0.6</span><br><span class="line"></span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods,svc -n kubernetes-dashboard</span><br><span class="line">NAME                                             READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-856586f554-nb68k   0/1     ContainerCreating   0          52s</span><br><span class="line">pod/kubernetes-dashboard-67484c44f6-shtz7        0/1     ContainerCreating   0          52s</span><br><span class="line">NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.96.188.208   &lt;none&gt;        8000/TCP        52s</span><br><span class="line">service/kubernetes-dashboard        NodePort    10.97.164.152   &lt;none&gt;        443:30001/TCP   53s</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹çŠ¶æ€æ­£åœ¨åˆ›å»ºå®¹å™¨ä¸­ï¼Œç¨åå†æ¬¡æŸ¥çœ‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-856586f554-nb68k   1/1     Running   0          2m11s</span><br><span class="line">pod/kubernetes-dashboard-67484c44f6-shtz7        1/1     Running   0          2m11s</span><br><span class="line">NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.96.188.208   &lt;none&gt;        8000/TCP        2m11s</span><br><span class="line">service/kubernetes-dashboard        NodePort    10.97.164.152   &lt;none&gt;        443:30001/TCP   2m12s</span><br></pre></td></tr></table></figure><p>è®¿é—®åœ°å€ï¼š<a href="https://NodeIP:30001ï¼›ä½¿ç”¨">https://NodeIP:30001ï¼›ä½¿ç”¨</a> Firefox æµè§ˆå™¨ï¼ŒChrome æµè§ˆå™¨æ‰“ä¸å¼€ä¸ä¿¡ä»» SSL è¯ä¹¦çš„ç½‘ç«™ã€‚</p><p>åˆ›å»º service account å¹¶ç»‘å®šé»˜è®¤ cluster-admin ç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class="line">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk <span class="string">'/dashboard-admin/&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„ç²˜è´´çš„æ—¶å€™æœ‰å¯èƒ½è¢«æ¢è¡Œï¼Œå¦‚æœè¢«æ¢è¡Œï¼Œå¯åœ¨è®°äº‹æœ¬ä¸­è®¾ç½®ä¸ºä¸€è¡Œã€‚</p><p>ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚</p><br/><h3 id="é—®é¢˜è§£å†³"><a href="#é—®é¢˜è§£å†³" class="headerlink" title="é—®é¢˜è§£å†³"></a>é—®é¢˜è§£å†³</h3><p>1ã€dial tcp 10.96.0.1:443: connect: no route to host</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br><span class="line">systemctl stop kubelet</span><br><span class="line">iptables --flush</span><br><span class="line">iptables -tnat --flush</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><p>2ã€failed to delegate add: failed to set bridge addr: â€œcni0â€œ already has an IP address different from 1</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/weixin_42562106/article/details/123749291</span><br></pre></td></tr></table></figure><p>3ã€failed to add vxlanRoute (10.244.0.0/24 -&gt; 10.244.0.0): network is down</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip link delete flannel.1</span><br><span class="line">systemctl restart network</span><br><span class="line">kubectl delete -f kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p>4ã€Get <a href="http://10.244.0.3:8181/ready" target="_blank" rel="noopener">http://10.244.0.3:8181/ready</a>: dial tcp 10.244.0.3:8181: connect: connection refused</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é‡æ–°coredns</span></span><br><span class="line">kubectl -n kube-system rollout restart deployment/coredns</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡ ä¸ªé—®é¢˜é‡åˆ°å¯ä»¥å…ˆå°è¯•é‡å¯æ‰€æœ‰çš„æœºå™¨ï¼Œå¦‚æœä¸è¡Œåœ¨é€šè¿‡ä¸Šè¿°æ–¹æ¡ˆè§£å†³</p><blockquote><p>å‚è€ƒï¼š<a href="https://">https://www.iuskye.com/2021/08/10/k8s-kubeadm-1213.html</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;k8sæ­å»º&quot;&gt;&lt;a href=&quot;#k8sæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;k8sæ­å»º&quot;&gt;&lt;/a&gt;k8sæ­å»º&lt;/h2&gt;&lt;h3 id=&quot;è¯´æ˜&quot;&gt;&lt;a href=&quot;#è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;è¯´æ˜&quot;&gt;&lt;/a&gt;è¯´</summary>
      
    
    
    
    
    <category term="è¿ç»´" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="k8s" scheme="http://example.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>redisson3.15.2 å…¬å¹³é”ä»»åŠ¡ä¸¢å¤±</title>
    <link href="http://example.com/2023/03/31/redisson3.15.2%20%E5%85%AC%E5%B9%B3%E9%94%81%E4%BB%BB%E5%8A%A1%E4%B8%A2%E5%A4%B1/"/>
    <id>http://example.com/2023/03/31/redisson3.15.2%20%E5%85%AC%E5%B9%B3%E9%94%81%E4%BB%BB%E5%8A%A1%E4%B8%A2%E5%A4%B1/</id>
    <published>2023-03-31T15:22:45.000Z</published>
    <updated>2023-03-31T15:37:33.829Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åœºæ™¯ï¼š</p><p>çº¿ç´¢æµè½¬æ”¹æˆ redisson å…¬å¹³é”ï¼Œä»»åŠ¡è€—æ—¶é•¿ï¼Œå¯¼è‡´éƒ¨åˆ†ä»»åŠ¡ä¸¢å¤±ã€‚</p></blockquote><h4 id="ä¸€ã€redisson-å…¬å¹³é”å®ç°"><a href="#ä¸€ã€redisson-å…¬å¹³é”å®ç°" class="headerlink" title="ä¸€ã€redisson å…¬å¹³é”å®ç°"></a><strong>ä¸€ã€redisson å…¬å¹³é”å®ç°</strong></h4><h5 id="1ã€redis-ä¸­çš„-K-V"><a href="#1ã€redis-ä¸­çš„-K-V" class="headerlink" title="1ã€redis ä¸­çš„ K/V"></a>1ã€redis ä¸­çš„ K/V</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">list:</span> <span class="string">redisson_lock_queue:&#123;test&#125;</span>    </span><br><span class="line"><span class="attr">elem:</span> <span class="string">UUID:threadId</span></span><br><span class="line"><span class="attr">zset:</span> <span class="string">redisson_lock_timeout:&#123;key&#125;</span>   </span><br><span class="line"><span class="attr">elem:</span> <span class="string">UUID:threadId</span>  </span><br><span class="line"><span class="attr">score:</span> <span class="string">timeout</span> <span class="string">=</span> <span class="string">ttl</span> <span class="string">+</span> <span class="string">çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms)</span> <span class="string">+</span> <span class="string">å½“å‰æ—¶é—´æˆ³</span></span><br><span class="line"><span class="attr">hset:</span> <span class="string">key</span> </span><br><span class="line">  <span class="attr">hashKey:</span> <span class="string">UUID:threadId</span> </span><br><span class="line">  <span class="attr">hashVal:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h5 id="2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰"><a href="#2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰" class="headerlink" title="2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰"></a>2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰</h5><blockquote><p>org.redisson.RedissonFairLock#tryLockInnerAsync</p></blockquote><ul><li>æ¸…é™¤ redisson_lock_timeout:{key} ä¸­ score å°äºå½“å‰æ—¶é—´æˆ³çš„elemï¼ŒåŒæ—¶æ¸…é™¤å¯¹åº” redisson_lock_queue:{test} ä¸­çš„ elem</li><li>å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹å ç”¨é”ï¼Œåˆ™ä¸Šé” (ttl = watchdogtimeout)ï¼ŒåŒæ—¶redisson_lock_timeout:{key} ä¸­æ‰€æœ‰çš„ score - çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms)</li><li>å¦‚æœå­˜åœ¨é”ï¼Œä¸”æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼Œåˆ™ hashVal åŠ ä¸€</li><li>å¦‚æœå­˜åœ¨é”ï¼Œä¸”ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼ŒåŒæ—¶å·²ç»åŠ å…¥è¿‡ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™è¿”å›å½“å‰çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„ ttl</li><li>å¦‚æœå­˜åœ¨é”ï¼Œä¸”ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼Œå¹¶ä¸”æœªåŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œtimeout= ttl + çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms) + å½“å‰æ—¶é—´æˆ³ï¼Œttl ä¸ºé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„ timeout - current æˆ–è€… é”çš„è¶…æ—¶æ—¶é—´</li></ul><h5 id="3ã€è®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId"><a href="#3ã€è®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId" class="headerlink" title="3ã€è®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId"></a>3ã€è®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId</h5><p>æ­¤å¤„é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯å‘é€ä¸ºæ­¢</p><h5 id="4ã€è§£é”æµç¨‹"><a href="#4ã€è§£é”æµç¨‹" class="headerlink" title="4ã€è§£é”æµç¨‹"></a>4ã€è§£é”æµç¨‹</h5><ul><li>æ¸…é™¤ redisson_lock_timeout:{key} ä¸­ score å°äºå½“å‰æ—¶é—´æˆ³çš„elemï¼ŒåŒæ—¶æ¸…é™¤å¯¹åº” redisson_lock_queue:{test}   ä¸­çš„ elem</li><li>åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜é”å·²ç»è¢«é‡Šæ”¾äº†ï¼Œåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰elemï¼Œæœ‰çš„è¯å–å‡ºç¬¬ä¸€ä¸ª publish message</li><li>å¦‚æœé”å­˜åœ¨ï¼Œä¸”éæœ¬çº¿ç¨‹æŒæœ‰ï¼Œåˆ™ç›´æ¥è¿”å› null</li><li>å¦‚æœæ‰€å­˜åœ¨ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¹¶ä¸”è·å–æ‰€æ¬¡æ•°å¤§äº 1ï¼Œåˆ™ hashValå‡ä¸€ï¼Œæ›´æ–°é”è¶…æ—¶æ—¶é—´</li><li>å¦‚æœæ‰€å­˜åœ¨ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œé‡Šæ”¾é”ï¼Œåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰elemï¼Œæœ‰çš„è¯å–å‡ºç¬¬ä¸€ä¸ª publish message</li></ul><h5 id="5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId"><a href="#5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId" class="headerlink" title="5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId"></a>5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId</h5><hr><h4 id="äºŒã€é—®é¢˜åˆ†æ"><a href="#äºŒã€é—®é¢˜åˆ†æ" class="headerlink" title="äºŒã€é—®é¢˜åˆ†æ"></a><strong>äºŒã€é—®é¢˜åˆ†æ</strong></h4><p>1ã€ç”±äºæµ‹è¯•ç¯å¢ƒç¬¬ä¸‰æ–¹é‰´æƒæ¥å£è¾ƒæ…¢ï¼Œæ¯åˆ†é…ä¸€æ¡çº¿ç´¢éœ€è¦3-4s</p><p>2ã€å­˜é‡çº¿ç´¢æœ‰ 1500+ æ¡ï¼Œæ¯ 200 æ¡ä½œä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œæ€»å…±æ‹†åˆ† 8 ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éœ€è¦æ‰§è¡Œ 200*3 = 600+ s</p><p>3ã€redisson å…¬å¹³é”çº¿ç¨‹ç­‰å¾…æ—¶é—´ (5*60000ms)ï¼Œä¹Ÿå°±æ˜¯è¯´å•ä¸ªä»»åŠ¡æ‰§è¡Œå®Œè‡³å°‘ä¼šæœ‰ä¸€ä¸ªä»»åŠ¡è¿‡æœŸï¼Œåœ¨ unlock æˆ–è€… lock æ“ä½œæ˜¯ä¼šå…ˆæ¸…é™¤è¿‡æœŸä»»åŠ¡</p><p>4ã€ç”±äºè·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹ä¼šè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadIdï¼Œé˜»å¡çŸ¥é“æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œåˆç”±äºç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹è¢«æ¸…äº†ï¼Œè¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ°¸è¿œä¸ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸€ç›´é˜»å¡ï¼Œä¸”ä»»åŠ¡æ— æ³•æ‰§è¡Œï¼Œèµ„æºè¢«å ç”¨ã€‚</p><p>5ã€ä»£ç æ¨¡æ‹Ÿï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">"redis://127.0.0.1:6379"</span>);</span><br><span class="line">        Redisson redissonClient = (Redisson) Redisson.create(config);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">10</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//RedissonFairLock lock = (RedissonFairLock) redissonClient.getFairLock("test");</span></span><br><span class="line">                RedissonFairLock lock = <span class="keyword">new</span> RedissonFairLock(redissonClient.getCommandExecutor(), <span class="string">"test"</span>, <span class="number">2000</span>);</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="comment">//æœ€ç»ˆè¾“å‡ºæ¬¡æ•°å°äº10</span></span><br><span class="line">                System.out.println(i);</span><br><span class="line">                ThreadUtil.sleep(<span class="number">10000</span>);</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/maybesuch/p/16012674.html" target="_blank" rel="noopener">å‚è€ƒ: Redissonåˆ†å¸ƒå¼é”ä¹‹å…¬å¹³é”åŸç†</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åœºæ™¯ï¼š&lt;/p&gt;
&lt;p&gt;çº¿ç´¢æµè½¬æ”¹æˆ redisson å…¬å¹³é”ï¼Œä»»åŠ¡è€—æ—¶é•¿ï¼Œå¯¼è‡´éƒ¨åˆ†ä»»åŠ¡ä¸¢å¤±ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;ä¸€ã€redisson-å…¬å¹³é”å®ç°&quot;&gt;&lt;a href=&quot;#ä¸€ã€redisson-å…¬å¹³é”å®ç°&quot; class</summary>
      
    
    
    
    <category term="redisson" scheme="http://example.com/categories/redisson/"/>
    
    
    <category term="redisson" scheme="http://example.com/tags/redisson/"/>
    
    <category term="æ¡†æ¶" scheme="http://example.com/tags/%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>apollo é›†ç¾¤æ¶æ„</title>
    <link href="http://example.com/2023/03/26/apollo-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/"/>
    <id>http://example.com/2023/03/26/apollo-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/</id>
    <published>2023-03-25T18:25:23.000Z</published>
    <updated>2023-03-31T15:44:48.277Z</updated>
    
    <content type="html"><![CDATA[<h1 id="apollo-é›†ç¾¤æ¶æ„"><a href="#apollo-é›†ç¾¤æ¶æ„" class="headerlink" title="apollo é›†ç¾¤æ¶æ„"></a>apollo é›†ç¾¤æ¶æ„</h1><h3 id="apollo-ç»„æˆç»“æ„"><a href="#apollo-ç»„æˆç»“æ„" class="headerlink" title="apollo ç»„æˆç»“æ„"></a>apollo ç»„æˆç»“æ„</h3><p>apollo é›†ç¾¤ä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œconfig-serviceï¼Œadmin-serviceï¼Œportal</p><ul><li>config-service: ä¸»è¦ä¸ºåº”ç”¨å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬é…ç½®çš„è¯»å–ã€æ¨é€ç­‰åŠŸèƒ½ï¼Œconfig-service å†…ç½® eurekaï¼Œå·²æä¾› admin-service, portal çš„æœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œ</li><li>admin-service: ä¸»è¦ä¸º apollo-portal æä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬åº”ç”¨é…ç½®ç®¡ç†ã€å‘å¸ƒç­‰åŠŸèƒ½</li><li>portal: æ˜¯ apollo æä¾›çš„æœåŠ¡é…ç½®å‰ç«¯é¡µé¢</li></ul><h3 id="apollo-éƒ¨ç½²æ–¹æ¡ˆ"><a href="#apollo-éƒ¨ç½²æ–¹æ¡ˆ" class="headerlink" title="apollo éƒ¨ç½²æ–¹æ¡ˆ"></a>apollo éƒ¨ç½²æ–¹æ¡ˆ</h3><p><img src="/images/283b123b3a2d818fb3f732c9a1b75a5d.png" alt="æˆªå›¾" style="zoom:100%" />è¿™ä¸ªå®˜ç½‘æä¾›çš„é«˜å¯ç”¨åŒç¯å¢ƒæ¶æ„ï¼Œæ›´å¤šçš„æ¶æ„æ–¹æ¡ˆå¯<a href="https://www.apolloconfig.com/#/zh/deployment/deployment-architecture?id=_34-%e9%ab%98%e5%8f%af%e7%94%a8%ef%bc%8c%e5%a4%9a%e4%b8%aa%e7%8e%af%e5%a2%83" target="_blank" rel="noopener">å‚è€ƒ</a></p><h3 id="docker-compose-éƒ¨ç½²-apollo-é›†ç¾¤"><a href="#docker-compose-éƒ¨ç½²-apollo-é›†ç¾¤" class="headerlink" title="docker-compose éƒ¨ç½² apollo é›†ç¾¤"></a>docker-compose éƒ¨ç½² apollo é›†ç¾¤</h3><ol><li>æ‰§è¡Œ <a href="https://github.com/apolloconfig/apollo-quick-start/tree/master/sql" target="_blank" rel="noopener">sql è„šæœ¬</a>ï¼Œç”Ÿæˆ apollo éœ€è¦çš„ db è¡¨</li><li>ç¼–å†™ docker-compose æ–‡ä»¶ï¼Œæœ¬æ¬¡åªæ­å»ºå¼€å‘ç¯å¢ƒæ¨¡æ‹Ÿå•æœºå•ç¯å¢ƒï¼Œconfig-serviceï¼Œadmin-serviceï¼Œportal éƒ½å„è‡ªéƒ¨ç½²ä¸€ä¸ªå®¹å™¨</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">net:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment">#å¼€å‘ç¯å¢ƒconfigServiceï¼Œeureka</span></span><br><span class="line">  <span class="attr">apollo-configservice-dev:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apolloconfig/apollo-configservice</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">configservice-dev</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloConfigDB?characterEncoding=utf8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">eureka.instance.ip-address=192.168.0.103</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">apollo-adminservice-dev:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apolloconfig/apollo-adminservice</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">adminservice-dev</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8090</span><span class="string">:8090</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloConfigDB?characterEncoding=utf8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=123456</span></span><br><span class="line">      <span class="comment">#è¿™é‡Œéœ€è¦é…ç½®å¼€ç¯ç¯å¢ƒçš„configService</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">eureka.service.url=http://configservice-dev:8080/eureka/</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apollo-configservice-dev</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">apollo-portal:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apolloconfig/apollo-portal</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">apollo-portal</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8070</span><span class="string">:8070</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloPortalDB?characterEncoding=utf8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spring.profiles.active=auth</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">APOLLO_PORTAL_ENVS=dev,fat,pre,gray,pro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEV_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="comment"># ä»¥ä¸‹è¿™äº›æš‚æ—¶ä½¿ç”¨å¼€å‘ç¯å¢ƒçš„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FAT_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PRE_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GRAY_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PRO_META=http://configservice-dev:8080</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apollo-adminservice-dev</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;apollo-é›†ç¾¤æ¶æ„&quot;&gt;&lt;a href=&quot;#apollo-é›†ç¾¤æ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;apollo é›†ç¾¤æ¶æ„&quot;&gt;&lt;/a&gt;apollo é›†ç¾¤æ¶æ„&lt;/h1&gt;&lt;h3 id=&quot;apollo-ç»„æˆç»“æ„&quot;&gt;&lt;a href=&quot;#apollo</summary>
      
    
    
    
    
    <category term="apollo" scheme="http://example.com/tags/apollo/"/>
    
    <category term="è¿ç»´" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>consul é›†ç¾¤æ­å»ºåŠæ³¨æ„äº‹é¡¹</title>
    <link href="http://example.com/2023/03/26/consul-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/"/>
    <id>http://example.com/2023/03/26/consul-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</id>
    <published>2023-03-25T17:16:50.000Z</published>
    <updated>2023-03-31T15:45:02.909Z</updated>
    
    <content type="html"><![CDATA[<h3 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h3><p><em>æœ¬æ¬¡åˆ©ç”¨ docker æ­å»º consul é›†ç¾¤ï¼Œåˆ©ç”¨ docker-compose ç»Ÿä¸€ç®¡ç†</em></p><p><em>é›†ç¾¤åŒ…å«ä¸‰ä¸ª server agent: node1ã€node2ã€node3</em></p><p><em>é›†ç¾¤åŒ…å«ä¸¤ä¸ª client agent: node4ã€node5ï¼Œclient agent æä¾› ui</em></p><p>**1ã€ä¸‹è½½ docker é•œåƒ **</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker</span><br></pre></td></tr></table></figure><p><strong>2ã€ç¼–è¾‘ docker-compose.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">byfn:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">consul1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node1</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-bootstrap-expect=3</span> <span class="string">-node=node1</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node2</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-retry-join=node1</span> <span class="string">-node=node2</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul1</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node3</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-retry-join=node1</span> <span class="string">-node=node3</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul1</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul4:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node4</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-retry-join=node1</span> <span class="string">-node=ndoe4</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span> <span class="string">-ui</span> </span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8500</span><span class="string">:8500</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul3</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul5:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node5</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-retry-join=node1</span> <span class="string">-node=ndoe5</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span> <span class="string">-ui</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8501</span><span class="string">:8500</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul3</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br></pre></td></tr></table></figure><h3 id="å‘½ä»¤è¡Œå‚æ•°"><a href="#å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="å‘½ä»¤è¡Œå‚æ•°"></a>å‘½ä»¤è¡Œå‚æ•°</h3><p>-serverï¼šè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„ server æ¨¡å¼ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™è¡¨ç¤ºæ˜¯ client æ¨¡å¼ã€‚</p><p>-nodeï¼šæŒ‡å®šå½“å‰èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­çš„åç§°ã€‚</p><p>-config-dirï¼šæŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå®šä¹‰æœåŠ¡çš„ï¼›è·¯å¾„ä¸‹é¢çš„æ‰€æœ‰ .json ç»“å°¾çš„æ–‡ä»¶éƒ½è¢«è®¿é—®ï¼›ç¼ºçœå€¼ä¸ºï¼š/consul/configã€‚</p><p>-data-dirï¼š consul å­˜å‚¨æ•°æ®çš„ç›®å½•ï¼›ç¼ºçœå€¼ä¸ºï¼š/consul/dataã€‚</p><p>-datacenterï¼šæ•°æ®ä¸­å¿ƒåç§°ï¼Œç¼ºçœå€¼ä¸º dc1ã€‚</p><p>-uiï¼šä½¿ç”¨ consul è‡ªå¸¦çš„ web UI ç•Œé¢ ã€‚</p><p>-joinï¼šåŠ å…¥åˆ°å·²æœ‰çš„é›†ç¾¤ä¸­ã€‚</p><p>-retry-joinï¼šä¸ -join ç±»ä¼¼ï¼Œä½†å…è®¸é‡è¯•è¿æ¥ï¼Œç›´åˆ°è¿æ¥æˆåŠŸã€‚ä¸€æ—¦æˆåŠŸåŠ å…¥æˆå‘˜åˆ—è¡¨ä¸­çš„æˆå‘˜ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šå°è¯•å†æ¬¡åŠ å…¥ã€‚ç„¶åï¼Œä»£ç†å•†å°†ä»…é€šè¿‡å…«å¦ç»´æŒå…¶ä¼šå‘˜èµ„æ ¼ã€‚å…è®¸é…ç½®å¤šä¸ª -retry-joinï¼Œç„¶åèŠ‚ç‚¹ä¼šæŒ‰ç…§é¡ºåºåŠ å…¥å’Œé‡è¯•ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸã€‚</p><p>-enable-script-checksï¼š æ£€æŸ¥æœåŠ¡æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç±»ä¼¼å¼€å¯å¿ƒè·³ã€‚</p><p>-advertiseï¼šé€šå‘Šåœ°å€ç”¨äºæ›´æ”¹æˆ‘ä»¬å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹é€šå‘Šçš„åœ°å€ã€‚ç›¸å½“äº -bind ä¸å¯ç”¨æ—¶æ›´æ”¹ -bind åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸º -bind çš„ä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆã€‚</p><p>-bindï¼š ç»‘å®šæœåŠ¡å™¨çš„ ip åœ°å€ï¼Œç¼ºçœå€¼ï¼šâ€œ0.0.0.0â€ï¼Œè¿™æ„å‘³ç€ consul å°†ç»‘å®šåˆ°æœ¬åœ°æœºå™¨ä¸Šçš„æ‰€æœ‰åœ°å€ï¼Œå¹¶å°†ç§æœ‰ IPv4 åœ°å€é€šå‘Šç»™é›†ç¾¤çš„å…¶ä½™èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å¤šä¸ªç§æœ‰ IPv4 åœ°å€å¯ç”¨ï¼Œconsul å°†åœ¨å¯åŠ¨æ—¶é€€å‡ºå¹¶æŠ¥é”™ã€‚consul 1.1.0 ä¹‹åï¼Œå¯ä»¥ç»“åˆ go-sockaddr templateä½¿ç”¨ï¼Œä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ consul agent -bind &#39;&#123;&#123; GetPrivateInterfaces | include &quot;network&quot; &quot;10.0.0.0&#x2F;8&quot; | attr &quot;address&quot; &#125;&#125;&#39;</span><br></pre></td></tr></table></figure><p>-clientï¼šå®¢æˆ·ç«¯å¯è®¿é—® ipï¼Œç¼ºçœå€¼ä¸ºï¼šâ€œ127.0.0.1â€ï¼Œå³ä»…å…è®¸ç¯å›è¿æ¥ã€‚</p><p>-bootstrap-expectï¼šåœ¨ä¸€ä¸ª datacenter ä¸­æœŸæœ›çš„ server èŠ‚ç‚¹æ•°ç›®ï¼Œconsul å¯åŠ¨æ—¶ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¾¾åˆ°è¿™ä¸ªæ•°ç›®çš„serveræ‰ä¼šå¼•å¯¼æ•´ä¸ªé›†ç¾¤ã€‚è¿™ä¸ªå‚æ•°çš„å€¼åœ¨åŒä¸€ä¸ª datacenter çš„æ‰€æœ‰serverèŠ‚ç‚¹ä¸Šå¿…é¡»ä¿æŒä¸€è‡´ã€‚</p><p>-bootstrapï¼šç”¨æ¥æ§åˆ¶ä¸€ä¸ª server æ˜¯å¦è¿è¡Œåœ¨ bootstrap æ¨¡å¼ï¼šå½“ä¸€ä¸ª server å¤„äº bootstrap æ¨¡å¼æ—¶ï¼Œå®ƒå¯ä»¥é€‰ä¸¾è‡ªå·±ä¸º leaderï¼›æ³¨æ„åœ¨ä¸€ä¸ª datacenter ä¸­åªèƒ½æœ‰ä¸€ä¸ª server å¤„äº bootstrap æ¨¡å¼ã€‚æ‰€ä»¥è¿™ä¸ªå‚æ•°ä¸€èˆ¬åªèƒ½ç”¨åœ¨åªæœ‰ä¸€ä¸ª server çš„å¼€å‘ç¯å¢ƒä¸­ï¼Œåœ¨æœ‰å¤šä¸ª server çš„ cluster äº§å“ç¯å¢ƒä¸­ï¼Œä¸èƒ½ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œå¦åˆ™å¦‚æœå¤šä¸ª server éƒ½æ ‡è®°è‡ªå·±ä¸º leader é‚£ä¹ˆä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å¦å¤–è¯¥æ ‡è®°ä¸èƒ½å’Œ -bootstrap-expect åŒæ—¶æŒ‡å®šã€‚</p><h3 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h3><p><strong>1ã€é€šè¿‡ config-file æ³¨å†ŒæœåŠ¡</strong>ï¼Œç¼–è¾‘ xxx.jsonï¼Œç„¶åæ”¾åœ¨ /consul/config ç›®å½•ä¸‹ï¼ˆé»˜è®¤æƒ…å†µï¼‰,å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ <a href="https://www.consul.io/commands/config/write" target="_blank" rel="noopener">consul å‘½ä»¤è¡Œ</a>åŠ è½½é…ç½®ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;                                                                                                                                                   </span><br><span class="line">  <span class="attr">"services"</span>: [                                                                                                                                     </span><br><span class="line">    &#123;                                                                                                                                               </span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"hertz-demo-001"</span>,                                                                                                                       </span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"hertz-demo"</span>,                                                                                                                         </span><br><span class="line">      <span class="attr">"tags"</span>: [                                                                                                                                     </span><br><span class="line">      ],                                                                                                                                            </span><br><span class="line">      <span class="attr">"address"</span>: <span class="string">"192.168.0.103"</span>,                                                                                                                       </span><br><span class="line">      <span class="attr">"port"</span>: <span class="number">5000</span>,                                                                                                                                 </span><br><span class="line">      <span class="attr">"checks"</span>: [                                                                                                                                   </span><br><span class="line">        &#123;                                                                                                                                           </span><br><span class="line">        <span class="attr">"http"</span>: <span class="string">"http://192.168.0.103:5000/ping"</span>,                                                                                                       </span><br><span class="line">        <span class="attr">"tlsSkipVerify"</span>: <span class="literal">false</span>,                                                                                                                   </span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"GET"</span>,                                                                                                                            </span><br><span class="line">        <span class="attr">"interval"</span>: <span class="string">"10s"</span>,                                                                                                                          </span><br><span class="line">        <span class="attr">"timeout"</span>: <span class="string">"1s"</span>,                                                                                                                             </span><br><span class="line">        <span class="attr">"deregisterCriticalServiceAfter"</span>: <span class="string">"30s"</span></span><br><span class="line">        &#125;                                                                                                                                           </span><br><span class="line">      ]                                                                                                                                             </span><br><span class="line">    &#125;                                                                                                                                               </span><br><span class="line">  ]                                                                                                                                                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2ã€æ‰§è¡Œ consul å‘½ä»¤é‡è½½é…ç½®æ–‡ä»¶</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul reload</span><br></pre></td></tr></table></figure><p><strong>3ã€å¯åŠ¨ web æœåŠ¡</strong>ï¼Œè¿™é‡Œä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡å³å¯ï¼Œè¿™é‡Œç”¨çš„æ˜¯ go http æ¡†æ¶ hertz:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/app"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/app/server"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/common/utils"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/protocol/consts"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := server.Default(</span><br><span class="line">server.WithHostPorts(<span class="string">"192.168.0.103:5000"</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">s.GET(<span class="string">"/ping"</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req *app.RequestContext)</span></span> &#123;</span><br><span class="line">log.Print(req.ClientIP(), <span class="string">" ping"</span>)</span><br><span class="line">req.JSON(consts.StatusOK, utils.H&#123;<span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">s.Spin()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4ã€æŸ¥çœ‹æœåŠ¡å¥åº·ä¿¡æ¯</strong>ï¼Œpassing å‚æ•°è¡¨ç¤ºæ˜¯å¦è¿‡æ»¤ä¸å¥åº·çš„æœåŠ¡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:8500/v1/health/service/hertz-demo\?passing\=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>5ã€æ³¨é”€æœåŠ¡</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --request PUT 127.0.0.1:8501/v1/agent/service/deregister/hertz-demo-001</span><br></pre></td></tr></table></figure><p><strong>6ã€consul ui ç•Œé¢ä¸Šæ˜¾ç¤ºå¦‚ä¸‹ï¼š</strong></p><img src="/images/15a776f6a2dd3e8cd4405101c5e47f9c.png" alt="æˆªå›¾" style="zoom:0%" /><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>1ã€æ³¨å†ŒæœåŠ¡æ—¶ï¼Œcheck å‚æ•° method GET æ³¨æ„ GET éœ€è¦å¤§å†™ï¼Œå¦åˆ™å¥åº·æ£€æŸ¥ä¼šå¤±è´¥</p><p>2ã€æœåŠ¡æ³¨å†Œçš„ client agent æŒ‚äº†ï¼Œé‚£ä¹ˆ consul ä¼šè®¤ä¸ºæœåŠ¡ä¹ŸæŒ‚äº†ï¼Œå¹¶ä¸ä¼šåšæ•…éšœè½¬ç§»ï¼Œä¹Ÿä¸ä¼šåŒæ­¥åŸæœ¬ client agent ä¸‹çš„æœåŠ¡ä¿¡æ¯</p><p>3ã€æœåŠ¡æ³¨å†Œéœ€è¦ç¡®ä¿ç½‘ç»œèƒ½è”é€š</p><h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><p><strong>1ã€å®˜æ–¹æ¨èçš„æ¶æ„æ–¹å¼</strong></p><p>å®˜æ–¹å»ºè®®ä¸€ä¸ªé›†ç¾¤éƒ¨ç½² 3-5 ä¸ª server agentï¼Œæ¯ä¸ªæœåŠ¡çš„æœåŠ¡å™¨éƒ¨ç½²ä¸€ä¸ª client agentï¼Œå¦‚ä¸‹å¦‚æ‰€ç¤ºï¼š</p><img src="/images/d54b9c5750f98deb333af08e95cd8c74.png" alt="æˆªå›¾" style="zoom:100%;" /><p><strong>2ã€å¦‚æ˜¯æƒ³è¦ç»Ÿä¸€ç®¡ç† consul agent</strong>ï¼Œé‚£å¯ä»¥å‚è€ƒå¦ä¸€ç§æ¶æ„æ–¹å¼ï¼š</p><img src="/images/46d62fa92deb1760cdec0d06f983dd1d.png" alt="æˆªå›¾" style="zoom:100%" /><br/><br/><blockquote><p>å‚è€ƒï¼š<br><a href="https://mp.weixin.qq.com/s/ecmqqWuMho2a0xhaF1vFNA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ecmqqWuMho2a0xhaF1vFNA</a><br><a href="https://www.cnblogs.com/brady-wang/p/14440649.html/" target="_blank" rel="noopener">https://www.cnblogs.com/brady-wang/p/14440649.html</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;é›†ç¾¤æ­å»º&quot;&gt;&lt;a href=&quot;#é›†ç¾¤æ­å»º&quot; class=&quot;headerlink&quot; title=&quot;é›†ç¾¤æ­å»º&quot;&gt;&lt;/a&gt;é›†ç¾¤æ­å»º&lt;/h3&gt;&lt;p&gt;&lt;em&gt;æœ¬æ¬¡åˆ©ç”¨ docker æ­å»º consul é›†ç¾¤ï¼Œåˆ©ç”¨ docker-compose ç»Ÿä¸€ç®¡ç†&lt;/em&gt;&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="consul" scheme="http://example.com/tags/consul/"/>
    
    <category term="è¿ç»´" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://example.com/2023/03/26/hello-world/"/>
    <id>http://example.com/2023/03/26/hello-world/</id>
    <published>2023-03-25T16:04:15.447Z</published>
    <updated>2023-03-25T16:04:15.447Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for</summary>
      
    
    
    
    
  </entry>
  
</feed>
