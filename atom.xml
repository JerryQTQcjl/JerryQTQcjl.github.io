<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jerry Chan</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2024-09-03T02:42:00.591Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Jerry Chan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>GraalVM + SpringBoot åˆæ¢</title>
    <link href="http://example.com/2024/09/03/GraalVM-SpringBoot-%E5%88%9D%E6%8E%A2/"/>
    <id>http://example.com/2024/09/03/GraalVM-SpringBoot-%E5%88%9D%E6%8E%A2/</id>
    <published>2024-09-03T02:27:04.000Z</published>
    <updated>2024-09-03T02:42:00.591Z</updated>
    
    <content type="html"><![CDATA[<h3 id="GraalVM-ç®€ä»‹"><a href="#GraalVM-ç®€ä»‹" class="headerlink" title="GraalVM ç®€ä»‹"></a>GraalVM ç®€ä»‹</h3><blockquote><p>GraalVM compiles your Java applications ahead of time into standalone binaries. These binaries are smaller, start up to 100x faster, provide peak performance with no warmup, and use less memory and CPU than applications running on a Java Virtual Machine (JVM).</p><p>GraalVM reduces the attack surface of your application. It excludes unused classes, methods, and fields from the application binary. It restricts reflection and other dynamic Java language features to build time only. It does not load any unknown code at run time.</p><p>Popular microservices frameworks such as Spring Boot, Micronaut, Helidon, and Quarkus, and cloud platforms such as Oracle Cloud Infrastructure, Amazon Web Services, Google Cloud Platform, and Microsoft Azure all support GraalVM.</p><p>With profile-guided optimization and the G1 (Garbage-First) garbage collector, you can get lower latency and on-par or better peak performance and throughput compared to applications running on a Java Virtual Machine (JVM).</p><p>You can use the GraalVM JDK just like any other Java Development Kit in your IDE.</p></blockquote><p>ä»¥ä¸Šæ˜¯æ¥è‡ª<a href="https://www.graalvm.org/latest/docs/introduction/" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šçš„ä»‹ç»ï¼Œç®€å•æ¥è¯´ä¸»è¦åŒ…æ‹¬å‡ ç‚¹ï¼š</p><ol><li>GraalVM æ”¯æŒ AOTï¼ˆAhead-Of-Timeï¼‰ï¼Œæå‰å°† Java åº”ç”¨ç¼–è¯‘æˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç›¸è¾ƒäºç¼–è¯‘æˆå­—èŠ‚ç ç”± JVM å³ä½¿ç¼–è¯‘ï¼Œæ‹¥æœ‰æ›´å¿«çš„é€Ÿåº¦ä»¥åŠæ›´å°çš„å†…å­˜ã€‚</li><li>GraalVM é™åˆ¶äº† Java çš„ä¸€äº›åŠ¨æ€èƒ½åŠ›ï¼Œä¾‹å¦‚åå°„ã€åŠ¨æ€ä»£ç†ã€java agentç­‰ï¼Œåªå…è®¸åœ¨æ„å»º Native Image æ—¶ä½¿ç”¨ã€‚ï¼ˆAOT æ¨¡å¼ï¼‰</li><li>ä¼˜åŒ– JVM å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰ï¼Œä½¿ç”¨ GraalVM ç¼–è¯‘å™¨æ›¿æ¢ C2 ç¼–è¯‘å™¨ï¼Œæå‡è¿è¡Œæ—¶æ€§èƒ½ã€‚</li></ol><h3 id="å®‰è£…-GraalVM"><a href="#å®‰è£…-GraalVM" class="headerlink" title="å®‰è£… GraalVM"></a>å®‰è£… GraalVM</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAVwIZ6.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p><a href="https://www.graalvm.org/downloads/#" target="_blank" rel="noopener">å®˜ç½‘</a>æä¾›äº†å¤šç§ä¸‹è½½æ–¹å¼ï¼Œç›®å‰å®˜ç½‘åªèƒ½ä¸‹è½½ Java17-22 çš„ç‰ˆæœ¬ï¼Œå¦‚æœæƒ³è¦ä¸‹è½½å…¶ä»–ç‰ˆæœ¬å¯ä»¥åˆ° <a href="https://github.com/graalvm/graalvm-ce-builds/releases?page=2" target="_blank" rel="noopener">github</a> ä¸‹è½½ã€‚</p><p>ç”±äºæœ¬äººä½¿ç”¨çš„æ˜¯ macosï¼Œæ‰€ä»¥å°±ç®€å•ä»‹ç»ä¸‹ macos ä¸‹çš„å®‰è£…æ–¹å¼ï¼Œæµç¨‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå…¶ä»–æ“ä½œç³»ç»Ÿå¯ä»¥è¿›è¡Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p><ol><li>ä¸‹è½½å¯¹åº”çš„ graalvm ç‰ˆæœ¬</li><li>è§£å‹ä¹‹åç§»åŠ¨åˆ° /Library/Java/JavaVirtualMachines ç›®å½•ä¸‹<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf graalvm-jdk-&lt;version&gt;_macos-&lt;architecture&gt;.tar.gz</span><br><span class="line">sudo mv graalvm-jdk-&lt;version&gt;_macos-&lt;architecture&gt; /Library/Java/JavaVirtualMachines</span><br></pre></td></tr></table></figure></li><li>æ·»åŠ ç¯å¢ƒå˜é‡</li><li>å¦‚æœæ˜¯ä» github ä¸‹è½½çš„ä½ç‰ˆæœ¬è¿˜éœ€è¦è¿›è¡Œä¸€ä¸‹ä¸¤ä¸ªæ­¥éª¤:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  If you are using macOS Catalina and later you may need to remove the quarantine attribute from the bits before you can use them.</span></span><br><span class="line">sudo xattr -r -d com.apple.quarantine path/to/graalvm/folder/</span><br><span class="line"><span class="comment"># å®˜ç½‘ä¸‹è½½çš„æ˜¯é»˜è®¤è‡ªå¸¦çš„</span></span><br><span class="line">gu install native-image</span><br></pre></td></tr></table></figure></li></ol><h3 id="Java-Demo"><a href="#Java-Demo" class="headerlink" title="Java Demo"></a>Java Demo</h3><p>ä»¥ä¸‹æ˜¯å®˜ç½‘æä¾›çš„å’Œä¸€ä¸ªçº¯ Java åº”ç”¨ Demo:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ylb.explore.graalvm.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello, Native World!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°† Java ä»£ç ç¼–è¯‘æˆå­—èŠ‚ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac HelloWorld.java</span><br></pre></td></tr></table></figure><p>å°†å­—èŠ‚ç ç¼–è¯‘æˆå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$JAVA_HOME</span>/bin/native-image com.ylb.explore.graalvm.java.HelloWorld HelloWorld</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ•ˆæœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./HelloWorld                                                                  </span><br><span class="line">Hello, Native World!</span><br></pre></td></tr></table></figure><p>æ€»ä½“è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œç¼–è¯‘æ—¶æ³¨æ„ä¸€ä¸‹ç±»è·¯å¾„å³å¯ã€‚</p><h3 id="SpringBoot-Demo"><a href="#SpringBoot-Demo" class="headerlink" title="SpringBoot Demo"></a>SpringBoot Demo</h3><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªç®€å•çš„ SpringBoot</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"cost: "</span> + (endTime - startTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showHelloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                hello world</span></span><br><span class="line"><span class="string">                template</span></span><br><span class="line"><span class="string">                "</span><span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç æä¾›ä¸€ä¸ªç®€å•çš„ http æ¥å£ï¼Œæ¥ä¸‹æ¥é…ç½®ä¸‹ maven ç›¸å…³æ’ä»¶ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ gradle çš„è¯å¯ä»¥å‚è€ƒ<a href="https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>windfall-explore-graalvm-spring-boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>21<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.main-class</span>&gt;</span>com.ylb.explore.graalvm.spring.boot.DemoApplication<span class="tag">&lt;/<span class="name">project.main-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>native-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- imageNameç”¨äºè®¾ç½®ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åç§° --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;project.main-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span>--enable-preview<span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥ä¸‹æ‰§è¡Œ maven æ’ä»¶å°†ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn native:compile</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™é‡åˆ°äº†ç¼–è¯‘æ—¶çš„ç¬¬ä¸€ä¸ªå‘</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAVwbJe.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>è¿™é‡ŒçœŸæ­£çš„æç¤ºé”™è¯¯æ²¡æœ‰é«˜äº®ï¼Œåè€Œæ˜¯ä¸‹é¢çš„ native-image -cp è¯­å¥è¿›è¡Œäº†é«˜äº®ï¼Œå¼‚æ­¥æµç¨‹å°±ä¼šé”™è¿‡ï¼Œè¿™é‡Œè€½æäº†æˆ‘ä¸å°‘æ—¶é—´ğŸŒšï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œåœ¨æ’ä»¶ä¸­æ·»åŠ é…ç½®å‚æ•°å³å¯</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;project.main-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸Š mainClass åï¼Œé‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤ï¼Œä¸€åˆ‡éƒ½ååˆ†é¡ºåˆ©</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAVwXQA.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>ç»è¿‡æ¼«é•¿çš„ç­‰å¾…ï¼Œç»ˆäºç¼–è¯‘æˆåŠŸï¼Œé‚£ä¹ˆä¸å‡ºæ„å¤–ï¼Œæ„å¤–é©¬ä¸Šå°±æ¥äº†</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ windfall-explore-graalvm-spring-boot</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">'_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | '</span>_ | <span class="string">'_| | '</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">'  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Spring Boot ::                (v3.3.3)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Application run failed</span></span><br><span class="line"><span class="string">org.springframework.boot.AotInitializerNotFoundException: Startup with AOT mode enabled failed: AOT initializer com.ylb.explore.graalvm.spring.boot.DemoApplication__ApplicationContextInitializer could not be found</span></span><br><span class="line"><span class="string">        at org.springframework.boot.SpringApplication.addAotGeneratedInitializerIfNecessary(SpringApplication.java:443)</span></span><br><span class="line"><span class="string">        at org.springframework.boot.SpringApplication.prepareContext(SpringApplication.java:400)</span></span><br><span class="line"><span class="string">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:334)</span></span><br><span class="line"><span class="string">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1363)</span></span><br><span class="line"><span class="string">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1352)</span></span><br><span class="line"><span class="string">        at com.ylb.explore.graalvm.spring.boot.DemoApplication.main(DemoApplication.java:11)</span></span><br><span class="line"><span class="string">        at java.base@21.0.4/java.lang.invoke.LambdaForm$DMH/sa346b79c.invokeStaticInit(LambdaForm$DMH)</span></span><br></pre></td></tr></table></figure><p>å‡ºç°è¿™ä¸ªé”™è¯¯çš„ä¸»è¦åŸå› æ˜¯ç¼ºå°‘äº† spring boot çš„ AOT å…ƒæ–‡ä»¶ä¿¡æ¯ï¼Œéœ€è¦å…ˆé€šè¿‡ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘ç”Ÿæˆ AOT å…ƒæ–‡ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mvn clean compil</span><br><span class="line">mvn spring-boot:process-aot</span><br><span class="line">mvn spring-boot:process-aot</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å†æ‰§è¡Œ  mvn native:compileï¼Œåç­‰äºŒè¿›åˆ¶æ–‡ä»¶ç¼–è¯‘å®Œæˆå³å¯ã€‚</p><p>ä¸‹é¢å¯¹æ¯”ä¸‹ä½¿ç”¨ jvm å¯åŠ¨å’Œä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶çš„è€—æ—¶:</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAVwjsI.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAVwvLt.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>è™½ç„¶æ²¡æœ‰åˆ°è¾¾äº†å®˜ç½‘æ‰€è¯´çš„ 100 å€é‚£ä¹ˆå¤šï¼Œä½†ä¹Ÿè¿™ä¸ªå·®è·ç›¸å½“ææ€–äº†ã€‚</p><p>ä»¥ä¸Šæ˜¯åœ¨æœ¬åœ°ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶çš„æ–¹å¼ï¼Œspring å®˜æ–¹è¿˜æä¾›äº†ç›´æ¥ç¼–è¯‘æ„å»º docker é•œåƒçš„æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:build-image -Pnative</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAVwzeP.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/09/03/pAV0po8.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>å†…éƒ¨æ˜¯åŸºäº paketobuildpacks/builder-jammy-tiny å’Œ paketobuildpacks/run-jammy-tiny æ„å»ºé•œåƒï¼Œåº•å±‚åŸç†è¿˜æœªäº†è§£ï¼Œä½†å¤§æ¦‚ç‡ä¹Ÿæ˜¯ä½œä¸ºåŸºç¡€é•œåƒå®‰è£…ç›¸å…³ç¯å¢ƒåï¼Œç¼–è¯‘ä»£ç ï¼Œç„¶åç˜¦èº«é•œåƒã€‚è¿™é‡Œæœ‰ä¸€ä¸ªï¼Œè¯·ç¡®ä¿ docker é…ç½®äº†è¶³å¤Ÿå¤šçš„å†…å­˜ï¼Œåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“ğŸŒš</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå‘çš„ç‚¹ï¼Œä½¿ç”¨ GraalVM ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ JDK æä¾›çš„ä¸€ä¸‹å·¥å…·ï¼Œä¾‹å¦‚ jstackã€jstat ç­‰ç­‰ï¼Œå¯èƒ½å¯¹ä¹‹å‰ä¹ æƒ¯ä½¿ç”¨è¿™äº›å·¥å…·çš„ç«¥é‹æ¥è¯´ï¼Œæ˜¯éš¾ä»¥æ¥å—çš„ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ jps</span><br><span class="line">43203 Main</span><br><span class="line">18475 Launcher</span><br><span class="line">18847 Jps</span><br><span class="line"></span><br><span class="line">$ ps -ef | grep windfall</span><br><span class="line">501 18834 27099   0 10:21AM ttys003    0:00.09 /windfall-common/windfall-explore/windfall-explore-graalvm/windfall-explore-graalvm-spring-boot/target/windfall-explore-graalvm-spring-boot</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”šè‡³ä¼šå¯¼è‡´è¿›ç¨‹ç›´æ¥ä¸­æ–­ï¼ŒçœŸææ€–</span></span><br><span class="line">$ jstack 19194                                                                                                                                                                  </span><br><span class="line">19194: No such process</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>GraalVM æä¾›äº† AOT ç¼–è¯‘å™¨ï¼Œå¤§å¤§æå‡äº†ä»£ç å¯åŠ¨æ•ˆç‡ï¼Œä½†åŒæ—¶ä¹Ÿå¤§å¤§å¢åŠ äº†ç¼–è¯‘æ—¶é—´ã€‚</li><li>GraalVM é™åˆ¶äº† Java è¿è¡Œæ—¶åŠ¨æ€åŠ è½½çš„ç‰¹æ€§ï¼Œå¯èƒ½å¾ˆå¤šæ·±åº¦ä½¿ç”¨ Java åŠ¨æ€åŠ è½½çš„åº”ç”¨æˆ–è€…å·¥å…·å¹¶ä¸é€‚ç”¨ã€‚</li><li>GraalVM AOT ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•ä½¿ç”¨ JDK æä¾›çš„ä¸€äº›ç›‘æ§è¯Šæ–­å·¥å…·ã€‚</li></ul><blockquote><p>å‚è€ƒï¼š</p><p><a href="https://www.graalvm.org/latest/reference-manual/native-image/" target="_blank" rel="noopener">https://www.graalvm.org/latest/reference-manual/native-image/</a></p><p><a href="https://graalvm.github.io/native-build-tools/latest/maven-plugin.html" target="_blank" rel="noopener">https://graalvm.github.io/native-build-tools/latest/maven-plugin.html</a></p><p><a href="https://docs.spring.io/spring-boot/how-to/native-image/developing-your-first-application.html" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/how-to/native-image/developing-your-first-application.html</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;GraalVM-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#GraalVM-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;GraalVM ç®€ä»‹&quot;&gt;&lt;/a&gt;GraalVM ç®€ä»‹&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;GraalVM compiles your Jav</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>nacos spring çƒ­æ›´æ–°</title>
    <link href="http://example.com/2024/08/30/nacos-spring-%E7%83%AD%E6%9B%B4%E6%96%B0/"/>
    <id>http://example.com/2024/08/30/nacos-spring-%E7%83%AD%E6%9B%B4%E6%96%B0/</id>
    <published>2024-08-29T16:05:05.000Z</published>
    <updated>2024-08-29T16:06:10.264Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>nacos çƒ­æ›´æ–°ä¸»è¦åˆ†ä¸ºå…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°å’Œå±€éƒ¨ Bean å­—æ®µçƒ­æ›´æ–°ï¼Œåˆ†åˆ«ç”± @NacosPropertySource å’Œ @NacosValue çš„ autoRefreshed å­—æ®µæ§åˆ¶ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«çœ‹çœ‹åŸç†ã€‚</p><h3 id="å…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°"><a href="#å…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°" class="headerlink" title="å…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°"></a>å…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°</h3><p>å…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°ç”± @NacosPropertySource çš„ autoRefreshed å­—æ®µæ§åˆ¶ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹æºç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.nacos.spring.core.env.NacosPropertySourcePostProcessor#doProcessPropertySource</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doProcessPropertySource</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®æ³¨è§£æˆ–è€…xmlé…ç½®è§£æbeanå¯¹è±¡ä¸­é…ç½®çš„é…ç½®æº</span></span><br><span class="line">        List&lt;NacosPropertySource&gt; nacosPropertySources = buildNacosPropertySources(</span><br><span class="line">                beanName, beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add Orderly</span></span><br><span class="line">        <span class="keyword">for</span> (NacosPropertySource nacosPropertySource : nacosPropertySources) &#123;</span><br><span class="line">            <span class="comment">// å°†é…ç½®æºæ·»åŠ åˆ°ç¯å¢ƒå¯¹è±¡ä¸­</span></span><br><span class="line">            addNacosPropertySource(nacosPropertySource);</span><br><span class="line">            <span class="comment">// å°†NacosPropertySourceæ³¨è§£ä¸­çš„éç©ºå­—ç¬¦ä¸²å±æ€§å’Œå…¨å±€é…ç½®åˆå¹¶è¿”å›</span></span><br><span class="line">            Properties properties = configServiceBeanBuilder</span><br><span class="line">                    .resolveProperties(nacosPropertySource.getAttributesMetadata());</span><br><span class="line">            <span class="comment">// æ·»åŠ é…ç½®å˜æ›´ç›‘å¬å™¨</span></span><br><span class="line">            addListenerIfAutoRefreshed(nacosPropertySource, properties, environment);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.alibaba.nacos.spring.core.env.NacosPropertySourcePostProcessor#addListenerIfAutoRefreshed</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addListenerIfAutoRefreshed</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> NacosPropertySource nacosPropertySource, <span class="keyword">final</span> Properties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœNacosPropertySourceæœªå¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (!nacosPropertySource.isAutoRefreshed()) &#123; <span class="comment">// Disable Auto-Refreshed</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ConfigService configService = nacosServiceFactory.createConfigService(properties);</span><br><span class="line">            Listener listener = <span class="keyword">new</span> AbstractListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String config)</span> </span>&#123;</span><br><span class="line">                    String name = nacosPropertySource.getName();</span><br><span class="line">                    <span class="comment">// ä½¿ç”¨æ–°é…ç½®æ•°æ®æ„å»ºé…ç½®å‘˜</span></span><br><span class="line">                    NacosPropertySource newNacosPropertySource = <span class="keyword">new</span> NacosPropertySource(</span><br><span class="line">                            dataId, groupId, name, config, type);</span><br><span class="line">                    <span class="comment">// æ‹·è´æ—§æºé…ç½®çš„å…ƒæ•°æ®</span></span><br><span class="line">                    newNacosPropertySource.copy(nacosPropertySource);</span><br><span class="line">                    MutablePropertySources propertySources = environment</span><br><span class="line">                            .getPropertySources();</span><br><span class="line">                    <span class="comment">// æ›¿æ¢ç¯å¢ƒå¯¹è±¡ä¸­çš„æºé…ç½®</span></span><br><span class="line">                    propertySources.replace(name, newNacosPropertySource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">      <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">            configService.addListener(dataId, groupId, listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ@NacosPropertySource çš„ autoRefreshed å­—æ®µä»…æ§åˆ¶ç¯å¢ƒå¯¹è±¡ä¸­çš„é…ç½®æºæ›´æ–°ã€‚</p><h3 id="å±€éƒ¨-Bean-å­—æ®µçƒ­æ›´æ–°"><a href="#å±€éƒ¨-Bean-å­—æ®µçƒ­æ›´æ–°" class="headerlink" title="å±€éƒ¨ Bean å­—æ®µçƒ­æ›´æ–°"></a>å±€éƒ¨ Bean å­—æ®µçƒ­æ›´æ–°</h3><p>æ¥ä¸‹æ¥çœ‹çœ‹å±€éƒ¨ Bean å­—æ®µæ›´æ–°ï¼Œå±€éƒ¨ Bean å­—æ®µæ›´æ–°ä¸»è¦ç”±  @NacosValue çš„ autoRefreshed å­—æ®µæ§åˆ¶ï¼Œæ¥ä¸‹æ¥åŒæ ·çœ‹çœ‹æºç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.annotation.config.NacosValueAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, <span class="keyword">final</span> String beanName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    doWithFields(bean, beanName);</span><br><span class="line">    doWithMethods(bean, beanName);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.postProcessBeforeInitialization(bean, beanName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.annotation.config.NacosValueAnnotationBeanPostProcessor#doWithFields</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWithFields</span><span class="params">(<span class="keyword">final</span> Object bean, <span class="keyword">final</span> String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è§£æbeanå¯¹è±¡ä¸­å­—æ®µçš„NacosValueæ³¨è§£</span></span><br><span class="line">    ReflectionUtils.doWithFields(bean.getClass(),</span><br><span class="line">            <span class="keyword">new</span> ReflectionUtils.FieldCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Field field)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">                    NacosValue annotation = getAnnotation(field, NacosValue<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    doWithAnnotation(beanName, bean, annotation, field.getModifiers(),</span><br><span class="line">                            <span class="keyword">null</span>, field);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.annotation.config.NacosValueAnnotationBeanPostProcessor#doWithAnnotation</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWithAnnotation</span><span class="params">(String beanName, Object bean, NacosValue annotation,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> modifiers, Method method, Field field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// é™æ€å­—æ®µä¸å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (Modifier.isStatic(modifiers)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¼€å¯è‡ªåŠ¨åˆ·æ–°</span></span><br><span class="line">            <span class="keyword">if</span> (annotation.autoRefreshed()) &#123;</span><br><span class="line">              <span class="comment">// è§£æå ä½ç¬¦</span></span><br><span class="line">                String placeholder = resolvePlaceholder(annotation.value());</span><br><span class="line">        <span class="comment">// å°†å ä½ç¬¦ï¼Œbeanå¯¹è±¡ï¼Œå­—æ®µä¿¡æ¯ç­‰ç¼“å­˜åœ¨å†…å­˜ä¸­</span></span><br><span class="line">                NacosValueTarget nacosValueTarget = <span class="keyword">new</span> NacosValueTarget(bean, beanName,</span><br><span class="line">                        method, field, annotation.value());</span><br><span class="line">                put2ListMap(placeholderNacosValueTargetMap, placeholder,</span><br><span class="line">                        nacosValueTarget);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Bean å¯¹è±¡åˆå§‹åŒ–å‰ï¼Œä¼šè§£æå¯¹è±¡ä¸­æ·»åŠ äº† @NacosValue çš„å­—æ®µæˆ–è€…æ–¹æ³•ï¼Œå¹¶å°†ç›¸å…³çš„å­—æ®µã€å¯¹è±¡ã€æ³¨è§£ä¿¡æ¯ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚æ¥ä¸‹æ¥çœ‹çœ‹è¿™äº›å­—æ®µæ˜¯å¦‚ä½•å®ç°çƒ­æ›´æ–°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.annotation.config.NacosValueAnnotationBeanPostProcessor#onApplicationEvent</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(NacosConfigReceivedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// In to this event receiver, the environment has been updated the</span></span><br><span class="line">        <span class="comment">// latest configuration information, pull directly from the environment</span></span><br><span class="line">        <span class="comment">// fix issue #142</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;NacosValueTarget&gt;&gt; entry : placeholderNacosValueTargetMap</span><br><span class="line">                .entrySet()) &#123;</span><br><span class="line">            String key = environment.resolvePlaceholders(entry.getKey());</span><br><span class="line">            <span class="comment">// ä»ç¯å¢ƒå˜é‡ä¸­å–å‡ºï¼Œå› ä¸ºç¯å¢ƒå˜é‡æ›´æ–°æ˜¯åœ¨äº‹ä»¶å‘å¸ƒä¹‹å‰åº”ç”¨äº‹ä»¶å‘å¸ƒå‰å®Œæˆçš„</span></span><br><span class="line">            <span class="comment">// æ‰€ä»¥æ­¤å¤„è·å–åˆ°çš„å€¼æ˜¯å·²ç»æ›´æ–°å®Œæˆä¹‹åçš„æ•°æ®</span></span><br><span class="line">            String newValue = environment.getProperty(key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;NacosValueTarget&gt; beanPropertyList = entry.getValue();</span><br><span class="line">            <span class="keyword">for</span> (NacosValueTarget target : beanPropertyList) &#123;</span><br><span class="line">              <span class="comment">// æ¯”è¾ƒæ–°æ—§æ•°æ®md5æ ¡éªŒå’Œ</span></span><br><span class="line">                String md5String = MD5Utils.md5Hex(newValue, <span class="string">"UTF-8"</span>);</span><br><span class="line">                <span class="keyword">boolean</span> isUpdate = !target.lastMD5.equals(md5String);</span><br><span class="line">                <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                    target.updateLastMD5(md5String);</span><br><span class="line">                    Object evaluatedValue = resolveNotifyValue(target.nacosValueExpr, key, newValue);</span><br><span class="line">                    <span class="comment">// æ›´æ–°beanå¯¹è±¡å­—æ®µæˆ–æ–¹æ³•</span></span><br><span class="line">                    <span class="keyword">if</span> (target.method == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        setField(target, evaluatedValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        setMethod(target, evaluatedValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æ¥æ”¶åˆ°é…ç½®å˜æ›´äº‹ä»¶æ—¶ï¼Œä¼šéå†å†…å­˜ä¸­çš„éœ€è¦è‡ªåŠ¨æ›´æ–°çš„ Bean å­—æ®µä¿¡æ¯ï¼Œå¯¹æ¯” MD5 æ ¡éªŒå’Œï¼Œå¦‚æœå‘ç°å­˜åœ¨å˜æ›´ï¼Œåˆ™æ›´æ–° Bean å­—æ®µæˆ–æ–¹æ³•ã€‚ï¼ˆæ­¤å¤„å­˜åœ¨ä¸€ä¸ªç–‘é—®ï¼Œæ¯æ¥æ”¶åˆ°ä¸€ä¸ªäº‹ä»¶éƒ½ä¼šéå†æ‰€æœ‰ Bean å­—æ®µä¿¡æ¯ï¼Œæ•ˆç‡æ˜¯å¦è¾ƒä½ï¼Ÿï¼‰</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼Œæ–°çš„é…ç½®æ•°æ®æ˜¯ç›´æ¥ä»ç¯å¢ƒå¯¹è±¡ä¸­å–å‡ºçš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€ @NacosValue å­—æ®µçš„è‡ªåŠ¨æ›´æ–°æ˜¯ä¼šå— @NacosPropertySource è‡ªåŠ¨æ›´æ–°çš„å½±å“çš„ã€‚å¦‚æœ @NacosPropertySource  æœªå¼€å¯è‡ªåŠ¨æ›´æ–°ï¼Œå³ä½¿ @NacosValue å¼€å¯è‡ªåŠ¨æ›´æ–°æœ€ç»ˆè¿˜æ˜¯æ— æ³•æ›´æ–°ã€‚</p><h3 id="æ›´æ–°äº‹ä»¶æ¥é€"><a href="#æ›´æ–°äº‹ä»¶æ¥é€" class="headerlink" title="æ›´æ–°äº‹ä»¶æ¥é€"></a>æ›´æ–°äº‹ä»¶æ¥é€</h3><p>æ¥ä¸‹æ¥å†æ¥éªŒè¯ä¸€ä¸‹ä¸Šé¢æ‰€è¯´çš„ï¼Œå…¨å±€ç¯å¢ƒå˜é‡çš„æ›´æ–°æ˜¯å±€éƒ¨ Bean å­—æ®µæ›´æ–°ä¹‹å‰å®Œæˆçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.nacos.client.config.impl.CacheData#safeNotifyListener</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">safeNotifyListener</span><span class="params">(<span class="keyword">final</span> String dataId, <span class="keyword">final</span> String group, <span class="keyword">final</span> String content, <span class="keyword">final</span> String type,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> String md5, <span class="keyword">final</span> String encryptedDataKey, <span class="keyword">final</span> ManagerListenerWrap listenerWrap)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    NotifyTask job = <span class="keyword">new</span> NotifyTask() &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            ClassLoader myClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">            ClassLoader appClassLoader = listener.getClass().getClassLoader();</span><br><span class="line">            ScheduledFuture&lt;?&gt; timeSchedule = <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">                timeSchedule = getNotifyBlockMonitor().schedule(</span><br><span class="line">                        <span class="keyword">new</span> LongNotifyHandler(listener.getClass().getSimpleName(), dataId, group, tenant, md5,</span><br><span class="line">                                notifyWarnTimeout, Thread.currentThread()), notifyWarnTimeout,</span><br><span class="line">                        TimeUnit.MILLISECONDS);</span><br><span class="line">                listenerWrap.inNotifying = <span class="keyword">true</span>;</span><br><span class="line">                listener.receiveConfigInfo(contentTmp);</span><br><span class="line">                <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (NacosException ex) &#123;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.event.config.DelegatingEventPublishingListener#receiveConfigInfo</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">    onReceived(content);</span><br><span class="line">    publishEvent(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.event.config.DelegatingEventPublishingListener#publishEvent</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">    NacosConfigReceivedEvent event = <span class="keyword">new</span> NacosConfigReceivedEvent(configService,</span><br><span class="line">            dataId, groupId, content, configType);</span><br><span class="line">    applicationEventPublisher.publishEvent(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.alibaba.nacos.spring.context.event.config.DelegatingEventPublishingListener#onReceived</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReceived</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        delegate.receiveConfigInfo(content);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå…ˆæ‰§è¡Œ Nacos åŸç”Ÿç›‘å¬å™¨çš„ receiveConfigInfo æ–¹æ³•ï¼Œå†å‘å¸ƒåº”ç”¨äº‹ä»¶ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>@NacosPropertySource çš„ autoRefreshed å­—æ®µæ§åˆ¶å…¨å±€ç¯å¢ƒå˜é‡çš„æ›´æ–°ã€‚</li><li>@NacosValue çš„ autoRefreshed å­—æ®µæ§åˆ¶å±€éƒ¨ Bean å¯¹è±¡å­—æ®µæ›´æ–°ã€‚</li><li>Bean å¯¹è±¡å­—æ®µæ›´æ–°è¿˜æ˜¯ä¼šå—åˆ° @NacosPropertySource çš„ autoRefreshed å­—æ®µçš„å½±å“ï¼Œåªæœ‰ @NacosPropertySource å’Œ @NacosValue åŒæ—¶å¼€å¯è‡ªåŠ¨åˆ·æ–°æ‰èƒ½çœŸæ­£è‡ªåŠ¨æ›´æ–°ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;nacos çƒ­æ›´æ–°ä¸»è¦åˆ†ä¸ºå…¨å±€ç¯å¢ƒå˜é‡çƒ­æ›´æ–°å’Œå±€éƒ¨ Bean å­—æ®µçƒ­æ›´æ–°ï¼Œåˆ†åˆ«ç”± @NacosPropertySource å’Œ @Nacos</summary>
      
    
    
    
    
    <category term="nacos" scheme="http://example.com/tags/nacos/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªæŸ¥è¯¢è¯­å¥åœ¨ ShardingJDBC ä¸­éƒ½å‘ç”Ÿäº†å•¥</title>
    <link href="http://example.com/2024/08/07/%E4%B8%80%E4%B8%AA%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E5%9C%A8-ShardingJDBC-%E4%B8%AD%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E5%95%A5/"/>
    <id>http://example.com/2024/08/07/%E4%B8%80%E4%B8%AA%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E5%9C%A8-ShardingJDBC-%E4%B8%AD%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E5%95%A5/</id>
    <published>2024-08-07T15:44:48.000Z</published>
    <updated>2024-08-07T15:58:10.989Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>éšç€ä¸šåŠ¡æ•°æ®çš„å¢é•¿ï¼ŒåŸæœ¬å…¬å¸ä¸­çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆç›¸å¯¹æ¥è¯´ä¸å¤Ÿçµæ´»ï¼Œæ‰€ä»¥å†³å®šå¼•å…¥ä¸šå†…ç›¸å¯¹è¾ƒä¸ºæˆç†Ÿçš„åˆ†åº“åˆ†è¡¨ç»„ä»¶ã€‚é€šè¿‡æ¥å…¥æˆæœ¬ã€æ€§èƒ½æŸè€—ã€ç¤¾åŒºæ´»è·ƒç­‰å¤šæ–¹é¢è€ƒè™‘ï¼Œå†³å®šå¼•å…¥ SharidngJDBCã€‚ä½†æ˜¯ç›®å‰ ShardingJDBC å¯¹éƒ¨åˆ†ç°æœ‰ä¸šåŠ¡æ— æ³•åšåˆ°å¤ªå‹å¥½çš„æ”¯æŒï¼Œæ‰€ä»¥å†³å®šåŸºäºç°æœ‰æ‰©å±•ç‚¹æ‰©å±•æˆ–è€…æ”¹é€ æºç ï¼Œä¸ºæ­¤éœ€è¦æ·±å…¥é˜…è¯» ShardingJDBC æºç ã€‚</p></blockquote><h3 id="ShardingJDBC-æ¶æ„å›¾"><a href="#ShardingJDBC-æ¶æ„å›¾" class="headerlink" title="ShardingJDBC æ¶æ„å›¾"></a>ShardingJDBC æ¶æ„å›¾</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/08/07/pkzCD6x.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>ä»¥ä¸Šæ˜¯ä»å®˜ç½‘æ‹·è´çš„æ¶æ„å›¾ï¼Œå›¾ä¸Šå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ° SQL å¤§è‡´æµç¨‹:</p><ol><li>è§£æå¼•æ“è¿›è¡Œ SQL è§£æï¼Œæ ¹æ®æ•°æ®åº“ç±»å‹å°† SQL è§£ææˆæŠ½è±¡è¯­æ³•æ ‘</li><li>è·¯ç”±å¼•æ“æ ¹æ®è·¯ç”±è§„åˆ™å’ŒæŠ½è±¡è¯­æ³•æ ‘ï¼Œç”Ÿæˆè·¯ç”±ä¸Šä¸‹æ–‡</li><li>æ”¹å†™å¼•æ“æ ¹æ®è·¯ç”±ä¸Šä¸‹æ–‡å’ŒæŠ½è±¡è¯­æ³•æ ‘ï¼Œå¯¹ SQL è¿›è¡Œæ”¹å†™ï¼Œå¹¶ç”Ÿæˆæ”¹å†™ä¸Šä¸‹æ–‡</li><li>æ ¹æ®è·¯ç”±ä¸Šä¸‹æ–‡ã€æ”¹å†™ä¸Šä¸‹æ–‡ç”Ÿæˆæ‰§è¡Œä¸Šä¸‹æ–‡</li><li>æ‰§è¡Œå¼•æ“æ‰§è¡Œä¸Šä¸‹æ–‡æ ¹æ®åº“ã€è¿æ¥æ•°ç­‰è¿›è¡Œåˆ†ç»„ï¼Œå¹¶å‘æ‰§è¡Œ SQL</li><li>åˆå¹¶å¼•æ“æ ¹æ®è·¯ç”±è§„åˆ™ç­‰å¯¹æ‰§è¡Œç»“æœè¿›è¡Œåˆå¹¶ç­‰ã€‚</li></ol><p>ä»¥ä¸Šæ˜¯ SQL å¤§è‡´çš„æ‰§è¡Œæµç¨‹ï¼Œæ¥ä¸‹æ¥å°±ä»æºç å±‚é¢å¤§è‡´çœ‹ä¸€ä¸‹å…·ä½“æ‰§è¡Œæµç¨‹ã€‚æ³¨ï¼šæœ¬æ–‡æ˜¯åŸºäº 5.5.0 çš„æºç ã€‚</p><h3 id="è§£æå¼•æ“"><a href="#è§£æå¼•æ“" class="headerlink" title="è§£æå¼•æ“"></a>è§£æå¼•æ“</h3><p>é¦–å…ˆçœ‹ä¸€ä¸‹ SQL è§£ææ˜¯åœ¨å“ªä¸ªé˜¶æ®µæ‰§è¡Œï¼Œå†çœ‹çœ‹å…·ä½“è§£æçš„é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯ SQL è§£ææ‰§è¡Œçš„é˜¶æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¢„å¤„ç†è¯­å¥</span></span><br><span class="line">PreparedStatement preparedStatement = connection.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.driver.jdbc.core.connection.ShardingSphereConnection#prepareStatement</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(<span class="keyword">final</span> String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ShardingSpherePreparedStatement(<span class="keyword">this</span>, sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement#ShardingSpherePreparedStatement</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ShardingSpherePreparedStatement</span><span class="params">(<span class="keyword">final</span> ShardingSphereConnection connection, <span class="keyword">final</span> String sql,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">final</span> <span class="keyword">int</span> resultSetType, <span class="keyword">final</span> <span class="keyword">int</span> resultSetConcurrency, <span class="keyword">final</span> <span class="keyword">int</span> resultSetHoldability, <span class="keyword">final</span> <span class="keyword">boolean</span> returnGeneratedKeys,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">final</span> String[] columns)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">// ç•¥...</span></span><br><span class="line">    SQLParserRule sqlParserRule = metaDataContexts.getMetaData().getGlobalRuleMetaData().getSingleRule(SQLParserRule<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// è·å– sql è§£æå¼•æ“</span></span><br><span class="line">    SQLParserEngine sqlParserEngine = sqlParserRule.getSQLParserEngine(metaDataContexts.getMetaData().getDatabase(connection.getDatabaseName()).getProtocolType());</span><br><span class="line">    <span class="comment">// å¯ä»¥é€šè¿‡ SQLParserRuleConfiguration é…ç½®ç¼“å­˜</span></span><br><span class="line">    sqlStatement = sqlParserEngine.parse(<span class="keyword">this</span>.sql, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    sqlStatementContext = <span class="keyword">new</span> SQLBindEngine(metaDataContexts.getMetaData(), connection.getDatabaseName(), hintValueContext).bind(sqlStatement, Collections.emptyList());</span><br><span class="line">    <span class="comment">// ç•¥...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°å¯ä»¥çœ‹åˆ° SQL è§£ææ˜¯åœ¨é¢„å¤„ç†é˜¶æ®µæ‰§è¡Œçš„ï¼Œé™¤äº† SQL è§£æé¢„å¤„ç†é˜¶æ®µè¿˜åˆå§‹åŒ–äº†å†…æ ¸å¤„ç†å™¨ï¼Œå„ç§æ‰§è¡Œå™¨ç­‰ç­‰ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹ SQL è§£æå…·ä½“æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼ŒSQL è§£æåº•å±‚ä¾èµ–äº Antlr4 (ä¸äº†è§£çš„å¯ä»¥çœ‹çœ‹è¿™è¾¹æ–‡ç«  <a href="https://juejin.cn/post/7396247820900352035" target="_blank" rel="noopener">ä¼ é€é—¨</a> )ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.infra.parser.sql.SQLStatementParserEngine#parse</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String sql, <span class="keyword">final</span> <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜ä¸­å­˜åœ¨sqlå¯¹åº”çš„ SQLStatement åˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œåº•å±‚ä½¿ç”¨çš„ caffeine</span></span><br><span class="line">    <span class="keyword">return</span> useCache ? sqlStatementCache.get(sql) : sqlStatementParserExecutor.parse(sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.parser.sql.SQLStatementParserExecutor#parse</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String sql)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1ã€åŸºäº Antlr4 è¯­æ³•è§„åˆ™ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘</span></span><br><span class="line">    <span class="comment">// 2ã€åŸºäº Antlr4 vistor ç”Ÿæˆ SQLStatement</span></span><br><span class="line">    <span class="keyword">return</span> visitorEngine.visit(parserEngine.parse(sql, <span class="keyword">false</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sql.parser.api.SQLParserEngine#parse</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ParseASTNode <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String sql, <span class="keyword">final</span> <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é€šå¸¸æ˜¯ä¼˜å…ˆä»ç¼“å­˜ä¸­å–ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨ç¼“å­˜ï¼Œæ²¡æœ‰åˆ™è§£æ</span></span><br><span class="line">    <span class="keyword">return</span> useCache ? parseTreeCache.get(sql) : sqlParserExecutor.parse(sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sql.parser.core.database.parser.SQLParserExecutor#parse</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ParseASTNode <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String sql)</span> </span>&#123;</span><br><span class="line">    ParseASTNode result = twoPhaseParse(sql);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ParseASTNode <span class="title">twoPhaseParse</span><span class="params">(<span class="keyword">final</span> String sql)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŸºäºSPIè·å–æ•°æ®åº“è§£æå™¨é—¨é¢ï¼Œå…¶ä¸­åŒ…å«è¯­æ³•è§£æå™¨å’Œè¯æ³•è§£æå™¨ç±»å‹</span></span><br><span class="line">    DialectSQLParserFacade sqlParserFacade = DatabaseTypedSPILoader.getService(DialectSQLParserFacade<span class="class">.<span class="keyword">class</span>, <span class="title">databaseType</span>)</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–è¯­æ³•è§£æå™¨ï¼Œæ­¤å¤„è¯­æ³•è§£æå™¨æ˜¯æ‰©å±•è‡ª Antlr4 ç”Ÿæˆçš„ä»£ç </span></span><br><span class="line">    SQLParser sqlParser = SQLParserFactory.newInstance(sql, sqlParserFacade.getLexerClass(), sqlParserFacade.getParserClass());</span><br><span class="line">    ((Parser) sqlParser).getInterpreter().setPredictionMode(PredictionMode.SLL);</span><br><span class="line">    <span class="keyword">return</span> (ParseASTNode) sqlParser.parse();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯ SQL è§£æçš„å…·ä½“è§£æé€»è¾‘ï¼Œåº•å±‚ä½¿ç”¨ Antlr4ï¼Œä¸»è¦æ˜¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>ä½¿ç”¨ Antlr4 ç”Ÿæˆçš„è¯­æ³•è§£æå™¨è§£æ SQLï¼Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘</li><li>ä½¿ç”¨è‡ªå®šä¹‰çš„ Vistor éå†æŠ½è±¡è¯­æ³•æ ‘ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ SQLStatement</li></ol><p>ä¸‹é¢å†ç®€å•çœ‹çœ‹ ShardingJDBC æ˜¯å¦‚ä½•ä½¿ç”¨ Antlr4 çš„ï¼Œå…·ä½“ä»£ç åœ¨ shardingsphere-parser è¿™ä¸ªæ¨¡å—ã€‚</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/08/07/pkzCrX6.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>ä»¥ MySQL Insert è¯­å¥çš„è¯­æ³•è§„åˆ™ä¸ºä¾‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">grammar</span> <span class="string">DMLStatement;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">import</span> <span class="string">BaseRule;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">insert</span></span><br><span class="line">    : INSERT insertSpecification INTO? tableName partitionNames? (insertValuesClause | setAssignmentsClause | insertSelectClause) onDuplicateKeyClause?</span><br><span class="line">    <span class="attr">;</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">insertSpecification</span></span><br><span class="line">    : (LOW_PRIORITY | DELAYED | HIGH_PRIORITY)? IGNORE?</span><br><span class="line">    <span class="attr">;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">insertValuesClause</span></span><br><span class="line">    : (LP_ fields? RP_ )? (VALUES | VALUE) (assignmentValues (COMMA_ assignmentValues)* | rowConstructorList) valueReference?</span><br><span class="line">    <span class="attr">;</span></span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/08/07/pkzCynK.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.shardingsphere.sql.parser.mysql.parser.MySQLParser#parse</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ASTNode <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// execute æ˜¯æ ¹æ® Antlr4 ç”Ÿæˆçš„è¯­æ³•è§„åˆ™ï¼ŒtokenStream æ˜¯è¯æ³•è§£æå™¨è§£æå‡ºæ¥çš„ Token æµ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ParseASTNode(execute(), (CommonTokenStream) getTokenStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯æŠ½è±¡è¯­æ³•æ ‘è§£æç›¸å…³çš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦å°±æ˜¯ä½¿ç”¨ Antlr4 çš„è¯­æ³•è§„åˆ™æ–‡ä»¶ç”Ÿæˆè¯­æ³•è§£æç›¸å…³çš„ä»£ç :</p><ul><li>execute æ˜¯ MySQL è¯­æ³•è§£æçš„æ€»å…¥å£ï¼Œå®šä¹‰åœ¨ MySQLStatement.g4 ä¸­ã€‚</li><li>getTokenStream æ˜¯è·å–è¯æ³•è§£æå™¨è§£æå‡ºçš„ TokenStreamã€‚</li><li>parse æ–¹æ³•å®é™…ä¸Šåšçš„å°±æ˜¯å°† Antlr4 è§£æå‡ºçš„æŠ½è±¡è¯­æ³•æ ‘å’Œ TokenStream å°è£…èµ·æ¥ï¼Œç”¨äºåç»­ Visitor éå†ä½¿ç”¨ã€‚</li></ul><p>æ¥ä¸‹æ¥å†çœ‹çœ‹ SQLStatement ç”Ÿæˆçš„è¿‡ç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.sql.parser.api.SQLStatementVisitorEngine#visit</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">visit</span><span class="params">(<span class="keyword">final</span> ParseASTNode parseASTNode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– visitor, visitor ç»§æ‰¿è‡ª Antlr ç”Ÿæˆä»£ç </span></span><br><span class="line">    SQLStatementVisitor visitor = SQLStatementVisitorFactory.newInstance(databaseType, SQLVisitorRule.valueOf(parseASTNode.getRootNode().getClass()));</span><br><span class="line">    <span class="comment">// éå†è¯­æ³•æ ‘ï¼Œç”Ÿæˆ SQLStatement</span></span><br><span class="line">    ASTNode result = parseASTNode.getRootNode().accept(visitor);</span><br><span class="line">    appendSQLComments(parseASTNode, result);</span><br><span class="line">    <span class="keyword">return</span> (SQLStatement) result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sql.parser.mysql.visitor.statement.MySQLStatementVisitor#visitInsert</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ASTNode <span class="title">visitInsert</span><span class="params">(<span class="keyword">final</span> InsertContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO :FIXME, since there is no segment for insertValuesClause, InsertStatement is created by sub rule.</span></span><br><span class="line">    MySQLInsertStatement result;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != ctx.insertValuesClause()) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® insert value è¯­æ³•ç”Ÿæˆ Statemen</span></span><br><span class="line">        result = (MySQLInsertStatement) visit(ctx.insertValuesClause());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> != ctx.insertSelectClause()) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® insert select è¯­æ³•ç”Ÿæˆ Statemen</span></span><br><span class="line">        result = (MySQLInsertStatement) visit(ctx.insertSelectClause());</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">        <span class="comment">// assignment </span></span><br><span class="line">        result = <span class="keyword">new</span> MySQLInsertStatement();</span><br><span class="line">        result.setSetAssignment((SetAssignmentSegment) visit(ctx.setAssignmentsClause()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç† on duplicate</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != ctx.onDuplicateKeyClause()) &#123;</span><br><span class="line">        result.setOnDuplicateKeyColumns((OnDuplicateKeyColumnsSegment) visit(ctx.onDuplicateKeyClause()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®è¡¨å</span></span><br><span class="line">    result.setTable((SimpleTableSegment) visit(ctx.tableName()));</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæš‚æ—¶ä¸çŸ¥é“ä½œç”¨</span></span><br><span class="line">    result.addParameterMarkerSegments(getParameterMarkerSegments());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Visitor çš„ä½œç”¨ä¸»è¦å°±æ˜¯è‡ªå®šä¹‰éå†æŠ½è±¡è¯­æ³•æ ‘çš„é€»è¾‘ï¼ŒAntlr4 å®šä¹‰çš„æ¯ä¸ªè¯­æ³•è§„åˆ™éƒ½ä¼šç”Ÿæˆä¸€ä¸ª visit æ–¹æ³•ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šç”Ÿæˆä¸€ä¸ª visit æ–¹æ³•ï¼Œvisit æ–¹æ³•çš„å…¥å‚æ˜¯æŠ½è±¡è¯­æ³•æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¼ å…¥çš„å¦‚æœæ˜¯éå¶å­èŠ‚ç‚¹ï¼ˆå­èŠ‚ç‚¹ï¼‰åˆ™éå†çš„æ˜¯å­æ ‘ã€‚</p><p>æ¥ä¸‹æ¥ç®€å•åˆ†æä¸€ä¸‹ visitInsert æ–¹æ³•ï¼š</p><ul><li>visitInsert æ˜¯ Insert è¯­æ³•å­æ ‘çš„å…¥å£ï¼Œå½“æ‰§è¡Œ parseASTNode.getRootNode().accept(visitor) ä¼šä» visitExecute å¼€å§‹æ‰§è¡Œï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° visitInsertã€‚</li><li>å¦‚æœ insertValuesClause å­æ ‘ä¸ä¸ºç©ºï¼Œåˆ™éå† insertValuesClause å­æ ‘ã€‚</li><li>å¦‚æœ insertSelectClause å­æ ‘ä¸ä¸ºç©ºï¼Œåˆ™éå† insertSelectClause å­æ ‘ã€‚</li><li>å…¶ä»–æ­¥éª¤å¤§å¤šç±»ä¼¼ï¼Œæœ€ç»ˆå°†éå†å„ä¸ªå­æ ‘çš„ç»“æœ (Statement) ç»„è£…æˆ  Statement è¿”å›ã€‚</li></ul><h3 id="æ‰§è¡ŒæŸ¥è¯¢"><a href="#æ‰§è¡ŒæŸ¥è¯¢" class="headerlink" title="æ‰§è¡ŒæŸ¥è¯¢"></a>æ‰§è¡ŒæŸ¥è¯¢</h3><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æ‰§è¡ŒæŸ¥è¯¢ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">executeQuery</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    ResultSet result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæŸ¥è¯¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">        QueryContext queryContext = createQueryContext();</span><br><span class="line">        <span class="comment">// å¼€å¯äº‹åŠ¡</span></span><br><span class="line">        handleAutoCommit(queryContext);</span><br><span class="line">        <span class="comment">// æµé‡æ²»ç†ç›¸å…³ï¼Ÿæš‚æ—¶ä¸çŸ¥é“ä½œç”¨</span></span><br><span class="line">        trafficInstanceId = getInstanceIdAndSet(queryContext).orElse(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != trafficInstanceId) &#123;</span><br><span class="line">            JDBCExecutionUnit executionUnit = createTrafficExecutionUnit(trafficInstanceId, queryContext);</span><br><span class="line">            <span class="keyword">return</span> executor.getTrafficExecutor().execute(executionUnit, (statement, sql) -&gt; ((PreparedStatement) statement).executeQuery());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// todo è”é‚¦æŸ¥è¯¢ç›¸å…³</span></span><br><span class="line">        useFederation = decide(queryContext,</span><br><span class="line">                metaDataContexts.getMetaData().getDatabase(databaseName), metaDataContexts.getMetaData().getGlobalRuleMetaData());</span><br><span class="line">        <span class="keyword">if</span> (useFederation) &#123;</span><br><span class="line">            <span class="keyword">return</span> executeFederationQuery(queryContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡</span></span><br><span class="line">        executionContext = createExecutionContext(queryContext);</span><br><span class="line">        <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢</span></span><br><span class="line">        result = doExecuteQuery(executionContext);</span><br><span class="line">        <span class="comment">// CHECKSTYLE:OFF</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RuntimeException ex) &#123;</span><br><span class="line">        <span class="comment">// CHECKSTYLE:ON</span></span><br><span class="line">        handleExceptionInTransaction(connection, metaDataContexts);</span><br><span class="line">        <span class="keyword">throw</span> SQLExceptionTransformEngine.toSQLException(ex, metaDataContexts.getMetaData().getDatabase(databaseName).getProtocolType());</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement#createExecutionContext</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ExecutionContext <span class="title">createExecutionContext</span><span class="params">(<span class="keyword">final</span> QueryContext queryContext)</span> </span>&#123;</span><br><span class="line">    RuleMetaData globalRuleMetaData = metaDataContexts.getMetaData().getGlobalRuleMetaData();</span><br><span class="line">    ShardingSphereDatabase currentDatabase = metaDataContexts.getMetaData().getDatabase(databaseName);</span><br><span class="line">    <span class="comment">// sql å®¡è®¡æ£€æŸ¥</span></span><br><span class="line">    SQLAuditEngine.audit(queryContext.getSqlStatementContext(), queryContext.getParameters(), globalRuleMetaData, currentDatabase, <span class="keyword">null</span>, queryContext.getHintValueContext());</span><br><span class="line">    <span class="comment">// â˜†â˜†â˜†â˜†æ ¸å¿ƒâ˜†â˜†â˜†â˜† ç”Ÿæˆæ‰§è¡Œä¸Šä¸‹æ–‡</span></span><br><span class="line">    ExecutionContext result = kernelProcessor.generateExecutionContext(</span><br><span class="line">            queryContext, currentDatabase, globalRuleMetaData, metaDataContexts.getMetaData().getProps(), connection.getDatabaseConnectionManager().getConnectionContext());</span><br><span class="line">    findGeneratedKey(result).ifPresent(optional -&gt; generatedValues.addAll(optional.getGeneratedValues()));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement#doExecuteQuery</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ShardingSphereResultSet <span class="title">doExecuteQuery</span><span class="params">(<span class="keyword">final</span> ExecutionContext executionContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢</span></span><br><span class="line">    List&lt;QueryResult&gt; queryResults = executeQuery0(executionContext);</span><br><span class="line">    <span class="comment">// â˜†â˜†â˜†â˜†æ ¸å¿ƒâ˜†â˜†â˜†â˜† åˆå¹¶ç»“æœã€åŠ å¯†ã€è„±æ•</span></span><br><span class="line">    MergedResult mergedResult = mergeQuery(queryResults, executionContext.getSqlStatementContext());</span><br><span class="line">    List&lt;ResultSet&gt; resultSets = getResultSets();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == columnLabelAndIndexMap) &#123;</span><br><span class="line">        columnLabelAndIndexMap = ShardingSphereResultSetUtils.createColumnLabelAndIndexMap(sqlStatementContext, selectContainsEnhancedTable, resultSets.get(<span class="number">0</span>).getMetaData());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ShardingSphereResultSet(resultSets, mergedResult, <span class="keyword">this</span>, selectContainsEnhancedTable, executionContext, columnLabelAndIndexMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.connection.kernel.KernelProcessor#generateExecutionContext</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ExecutionContext <span class="title">generateExecutionContext</span><span class="params">(<span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> ShardingSphereDatabase database, <span class="keyword">final</span> RuleMetaData globalRuleMetaData,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> ConfigurationProperties props, <span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·¯ç”±ï¼ŒåŒ…æ‹¬åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æ•°æ®æºåŒ¹é…ç­‰ç­‰</span></span><br><span class="line">    <span class="comment">// æ ¹æ®æŸ¥è¯¢ä¸Šä¸‹æ–‡ã€æ•°æ®åº“å¯¹è±¡ã€å…¨å±€è§„åˆ™å…ƒæ•°æ®ç­‰å‚æ•°è¿›è¡Œè·¯ç”±ï¼Œå¾—åˆ°è·¯ç”±ä¸Šä¸‹æ–‡</span></span><br><span class="line">    RouteContext routeContext = route(queryContext, database, globalRuleMetaData, props, connectionContext);</span><br><span class="line">    <span class="comment">// æ ¹æ®è·¯ç”±ç»“æœæ”¹å†™sql</span></span><br><span class="line">    <span class="comment">// æ ¹æ®è·¯ç”±ä¸Šä¸‹æ–‡å’Œå…¶ä»–å‚æ•°ï¼Œå¯¹æŸ¥è¯¢è¯­å¥è¿›è¡Œæ”¹å†™ï¼Œå¾—åˆ°æ”¹å†™ç»“æœ</span></span><br><span class="line">    SQLRewriteResult rewriteResult = rewrite(queryContext, database, globalRuleMetaData, props, routeContext, connectionContext);</span><br><span class="line">    <span class="comment">// æ ¹æ®æŸ¥è¯¢ä¸Šä¸‹æ–‡ã€æ•°æ®åº“å¯¹è±¡ã€è·¯ç”±ä¸Šä¸‹æ–‡ã€æ”¹å†™ç»“æœç­‰ä¿¡æ¯åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡</span></span><br><span class="line">    ExecutionContext result = createExecutionContext(queryContext, database, routeContext, rewriteResult);</span><br><span class="line">    logSQL(queryContext, props, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæŸ¥è¯¢ä¸»è¦çš„é€»è¾‘åŒ…æ‹¬æ‰§è¡Œä¸Šä¸‹æ–‡çš„åˆ›å»ºï¼Œä»¥åŠå…·ä½“æ‰§è¡ŒæŸ¥è¯¢é€»è¾‘ã€‚å…¶ä¸­è”é‚¦æŸ¥è¯¢é€»è¾‘ç”±äºæ˜¯å®éªŒç‰¹æ€§ï¼Œä¹‹åå†è¯¦çœ‹ã€‚</p><ul><li>æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»ºä¸»è¦åŒ…æ‹¬ SQL å®¡è®¡ã€åˆ†ç‰‡è·¯ç”±ï¼ˆåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€å½±å­åº“ï¼‰ã€SQL æ”¹å†™ï¼ˆåˆ†åº“åˆ†è¡¨æ”¹å†™ã€æ•°æ®åŠ å¯†ï¼‰</li><li>å…·ä½“æ‰§è¡Œé€»è¾‘ä¸»è¦åŒ…æ‹¬æ‰§è¡Œä¸Šä¸‹æ–‡åˆ†ç»„ã€æ ¹æ®åˆ†ç»„å¹¶å‘æ‰§è¡Œã€æŸ¥è¯¢ç»“æœåˆå¹¶ï¼ˆåˆ†ç‰‡ç»“æœåˆå¹¶ã€åˆ†é¡µç»“æœåˆå¹¶ã€æ•°æ®è„±æ•ã€æ•°æ®åŠ å¯†ï¼‰</li></ul><h3 id="SQL-å®¡è®¡å¼•æ“"><a href="#SQL-å®¡è®¡å¼•æ“" class="headerlink" title="SQL å®¡è®¡å¼•æ“"></a>SQL å®¡è®¡å¼•æ“</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span>(access = AccessLevel.PRIVATE)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLAuditEngine</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(<span class="keyword">final</span> SQLStatementContext sqlStatementContext, <span class="keyword">final</span> List&lt;Object&gt; params,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">final</span> RuleMetaData globalRuleMetaData, <span class="keyword">final</span> ShardingSphereDatabase database, <span class="keyword">final</span> Grantee grantee, <span class="keyword">final</span> HintValueContext hintValueContext)</span> </span>&#123;</span><br><span class="line">        Collection&lt;ShardingSphereRule&gt; rules = <span class="keyword">new</span> LinkedList&lt;&gt;(globalRuleMetaData.getRules());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != database) &#123;</span><br><span class="line">            rules.addAll(database.getRuleMetaData().getRules());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¹æ®åˆ†ç‰‡è§„åˆ™è·å–å¯¹åº”çš„å®¡è®¡è§„åˆ™</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;ShardingSphereRule, SQLAuditor&gt; entry : OrderedSPILoader.getServices(SQLAuditor<span class="class">.<span class="keyword">class</span>, <span class="title">rules</span>).<span class="title">entrySet</span>()) </span>&#123;</span><br><span class="line">            entry.getValue().audit(sqlStatementContext, params, grantee, globalRuleMetaData, database, entry.getKey(), hintValueContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¡è®¡è§„åˆ™æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åŸºäº SPI è·å–è§„åˆ™å¯¹åº”çš„å®¡è®¡è§„åˆ™ï¼Œä¾‹å¦‚é»˜è®¤çš„åˆ†ç‰‡å®¡è®¡è§„åˆ™ä¸å…è®¸ SQL ä¸­æ²¡æœ‰åˆ†ç‰‡æ¡ä»¶ã€‚</p><h3 id="è·¯ç”±å¼•æ“"><a href="#è·¯ç”±å¼•æ“" class="headerlink" title="è·¯ç”±å¼•æ“"></a>è·¯ç”±å¼•æ“</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.infra.route.engine.impl.PartialSQLRouteExecutor#route</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteContext <span class="title">route</span><span class="params">(<span class="keyword">final</span> ConnectionContext connectionContext, <span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> RuleMetaData globalRuleMetaData, <span class="keyword">final</span> ShardingSphereDatabase database)</span> </span>&#123;</span><br><span class="line">    RouteContext result = <span class="keyword">new</span> RouteContext();</span><br><span class="line">    <span class="comment">// å¼ºåˆ¶è·¯ç”±åº“</span></span><br><span class="line">    Optional&lt;String&gt; dataSourceName = findDataSourceByHint(queryContext.getHintValueContext(), database.getResourceMetaData().getStorageUnits());</span><br><span class="line">    <span class="keyword">if</span> (dataSourceName.isPresent()) &#123;</span><br><span class="line">        result.getRouteUnits().add(<span class="keyword">new</span> RouteUnit(<span class="keyword">new</span> RouteMapper(dataSourceName.get(), dataSourceName.get()), Collections.emptyList()));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è£…é¥°å™¨è£…é¥°è·¯ç”±ä¸Šä¸‹æ–‡ï¼Œè¿™é‡Œçš„ routers æ ¹æ®é…ç½®çš„è§„åˆ™è€Œç¡®å®šï¼Œä¾‹å¦‚ shardingRuleï¼ŒreadWriteSplitRule éƒ½ä¼šæœ‰å¯¹åº”çš„ routers</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;ShardingSphereRule, SQLRouter&gt; entry : routers.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.getRouteUnits().isEmpty()) &#123;</span><br><span class="line">            result = entry.getValue().createRouteContext(queryContext, globalRuleMetaData, database, entry.getKey(), props, connectionContext);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            entry.getValue().decorateRouteContext(result, queryContext, database, entry.getKey(), props, connectionContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result.getRouteUnits().isEmpty() &amp;&amp; <span class="number">1</span> == database.getResourceMetaData().getStorageUnits().size()) &#123;</span><br><span class="line">        String singleDataSourceName = database.getResourceMetaData().getStorageUnits().keySet().iterator().next();</span><br><span class="line">        result.getRouteUnits().add(<span class="keyword">new</span> RouteUnit(<span class="keyword">new</span> RouteMapper(singleDataSourceName, singleDataSourceName), Collections.emptyList()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p><ul><li>å¦‚æœæ˜¯å¼ºåˆ¶è·¯ç”±æ•°æ®åº“ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li><li>æ ¹æ®è§„åˆ™è·å– SQLRouterï¼ŒSQLRouter ç”± SPI åŠ è½½ï¼Œå…¶ä¸­åŒ…æ‹¬å•è¡¨ã€åˆ†åº“åˆ†è¡¨ã€å¹¿æ’­ã€è¯»å†™åˆ†ç¦»å½±å­åº“ç­‰å¤šç§ SQLRouterã€‚</li><li>SQLRouter é‡‡ç”¨è£…é¥°å™¨æ¨¡å¼ï¼ŒSQLRouter ä¸­å®šä¹‰äº†ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„ SQLRouter åˆ›å»ºè·¯ç”±ä¸Šä¸‹æ–‡ï¼Œä¹‹åçš„ SQLRouter è´Ÿè´£è£…é¥°è·¯ç”±ä¸Šä¸‹æ–‡ã€‚</li></ul><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹åˆ†åº“åˆ†è¡¨å’Œè¯»å†™åˆ†ç¦»ï¼Œå…¶ä»–çš„æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œçœ‹çœ‹æºç ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹åˆ†åº“åˆ†è¡¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.engine.ShardingSQLRouter#createRouteContext0</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RouteContext <span class="title">createRouteContext0</span><span class="params">(<span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> RuleMetaData globalRuleMetaData, <span class="keyword">final</span> ShardingSphereDatabase database, <span class="keyword">final</span> ShardingRule rule,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">final</span> ConfigurationProperties props, <span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–æŸ¥è¯¢ä¸Šä¸‹æ–‡ä¸­çš„ sql è¯­å¥</span></span><br><span class="line">    SQLStatement sqlStatement = queryContext.getSqlStatementContext().getSqlStatement();</span><br><span class="line">    <span class="comment">// è§£æåˆ†ç‰‡æ¡ä»¶</span></span><br><span class="line">    ShardingConditions shardingConditions = createShardingConditions(queryContext, globalRuleMetaData, database, rule);</span><br><span class="line">    <span class="comment">// todo æ ¡éªŒ sql è¯­å¥</span></span><br><span class="line">    Optional&lt;ShardingStatementValidator&gt; validator = ShardingStatementValidatorFactory.newInstance(sqlStatement, shardingConditions, globalRuleMetaData);</span><br><span class="line">    validator.ifPresent(optional -&gt; optional.preValidate(rule, queryContext.getSqlStatementContext(), queryContext.getParameters(), database, props));</span><br><span class="line">    <span class="comment">// åŒ…å«å­æŸ¥è¯¢éœ€è¦åˆå¹¶åˆ†ç‰‡æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> DMLStatement &amp;&amp; shardingConditions.isNeedMerge()) &#123;</span><br><span class="line">        <span class="comment">// åˆå¹¶æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">        shardingConditions.merge();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®sqlè¯­å¥ç±»å‹ï¼Œè·¯ç”±è§„åˆ™ç­‰è·å–åˆ†ç‰‡å¼•æ“ï¼Œå¹¶åˆ†ç‰‡</span></span><br><span class="line">    RouteContext result = ShardingRouteEngineFactory.newInstance(rule, database, queryContext, shardingConditions, props, connectionContext, globalRuleMetaData)</span><br><span class="line">            .route(rule);</span><br><span class="line">    <span class="comment">// todo åç½®æ ¡éªŒ</span></span><br><span class="line">    validator.ifPresent(optional -&gt; optional.postValidate(rule, queryContext.getSqlStatementContext(), queryContext.getHintValueContext(), queryContext.getParameters(), database, props, result));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯ ShardingSQLRouter åˆ›å»ºè·¯ç”±ä¸Šä¸‹æ–‡çš„é€»è¾‘ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>æ ¹æ®åˆ†ç‰‡è§„åˆ™è§£æåˆ†è¡¨æ¡ä»¶ï¼ŒåŒ…æ‹¬åˆ†ç‰‡è¡¨ã€åˆ†ç‰‡å­—æ®µã€å­—æ®µå€¼ã€‚</li><li>SQL è¯­å¥æ ¡éªŒã€‚</li><li>æ ¹æ®åˆ†ç‰‡è§„åˆ™åˆ›å»ºå¯¹åº”çš„åˆ†ç‰‡è·¯ç”±å¼•æ“ï¼Œå¹¶åˆ›å»ºè·¯ç”±ä¸Šä¸‹æ–‡ã€‚</li></ul><p>ä¸‹é¢çœ‹çœ‹æœ€ç®€å•çš„åˆ†ç‰‡è§„åˆ™è·¯ç”±å¼•æ“ (ShardingStandardRoutingEngine) æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.engine.type.standard.ShardingStandardRoutingEngine#route</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteContext <span class="title">route</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule)</span> </span>&#123;</span><br><span class="line">    RouteContext result = <span class="keyword">new</span> RouteContext();</span><br><span class="line">    <span class="comment">// â˜†â˜†â˜†â˜†æ ¸å¿ƒâ˜†â˜†â˜†â˜† æ ¹æ®è§„åˆ™ï¼Œè·å–æ•°æ®èŠ‚ç‚¹</span></span><br><span class="line">    Collection&lt;DataNode&gt; dataNodes = getDataNodes(shardingRule, shardingRule.getShardingTable(logicTableName));</span><br><span class="line">    result.getOriginalDataNodes().addAll(originalDataNodes);</span><br><span class="line">    <span class="keyword">for</span> (DataNode each : dataNodes) &#123;</span><br><span class="line">        <span class="comment">// ä»¥è·¯ç”±å•ä½è¿›è¡Œå°è£…ï¼Œå°è£…é€»è¾‘åº“ä¸å®é™…åº“æ˜ å°„ï¼Œé€»è¾‘è¡¨ä¸å®é™…è¡¨æ˜ å°„</span></span><br><span class="line">        result.getRouteUnits().add(</span><br><span class="line">                <span class="keyword">new</span> RouteUnit(<span class="keyword">new</span> RouteMapper(each.getDataSourceName(), each.getDataSourceName()), Collections.singleton(<span class="keyword">new</span> RouteMapper(logicTableName, each.getTableName()))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.engine.type.standard.ShardingStandardRoutingEngine#getDataNodes</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">getDataNodes</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> ShardingTable shardingTable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®è§„åˆ™è·å–æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥</span></span><br><span class="line">    ShardingStrategy databaseShardingStrategy = createShardingStrategy(shardingRule.getDatabaseShardingStrategyConfiguration(shardingTable),</span><br><span class="line">            shardingRule.getShardingAlgorithms(), shardingRule.getDefaultShardingColumn());</span><br><span class="line">    <span class="comment">// æ ¹æ®è§„åˆ™è·å–è¡¨åˆ†ç‰‡ç­–ç•¥</span></span><br><span class="line">    ShardingStrategy tableShardingStrategy = createShardingStrategy(shardingRule.getTableShardingStrategyConfiguration(shardingTable),</span><br><span class="line">            shardingRule.getShardingAlgorithms(), shardingRule.getDefaultShardingColumn());</span><br><span class="line">    <span class="comment">// å¼ºåˆ¶è·¯ç”±</span></span><br><span class="line">    <span class="keyword">if</span> (isRoutingByHint(shardingRule, shardingTable)) &#123;</span><br><span class="line">        <span class="keyword">return</span> routeByHint(shardingTable, databaseShardingStrategy, tableShardingStrategy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¡ä»¶è·¯ç”±</span></span><br><span class="line">    <span class="keyword">if</span> (isRoutingByShardingConditions(shardingRule, shardingTable)) &#123;</span><br><span class="line">        <span class="keyword">return</span> routeByShardingConditions(shardingRule, shardingTable, databaseShardingStrategy, tableShardingStrategy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ··åˆå¼ºåˆ¶è·¯ç”±å’Œæ¡ä»¶è·¯ç”±ï¼Œåº“å’Œè¡¨åˆ†ç‰‡å…¶ä¸­ä¸€ä¸ªæ˜¯å¼ºåˆ¶è·¯ç”±</span></span><br><span class="line">    <span class="keyword">return</span> routeByMixedConditions(shardingRule, shardingTable, databaseShardingStrategy, tableShardingStrategy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.engine.type.standard.ShardingStandardRoutingEngine#routeByShardingConditionsWithCondition</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">routeByShardingConditionsWithCondition</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> ShardingTable shardingTable,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                        <span class="keyword">final</span> ShardingStrategy databaseShardingStrategy, <span class="keyword">final</span> ShardingStrategy tableShardingStrategy)</span> </span>&#123;</span><br><span class="line">    Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// æ ¹æ®åˆ†ç‰‡æ¡ä»¶è·¯ç”±ï¼Œè·å–æ•°æ®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (ShardingCondition each : shardingConditions.getConditions()) &#123;</span><br><span class="line">        Collection&lt;DataNode&gt; dataNodes = route0(shardingTable,</span><br><span class="line">                databaseShardingStrategy, getShardingValuesFromShardingConditions(shardingRule, databaseShardingStrategy.getShardingColumns(), each),</span><br><span class="line">                tableShardingStrategy, getShardingValuesFromShardingConditions(shardingRule, tableShardingStrategy.getShardingColumns(), each));</span><br><span class="line">        result.addAll(dataNodes);</span><br><span class="line">        originalDataNodes.add(dataNodes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.engine.type.standard.ShardingStandardRoutingEngine#route0</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;DataNode&gt; <span class="title">route0</span><span class="params">(<span class="keyword">final</span> ShardingTable shardingTable,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">final</span> ShardingStrategy databaseShardingStrategy, <span class="keyword">final</span> List&lt;ShardingConditionValue&gt; databaseShardingValues,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">final</span> ShardingStrategy tableShardingStrategy, <span class="keyword">final</span> List&lt;ShardingConditionValue&gt; tableShardingValues)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·¯ç”±åˆ°å¯¹åº”æ•°æ®åº“</span></span><br><span class="line">    Collection&lt;String&gt; routedDataSources = routeDataSources(shardingTable, databaseShardingStrategy, databaseShardingValues);</span><br><span class="line">    Collection&lt;DataNode&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// è·¯ç”±åˆ°å¯¹åº”è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (String each : routedDataSources) &#123;</span><br><span class="line">        result.addAll(routeTables(shardingTable, each, tableShardingStrategy, tableShardingValues));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.strategy.type.standard.StandardShardingStrategy#doSharding</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> Collection&lt;ShardingConditionValue&gt; shardingConditionValues,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">final</span> DataNodeInfo dataNodeInfo, <span class="keyword">final</span> ConfigurationProperties props)</span> </span>&#123;</span><br><span class="line">    ShardingConditionValue shardingConditionValue = shardingConditionValues.iterator().next();</span><br><span class="line">    <span class="comment">// æ ¹æ®åˆ†ç‰‡åˆ—æ˜¯ç²¾ç¡®æŸ¥è¯¢è¿˜æ˜¯èŒƒå›´æŸ¥è¯¢è°ƒç”¨å¯¹åº”çš„å¤„ç†æ–¹æ³•</span></span><br><span class="line">    Collection&lt;String&gt; shardingResult = shardingConditionValue <span class="keyword">instanceof</span> ListShardingConditionValue</span><br><span class="line">            ? doSharding(availableTargetNames, (ListShardingConditionValue) shardingConditionValue, dataNodeInfo)</span><br><span class="line">            : doSharding(availableTargetNames, (RangeShardingConditionValue) shardingConditionValue, dataNodeInfo);</span><br><span class="line">    Collection&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">    result.addAll(shardingResult);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.route.strategy.type.standard.StandardShardingStrategy#doSharding</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(<span class="keyword">final</span> Collection&lt;String&gt; availableTargetNames, <span class="keyword">final</span> ListShardingConditionValue&lt;?&gt; shardingValue, <span class="keyword">final</span> DataNodeInfo dataNodeInfo)</span> </span>&#123;</span><br><span class="line">    Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Object each : shardingValue.getValues()) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œå°±æ˜¯æˆ‘ä»¬æŒ‡å®šçš„æˆ–è€…è‡ªå®šä¹‰çš„åˆ†ç‰‡ç®—æ³•</span></span><br><span class="line">        String target = shardingAlgorithm.doSharding(availableTargetNames,</span><br><span class="line">                <span class="keyword">new</span> PreciseShardingValue(shardingValue.getTableName(), shardingValue.getColumnName(), dataNodeInfo, each));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != target &amp;&amp; availableTargetNames.contains(target)) &#123;</span><br><span class="line">            result.add(target);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> != target &amp;&amp; !availableTargetNames.contains(target)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ShardingRouteAlgorithmException(target, availableTargetNames);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç®€å•åˆ†æä¸€ä¸‹ï¼Œä¸Šè¿°ä»£ç æ˜¯ä»¥åˆ†ç‰‡æ¡ä»¶è¿›è¡Œè·¯ç”±ï¼š</p><ul><li>è·¯ç”±ä¸Šä¸‹æ–‡ä¸»è¦æ˜¯ç”±ä¸€ç»„è·¯ç”±å•å…ƒç»„æˆï¼Œè·¯ç”±å•å…ƒä¸­ä¸»è¦åŒ…æ‹¬åº“æ˜ å°„å’Œè¡¨æ˜ å°„ã€‚</li><li>è·¯ç”±ä¸»è¦åŒ…æ‹¬åº“è·¯ç”±å’Œè¡¨è·¯ç”±ï¼Œå…¶ä¸­åŒ…æ‹¬å¼ºåˆ¶è·¯ç”±ã€åˆ†ç‰‡è·¯ç”±ã€æ··åˆå¼ºåˆ¶è·¯ç”±ï¼ˆåº“å¼ºåˆ¶æ ‡æ¡ä»¶æˆ–è€…åº“æ¡ä»¶è¡¨å¼ºåˆ¶ï¼‰ã€‚</li><li>è·¯ç”±çš„å¯ç”¨æ•°æ®èŠ‚ç‚¹ (DataNodes) æ˜¯æ ¹æ®è¡¨åˆ†ç‰‡è§„åˆ™çš„ AcutalDataNode è§£æçš„ã€‚</li><li>æ ¹æ®æˆ‘ä»¬åˆ†ç‰‡è§„åˆ™æŒ‡å®šçš„åˆ†ç‰‡ç®—æ³•è¿›è¡Œè·¯ç”±ï¼Œè·¯ç”±ä¸»è¦åŒ…æ‹¬ç­‰å€¼æ¡ä»¶è·¯ç”±å’ŒèŒƒå›´æ¡ä»¶è·¯ç”±ã€‚</li><li>å¦‚æœ SQL æ²¡æœ‰åˆ†ç‰‡æ¡ä»¶ï¼Œåˆ™è¿›è¡Œå…¨åº“è¡¨è·¯ç”±ã€‚</li></ul><p>æ¥ä¸‹æ¥çœ‹çœ‹è¯»å†™åˆ†ç¦»çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.readwritesplitting.route.ReadwriteSplittingSQLRouter#createRouteContext</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteContext <span class="title">createRouteContext</span><span class="params">(<span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> RuleMetaData globalRuleMetaData,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">final</span> ShardingSphereDatabase database, <span class="keyword">final</span> ReadwriteSplittingRule rule, <span class="keyword">final</span> ConfigurationProperties props, <span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ReadwriteSplittingSQLRouteråœ¨æ‰€æœ‰SQLRouterä¸­æ’æœ€åä¸€ä½ï¼Œå¦‚æœæ˜¯åˆ›å»ºè·¯ç”±ä¸Šä¸‹æ–‡åˆ™è¯´æ˜å½“å‰SQLæœªåŒ¹é…å…¶ä»–è·¯ç”±æ¡ä»¶</span></span><br><span class="line">    RouteContext result = <span class="keyword">new</span> RouteContext();</span><br><span class="line">    ReadwriteSplittingDataSourceRule singleDataSourceRule = rule.getSingleDataSourceRule();</span><br><span class="line">    <span class="comment">// ç›´æ¥ä½¿ç”¨ReadwriteSplittingDataSourceRouteræ¥è¿›è¡Œè·¯ç”±</span></span><br><span class="line">    String dataSourceName = <span class="keyword">new</span> ReadwriteSplittingDataSourceRouter(singleDataSourceRule, connectionContext).route(queryContext.getSqlStatementContext(), queryContext.getHintValueContext());</span><br><span class="line">    result.getRouteUnits().add(<span class="keyword">new</span> RouteUnit(<span class="keyword">new</span> RouteMapper(singleDataSourceRule.getName(), dataSourceName), Collections.emptyList()));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.readwritesplitting.route.ReadwriteSplittingSQLRouter#decorateRouteContext</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decorateRouteContext</span><span class="params">(<span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> ShardingSphereDatabase database,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">final</span> ReadwriteSplittingRule rule, <span class="keyword">final</span> ConfigurationProperties props, <span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    Collection&lt;RouteUnit&gt; toBeRemoved = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    Collection&lt;RouteUnit&gt; toBeAdded = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (RouteUnit each : routeContext.getRouteUnits()) &#123;</span><br><span class="line">        <span class="comment">// è·å–é€»è¾‘åº“å¯¹åº”çš„è¯»å†™åˆ†ç¦»è§„åˆ™ï¼Œå¦‚æœé€»è¾‘åº“å­˜åœ¨å¯¹åº”è§„åˆ™ï¼Œå¹¶ä¸”è·¯ç”±å•å…ƒçš„å®é™…åº“ç­‰äºè¯»å†™åˆ†ç¦»è§„åˆ™å</span></span><br><span class="line">        String dataSourceName = each.getDataSourceMapper().getLogicName();</span><br><span class="line">        Optional&lt;ReadwriteSplittingDataSourceRule&gt; dataSourceRule = rule.findDataSourceRule(dataSourceName);</span><br><span class="line">        <span class="keyword">if</span> (dataSourceRule.isPresent() &amp;&amp; dataSourceRule.get().getName().equalsIgnoreCase(each.getDataSourceMapper().getActualName())) &#123;</span><br><span class="line">            toBeRemoved.add(each);</span><br><span class="line">            <span class="comment">// é‡æ–°æ„å»ºè·¯ç”±å•å…ƒ</span></span><br><span class="line">            String actualDataSourceName = <span class="keyword">new</span> ReadwriteSplittingDataSourceRouter(dataSourceRule.get(), connectionContext).route(queryContext.getSqlStatementContext(),</span><br><span class="line">                    queryContext.getHintValueContext());</span><br><span class="line">            toBeAdded.add(<span class="keyword">new</span> RouteUnit(<span class="keyword">new</span> RouteMapper(each.getDataSourceMapper().getLogicName(), actualDataSourceName), each.getTableMappers()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    routeContext.getRouteUnits().removeAll(toBeRemoved);</span><br><span class="line">    routeContext.getRouteUnits().addAll(toBeAdded);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.readwritesplitting.route.ReadwriteSplittingDataSourceRouter#route</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">route</span><span class="params">(<span class="keyword">final</span> SQLStatementContext sqlStatementContext, <span class="keyword">final</span> HintValueContext hintValueContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (QualifiedReadwriteSplittingDataSourceRouter each : getQualifiedRouters(connectionContext)) &#123;</span><br><span class="line">        <span class="comment">// 1ã€å†™æ“ä½œã€ä¸Šé”ã€å¼ºåˆ¶å†™ 2ã€äº‹åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (each.isQualified(sqlStatementContext, rule, hintValueContext)) &#123;</span><br><span class="line">            <span class="keyword">return</span> each.route(rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è´Ÿè½½å‡è¡¡åˆ°ä»åº“ï¼ˆè¿‡æ»¤ç¦ç”¨ä»åº“ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StandardReadwriteSplittingDataSourceRouter().route(rule);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.readwritesplitting.route.ReadwriteSplittingDataSourceRouter#getQualifiedRouters</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;QualifiedReadwriteSplittingDataSourceRouter&gt; <span class="title">getQualifiedRouters</span><span class="params">(<span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1ã€QualifiedReadwriteSplittingPrimaryDataSourceRouter å†™æ“ä½œã€ä¸Šé”ã€å¼ºåˆ¶è·¯ç”±è·¯ç”±ä¸»åº“</span></span><br><span class="line">    <span class="comment">// 2ã€QualifiedReadwriteSplittingTransactionalDataSourceRouter äº‹åŠ¡é»˜è®¤è·¯ç”±ä¸»åº“ï¼ŒFIXEDã€DYNAMICç­–ç•¥è¯»ä»åº“(è¿‡æ»¤ç¦ç”¨çš„ä»åº“)</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> QualifiedReadwriteSplittingPrimaryDataSourceRouter(), <span class="keyword">new</span> QualifiedReadwriteSplittingTransactionalDataSourceRouter(connectionContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¯»å†™åˆ†ç¦»è·¯ç”±å™¨ä¸»è¦åˆ†ä¸ºåˆ›å»ºè·¯ç”±å•å…ƒå’Œè£…é¥°è·¯ç”±å•å…ƒ</li><li>ç”±äºè¯»å†™åˆ†ç¦»è·¯ç”±å™¨åœ¨æ‰€æœ‰è·¯ç”±å™¨ä¸­æ’åœ¨æœ€åä¸€ä½ï¼Œå¦‚æœæ˜¯åˆ›å»ºè·¯ç”±å•å…ƒè¯´æ˜å…¶ä»–è·¯ç”±è§„åˆ™éƒ½æ²¡æœ‰åŒ¹é…åˆ°ï¼Œæ­¤æ—¶ç›´æ¥ä½¿ç”¨ ReadwriteSplittingDataSourceRouter è¿›è¡Œè·¯ç”±</li><li>å¦‚æœæ˜¯è£…é¥°è·¯ç”±ä¸Šä¸‹æ–‡ï¼Œåˆ™éå†è·¯ç”±å•å…ƒï¼Œå¦‚æœåŒ¹é…ä¸Šè¯»å†™åˆ†ç¦»è§„åˆ™åˆ™é‡æ–°ä½¿ç”¨ ReadwriteSplittingDataSourceRouter è¿›è¡Œè·¯ç”±åè¦†ç›–åŸæœ¬çš„è·¯ç”±å•å…ƒ</li><li>ReadwriteSplittingDataSourceRouter ä¸»è¦æ˜¯æ ¹æ®ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶åˆ¤æ–­æ˜¯å¦è¯»ä¸»åº“<ul><li>å†™æ“ä½œã€ä¸Šé”ã€å¼ºåˆ¶è·¯ç”±è·¯ç”±ä¸»åº“</li><li>äº‹åŠ¡é»˜è®¤è·¯ç”±ä¸»åº“ï¼ŒFIXEDã€DYNAMICç­–ç•¥è¯»ä»åº“(è¿‡æ»¤ç¦ç”¨çš„ä»åº“)</li><li>å…¶ä»–æƒ…å†µéƒ½æ˜¯è´Ÿè½½å‡è¡¡åˆ°ä»åº“ï¼ˆå…·ä½“è´Ÿè½½å‡è¡¡è§„åˆ™æ˜¯æˆ‘ä»¬è‡ªå·±æŒ‡å®šçš„ï¼‰</li></ul></li></ul><h3 id="æ”¹å†™å¼•æ“"><a href="#æ”¹å†™å¼•æ“" class="headerlink" title="æ”¹å†™å¼•æ“"></a>æ”¹å†™å¼•æ“</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.infra.rewrite.SQLRewriteEntry#rewrite</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SQLRewriteResult <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// â˜†â˜†â˜†â˜†æ ¸å¿ƒâ˜†â˜†â˜†â˜† åˆ›å»ºsqlæ”¹å†™ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬sqlTokençš„ç”Ÿæˆ</span></span><br><span class="line">    SQLRewriteContext sqlRewriteContext = createSQLRewriteContext(queryContext, routeContext, connectionContext);</span><br><span class="line">    SQLTranslatorRule rule = globalRuleMetaData.getSingleRule(SQLTranslatorRule<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// æ”¹å†™ï¼Œæ ¹æ®æ˜¯å¦æœ‰è·¯ç”±å•å…ƒé€‰æ‹©å¯¹åº”çš„æ”¹å†™å¼•æ“</span></span><br><span class="line">    <span class="keyword">return</span> routeContext.getRouteUnits().isEmpty()</span><br><span class="line">            ? <span class="keyword">new</span> GenericSQLRewriteEngine(rule, database, globalRuleMetaData).rewrite(sqlRewriteContext, queryContext)</span><br><span class="line">            : <span class="keyword">new</span> RouteSQLRewriteEngine(rule, database, globalRuleMetaData).rewrite(sqlRewriteContext, routeContext, queryContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SQL æ”¹å†™ä¸»è¦æœ‰ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ol><li>SQL æ”¹å†™ä¸Šä¸‹æ–‡çš„åˆ›å»ºï¼ŒåŒ…æ‹¬ sqlToken çš„ç”Ÿæˆï¼ŒsqlToken ä¸»è¦ç”¨äºæ”¹å†™ SQLã€‚</li><li>æ ¹æ®è·¯ç”±ä¸Šä¸‹æ–‡å’Œ SQL æ”¹å†™ä¸Šä¸‹æ–‡è¿›è¡Œæ”¹å†™ã€‚</li></ol><p>æ¥ä¸‹æ¥å…ˆçœ‹ä¸€ä¸‹ SQL æ”¹å†™ä¸Šä¸‹æ–‡çš„åˆ›å»ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.infra.rewrite.SQLRewriteEntry#createSQLRewriteContext</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLRewriteContext <span class="title">createSQLRewriteContext</span><span class="params">(<span class="keyword">final</span> QueryContext queryContext, <span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> ConnectionContext connectionContext)</span> </span>&#123;</span><br><span class="line">    HintValueContext hintValueContext = queryContext.getHintValueContext();</span><br><span class="line">    SQLRewriteContext result = <span class="keyword">new</span> SQLRewriteContext(database, queryContext.getSqlStatementContext(), queryContext.getSql(), queryContext.getParameters(), connectionContext, hintValueContext);</span><br><span class="line">    <span class="comment">// è£…é¥°sqlæ”¹å†™ä¸Šä¸‹æ–‡</span></span><br><span class="line">    decorate(decorators, result, routeContext, hintValueContext);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆ sqlTokenï¼ŒsqlToken ä¸»è¦æ˜¯é’ˆå¯¹sqlè¯­å¥çš„å„ä¸ªåˆ†æ®µè¿›è¡Œæ”¹å†™ï¼Œä¾‹å¦‚è¡¨åã€å­—æ®µã€å­—æ®µå€¼ç­‰ç­‰</span></span><br><span class="line">    result.generateSQLTokens();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.rewrite.SQLRewriteEntry#decorate</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decorate</span><span class="params">(<span class="keyword">final</span> Map&lt;ShardingSphereRule, SQLRewriteContextDecorator&gt; decorators, <span class="keyword">final</span> SQLRewriteContext sqlRewriteContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> HintValueContext hintValueContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¼ºåˆ¶è·¯ç”±å¯ä»¥ç»•è¿‡æ”¹å†™</span></span><br><span class="line">    <span class="keyword">if</span> (hintValueContext.isSkipSQLRewrite()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;ShardingSphereRule, SQLRewriteContextDecorator&gt; entry : decorators.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// â˜†â˜†â˜†â˜†æ ¸å¿ƒâ˜†â˜†â˜†â˜† åŸºäºè£…é¥°å™¨æ‰©å±•ç‚¹ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›è‡ªå·±éœ€è¦çš„sqlTokenï¼Œç”¨äºæ‰©å±•æ”¹å†™sql</span></span><br><span class="line">        entry.getValue().decorate(entry.getKey(), props, sqlRewriteContext, routeContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.rewrite.context.ShardingSQLRewriteContextDecorator#decorate</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decorate</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> ConfigurationProperties props, <span class="keyword">final</span> SQLRewriteContext sqlRewriteContext, <span class="keyword">final</span> RouteContext routeContext)</span> </span>&#123;</span><br><span class="line">    SQLStatementContext sqlStatementContext = sqlRewriteContext.getSqlStatementContext();</span><br><span class="line">    <span class="keyword">if</span> (sqlStatementContext <span class="keyword">instanceof</span> InsertStatementContext &amp;&amp; !containsShardingTable(shardingRule, sqlStatementContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!sqlRewriteContext.getParameters().isEmpty()) &#123;</span><br><span class="line">        Collection&lt;ParameterRewriter&gt; parameterRewriters =</span><br><span class="line">                <span class="keyword">new</span> ShardingParameterRewriterBuilder(shardingRule, routeContext, sqlRewriteContext.getDatabase().getSchemas(), sqlStatementContext).getParameterRewriters();</span><br><span class="line">        rewriteParameters(sqlRewriteContext, parameterRewriters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ·»åŠ sqlTokenæ„å»ºå™¨</span></span><br><span class="line">    sqlRewriteContext.addSQLTokenGenerators(<span class="keyword">new</span> ShardingTokenGenerateBuilder(shardingRule, routeContext, sqlStatementContext).getSQLTokenGenerators());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.rewrite.token.ShardingTokenGenerateBuilder#getSQLTokenGenerators</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;SQLTokenGenerator&gt; <span class="title">getSQLTokenGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Collection&lt;SQLTokenGenerator&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> TableTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> DistinctProjectionPrefixTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> ProjectionsTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> OrderByTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> AggregationDistinctTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> IndexTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> ConstraintTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> OffsetTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> RowCountTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> GeneratedKeyInsertColumnTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> GeneratedKeyForUseDefaultInsertColumnsTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> GeneratedKeyAssignmentTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> ShardingInsertValuesTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> GeneratedKeyInsertValuesTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> ShardingRemoveTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> CursorTokenGenerator());</span><br><span class="line">    addSQLTokenGenerator(result, <span class="keyword">new</span> FetchDirectionTokenGenerator());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.rewrite.token.generator.impl.TableTokenGenerator#generateSQLTokens</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;SQLToken&gt; <span class="title">generateSQLTokens</span><span class="params">(<span class="keyword">final</span> TableAvailable sqlStatementContext)</span> </span>&#123;</span><br><span class="line">    Collection&lt;SQLToken&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SimpleTableSegment each : sqlStatementContext.getAllTables()) &#123;</span><br><span class="line">        TableNameSegment tableName = each.getTableName();</span><br><span class="line">        <span class="keyword">if</span> (shardingRule.findShardingTable(tableName.getIdentifier().getValue()).isPresent()) &#123;</span><br><span class="line">            result.add(<span class="keyword">new</span> TableToken(tableName.getStartIndex(), tableName.getStopIndex(), tableName.getIdentifier(), (SQLStatementContext) sqlStatementContext, shardingRule));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SQL æ”¹å†™ä¸Šä¸‹æ–‡çš„åˆ›å»ºæœ€ä¸»è¦å°±æ˜¯åˆ›å»º sqlTokenï¼Œå…¶ä¸­å¯ä»¥åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li><p>æ ¹æ®è§„åˆ™è·å– SQL æ”¹å†™ä¸Šä¸‹æ–‡è£…é¥°å™¨ï¼Œä¸»è¦åŒ…æ‹¬åˆ†ç‰‡è§„åˆ™å’Œæ•°æ®åŠ å¯†è£…é¥°å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decorators = OrderedSPILoader.getServices(SQLRewriteContextDecorator<span class="class">.<span class="keyword">class</span>, <span class="title">database</span>.<span class="title">getRuleMetaData</span>().<span class="title">getRules</span>())</span>;</span><br></pre></td></tr></table></figure></li><li><p>è£…é¥°å™¨ä¸»è¦ä½œç”¨å°±æ˜¯æ·»åŠ  sqlToken æ„å»ºå™¨ã€‚</p></li><li><p>ç»Ÿä¸€ç”Ÿæˆ sqlTokenï¼ŒsqlToken ä¸»è¦æ˜¯é’ˆå¯¹ SQL è¯­å¥çš„å„ä¸ªåˆ†æ®µè¿›è¡Œæ”¹å†™ï¼Œä¾‹å¦‚è¡¨åã€å­—æ®µã€å­—æ®µå€¼ç­‰ç­‰ã€‚ä»¥ TableToken ä¸ºä¾‹ï¼ŒTableToken ä» SQL è§£æå‡ºæ¥çš„ TableStatement ä¸­è·å–åˆ°è¡¨åçš„èµ·å§‹ç»“æŸä½ç½®ï¼Œæ”¹å†™æ—¶å°±æ˜¯åˆ©ç”¨å­—ç¬¦ä¸²æˆªå–æ›¿æ¢èµ·å§‹ç»“æŸä½ç½®ä¹‹é—´çš„å­—ç¬¦ä¸²ã€‚</p></li></ol><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„æ”¹å†™é€»è¾‘å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// org.apache.shardingsphere.infra.rewrite.engine.RouteSQLRewriteEngine#rewrite</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> RouteSQLRewriteResult <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> SQLRewriteContext sqlRewriteContext, <span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> QueryContext queryContext)</span> </span>&#123;</span><br><span class="line">    Map&lt;RouteUnit, SQLRewriteUnit&gt; sqlRewriteUnits = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(routeContext.getRouteUnits().size(), <span class="number">1F</span>);</span><br><span class="line">    <span class="comment">// æ ¹æ®æ•°æ®åº“åˆ†ç»„</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, Collection&lt;RouteUnit&gt;&gt; entry : aggregateRouteUnitGroups(routeContext.getRouteUnits()).entrySet()) &#123;</span><br><span class="line">        Collection&lt;RouteUnit&gt; routeUnits = entry.getValue();</span><br><span class="line">        <span class="comment">// åŒä¸€ä¸ªåº“çš„æŸ¥è¯¢è¯­å¥ï¼Œä¸”ä¸åŒ…å«å­æŸ¥è¯¢ã€å…³è”æŸ¥è¯¢ã€æ’åºã€åˆ†é¡µã€é”</span></span><br><span class="line">        <span class="keyword">if</span> (isNeedAggregateRewrite(sqlRewriteContext.getSqlStatementContext(), routeUnits)) &#123;</span><br><span class="line">            <span class="comment">// ç”¨ union all è¿æ¥ sql</span></span><br><span class="line">            sqlRewriteUnits.put(routeUnits.iterator().next(), createSQLRewriteUnit(sqlRewriteContext, routeContext, routeUnits));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ”¹å†™sqlåå°è£…æˆsqlæ”¹å†™å•å…ƒ</span></span><br><span class="line">            addSQLRewriteUnits(sqlRewriteUnits, sqlRewriteContext, routeContext, routeUnits);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¿»è¯‘SQLï¼Œå®˜æ–¹æš‚æœªæä¾›å®ç°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RouteSQLRewriteResult(translate(queryContext, sqlRewriteUnits));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.rewrite.engine.RouteSQLRewriteEngine#createSQLRewriteUnit</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLRewriteUnit <span class="title">createSQLRewriteUnit</span><span class="params">(<span class="keyword">final</span> SQLRewriteContext sqlRewriteContext, <span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> Collection&lt;RouteUnit&gt; routeUnits)</span> </span>&#123;</span><br><span class="line">    Collection&lt;String&gt; sql = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    List&lt;Object&gt; params = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// å‚æ•°æ˜¯å¦æ˜¯$å¼€å¤´</span></span><br><span class="line">    <span class="keyword">boolean</span> containsDollarMarker = sqlRewriteContext.getSqlStatementContext() <span class="keyword">instanceof</span> SelectStatementContext</span><br><span class="line">            &amp;&amp; ((SelectStatementContext) (sqlRewriteContext.getSqlStatementContext())).isContainsDollarParameterMarker();</span><br><span class="line">    <span class="keyword">for</span> (RouteUnit each : routeUnits) &#123;</span><br><span class="line">        <span class="comment">// ç§»é™¤sqlä¸­çš„;å·</span></span><br><span class="line">        sql.add(SQLUtils.trimSemicolon(<span class="keyword">new</span> RouteSQLBuilder(sqlRewriteContext, each).toSQL()));</span><br><span class="line">        <span class="keyword">if</span> (containsDollarMarker &amp;&amp; !params.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        params.addAll(getParameters(sqlRewriteContext.getParameterBuilder(), routeContext, each));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”¨ union all è¿æ¥ sql</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SQLRewriteUnit(String.join(<span class="string">" UNION ALL "</span>, sql), params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.rewrite.engine.RouteSQLRewriteEngine#addSQLRewriteUnits</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addSQLRewriteUnits</span><span class="params">(<span class="keyword">final</span> Map&lt;RouteUnit, SQLRewriteUnit&gt; sqlRewriteUnits, <span class="keyword">final</span> SQLRewriteContext sqlRewriteContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> Collection&lt;RouteUnit&gt; routeUnits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (RouteUnit each : routeUnits) &#123;</span><br><span class="line">        <span class="comment">// â˜†â˜†â˜†â˜†æ ¸å¿ƒâ˜†â˜†â˜†â˜† RouteSQLBuilder.toSQL() æ”¹å†™sql</span></span><br><span class="line">        sqlRewriteUnits.put(each, <span class="keyword">new</span> SQLRewriteUnit(<span class="keyword">new</span> RouteSQLBuilder(sqlRewriteContext, each).toSQL(), getParameters(sqlRewriteContext.getParameterBuilder(), routeContext, each)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.rewrite.sql.impl.AbstractSQLBuilder#toSQL</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toSQL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.getSqlTokens().isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> context.getSql();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®sqlTokençš„startIndexè¿›è¡Œæ’åº</span></span><br><span class="line">    Collections.sort(context.getSqlTokens());</span><br><span class="line">    <span class="comment">// éå†sqlTokenæ›¿æ¢å’Œç»„è£…sqlå­—ç¬¦ä¸²</span></span><br><span class="line">    StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    result.append(context.getSql(), <span class="number">0</span>, context.getSqlTokens().get(<span class="number">0</span>).getStartIndex());</span><br><span class="line">    <span class="keyword">for</span> (SQLToken each : context.getSqlTokens()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (each <span class="keyword">instanceof</span> ComposableSQLToken) &#123;</span><br><span class="line">            result.append(getComposableSQLTokenText((ComposableSQLToken) each));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> SubstitutableColumnNameToken) &#123;</span><br><span class="line">            result.append(((SubstitutableColumnNameToken) each).toString(routeUnit));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// sqlTokenæœ¬èº«æ˜¯åŒ…å«æŠ½è±¡è¯­æ³•æ ‘è¯­æ³•èŠ‚ç‚¹çš„æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿›è¡Œç»„è£…</span></span><br><span class="line">            result.append(getSQLTokenText(each));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç»„è£…sqlTokenä¹‹é—´çš„è¿æ¥ç¬¦</span></span><br><span class="line">        result.append(getConjunctionText(each));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„æ”¹å†™é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨ sqlToken ç»„è£… SQLï¼Œå› ä¸º sqlToken æœ¬èº«åœ¨ç”Ÿæˆæ—¶å°±åŒ…å«è¯­æ³•æ ‘çš„èŠ‚ç‚¹æ•°æ®ï¼Œæ‰€ä»¥åªéœ€è¦æ ¹æ®è§„åˆ™è¿›è¡Œå¤„ç†å³å¯ï¼Œä¾‹å¦‚åˆ†åº“åˆ†è¡¨ã€æ•°æ®åŠ å¯†ã€‚</p><h3 id="åˆå¹¶å¼•æ“"><a href="#åˆå¹¶å¼•æ“" class="headerlink" title="åˆå¹¶å¼•æ“"></a>åˆå¹¶å¼•æ“</h3><p>åœ¨è®²åˆå¹¶å¼•æ“ä¹‹å‰ï¼Œå…ˆç®€å•çœ‹ä¸€ä¸‹å…·ä½“æ‰§è¡ŒæŸ¥è¯¢çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement#executeQuery0</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;QueryResult&gt; <span class="title">executeQuery0</span><span class="params">(<span class="keyword">final</span> ExecutionContext executionContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// æŒ‰æ¯ä¸ªæ•°æ®æºçš„è¿æ¥æ•°åˆ†ç»„ï¼Œä¸€ä¸ªè¿æ¥ä¸‹å¯ä»¥åŒ…å«ä¸€ä¸ªæ•°æ®æºä¸‹çš„å¤šä¸ªsql</span></span><br><span class="line">    ExecutionGroupContext&lt;JDBCExecutionUnit&gt; executionGroupContext = createExecutionGroupContext(executionContext);</span><br><span class="line">    <span class="keyword">return</span> executor.getRegularExecutor().executeQuery(executionGroupContext, executionContext.getQueryContext(),</span><br><span class="line">            <span class="keyword">new</span> PreparedStatementExecuteQueryCallback(metaDataContexts.getMetaData().getDatabase(databaseName).getProtocolType(),</span><br><span class="line">                    metaDataContexts.getMetaData().getDatabase(databaseName).getResourceMetaData(), sqlStatement,</span><br><span class="line">                    SQLExecutorExceptionHandler.isExceptionThrown()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.executor.sql.prepare.AbstractExecutionPrepareEngine#prepare</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ExecutionGroupContext&lt;T&gt; <span class="title">prepare</span><span class="params">(<span class="keyword">final</span> RouteContext routeContext, <span class="keyword">final</span> Map&lt;String, Integer&gt; connectionOffsets, <span class="keyword">final</span> Collection&lt;ExecutionUnit&gt; executionUnits,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> ExecutionGroupReportContext reportContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Collection&lt;ExecutionGroup&lt;T&gt;&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// æŒ‰æ•°æ®åŸåˆ†æ•°</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, List&lt;ExecutionUnit&gt;&gt; entry : aggregateExecutionUnitGroups(executionUnits).entrySet()) &#123;</span><br><span class="line">        String dataSourceName = entry.getKey();</span><br><span class="line">        <span class="comment">// æŒ‰æ¯ä¸ªæ•°æ®æºçš„è¿æ¥æ•°æ‹†åˆ†æˆå¤šæ‰§è¡Œå•å…ƒï¼ˆsqlï¼‰é›†åˆ</span></span><br><span class="line">        List&lt;List&lt;ExecutionUnit&gt;&gt; executionUnitGroups = group(entry.getValue());</span><br><span class="line">        ConnectionMode connectionMode = maxConnectionsSizePerQuery &lt; entry.getValue().size() ? ConnectionMode.CONNECTION_STRICTLY : ConnectionMode.MEMORY_STRICTLY;</span><br><span class="line">        <span class="comment">// æŒ‰æ¯ä¸ªæ•°æ®æºçš„è¿æ¥æ•°åˆ†ç»„ï¼Œä¸€ä¸ªè¿æ¥ä¸‹å¯ä»¥åŒ…å«ä¸€ä¸ªæ•°æ®æºä¸‹çš„å¤šä¸ªsql</span></span><br><span class="line">        result.addAll(group(dataSourceName, connectionOffsets.getOrDefault(dataSourceName, <span class="number">0</span>), executionUnitGroups, connectionMode));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯æ‰©å±•çš„è£…é¥°å™¨</span></span><br><span class="line">    <span class="keyword">return</span> decorate(routeContext, result, reportContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine#execute</span></span><br><span class="line"><span class="keyword">public</span> &lt;I, O&gt; <span class="function">List&lt;O&gt; <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ExecutionGroupContext&lt;I&gt; executionGroupContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> ExecutorCallback&lt;I, O&gt; firstCallback, <span class="keyword">final</span> ExecutorCallback&lt;I, O&gt; callback, <span class="keyword">final</span> <span class="keyword">boolean</span> serial)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (executionGroupContext.getInputGroups().isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serial ? serialExecute(executionGroupContext.getInputGroups().iterator(), executionGroupContext.getReportContext().getProcessId(), firstCallback, callback)</span><br><span class="line">            : parallelExecute(executionGroupContext.getInputGroups().iterator(), executionGroupContext.getReportContext().getProcessId(), firstCallback, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œé€»è¾‘ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š</p><ol><li>æ ¹æ®æ•°æ®åº“å’Œå•åº“æœ€å¤§è¿æ¥æ•° (maxConnectionsSizePerQuery) å¯¹æ‰§è¡Œå•å…ƒè¿›è¡Œåˆ†ç»„</li><li>æ ¹æ®åˆ†ç»„åçš„æ‰§è¡Œå•å…ƒå¹¶å‘æ‰§è¡Œï¼Œä»¥æ±‚æœ€å¤§çš„æ‰§è¡Œæ•ˆç‡ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼‰</li></ol><p>æ¥ä¸‹æ¥çœ‹çœ‹åˆå¹¶å¼•æ“ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement#mergeQuery</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MergedResult <span class="title">mergeQuery</span><span class="params">(<span class="keyword">final</span> List&lt;QueryResult&gt; queryResults, <span class="keyword">final</span> SQLStatementContext sqlStatementContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶å¼•æ“ï¼ŒåŒ…æ‹¬åˆ†ç‰‡åˆå¹¶ã€æ•°æ®è„±æ•ã€æ•°æ®åŠ å¯†</span></span><br><span class="line">    MergeEngine mergeEngine = <span class="keyword">new</span> MergeEngine(metaDataContexts.getMetaData().getDatabase(databaseName),</span><br><span class="line">            metaDataContexts.getMetaData().getProps(), connection.getDatabaseConnectionManager().getConnectionContext());</span><br><span class="line">    <span class="keyword">return</span> mergeEngine.merge(queryResults, sqlStatementContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.merge.MergeEngine#merge</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MergedResult <span class="title">merge</span><span class="params">(<span class="keyword">final</span> List&lt;QueryResult&gt; queryResults, <span class="keyword">final</span> SQLStatementContext sqlStatementContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ†ç‰‡ç»“æœåˆå¹¶</span></span><br><span class="line">    Optional&lt;MergedResult&gt; mergedResult = executeMerge(queryResults, sqlStatementContext);</span><br><span class="line">    <span class="comment">// ç»“æœå¤„ç†ï¼Œæ•°æ®è„±æ•ã€æ•°æ®è§£å¯†</span></span><br><span class="line">    Optional&lt;MergedResult&gt; result = mergedResult.isPresent() ? Optional.of(decorate(mergedResult.get(), sqlStatementContext)) : decorate(queryResults.get(<span class="number">0</span>), sqlStatementContext);</span><br><span class="line">    <span class="keyword">return</span> result.orElseGet(() -&gt; <span class="keyword">new</span> TransparentMergedResult(queryResults.get(<span class="number">0</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.merge.MergeEngine#executeMerge</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Optional&lt;MergedResult&gt; <span class="title">executeMerge</span><span class="params">(<span class="keyword">final</span> List&lt;QueryResult&gt; queryResults, <span class="keyword">final</span> SQLStatementContext sqlStatementContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;ShardingSphereRule, ResultProcessEngine&gt; entry : engines.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.getValue() <span class="keyword">instanceof</span> ResultMergerEngine) &#123;</span><br><span class="line">            ResultMerger resultMerger = ((ResultMergerEngine) entry.getValue()).newInstance(database.getName(), database.getProtocolType(), entry.getKey(), props, sqlStatementContext);</span><br><span class="line">            <span class="keyword">return</span> Optional.of(resultMerger.merge(queryResults, sqlStatementContext, database, connectionContext));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Optional.empty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#build</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MergedResult <span class="title">build</span><span class="params">(<span class="keyword">final</span> List&lt;QueryResult&gt; queryResults, <span class="keyword">final</span> SelectStatementContext selectStatementContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap, <span class="keyword">final</span> ShardingSphereDatabase database)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    String defaultSchemaName = <span class="keyword">new</span> DatabaseTypeRegistry(selectStatementContext.getDatabaseType()).getDefaultSchemaName(database.getName());</span><br><span class="line">    ShardingSphereSchema schema = selectStatementContext.getTablesContext().getSchemaName()</span><br><span class="line">            .map(database::getSchema).orElseGet(() -&gt; database.getSchema(defaultSchemaName));</span><br><span class="line">    <span class="comment">// åˆ†ç»„ã€å­—æ®µæ˜¯èšåˆå‡½æ•°ï¼Œä¾‹å¦‚sum()ã€min()</span></span><br><span class="line">    <span class="keyword">if</span> (isNeedProcessGroupBy(selectStatementContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getGroupByMergedResult(queryResults, selectStatementContext, columnLabelIndexMap, schema);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å»é‡ distinct</span></span><br><span class="line">    <span class="keyword">if</span> (isNeedProcessDistinctRow(selectStatementContext)) &#123;</span><br><span class="line">        setGroupByForDistinctRow(selectStatementContext);</span><br><span class="line">        <span class="keyword">return</span> getGroupByMergedResult(queryResults, selectStatementContext, columnLabelIndexMap, schema);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    <span class="keyword">if</span> (isNeedProcessOrderBy(selectStatementContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OrderByStreamMergedResult(queryResults, selectStatementContext, schema);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IteratorStreamMergedResult(queryResults);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.infra.merge.MergeEngine#decorate</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MergedResult <span class="title">decorate</span><span class="params">(<span class="keyword">final</span> MergedResult mergedResult, <span class="keyword">final</span> SQLStatementContext sqlStatementContext)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    MergedResult result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;ShardingSphereRule, ResultProcessEngine&gt; entry : engines.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.getValue() <span class="keyword">instanceof</span> ResultDecoratorEngine) &#123;</span><br><span class="line">            <span class="comment">// è·å–ç»“æœé›†è£…é¥°å™¨</span></span><br><span class="line">            ResultDecorator resultDecorator = getResultDecorator(sqlStatementContext, entry);</span><br><span class="line">            result = <span class="keyword">null</span> == result ? resultDecorator.decorate(mergedResult, sqlStatementContext, entry.getKey()) : resultDecorator.decorate(result, sqlStatementContext, entry.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span> == result ? mergedResult : result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå¹¶å¼•æ“ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>æŸ¥è¯¢ç»“æœåˆå¹¶ï¼ŒåŒ…æ‹¬èšåˆã€æ’åºã€å»é‡ã€åˆ†é¡µ</li><li>æŸ¥è¯¢ç»“æœå€¼å¤„ç†ï¼ŒåŒ…æ‹¬æ•°æ®è„±æ•ã€è§£å¯†</li></ol><p>æ³¨æ„ï¼Œåˆå¹¶å¼•æ“å®é™…åªæ˜¯è¿”å›ä¸Šç€åšäº†å°è£…çš„ MergedResultï¼Œå…·ä½“çš„åˆå¹¶é€»è¾‘å®é™…æ˜¯åœ¨éå†è·å–ç»“æœæ•°æ®æ—¶è¿›è¡Œçš„ï¼Œä¸‹é¢ä»¥æ’åºç»“æœåˆå¹¶ä¸ºä¾‹å­ï¼Œçœ‹çœ‹åˆå¹¶å…·ä½“æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.merge.dql.orderby.OrderByStreamMergedResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByStreamMergedResult</span> <span class="keyword">extends</span> <span class="title">StreamMergedResult</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;OrderByItem&gt; orderByItems;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;OrderByValue&gt; orderByValuesQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Getter</span>(AccessLevel.PROTECTED)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstNext;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderByStreamMergedResult</span><span class="params">(<span class="keyword">final</span> List&lt;QueryResult&gt; queryResults, <span class="keyword">final</span> SelectStatementContext selectStatementContext, <span class="keyword">final</span> ShardingSphereSchema schema)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        orderByItems = selectStatementContext.getOrderByContext().getItems();</span><br><span class="line">        orderByValuesQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(queryResults.size());</span><br><span class="line">        orderResultSetsToQueue(queryResults, selectStatementContext, schema);</span><br><span class="line">        isFirstNext = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">orderResultSetsToQueue</span><span class="params">(<span class="keyword">final</span> List&lt;QueryResult&gt; queryResults, <span class="keyword">final</span> SelectStatementContext selectStatementContext, <span class="keyword">final</span> ShardingSphereSchema schema)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (QueryResult each : queryResults) &#123;</span><br><span class="line">            OrderByValue orderByValue = <span class="keyword">new</span> OrderByValue(each, orderByItems, selectStatementContext, schema);</span><br><span class="line">            <span class="keyword">if</span> (orderByValue.next()) &#123;</span><br><span class="line">                orderByValuesQueue.offer(orderByValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setCurrentQueryResult(orderByValuesQueue.isEmpty() ? queryResults.get(<span class="number">0</span>) : orderByValuesQueue.peek().getQueryResult());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (orderByValuesQueue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isFirstNext) &#123;</span><br><span class="line">            isFirstNext = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å–å‡ºæ’åºä¼˜å…ˆé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç»“æœé›†</span></span><br><span class="line">        OrderByValue firstOrderByValue = orderByValuesQueue.poll();</span><br><span class="line">        <span class="comment">// å¦‚æœç¬¬ä¸€ä¸ªç»“æœé›†ä¸­å­˜åœ¨ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™å°†ç»“æœé›†ä¸‹ä¸€ä¸ªå…ƒç´ ä¸­çš„å€¼å¤åˆ¶åˆ°OrderByValueä¸­ï¼Œ</span></span><br><span class="line">        <span class="comment">// ç„¶åé‡æ–°æ”¾å›ä¼˜å…ˆé˜Ÿåˆ—ä¸­ï¼Œä»è€Œä¿è¯æ‰€æœ‰ç»“æœé›†çš„é¡ºåºæ˜¯æ­£ç¡®çš„</span></span><br><span class="line">        <span class="keyword">if</span> (firstOrderByValue.next()) &#123;</span><br><span class="line">            orderByValuesQueue.offer(firstOrderByValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¼˜å…ˆé˜Ÿåˆ—ä¸ºç©ºåˆ™è¯´æ˜éå†åˆ°æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> (orderByValuesQueue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å–å½“å‰é¡ºåºæœ€å‰çš„å…ƒç´ ï¼Œä½†ä¸ç§»é™¤å…ƒç´ </span></span><br><span class="line">        setCurrentQueryResult(orderByValuesQueue.peek().getQueryResult());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.shardingsphere.sharding.merge.dql.orderby.OrderByValue</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByValue</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">OrderByValue</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">// ç§»åŠ¨æ¸¸æ ‡</span></span><br><span class="line">        <span class="keyword">boolean</span> result = queryResult.next();</span><br><span class="line">        <span class="comment">// å°†å½“å‰æ¸¸æ ‡çš„æ’åºå­—æ®µå€¼èµ‹å€¼ç»™orderValues</span></span><br><span class="line">        orderValues = result ? getOrderValues() : Collections.emptyList();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Comparable&lt;?&gt;&gt; getOrderValues() <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        List&lt;Comparable&lt;?&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(orderByItems.size());</span><br><span class="line">        <span class="keyword">for</span> (OrderByItem each : orderByItems) &#123;</span><br><span class="line">            Object value = queryResult.getValue(each.getIndex(), Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            ShardingSpherePreconditions.checkState(<span class="keyword">null</span> == value || value <span class="keyword">instanceof</span> Comparable, () -&gt; <span class="keyword">new</span> NotImplementComparableValueException(<span class="string">"Order by"</span>, value));</span><br><span class="line">            result.add((Comparable&lt;?&gt;) value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(<span class="keyword">final</span> OrderByValue orderByValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¯¹æ¯”å¤šä¸ªæ¸¸æ ‡çš„å½“å‰å€¼</span></span><br><span class="line">        <span class="keyword">for</span> (OrderByItem each : orderByItems) &#123;</span><br><span class="line">            <span class="keyword">int</span> result = CompareUtils.compareTo(orderValues.get(i), orderByValue.orderValues.get(i), each.getSegment().getOrderDirection(),</span><br><span class="line">                    each.getSegment().getNullsOrderType(selectStatementContext.getDatabaseType()), orderValuesCaseSensitive.get(i));</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> != result) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸€ä¸‹æ’åºç»“æœé›†åˆå¹¶çš„ä»£ç ï¼Œå‡è®¾ä¸€æ¡æŸ¥è¯¢è¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> f_id, f_name <span class="keyword">from</span> t_user <span class="keyword">order</span> <span class="keyword">by</span> f_id;</span><br></pre></td></tr></table></figure><p>åˆ†ç‰‡è·¯ç”±åéœ€è¦æŸ¥è¯¢å››å¼ è¡¨ï¼Œé‚£ä¹ˆæœ€ç»ˆå°±ä¼šäº§ç”Ÿå››ä¸ªç»“æœé›†ï¼Œä»¥è¿™ä¸ªåœºæ™¯ä¸ºä¾‹å­çœ‹çœ‹ç»“æœæ˜¯å¦‚ä½•åˆå¹¶çš„ï¼š</p><ol><li>å°†å„ä¸ªç»“æœé›†å°è£…æˆ OrderByValueï¼Œå¹¶å°†ç»“æœé›†çš„ç¬¬ä¸€ä¸ªè¡Œæ•°æ®çš„æ’åºå­—æ®µèµ‹å€¼ç»™ OrderByValueï¼ŒOrderByValue æ ¹æ®ç»“æœé›†èµ‹å€¼çš„æ’åºå­—æ®µå¯¹æ¯”è¿›è¡Œæ’åºã€‚</li><li>å°†å°è£…å¥½çš„ OrderByValue æ”¾å…¥ä¼˜å…ˆé˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆæœ€åˆå°±æ˜¯æ ¹ç»æ¯ä¸ªç»“æœé›†çš„ç¬¬ä¸€ä¸ªè¡Œæ•°æ®çš„æ’åºå­—æ®µè¿›è¡Œæ’åºã€‚</li><li>åœ¨æ‰§è¡Œ OrderByStreamMergedResult.next æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å°†ä¼˜å…ˆé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç»“æœé›†å–å‡ºå¹¶å°†å®ƒçš„æ¸¸æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€ä½ï¼Œå¹¶é‡æ–°å°†æ’åºå­—æ®µèµ‹å€¼ç»™ OrderByValue åæ”¾å…¥ä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚</li><li>ç„¶åå†è¿”å›ä¼˜å…ˆé˜Ÿåˆ—ä¸­æ’åœ¨ç¬¬ä¸€ä½çš„ç»“æœé›†ï¼Œä½†ä¸ä»é˜Ÿåˆ—ç§»é™¤ï¼Œæ­¤æ—¶è¯¥ç»“æœé›†çš„æ¸¸æ ‡æ‰€å¤„ä½ç½®è¡¨ç¤ºçš„å°±æ˜¯æ’åºæœ€å‰çš„è¡Œæ•°æ®ã€‚</li><li>åå¤æ‰§è¡Œ 3ã€4 æ­¥éª¤ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰ç»“æœé›†ä¸‹çš„æ‰€æœ‰è¡Œæ•°æ®ï¼Œä¸€æ¬¡ä¿è¯æ‰€æœ‰ç»“æœé›†æ•°æ®çš„é¡ºåºã€‚</li></ol><p>ä»¥ä¸Šå°±æ˜¯æ’åºç»“æœé›†åˆå¹¶çš„å…·ä½“é€»è¾‘ï¼Œå¦‚æœå¯¹å…¶ä»–ç»“æœé›†åˆå¹¶é€»è¾‘æ„Ÿå…´è¶£çš„çœ‹çœ‹ MergedResult çš„å…¶ä»–å®ç°ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/08/07/pkzCD6x.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>æœ€åå†é‡æ–°çœ‹ä¸€ä¸‹è¿™å¼ æµç¨‹å›¾ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çš„å‘ç°ä»£ç çš„è®¾è®¡å®Œå…¨ä¸è¿™å¼ æµç¨‹å›¾ä¸€è‡´ï¼Œä¸»è¦æµç¨‹ SQL è§£æ -&gt; åˆ†ç‰‡è·¯ç”± -&gt; SQL æ”¹å†™ -&gt; SQL æ‰§è¡Œ -&gt; ç»“æœåˆå¹¶ã€‚</p><blockquote><p>æ³¨ï¼šç”±äºæ–‡ç« ç¯‡å¹…æœ‰é™ï¼Œæ²¡æœ‰è´´å®Œæ•´ä»£ç ï¼Œå¹¶ä¸”åˆ†ç‰‡è·¯ç”±ç®—æ³•ã€è¯»å†™åˆ†ç¦»è´Ÿè½½å‡è¡¡ã€åŠ å¯†è„±æ•ã€äº‹åŠ¡ç›¸å…³éƒ½æœªè¯¦è®²ï¼Œæœ‰å…´è¶£ä¹‹åå†å•ç‹¬æ‹†ä¸€ç¯‡æ–‡ç« å‡ºæ¥è¯¦è®²ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://shardingsphere.apache.org/document/current/cn/reference/architecture/" target="_blank" rel="noopener">https://shardingsphere.apache.org/document/current/cn/reference/architecture/</a></p><p><a href="https://juejin.cn/post/7343161077062991882?searchId=20240721230809FB22ACC70520144A6608#heading-28" target="_blank" rel="noopener">https://juejin.cn/post/7343161077062991882?searchId=20240721230809FB22ACC70520144A6608#heading-28</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;éšç€ä¸šåŠ¡æ•°æ®çš„å¢é•¿ï¼ŒåŸæœ¬å…¬å¸ä¸­çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆç›¸å¯¹æ¥è¯´ä¸å¤Ÿçµæ´»ï¼Œæ‰€ä»¥å†³å®šå¼•å…¥ä¸šå†…ç›¸å¯¹è¾ƒä¸ºæˆç†Ÿçš„åˆ†åº“åˆ†è¡¨ç»„ä»¶ã€‚é€šè¿‡æ¥å…¥æˆæœ¬ã€æ€§èƒ½æŸè€—ã€ç¤¾åŒºæ´»è·ƒç­‰å¤šæ–¹é¢è€ƒè™‘ï¼Œå†³å®šå¼•å…¥ SharidngJDBCã€‚ä½†æ˜¯ç›®å‰ ShardingJDBC å¯¹éƒ¨åˆ†ç°æœ‰ä¸šåŠ¡æ— æ³•åšåˆ°å¤ª</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>è®°ä¸€æ¬¡ opentelemetry æ—¥å¿—æ‰“å° traceId ç¼ºå¤±é—®é¢˜åˆ†æ</title>
    <link href="http://example.com/2024/08/05/%E8%AE%B0%E4%B8%80%E6%AC%A1-opentelemetry-%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0-traceId-%E7%BC%BA%E5%A4%B1%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2024/08/05/%E8%AE%B0%E4%B8%80%E6%AC%A1-opentelemetry-%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0-traceId-%E7%BC%BA%E5%A4%B1%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</id>
    <published>2024-08-05T03:51:33.000Z</published>
    <updated>2024-08-05T04:05:40.501Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>èƒŒæ™¯ï¼šé¡¹ç›®ä¸­æœ‰ä¸€äº›æ¶ˆè´¹ kafka æ¶ˆæ¯è€…æ‰“å°çš„æ—¥å¿—ä¸­ç¼ºå¤± traceIdï¼Œé¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ javaagent çš„æ–¹å¼æ¥å…¥ opentelemetryï¼Œä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ 1.4.xã€‚ <br/></p></blockquote><h3 id="Kafka-ç”Ÿäº§è€…"><a href="#Kafka-ç”Ÿäº§è€…" class="headerlink" title="Kafka ç”Ÿäº§è€…"></a>Kafka ç”Ÿäº§è€…</h3><p>é¦–å…ˆçœ‹çœ‹ç”Ÿäº§è€…æ¶ˆæ¯å‘é€æ–¹æ³•çš„æ–¹æ³•å¢å¼º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodEnter(suppress = Throwable<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">onEnter</span>(</span></span><br><span class="line">        @Advice.FieldValue("apiVersions") ApiVersions apiVersions,</span><br><span class="line">        <span class="meta">@Advice</span>.Argument(value = <span class="number">0</span>, readOnly = <span class="keyword">false</span>) ProducerRecord&lt;?, ?&gt; record,</span><br><span class="line">        <span class="meta">@Advice</span>.Argument(value = <span class="number">1</span>, readOnly = <span class="keyword">false</span>) Callback callback,</span><br><span class="line">        <span class="meta">@Advice</span>.Local(<span class="string">"otelContext"</span>) Context context,</span><br><span class="line">        <span class="meta">@Advice</span>.Local(<span class="string">"otelScope"</span>) Scope scope) &#123;</span><br><span class="line">      <span class="comment">// è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡</span></span><br><span class="line">      Context parentContext = Java8BytecodeBridge.currentContext();</span><br><span class="line">      <span class="comment">// ç”Ÿæˆ context (åŒ…æ‹¬ç”Ÿæˆ span)</span></span><br><span class="line">      context = tracer().startProducerSpan(parentContext, record);</span><br><span class="line"></span><br><span class="line">      callback = <span class="keyword">new</span> ProducerCallback(callback, parentContext, context);</span><br><span class="line">    </span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦ä¼ æ’­é“¾è·¯</span></span><br><span class="line">      <span class="keyword">if</span> (tracer().shouldPropagate(apiVersions)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// å¾€è¯·æ±‚å¤´ä¸­æ·»åŠ  span ä¿¡æ¯</span></span><br><span class="line">          tracer().inject(context, record.headers(), SETTER);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">          <span class="comment">// headers must be read-only from reused record. try again with new one.</span></span><br><span class="line">          record =</span><br><span class="line">              <span class="keyword">new</span> ProducerRecord&lt;&gt;(</span><br><span class="line">                  record.topic(),</span><br><span class="line">                  record.partition(),</span><br><span class="line">                  record.timestamp(),</span><br><span class="line">                  record.key(),</span><br><span class="line">                  record.value(),</span><br><span class="line">                  record.headers());</span><br><span class="line"></span><br><span class="line">          tracer().inject(context, record.headers(), SETTER);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°†ç”Ÿæˆçš„ context è®¾ç½®åˆ°å½“å‰ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤ä½¿ç”¨threadLocalï¼‰</span></span><br><span class="line">      scope = context.makeCurrent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodExit(onThrowable = Throwable<span class="class">.<span class="keyword">class</span>, <span class="title">suppress</span> </span>= Throwable<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">stopSpan</span>(</span></span><br><span class="line"><span class="class">        @<span class="title">Advice</span>.<span class="title">Thrown</span> <span class="title">Throwable</span> <span class="title">throwable</span>,</span></span><br><span class="line">        @Advice.Local("otelContext") Context context,</span><br><span class="line">        <span class="meta">@Advice</span>.Local(<span class="string">"otelScope"</span>) Scope scope) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// å°†å½“å‰ä¸Šä¸‹æ–‡æ¸…ç©ºï¼Œå¹¶æ¢å¤åˆ°çˆ¶ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰</span></span><br><span class="line">      scope.close();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        tracer().endExceptionally(context, throwable);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// span finished by ProducerCallback</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š"><a href="#ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š" class="headerlink" title="ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š"></a>ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š</h4><ol><li>æ–¹æ³•å¢å¼ºä¼šåœ¨å‘é€æ¶ˆæ¯å‰ç”Ÿæˆ contextï¼Œå¦‚æœå­˜åœ¨ parentContext åˆ™ä½¿ç”¨ parentContext çš„ traceIdã€‚</li><li>å¦‚æœæ”¯æŒä¼ æ’­ï¼Œåˆ™ä¼šå°† span ç»„è£…å¥½æ”¾åˆ°æ¶ˆæ¯ headerï¼Œå…·ä½“å‚æ•°åçœ‹ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆåè®®ï¼Œé»˜è®¤æ˜¯ traceparentï¼Œè¿™é‡Œä½¿ç”¨ jaegerï¼Œæ‰€ä»¥å‚æ•°åæ˜¯ uber-trace-idã€‚</li><li>å°†ç”Ÿæˆçš„ context è®¾ç½®åˆ°å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡</li><li>æ¶ˆæ¯å‘é€ç»“æŸæ—¶ä¼šå°†çº¿ç¨‹ä¸Šä¸‹æ–‡æ¢å¤åˆ°åŸæœ¬çš„ä¸Šä¸‹æ–‡</li></ol><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s21.ax1x.com/2024/08/05/pkvU8Ig.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><h4 id="Producer-traceId-æ¶ˆæ¯ç¼ºå¤±åˆ†æ"><a href="#Producer-traceId-æ¶ˆæ¯ç¼ºå¤±åˆ†æ" class="headerlink" title="Producer traceId æ¶ˆæ¯ç¼ºå¤±åˆ†æ"></a>Producer traceId æ¶ˆæ¯ç¼ºå¤±åˆ†æ</h4><ol><li>ç”±äºå½“å‰ä¸å­˜åœ¨ä¸Šä¸‹æ–‡ï¼Œç”Ÿäº§è€…åœ¨å‘é€å®Œæ¶ˆæ¯åå°±ç›´æ¥å°†ä¸Šä¸‹æ–‡æ¸…ç©ºäº†ï¼Œæ‰€ä»¥åç»­æ‰“å°çš„æ—¥å¿—éƒ½ä¸å­˜åœ¨ä¸Šä¸‹æ–‡</li><li>é€šè¿‡ callback æ‰“å°æ—¥å¿—ï¼Œç”±äº callback æ˜¯åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¹Ÿè·å–ä¸åˆ°ä¸Šä¸‹æ–‡</li></ol><br/><h3 id="Kafka-æ¶ˆè´¹è€…"><a href="#Kafka-æ¶ˆè´¹è€…" class="headerlink" title="Kafka æ¶ˆè´¹è€…"></a>Kafka æ¶ˆè´¹è€…</h3><p>é¦–å…ˆçœ‹çœ‹æ¶ˆè´¹è€…æ¶ˆæ¯æ¶ˆè´¹æ–¹æ³•çš„æ–¹æ³•å¢å¼º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(TypeTransformer transformer)</span> </span>&#123;</span><br><span class="line">    transformer.applyAdviceToMethod(</span><br><span class="line">        isMethod()</span><br><span class="line">            .and(isPublic())</span><br><span class="line">            .and(named(<span class="string">"records"</span>))</span><br><span class="line">            .and(takesArgument(<span class="number">0</span>, String<span class="class">.<span class="keyword">class</span>))</span></span><br><span class="line"><span class="class">            .<span class="title">and</span>(<span class="title">returns</span>(<span class="title">Iterable</span>.<span class="title">class</span>)),</span></span><br><span class="line">        KafkaConsumerInstrumentation.class.getName() + "$IterableAdvice");</span><br><span class="line">    transformer.applyAdviceToMethod(</span><br><span class="line">        isMethod()</span><br><span class="line">            .and(isPublic())</span><br><span class="line">            .and(named(<span class="string">"records"</span>))</span><br><span class="line">            .and(takesArgument(<span class="number">0</span>, named(<span class="string">"org.apache.kafka.common.TopicPartition"</span>)))</span><br><span class="line">            .and(returns(List<span class="class">.<span class="keyword">class</span>)),</span></span><br><span class="line">        KafkaConsumerInstrumentation.class.getName() + "$ListAdvice");</span><br><span class="line">    transformer.applyAdviceToMethod(</span><br><span class="line">        isMethod()</span><br><span class="line">            .and(isPublic())</span><br><span class="line">            .and(named(<span class="string">"iterator"</span>))</span><br><span class="line">            .and(takesArguments(<span class="number">0</span>))</span><br><span class="line">            .and(returns(Iterator<span class="class">.<span class="keyword">class</span>)),</span></span><br><span class="line">        KafkaConsumerInstrumentation.class.getName() + "$IteratorAdvice");</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IterableAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodExit(suppress = Throwable<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">wrap</span>(</span></span><br><span class="line"><span class="class">        @<span class="title">Advice</span>.<span class="title">Return</span>(<span class="title">readOnly</span> </span>= <span class="keyword">false</span>) Iterable&lt;ConsumerRecord&lt;?, ?&gt;&gt; iterable) &#123;</span><br><span class="line">      <span class="keyword">if</span> (iterable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¦†ç›–è¿­ä»£å™¨</span></span><br><span class="line">        iterable = <span class="keyword">new</span> TracingIterable(iterable, tracer());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodExit(suppress = Throwable<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">wrap</span>(@<span class="title">Advice</span>.<span class="title">Return</span>(<span class="title">readOnly</span> </span>= <span class="keyword">false</span>) List&lt;ConsumerRecord&lt;?, ?&gt;&gt; iterable) &#123;</span><br><span class="line">      <span class="keyword">if</span> (iterable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¦†ç›–List</span></span><br><span class="line">        iterable = <span class="keyword">new</span> TracingList(iterable, tracer());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodExit(suppress = Throwable<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">wrap</span>(</span></span><br><span class="line"><span class="class">        @<span class="title">Advice</span>.<span class="title">Return</span>(<span class="title">readOnly</span> </span>= <span class="keyword">false</span>) Iterator&lt;ConsumerRecord&lt;?, ?&gt;&gt; iterator) &#123;</span><br><span class="line">      <span class="keyword">if</span> (iterator != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¦†ç›–è¿­ä»£å™¨</span></span><br><span class="line">        iterator = <span class="keyword">new</span> TracingIterator(iterator, tracer());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TracingIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">ConsumerRecord</span>&lt;?, ?&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;ConsumerRecord&lt;?, ?&gt;&gt; delegateIterator;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> KafkaConsumerTracer tracer;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Note: this may potentially create problems if this iterator is used from different threads. But</span></span><br><span class="line"><span class="comment">   * at the moment we cannot do much about this.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> Context currentContext;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> Scope currentScope;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TracingIterator</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Iterator&lt;ConsumerRecord&lt;?, ?&gt;&gt; delegateIterator, KafkaConsumerTracer tracer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.delegateIterator = delegateIterator;</span><br><span class="line">    <span class="keyword">this</span>.tracer = tracer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    closeScopeAndEndSpan();</span><br><span class="line">    <span class="keyword">return</span> delegateIterator.hasNext();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> ConsumerRecord&lt;?, ?&gt; next() &#123;</span><br><span class="line">    <span class="comment">// in case they didn't call hasNext()...</span></span><br><span class="line">    <span class="comment">// æ¸…é™¤ä¸Šä¸€æ¡æ¶ˆæ¯çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">    closeScopeAndEndSpan();</span><br><span class="line"></span><br><span class="line">    ConsumerRecord&lt;?, ?&gt; next = delegateIterator.next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// ç”Ÿæˆä¸Šä¸‹æ–‡ï¼ŒåŒ…å«spanï¼Œå¦‚æœæ¶ˆæ¯æœ‰ä¸Šä¸‹æ–‡åˆ™æå–</span></span><br><span class="line">      currentContext = tracer.startSpan(next);</span><br><span class="line">      currentScope = currentContext.makeCurrent();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeScopeAndEndSpan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (currentScope != <span class="keyword">null</span>) &#123;</span><br><span class="line">      currentScope.close();</span><br><span class="line">      currentScope = <span class="keyword">null</span>;</span><br><span class="line">      tracer.end(currentContext);</span><br><span class="line">      currentContext = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    delegateIterator.remove();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š-1"><a href="#ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š-1" class="headerlink" title="ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š"></a>ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼š</h4><ol><li>è¿­ä»£å™¨æ¯è·å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œä¼šå…ˆæ¸…é™¤ä¸Šä¸‹æ–‡ï¼Œç„¶åå†ç”Ÿæˆæ–°çš„ä¸Šä¸‹æ–‡ï¼Œå¦‚æœæ¶ˆæ¯å¤´æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯åˆ™æå–</li><li>æ¯æ¬¡åˆ¤æ–­ hasNext æ˜¯éƒ½ä¼šæ¸…é™¤ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥éå†æ—¶å¾ªç¯ç»“æŸï¼Œä¸Šä¸‹æ–‡ä¹Ÿä¼šè¢«æ¸…é™¤</li></ol><h4 id="Consumer-traceId-æ¶ˆæ¯ç¼ºå¤±åˆ†æ"><a href="#Consumer-traceId-æ¶ˆæ¯ç¼ºå¤±åˆ†æ" class="headerlink" title="Consumer traceId æ¶ˆæ¯ç¼ºå¤±åˆ†æ"></a>Consumer traceId æ¶ˆæ¯ç¼ºå¤±åˆ†æ</h4><ol><li>åŒä¸Šåœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šä½¿ç”¨ foreachï¼Œå¦‚æœé€»è¾‘ä¸åœ¨ foreach ä¹‹é—´ï¼Œåˆ™ä¼šé€ æˆ traceId ç¼ºå¤±ã€‚</li><li>æœ‰çš„æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ï¼ŒåŒæ ·ä¼šé€ æˆ traceId ç¼ºå¤±</li></ol><br/><h3 id="Opentelemetry-æ—¥å¿—ä¸Šä¸‹æ–‡"><a href="#Opentelemetry-æ—¥å¿—ä¸Šä¸‹æ–‡" class="headerlink" title="Opentelemetry æ—¥å¿—ä¸Šä¸‹æ–‡"></a>Opentelemetry æ—¥å¿—ä¸Šä¸‹æ–‡</h3><p>åŒæ ·æ˜¯å…ˆçœ‹çœ‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenTelemetryContextDataProvider</span> <span class="keyword">implements</span> <span class="title">ContextDataProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns context from the current span when available.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A map containing string versions of the traceId, spanId, and traceFlags, which can then</span></span><br><span class="line"><span class="comment">   *     be accessed from layout components</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">supplyContextData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Span currentSpan = Span.current();</span><br><span class="line">    <span class="keyword">if</span> (!currentSpan.getSpanContext().isValid()) &#123;</span><br><span class="line">      <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; contextData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    SpanContext spanContext = currentSpan.getSpanContext();</span><br><span class="line">    contextData.put(TRACE_ID, spanContext.getTraceId());</span><br><span class="line">    contextData.put(SPAN_ID, spanContext.getSpanId());</span><br><span class="line">    contextData.put(TRACE_FLAGS, spanContext.getTraceFlags().asHex());</span><br><span class="line">    <span class="keyword">return</span> contextData;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸æ˜¯ä½¿ç”¨çš„ MDCï¼Œå¦å¤–å¯ä»¥å°è¯•ä½¿ç”¨ä¸‹é¢æ–¹å¼ä½¿ç”¨è‡ªå®šä¹‰çš„ä¸Šä¸‹æ–‡æ•°æ®å­˜å‚¨ï¼ˆäº²æµ‹ä¸è¡Œï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ä¿®æ”¹æºç è§£å†³ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:path/to/opentelemetry-javaagent.jar -Dio.opentelemetry.context.contextStorageProvider=your.package.CustomContextStorageProvider -jar your-application.jar</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;èƒŒæ™¯ï¼šé¡¹ç›®ä¸­æœ‰ä¸€äº›æ¶ˆè´¹ kafka æ¶ˆæ¯è€…æ‰“å°çš„æ—¥å¿—ä¸­ç¼ºå¤± traceIdï¼Œé¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ javaagent çš„æ–¹å¼æ¥å…¥ opentelemetryï¼Œä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ 1.4.xã€‚ &lt;br/&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;Ka</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Antlr4 åˆæ¢</title>
    <link href="http://example.com/2024/07/28/Antlr4-%E5%88%9D%E6%8E%A2/"/>
    <id>http://example.com/2024/07/28/Antlr4-%E5%88%9D%E6%8E%A2/</id>
    <published>2024-07-28T08:59:57.000Z</published>
    <updated>2024-07-28T09:47:06.856Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åœ¨çœ‹ Shardingjdbc æºç ï¼Œå…¶ä¸­ Sql ä½¿ç”¨çš„è¯­æ³•è§£æå™¨æ˜¯ Antlr4ï¼Œç»è¿‡äº†è§£è®¸å¤šæ¡†æ¶éƒ½ä½¿ç”¨ Antlr4 ä½œä¸ºè¯­æ³•è§£æå™¨ã€‚</p></blockquote><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>Antlr å…¨ç§°ï¼ˆANother Tool for Language Recognitionï¼‰ï¼Œæ˜¯ä¸€æ¬¾å¼ºå¤§çš„è¯­æ³•åˆ†æå™¨ç”Ÿæˆå·¥å…·ï¼Œåƒæ¨ç‰¹ã€Hadoopã€Oracle ç­‰çŸ¥åå…¬å¸éƒ½åœ¨ä½¿ç”¨å®ƒæ¥æ„å»ºè‡ªå·±çš„è¯­è¨€å¤„ç†ç±»é¡¹ç›®ã€‚</p><p>ä¸€é—¨è¯­è¨€çš„æ­£å¼æè¿°ç§°ä¸ºè¯­æ³•ï¼ŒAntlr å¯ä»¥ä¸ºè¯­è¨€ç”Ÿæˆè¯æ³•åˆ†æå™¨ï¼Œå¹¶è‡ªåŠ¨å»ºç«‹è¯­æ³•åˆ†ææ ‘å’Œæ ‘çš„éå†å™¨ï¼Œç„¶åæˆ‘ä»¬å°±èƒ½è®¿é—®æ ‘çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚</p><p>åœ¨å®é™…ä½¿ç”¨ Antlr æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æçš„è¿‡ç¨‹ï¼Œåªéœ€å®šä¹‰è¯­æ³•è§„åˆ™ä»¥åŠå¤„ç†æœ€åçš„è¯­æ³•åˆ†ææ ‘å³å¯ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒé…ç½®ï¼ˆå¦‚ä½¿ç”¨ Idea æ’ä»¶ï¼‰ã€å¼•å…¥ç›¸å…³ä¾èµ–ï¼ˆå¦‚åœ¨ Pom æ–‡ä»¶ä¸­æ·»åŠ  Antlr ä¾èµ–ï¼‰ã€ç¼–å†™è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ç­‰æ­¥éª¤æ¥å®ç°åŸºäº Antlr çš„åº”ç”¨ã€‚</p><br/><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><h4 id="è¯æ³•åˆ†æå™¨-Lexer"><a href="#è¯æ³•åˆ†æå™¨-Lexer" class="headerlink" title="è¯æ³•åˆ†æå™¨ (Lexer)"></a>è¯æ³•åˆ†æå™¨ (Lexer)</h4><ul><li>è¯æ³•åˆ†ææ˜¯æŒ‡åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå°†å­—ç¬¦åºåˆ—è½¬æ¢ä¸ºå•è¯ï¼ˆTokenï¼‰çš„è¿‡ç¨‹ï¼Œç®€å•ç†è§£å°±æ˜¯åˆ†è¯çš„è¿‡ç¨‹ã€‚</li><li>æ‰€è°“ Token ï¼Œå°±æ˜¯æºæ–‡ä»¶ä¸­ä¸å¯å†è¿›ä¸€æ­¥åˆ†å‰²çš„ä¸€ä¸²å­—ç¬¦ï¼Œç±»ä¼¼äºè‹±è¯­ä¸­å•è¯ï¼Œæˆ–æ±‰è¯­ä¸­çš„è¯ã€‚</li><li>==è¯æ³•åˆ†æå™¨ (Lexer) å°±æ˜¯æ ¹æ®è§„åˆ™å°†æ–‡æœ¬ï¼ˆå­—ç¬¦æµï¼‰è½¬æ¢ä¸ºå•è¯ï¼ˆTokenï¼‰çš„ç¨‹åºã€‚==<img src="https://s21.ax1x.com/2024/07/28/pkq4R4x.png" alt="æˆªå›¾" /></li></ul><h4 id="è¯­æ³•è§£æå™¨-Parser"><a href="#è¯­æ³•è§£æå™¨-Parser" class="headerlink" title="è¯­æ³•è§£æå™¨ (Parser)"></a>è¯­æ³•è§£æå™¨ (Parser)</h4><ul><li>è¯æ³•åˆ†æå®Œæˆåï¼Œå­—ç¬¦æµå°±è¢«è½¬æ¢ä¸º Token æµäº†ï¼Œæ¥ä¸‹æ¥æ ¹æ®è¯­è¨€çš„è¯­æ³•è§„åˆ™æ¥è§£æè¿™ä¸ª Token æµï¼Œè¢«ç§°ä¸ºè¯­æ³•è§£æã€‚</li><li>è¯­æ³•è§£æå™¨é€šå¸¸ä½œä¸ºç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨å‡ºç°ã€‚==å®ƒçš„ä½œç”¨æ˜¯è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œå¹¶å°†è¯æ³•åˆ†æå™¨ï¼ˆLexerï¼‰è¾“å‡ºçš„ Token æµè§£ææˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘ã€‚==<img src="https://s21.ax1x.com/2024/07/28/pkq4fC6.png" alt="æˆªå›¾" /></li></ul><h4 id="æŠ½è±¡è¯­æ³•æ ‘-Abstract-Syntax-Tree-AST"><a href="#æŠ½è±¡è¯­æ³•æ ‘-Abstract-Syntax-Tree-AST" class="headerlink" title="æŠ½è±¡è¯­æ³•æ ‘ (Abstract Syntax Tree,AST)"></a>æŠ½è±¡è¯­æ³•æ ‘ (Abstract Syntax Tree,AST)</h4><p>æŠ½è±¡è¯­æ³•æ ‘æ˜¯æºä»£ç ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºï¼Œå®ƒä»¥æ ‘çš„å½¢çŠ¶è¡¨ç¤ºè¯­è¨€çš„è¯­æ³•ç»“æ„ã€‚æŠ½è±¡è¯­æ³•æ ‘ä¸€èˆ¬å¯ä»¥ç”¨æ¥è¿›è¡Œä»£ç è¯­æ³•çš„æ£€æŸ¥ï¼Œä»£ç é£æ ¼çš„æ£€æŸ¥ï¼Œä»£ç çš„æ ¼å¼åŒ–ï¼Œä»£ç çš„é«˜äº®ï¼Œä»£ç çš„é”™è¯¯æç¤ºä»¥åŠä»£ç çš„è‡ªåŠ¨è¡¥å…¨ç­‰ç­‰ã€‚</p><br/><h3 id="Antlr-Grammaræ–‡ä»¶ç®€ä»‹"><a href="#Antlr-Grammaræ–‡ä»¶ç®€ä»‹" class="headerlink" title="Antlr  Grammaræ–‡ä»¶ç®€ä»‹"></a>Antlr  Grammaræ–‡ä»¶ç®€ä»‹</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Grammar æ–‡ä»¶ Expr.g4ï¼Œå®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å››åˆ™è¿ç®—è¯­æ³•è§„åˆ™ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">grammar Expr;</span><br><span class="line">prog:    expr EOF ;</span><br><span class="line">expr:    expr (&#39;*&#39;|&#39;&#x2F;&#39;) expr  #MultiOrDiv</span><br><span class="line">    |    expr (&#39;+&#39;|&#39;-&#39;) expr  #AddOrSub</span><br><span class="line">    |    INT     #Lieteral</span><br><span class="line">    |    &#39;(&#39; expr &#39;)&#39;   #Single</span><br><span class="line">    ;</span><br><span class="line">NEWLINE : [\r\n]+ -&gt; skip;</span><br><span class="line">INT     : [0-9]+ ;</span><br></pre></td></tr></table></figure><ul><li>grammar Expr: å£°æ˜ä¸€ä¸ªåä¸º Expr çš„è¯­æ³•è§„åˆ™</li><li>Grammar æ–‡ä»¶ä¸­ä»¥å°å†™å­—æ¯å¼€å¤´çš„ä¸ºè¯­æ³•è§„åˆ™ï¼Œä»¥å¤§å†™å­—æ¯å¼€å¤´çš„ä¸ºè¯æ³•è§„åˆ™ï¼Œé‚£ä¹ˆæœ¬è§„åˆ™ä¸­è¯­æ³•è§„åˆ™æœ‰ progã€exprï¼Œè¯æ³•è§„åˆ™æœ‰ NEWLINEã€INT</li><li>prog: å®šä¹‰äº†ä¸€ä¸ªè¯­æ³•è§„åˆ™ï¼Œå®šä¹‰äº†ä¸€ä¸ª expr è¡¨è¾¾å¼ï¼Œåé¢è·Ÿç€ EOF æ ‡è¯†æ–‡ä»¶ç»“æŸ</li><li>expr: å®šä¹‰äº†ä¸€ä¸ªé€’å½’è¯­æ³•è§„åˆ™ï¼Œæ ‡è¯†å¯ä»¥åŒ¹é… n+nã€n*nã€n-nã€n/nã€(n) è¿™æ ·çš„å››åˆ™è¿ç®—ï¼Œå…¶ä¸­ n å¿…é¡»æ˜¯ INTï¼Œè§„åˆ™ prog å¼•ç”¨çš„è¡¨è¾¾å¼ expr å°±æ˜¯æœ¬è§„åˆ™ã€‚</li><li>NEWLINE: å®šä¹‰äº†ä¸€ä¸ªè¯æ³•è§„åˆ™ï¼Œè¡¨ç¤ºæ¡è§„ä¸€ä¸ªæˆ–å¤šä¸ªå›è½¦æˆ–æ¢è¡Œç¬¦ã€‚</li><li>INT: å®šä¹‰äº†ä¸€ä¸ªè¯æ³•è§„åˆ™ï¼Œè¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª 0-9 çš„æ•°å­—</li></ul><br/><h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><h4 id="å®‰è£…-Antlr"><a href="#å®‰è£…-Antlr" class="headerlink" title="å®‰è£… Antlr"></a>å®‰è£… Antlr</h4><p>å®‰è£… Anltr çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥å®‰è£…ç³»ç»Ÿå‘½ä»¤è¡Œå·¥å…·ï¼Œä¹Ÿå¯ä»¥æ˜¯ ide æ’ä»¶ï¼Œæœ¬æ–‡å®‰è£…çš„æ˜¯ idea æ’ä»¶ã€‚å…¶ä»–æ–¹å¼å¯ä»¥å‚è€ƒ <a href="https://github.com/antlr/antlr4/blob/master/doc/getting-started.md" target="_blank" rel="noopener">ä¼ é€é—¨</a>ã€‚</p><img src="https://s21.ax1x.com/2024/07/28/pkq45vD.png" alt="æˆªå›¾" style="zoom:50%;" /><br><br><img src="https://s21.ax1x.com/2024/07/28/pkq4TDH.png" alt="æˆªå›¾" />é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘è¿™ä¸»è¦é…äº†æ ¹æ®è§„åˆ™ç”Ÿæˆçš„ä»£ç è·¯å¾„ã€å·²ç»ç”Ÿæˆçš„ä»£ç è¯­è¨€ã€‚<h4 id="ç¼–å†™-Grammer-æ–‡ä»¶"><a href="#ç¼–å†™-Grammer-æ–‡ä»¶" class="headerlink" title="ç¼–å†™ Grammer æ–‡ä»¶"></a>ç¼–å†™ Grammer æ–‡ä»¶</h4><p>è¿™é‡Œç›´æ¥ä½¿ç”¨ä¸Šè¿°è®²è§£ä¸­ä½¿ç”¨çš„è¯­æ³•æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grammar Expr;</span><br><span class="line">package org.apache.shardingsphere.example.parser.demo;</span><br><span class="line">prog:    expr EOF ;</span><br><span class="line">expr:    expr (&#39;*&#39;|&#39;&#x2F;&#39;) expr  #MultiOrDiv</span><br><span class="line">    |    expr (&#39;+&#39;|&#39;-&#39;) expr  #AddOrSub</span><br><span class="line">    |    INT     #Lieteral</span><br><span class="line">    |    &#39;(&#39; expr &#39;)&#39;   #Single</span><br><span class="line">    ;</span><br><span class="line">NEWLINE : [\r\n]+ -&gt; skip;</span><br><span class="line">INT     : [0-9]+ ;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨æ’ä»¶è§£æè¯­æ³•æ ‘"><a href="#ä½¿ç”¨æ’ä»¶è§£æè¯­æ³•æ ‘" class="headerlink" title="ä½¿ç”¨æ’ä»¶è§£æè¯­æ³•æ ‘"></a>ä½¿ç”¨æ’ä»¶è§£æè¯­æ³•æ ‘</h4><img src="https://s21.ax1x.com/2024/07/28/pkq4bVA.png" alt="æˆªå›¾" style="zoom:50%;" /><br><br><img src="https://s21.ax1x.com/2024/07/28/pkq59bj.png" alt="æˆªå›¾" /><h4 id="æ ¹æ®-Grammer-æ–‡ä»¶ç”Ÿæˆä»£ç "><a href="#æ ¹æ®-Grammer-æ–‡ä»¶ç”Ÿæˆä»£ç " class="headerlink" title="æ ¹æ® Grammer æ–‡ä»¶ç”Ÿæˆä»£ç "></a>æ ¹æ® Grammer æ–‡ä»¶ç”Ÿæˆä»£ç </h4><img src="https://s21.ax1x.com/2024/07/28/pkq5PVs.png" alt="æˆªå›¾" style="zoom:50%;" /><br><br><img src="https://s21.ax1x.com/2024/07/28/pkq5ian.png" alt="æˆªå›¾" style="zoom:80%;" /><p>å…¶ä¸­æ–‡ä»¶çš„å«ä¹‰ï¼š</p><ul><li>ExprParser: åŒ…å«è¯­æ³•åˆ†æå™¨çš„å®šä¹‰ï¼Œä¸“é—¨ç”¨æ¥è¯†åˆ«æˆ‘ä»¬çš„è¯­è¨€ã€‚</li><li>ExprLexer: è¯æ³•åˆ†æå™¨çš„å®šä¹‰ï¼Œå°†è¾“å…¥å­—ç¬¦åˆ†è§£ä¸ºè¯æ±‡ç¬¦å·ï¼›</li><li>ExprLexer.tokens: antlr4 ä¼šå°†æˆ‘ä»¬å®šä¹‰çš„è¯æ³•ç¬¦å·æŒ‡å®šä¸€ä¸ªæ•°å­—ç±»å‹ï¼Œç„¶åå°†å¯¹åº”çš„å…³ç³»å­˜å‚¨åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</li><li>ExprListener: antlr4 åœ¨éå†è¯­æ³•æ ‘çš„æ—¶å€™ï¼Œéå†å™¨ä¼šè§¦å‘ä¸€ç³»åˆ—çš„äº‹ä»¶ï¼Œé€šçŸ¥æˆ‘ä»¬çš„ç›‘å¬å™¨ï¼›ExprListener æ˜¯ç›‘å¬å™¨çš„æ¥å£å®šä¹‰  ExprBaseListener æ˜¯ç›‘å¬å™¨çš„ç©ºå®ç°ã€‚</li><li>ExprVisitor: å¦‚æœæˆ‘ä»¬æƒ³è¦è‡ªå·±æ˜¾ç¤ºçš„è‡ªå®šä¹‰éå†è¯­æ³•æ ‘ï¼Œå¯ä»¥ä½¿ç”¨ Visitor æ¥éå†æ ‘ï¼ŒExprBaseVistor æ˜¯é»˜è®¤çš„ç©ºå®ç°ã€‚</li></ul><p>==ç”Ÿæˆä»£ç åï¼Œè¿˜éœ€è¦å¼•å…¥å¯¹åº”çš„ä¾èµ–==</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.antlr<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>antlr4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™ä¸»ç¨‹åº"><a href="#ç¼–å†™ä¸»ç¨‹åº" class="headerlink" title="ç¼–å†™ä¸»ç¨‹åº"></a>ç¼–å†™ä¸»ç¨‹åº</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExprDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ„å»ºå­—ç¬¦æµ</span></span><br><span class="line">        CodePointCharStream charStream = CharStreams.fromString(<span class="string">"1+2+3*4"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»å­—ç¬¦æµåˆ†æè¯æ³•ï¼Œ è§£æä¸ºtoken</span></span><br><span class="line">        ExprLexer lexer = <span class="keyword">new</span> ExprLexer(charStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»tokenè¿›è¡Œåˆ†æ</span></span><br><span class="line">        ExprParser parser = <span class="keyword">new</span> ExprParser(<span class="keyword">new</span> CommonTokenStream( lexer) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ç›‘å¬å™¨ï¼Œéå†è¯­æ³•æ ‘ï¼Œæ ¹æ®è¯­æ³•å®šä¹‰ï¼Œprogä¸ºè¯­æ³•æ ‘çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        ExprParser.ProgContext prog = parser.prog();</span><br><span class="line">        ParseTreeWalker walker = <span class="keyword">new</span> ParseTreeWalker();</span><br><span class="line">        walker.walk( <span class="keyword">new</span> ExprBaseListener(), prog );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨visitorï¼Œç”Ÿæˆè‡ªå®šä¹‰çš„å¯¹è±¡</span></span><br><span class="line">        Object accept = prog.accept(<span class="keyword">new</span> ExprBaseVisitor&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        System.out.println(accept);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°ç”Ÿæˆçš„è¯­æ³•æ ‘</span></span><br><span class="line">        System.out.println( prog.toStringTree(parser));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰-Visitor"><a href="#è‡ªå®šä¹‰-Visitor" class="headerlink" title="è‡ªå®šä¹‰ Visitor"></a>è‡ªå®šä¹‰ Visitor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvalExprVisitor</span> <span class="keyword">extends</span> <span class="title">ExprBaseVisitor</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">visitProg</span><span class="params">(ExprParser.ProgContext ctx)</span> </span>&#123;</span><br><span class="line">        ExprParser.ExprContext expr = ctx.expr();</span><br><span class="line">        <span class="keyword">return</span> visit(expr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">visitAddOrSub</span><span class="params">(ExprParser.AddOrSubContext ctx)</span> </span>&#123;</span><br><span class="line">        Integer expr1 = visit(ctx.expr(<span class="number">0</span>));</span><br><span class="line">        Integer expr2 = visit(ctx.expr(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"+"</span>.equals(ctx.getChild(<span class="number">1</span>).getText())) &#123;</span><br><span class="line">            <span class="keyword">return</span> expr1 + expr2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> expr1 - expr2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">visitSingle</span><span class="params">(ExprParser.SingleContext ctx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> visit(ctx.expr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">visitLieteral</span><span class="params">(ExprParser.LieteralContext ctx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.valueOf(ctx.INT().getText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">visitMultiOrDiv</span><span class="params">(ExprParser.MultiOrDivContext ctx)</span> </span>&#123;</span><br><span class="line">        Integer expr1 = visit(ctx.expr(<span class="number">0</span>));</span><br><span class="line">        Integer expr2 = visit(ctx.expr(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"*"</span>.equals(ctx.getChild(<span class="number">1</span>).getText())) &#123;</span><br><span class="line">            <span class="keyword">return</span> expr1 * expr2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> expr1 / expr2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="éªŒè¯ç»“æœ"><a href="#éªŒè¯ç»“æœ" class="headerlink" title="éªŒè¯ç»“æœ"></a>éªŒè¯ç»“æœ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExprDemo2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; testSet = Arrays.asList(</span><br><span class="line">                <span class="string">"1+2"</span>,</span><br><span class="line">                <span class="string">"1+2+3*4"</span>,</span><br><span class="line">                <span class="string">"3/3"</span>,</span><br><span class="line">                <span class="string">"10/2"</span>,</span><br><span class="line">                <span class="string">"5*5+10+5*5"</span>,</span><br><span class="line">                <span class="string">"6+5*(1+2)"</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; res = Arrays.asList(</span><br><span class="line">                <span class="number">3</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">60</span>, <span class="number">21</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; testSet.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// æ„å»ºå­—ç¬¦æµ</span></span><br><span class="line">            CodePointCharStream charStream = CharStreams.fromString(testSet.get(i));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä»å­—ç¬¦æµåˆ†æè¯æ³•ï¼Œ è§£æä¸ºtoken</span></span><br><span class="line">            ExprLexer lexer = <span class="keyword">new</span> ExprLexer(charStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä»tokenè¿›è¡Œåˆ†æ</span></span><br><span class="line">            ExprParser parser = <span class="keyword">new</span> ExprParser(<span class="keyword">new</span> CommonTokenStream(lexer));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨ç›‘å¬å™¨ï¼Œéå†è¯­æ³•æ ‘ï¼Œæ ¹æ®è¯­æ³•å®šä¹‰ï¼Œprogä¸ºè¯­æ³•æ ‘çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">            ExprParser.ProgContext prog = parser.prog();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨visitorï¼Œç”Ÿæˆè‡ªå®šä¹‰çš„å¯¹è±¡</span></span><br><span class="line">            Integer integer = prog.accept(<span class="keyword">new</span> EvalExprVisitor());</span><br><span class="line">            System.out.println(integer);</span><br><span class="line">            Assert.assertEquals(integer, res.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ï¼Œä¸Šè¿°çš„å†…å®¹å·²ç»è¶³ä»¥æ»¡è¶³æˆ‘ç ”ç©¶ Shardingjdbc çš„ Sql è¯­æ³•è§£æäº†ï¼Œå¦‚æœå¯¹ Listener æ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒ <a href="https://github.com/antlr/antlr4/blob/master/doc/listeners.md" target="_blank" rel="noopener">ä¼ é€é—¨</a></p><blockquote><p>å‚è€ƒ</p><p><a href="https://github.com/antlr/antlr4/blob/master/doc/index.md" target="_blank" rel="noopener">https://github.com/antlr/antlr4/blob/master/doc/index.md</a></p><p><a href="https://iamazy.github.io/2020/02/12/antlr4-jiao-cheng/" target="_blank" rel="noopener">https://iamazy.github.io/2020/02/12/antlr4-jiao-cheng/</a></p><p><a href="https://juejin.cn/post/7174054658460090381?searchId=20240727211235DCC7CEBC417B312D14AF" target="_blank" rel="noopener">https://juejin.cn/post/7174054658460090381?searchId=20240727211235DCC7CEBC417B312D14AF</a></p><p>æ³¨ï¼šæœ¬æ–‡ä¸­çš„ä¾‹å­å¼•ç”¨è‡ª </p><p><a href="https://juejin.cn/post/7174054658460090381?searchId=20240727211235DCC7CEBC417B312D14AF" target="_blank" rel="noopener">https://juejin.cn/post/7174054658460090381?searchId=20240727211235DCC7CEBC417B312D14AF</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åœ¨çœ‹ Shardingjdbc æºç ï¼Œå…¶ä¸­ Sql ä½¿ç”¨çš„è¯­æ³•è§£æå™¨æ˜¯ Antlr4ï¼Œç»è¿‡äº†è§£è®¸å¤šæ¡†æ¶éƒ½ä½¿ç”¨ Antlr4 ä½œä¸ºè¯­æ³•è§£æå™¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>shardingjdbc æ•°æ®åˆ†ç‰‡ç¬”è®°</title>
    <link href="http://example.com/2024/06/29/shardingjdbc-%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%E7%AC%94%E8%AE%B0/"/>
    <id>http://example.com/2024/06/29/shardingjdbc-%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%E7%AC%94%E8%AE%B0/</id>
    <published>2024-06-29T13:12:00.000Z</published>
    <updated>2024-06-29T13:34:31.709Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åˆ†ç‰‡è·¯ç”±å¼•æ“"><a href="#åˆ†ç‰‡è·¯ç”±å¼•æ“" class="headerlink" title="åˆ†ç‰‡è·¯ç”±å¼•æ“"></a>åˆ†ç‰‡è·¯ç”±å¼•æ“</h3><p>org.apache.shardingsphere.core.route.type.RoutingEngine</p><p><img src="https://s21.ax1x.com/2024/06/29/pkcknFP.png" /> <br></p><p><img src="https://s21.ax1x.com/2024/06/29/pkckKW8.png" /> <br></p><img src="https://s21.ax1x.com/2024/06/29/pkcAPkq.md.png" />å…·ä½“é€‰æ‹©ä»€ä¹ˆåˆ†ç‰‡è·¯ç”±å¼•æ“å–å†³äºæ‰§è¡Œçš„ sql<p>org.apache.shardingsphere.core.route.router.sharding.ShardingRouter#route</p><h3 id="åˆ†ç‰‡è·¯ç”±ç­–ç•¥"><a href="#åˆ†ç‰‡è·¯ç”±ç­–ç•¥" class="headerlink" title="åˆ†ç‰‡è·¯ç”±ç­–ç•¥"></a>åˆ†ç‰‡è·¯ç”±ç­–ç•¥</h3><p>org.apache.shardingsphere.core.strategy.route.ShardingStrategy</p><img src="https://s21.ax1x.com/2024/06/29/pkcklQg.png" /><ul><li><p>org.apache.shardingsphere.core.strategy.route.none.NoneShardingStrategy  ä¸è¿›è¡Œåˆ†ç‰‡è·¯ç”±</p></li><li><p>org.apache.shardingsphere.core.strategy.route.none.NoneShardingStrategy æ ¹æ®è¡Œè¡¨è¾¾å¼è·¯ç”±ï¼Œä¸æ”¯æŒæŒ‰æ¡ä»¶èŒƒå›´åˆ†ç‰‡</p></li><li><p>org.apache.shardingsphere.core.strategy.route.standard.StandardShardingStrategy ç»å…¸åˆ†ç‰‡ç­–ç•¥ï¼Œå†…ç½®æŒ‰å€¼åˆ†ç‰‡ç®—æ³•ï¼ŒæŒ‰èŒƒå›´åˆ†é…ç®—æ³•</p><img src="https://s21.ax1x.com/2024/06/29/pkck1yQ.png" /></li><li><p>org.apache.shardingsphere.core.strategy.route.complex.ComplexShardingStrategy ç»„åˆæ¡ä»¶åˆ†ç‰‡ç­–ç•¥ï¼Œé€»è¾‘éœ€è¦æ‰§è¡Œå®ç°ï¼Œ==åŒæ—¶å¦‚æœæŸäº›é€»è¾‘ StandardShardingStrategy æ— æ³•å®ç°ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ ComplexShardingStrategy==ã€‚</p></li><li><p>org.apache.shardingsphere.core.strategy.route.hint.HintShardingStrategy å¼ºåˆ¶åˆ†ç‰‡ç­–ç•¥ï¼Œé€‚åˆéœ€è¦æŒ‰ç…§åˆ†æ•°æ®åº“çš„åˆ—è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯ï¼Œæ¯”å¦‚æ ¹æ® æ¥æºip è¿›è¡Œåˆ†ç‰‡ï¼Œåº•å±‚åŸºäº ThreadLocal å®ç°ï¼Œéœ€è¦åœ¨æ‰§è¡Œ sql å‰æŒ‡å®šåˆ†ç‰‡å€¼ã€‚</p></li></ul><h3 id="ä½¿ç”¨-DEMO"><a href="#ä½¿ç”¨-DEMO" class="headerlink" title="ä½¿ç”¨ DEMO"></a>ä½¿ç”¨ DEMO</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.shardingsphere.example.sharding.raw.jdbc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.config.sharding.KeyGeneratorConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.config.sharding.ShardingRuleConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.config.sharding.TableRuleConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.config.sharding.strategy.ComplexShardingStrategyConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.config.sharding.strategy.StandardShardingStrategyConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.sharding.complex.ComplexKeysShardingAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.sharding.complex.ComplexKeysShardingValue;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.core.constant.properties.ShardingPropertiesConstant;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.example.algorithm.PreciseModuloShardingTableAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.example.config.ExampleConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.example.core.api.DataSourceUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.shardingjdbc.api.ShardingDataSourceFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingMultiDatabasesAndTablesConfigurationPrecise</span> <span class="keyword">implements</span> <span class="title">ExampleConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        ShardingRuleConfiguration shardingRuleConfig = <span class="keyword">new</span> ShardingRuleConfiguration();</span><br><span class="line">        shardingRuleConfig.getTableRuleConfigs().add(getOrderTableRuleConfiguration());</span><br><span class="line">        shardingRuleConfig.getTableRuleConfigs().add(getOrderItemTableRuleConfiguration());</span><br><span class="line">        shardingRuleConfig.getBindingTableGroups().add(<span class="string">"t_order, t_order_item"</span>);</span><br><span class="line">        shardingRuleConfig.getBroadcastTables().add(<span class="string">"t_address"</span>);</span><br><span class="line"><span class="comment">//        shardingRuleConfig.setDefaultDatabaseShardingStrategyConfig(new InlineShardingStrategyConfiguration("user_id", "demo_ds_$&#123;user_id % 2&#125;"));</span></span><br><span class="line">        shardingRuleConfig.setDefaultDatabaseShardingStrategyConfig(<span class="keyword">new</span> ComplexShardingStrategyConfiguration(<span class="string">"user_id"</span>, <span class="keyword">new</span> CustomComplexKeysShardingAlgorithm()));</span><br><span class="line">        shardingRuleConfig.setDefaultTableShardingStrategyConfig(<span class="keyword">new</span> StandardShardingStrategyConfiguration(<span class="string">"order_id"</span>, <span class="keyword">new</span> PreciseModuloShardingTableAlgorithm()));</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.put(ShardingPropertiesConstant.SQL_SHOW.getKey(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> ShardingDataSourceFactory.createDataSource(createDataSourceMap(), shardingRuleConfig, props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> TableRuleConfiguration <span class="title">getOrderTableRuleConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TableRuleConfiguration result = <span class="keyword">new</span> TableRuleConfiguration(<span class="string">"t_order"</span>, <span class="string">"demo_ds_$&#123;0..1&#125;.t_order_$&#123;[0, 1]&#125;"</span>);</span><br><span class="line">        result.setKeyGeneratorConfig(<span class="keyword">new</span> KeyGeneratorConfiguration(<span class="string">"SNOWFLAKE"</span>, <span class="string">"order_id"</span>, getProperties()));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> TableRuleConfiguration <span class="title">getOrderItemTableRuleConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TableRuleConfiguration result = <span class="keyword">new</span> TableRuleConfiguration(<span class="string">"t_order_item"</span>, <span class="string">"demo_ds_$&#123;0..1&#125;.t_order_item_$&#123;[0, 1]&#125;"</span>);</span><br><span class="line">        result.setKeyGeneratorConfig(<span class="keyword">new</span> KeyGeneratorConfiguration(<span class="string">"SNOWFLAKE"</span>, <span class="string">"order_item_id"</span>, getProperties()));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, DataSource&gt; <span class="title">createDataSourceMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, DataSource&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">"demo_ds_0"</span>, DataSourceUtil.createDataSource(<span class="string">"demo_ds_0"</span>));</span><br><span class="line">        result.put(<span class="string">"demo_ds_1"</span>, DataSourceUtil.createDataSource(<span class="string">"demo_ds_1"</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Properties <span class="title">getProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties result = <span class="keyword">new</span> Properties();</span><br><span class="line">        result.setProperty(<span class="string">"worker.id"</span>, <span class="string">"123"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomComplexKeysShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">ComplexKeysShardingAlgorithm</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ComplexKeysShardingValue&lt;Integer&gt; shardingValue)</span> </span>&#123;</span><br><span class="line">            List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            shardingValue.getColumnNameAndShardingValuesMap().forEach((column, valueList) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(column, <span class="string">"user_id"</span>)) &#123;</span><br><span class="line">                    valueList.forEach(value -&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> (value % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                            result.addAll(availableTargetNames);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            Optional&lt;String&gt; optional = availableTargetNames.stream().filter(name -&gt; name.endsWith(String.valueOf(value % <span class="number">2</span>))).findFirst();</span><br><span class="line">                            optional.ifPresent(result::add);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul><li>==å¦‚æœ sql è¯­å¥æ²¡æœ‰å‘½ä¸­åˆ†ç‰‡æ¡ä»¶ï¼Œå°†åœ¨æ‰€æœ‰çš„ç‰©ç†è¡¨ä¸­æ‰§è¡Œ sql==</li><li>hint å¿…é¡»è¦åœ¨æ‰§è¡Œ sql å‰è®¾ç½®æ¡ä»¶å€¼ï¼Œå¦åˆ™ä¼šå’Œä¸Šè¿°ä¸€æ ·å› æœªå‘½ä¸­åˆ†ç‰‡æ¡ä»¶è€Œåœ¨æ‰€æœ‰ç‰©ç†è¡¨æ‰§è¡Œ sql</li><li>ç›®å‰æ”¯æŒåŸç”Ÿçš„åˆ†ç‰‡ç­–ç•¥ï¼Œå¦‚æœè¦æ”¯æŒè‡ªå®šä¹‰çš„å¯èƒ½å¾—æŠŠå¤§éƒ¨åˆ†ä¸Šæ¸¸ç»„ä»¶ç»™æ”¹äº†</li><li>æ”¯æŒå¾ˆå¤š sqi æ‰©å±•é’©å­ï¼Œä¾‹å¦‚ org.apache.shardingsphere.sql.parser.hook.SPIParsingHook</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;åˆ†ç‰‡è·¯ç”±å¼•æ“&quot;&gt;&lt;a href=&quot;#åˆ†ç‰‡è·¯ç”±å¼•æ“&quot; class=&quot;headerlink&quot; title=&quot;åˆ†ç‰‡è·¯ç”±å¼•æ“&quot;&gt;&lt;/a&gt;åˆ†ç‰‡è·¯ç”±å¼•æ“&lt;/h3&gt;&lt;p&gt;org.apache.shardingsphere.core.route.type.RoutingEngin</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>è®°å½•ä¸€æ¬¡å¢é‡æ•°æ®ä¸€è‡´æ€§é—®é¢˜</title>
    <link href="http://example.com/2023/11/19/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%A2%9E%E9%87%8F%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/"/>
    <id>http://example.com/2023/11/19/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%A2%9E%E9%87%8F%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/</id>
    <published>2023-11-19T02:11:45.000Z</published>
    <updated>2023-11-19T15:11:48.859Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘æ”¶åˆ°å®¢æˆ·æŠ•è¯‰å‡ºç°æ•°æ®æ— æ³•æ“ä½œçš„é—®é¢˜ï¼Œç»è¿‡æ’æŸ¥ï¼ŒMysql å’Œ ES æ•°æ®å‡ºç°ä¸€è‡´æ€§é—®é¢˜ã€‚æˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯æ˜¯å®šäº Mysql binlog æŠ•é€’åˆ° Kafkaï¼Œå¢é‡æœåŠ¡é¡ºåºæ¶ˆè´¹ Kafka ä¸­çš„æ¶ˆæ¯ï¼Œæ›´æ–° ES ä¸­çš„æ–‡æ¡£ã€‚</p></blockquote><h3 id="ç´¢å¼•ç»“æ„"><a href="#ç´¢å¼•ç»“æ„" class="headerlink" title="ç´¢å¼•ç»“æ„"></a>ç´¢å¼•ç»“æ„</h3><p>åœ¨åˆ†æé—®é¢˜å‰å…ˆç®€å•çœ‹ä¸‹ç´¢å¼•ç»“æ„ï¼Œè¿™é‡Œåªçœ‹å‡ºç°é—®é¢˜çš„å­—æ®µï¼Œä¸»è¦å°±æ˜¯ç”¨äºå­˜å‚¨æ ‡ç­¾ id çš„ä¸€ä¸ª long ç±»å‹çš„å­—æ®µï¼Œå­˜çš„æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">    <span class="attr">"f_tag_id"</span> : &#123;</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"long"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"f_status"</span> : &#123;</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"byte"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h3><ul><li>å…ˆç®€å•çœ‹ä¸€ä¸‹æ ‡ç­¾å¢é‡çš„é€»è¾‘ï¼Œç”±äºæ ‡ç­¾å­˜çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥åœ¨æ›´æ–°çš„æ—¶å€™æ˜¯å…ˆæŠŠæ–‡æ¡£æŸ¥è¯¢å‡ºæ¥ï¼Œå†å¯¹ç›¸åº”çš„æ•°ç»„å­—æ®µåšå…ƒç´ çš„æ–°å¢æˆ–è€…åˆ é™¤ï¼Œç„¶åå†é‡æ–°ç´¢å¼•åˆ° ES ä¸­ã€‚</li><li>ç”Ÿäº§ä¸­çš„åœºæ™¯æ˜¯åŒæ—¶æœ‰ä¸¤ä¸ª binlog å¹¶å‘ï¼Œä½†æ˜¯æ˜¯åˆ†ä¸¤æ¬¡æ¶ˆè´¹ï¼ˆåŒä¸€æ‰¹æ¬¡çš„æ¶ˆæ¯æˆ‘ä»¬è¿™è¾¹ä¼šåœ¨å†…å­˜è¿›è¡Œç»„è£…ï¼‰ï¼ŒA è¡¨çš„ binlog å…ˆæ›´æ–° f_statusï¼ŒB è¡¨ (æ ‡ç­¾å…³è”è¡¨) çš„ binlog å…ˆå°†æ–‡æ¡£æŸ¥è¯¢å‡ºæ¥ï¼Œæ›´æ–°å®Œä¹‹åå†å°†æ•´ä¸ªæ–‡æ¡£ç´¢å¼•å› ESï¼ˆæ›´æ–°ä»£ç é€šç”¨æ€§ï¼Œæ‰€ä»¥æ˜¯æ›´æ–°æ•´ä¸ªæ–‡æ¡£ï¼‰ã€‚</li><li>ç”±äº ES ç´¢å¼•æ›´æ–°åˆ·ç›˜å¹¶éå®æ—¶çš„ï¼Œå¯¼è‡´ B è¡¨æŸ¥è¯¢å‡ºæ¥çš„æ–‡æ¡£æ˜¯æ—§çš„ï¼Œæ‰€ä»¥ B è¡¨åœ¨æ›´æ–°ç´¢å¼•æ—¶å°†æ—§çš„æ•°æ®è¦†ç›–äº†æ–°çš„æ•°æ®ã€‚</li><li>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š<ul><li>å‡è®¾åŸæœ¬ f_status = 0, f_tag_id = []</li><li>A è¡¨æ›´æ–° f_status =1ï¼Œæ­¤æ—¶ f_status = 1, f_tag_id = []</li><li>B è¡¨æ›´æ–° f_tag_id = [1]ï¼Œç”±äº ES åˆ·ç›˜å­˜åœ¨å»¶è¿Ÿï¼Œå¯¼è‡´æ›´æ–°çš„æ•°æ®ä¸º f_status = 0, f_tag_id = [1]</li></ul></li></ul><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ul><li><p>æœ€åˆçš„æƒ³æ³•æ˜¯åªæ›´æ–° f_tag_id å­—æ®µï¼Œä½†æ˜¯è¿™æ ·å…¶å®è¿˜æ˜¯ä¼šæœ‰é—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­ B è¡¨ (æ ‡ç­¾å…³è”è¡¨) é’ˆå¯¹åŒä¸€æ¡è®°å½•ä¸¤ä¸ªæ ‡ç­¾å…³è”æ•°æ®ï¼Œæ„å‘³ç€ä¼šæœ‰ä¸¤ä¸ª binlog ç”Ÿæˆï¼Œå‡è®¾å¾ˆä¸å·§ï¼ŒKafka æ¶ˆè´¹è€…åˆ†äº†ä¸¤ä¸ªæ‰¹æ¬¡å»æ›´æ–°ç´¢å¼•ï¼Œå°±ä¼šé€ æˆå’Œä¸Šè¿°ç±»ä¼¼çš„åœºæ™¯ã€‚</p><ul><li>å‡è®¾åŸæœ¬ f_tag_id = [1,2]</li><li>ç¬¬ä¸€æ¡ binlog æ›´æ–° f_tag_id = [1,2,3]</li><li>ç¬¬äºŒæ¡ binlog æ¶ˆè´¹æ—¶ï¼Œå…ˆæŸ¥è¯¢ f_tag_id = [1,2]ï¼Œæ­¤æ—¶åœ¨å»æ›´æ–° f_tag_id å°±ä¼šå˜æˆ [1,2,4]ï¼Œè¿˜æ˜¯ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜</li></ul></li><li><p>ç¬¬ä¸€ä¸ªæ–¹æ¡ˆè¡Œä¸é€šï¼Œé‚£èƒ½ä¸èƒ½è®© f_tag_id åƒæ›´æ–°å…¶ä»–å­—æ®µä¸€æ ·ï¼Œä¸éœ€è¦å…ˆæŸ¥è¯¢å‡ºæ¥ç»„è£…å†é‡æ–°ç´¢å¼•å› ESï¼Œç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œé‚£å°±æ˜¯åˆ©ç”¨ ES è„šæœ¬æ›´æ–°ï¼Œå› ä¸ºæ›´æ–°æ“ä½œæ˜¯å¯ä»¥ç›´æ¥æ›´æ–°å†…å­˜çš„æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®æ˜¯å®æ—¶çš„ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script"</span>: &#123;</span><br><span class="line">    <span class="attr">"source"</span>: <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">      List tagIdList = ctx._source.f_tag_id == null </span></span><br><span class="line"><span class="string">          ? new ArrayList() </span></span><br><span class="line"><span class="string">          : ctx._source.f_tag_id;</span></span><br><span class="line"><span class="string">      if("</span>insert<span class="string">".equals(params.method) </span></span><br><span class="line"><span class="string">        &amp;&amp; !tagIdList.contains(params.changeTagId))&#123;</span></span><br><span class="line"><span class="string">        tagIdList.add(params.changeTagId);</span></span><br><span class="line"><span class="string">      &#125; else if("</span>delete<span class="string">".equals(params.method)</span></span><br><span class="line"><span class="string">        &amp;&amp; tagIdList.contains(params.changeTagId))&#123;</span></span><br><span class="line"><span class="string">         tagIdList.remove(tagIdList.indexOf(params.changeTagId));</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      ctx._source.f_tag_id = tagIdList;</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span>,</span><br><span class="line">    <span class="attr">"lang"</span>: <span class="string">"painless"</span>,</span><br><span class="line">    <span class="attr">"params"</span>: &#123;</span><br><span class="line">      <span class="attr">"changeTagId"</span>: <span class="number">12</span>,</span><br><span class="line">      <span class="attr">"method"</span>: <span class="string">"insert"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"upsert"</span>: &#123;</span><br><span class="line">    <span class="attr">"f_tag_id"</span>: [<span class="number">12</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤§æ¦‚æ€è·¯å°±æ˜¯åˆ©ç”¨è„šæœ¬ç›´æ¥é’ˆå¯¹ f_tag_id è¿›è¡Œå…ƒç´ å˜æ›´ï¼Œè¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒæŸ¥å‡ºæ¥çš„ f_tad_id æ˜¯æ—§çš„äº†ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/docs-update.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.14/docs-update.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.14/painless-types.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/painless/7.14/painless-types.html</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘æ”¶åˆ°å®¢æˆ·æŠ•è¯‰å‡ºç°æ•°æ®æ— æ³•æ“ä½œçš„é—®é¢˜ï¼Œç»è¿‡æ’æŸ¥ï¼ŒMysql å’Œ ES æ•°æ®å‡ºç°ä¸€è‡´æ€§é—®é¢˜ã€‚æˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯æ˜¯å®šäº Mysql binlog æŠ•é€’åˆ° Kafkaï¼Œå¢é‡æœåŠ¡é¡ºåºæ¶ˆè´¹ Kafka ä¸­çš„æ¶ˆæ¯ï¼Œæ›´æ–° ES ä¸­çš„æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;/blockq</summary>
      
    
    
    
    
    <category term="ES" scheme="http://example.com/tags/ES/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡ä¹‹ 2PC çš„ XA è§„èŒƒå®ç°</title>
    <link href="http://example.com/2023/07/25/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8B-2PC-%E7%9A%84-XA-%E8%A7%84%E8%8C%83%E5%AE%9E%E7%8E%B0/"/>
    <id>http://example.com/2023/07/25/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8B-2PC-%E7%9A%84-XA-%E8%A7%84%E8%8C%83%E5%AE%9E%E7%8E%B0/</id>
    <published>2023-07-25T02:11:00.000Z</published>
    <updated>2023-07-25T02:16:46.841Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åˆšå¼€å§‹å­¦ä¹ åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆå°±æ˜¯ 2PCï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å†™è¿‡ demoï¼Œä¹Ÿæ²¡æœ‰ç”Ÿäº§ä¸­ä½¿ç”¨è¿‡è¿™ç§æ–¹æ¡ˆï¼Œéšæ„æ˜¯æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿã€‚æœ¬æ–‡åªåœ¨å®ç°ä¸€ä¸ª 2PC XAæ–¹æ¡ˆçš„ demoï¼Œä¸‡ä¸€å°†æ¥éœ€è¦ç”¨åˆ°è¿™ç§æ–¹æ¡ˆä¸è‡³äºå°‘ä¹Ÿä¸æ‡‚ã€‚</p></blockquote><h4 id="2PC-ç®€ä»‹"><a href="#2PC-ç®€ä»‹" class="headerlink" title="2PC ç®€ä»‹"></a>2PC ç®€ä»‹</h4><p>2PC ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå‡†å¤‡é˜¶æ®µã€æäº¤é˜¶æ®µã€‚</p><p><strong>å‡†å¤‡é˜¶æ®µ</strong>ï¼šTMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å‘ RMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰å‘é€ Prepare æ¶ˆæ¯ï¼ŒRM æœ¬åœ°æ‰§è¡Œäº‹åŠ¡ï¼Œæ­¤æ—¶ RM å¹¶æœªæäº¤æœ¬åœ°äº‹åŠ¡ï¼ˆä¸Šé”ï¼‰ï¼ŒRM å‘é€æ‰§è¡ŒæˆåŠŸ/å¤±è´¥ç»™åˆ° TM</p><p><strong>æäº¤é˜¶æ®µ</strong>ï¼šTM å‘ RM å‘é€ Commit/Rollback æ¶ˆæ¯ï¼ŒRM æ ¹æ® TM å‘é€çš„æ¶ˆæ¯æ‰§è¡Œæäº¤æˆ–å›æ»šæœ¬åœ°äº‹åŠ¡ã€‚</p><p>ä»¥ä¸‹æ˜¯ç½‘ä¸Šæ‰¾çš„ä¸€å¼  2PC çš„æµç¨‹å›¾ï¼š</p><img src="/images/d168e9ad85a69717fcd5f4296458e76b.png" alt="æˆªå›¾" style="zoom:80%;" /><h4 id="XA-æ–¹æ¡ˆ"><a href="#XA-æ–¹æ¡ˆ" class="headerlink" title="XA æ–¹æ¡ˆ"></a>XA æ–¹æ¡ˆ</h4><blockquote><p>2PC çš„ä¼ ç»Ÿæ–¹æ¡ˆæ˜¯åœ¨æ•°æ®åº“å±‚é¢å®ç°çš„ï¼Œå¦‚ Oracleã€MySQL éƒ½æ”¯æŒ 2PC åè®®ï¼Œä¸ºäº†ç»Ÿä¸€æ ‡å‡†å‡å°‘è¡Œä¸šå†…ä¸å¿…è¦çš„å¯¹æ¥æˆæœ¬ï¼Œéœ€è¦åˆ¶å®šæ ‡å‡†åŒ–çš„å¤„ç†æ¨¡å‹åŠæ¥å£æ ‡å‡†ï¼Œå›½é™…å¼€æ”¾æ ‡å‡†ç»„ç»‡ Open Group å®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹DTPï¼ˆDistributed Transaction Processing Reference Modelï¼‰ã€‚</p></blockquote><p><strong>DTP æ¨¡å‹å®šä¹‰å¦‚ä¸‹è§’è‰²ï¼š</strong></p><ul><li>APï¼ˆApplication Programï¼‰ï¼šå³åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ç†è§£ä¸ºä½¿ç”¨ DTP åˆ†å¸ƒå¼äº‹åŠ¡çš„ç¨‹åºã€‚</li><li>RMï¼ˆResource Managerï¼‰ï¼šå³èµ„æºç®¡ç†å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºäº‹åŠ¡çš„å‚ä¸è€…ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æŒ‡ä¸€ä¸ªæ•°æ®åº“å®ä¾‹ï¼Œé€šè¿‡èµ„æºç®¡ç†å™¨å¯¹è¯¥æ•°æ®åº“è¿›è¡Œæ§åˆ¶ï¼Œèµ„æºç®¡ç†å™¨æ§åˆ¶ç€åˆ†æ”¯äº‹åŠ¡ã€‚</li><li>TMï¼ˆTransaction Managerï¼‰ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œè´Ÿè´£åè°ƒå’Œç®¡ç†äº‹åŠ¡ï¼Œäº‹åŠ¡ç®¡ç†å™¨æ§åˆ¶ç€å…¨å±€äº‹åŠ¡ï¼Œç®¡ç†äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶åè°ƒå„ä¸ª RMã€‚å…¨å±€äº‹åŠ¡æ˜¯æŒ‡åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç¯å¢ƒä¸­ï¼Œéœ€è¦æ“ä½œå¤šä¸ªæ•°æ®åº“å…±åŒå®Œæˆä¸€ä¸ªå·¥ä½œï¼Œè¿™ä¸ªå·¥ä½œå³æ˜¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚</li><li>DTP æ¨¡å‹å®šä¹‰TMå’ŒRMä¹‹é—´é€šè®¯çš„æ¥å£è§„èŒƒå« XAï¼Œç®€å•ç†è§£ä¸ºæ•°æ®åº“æä¾›çš„ 2PC æ¥å£åè®®ï¼ŒåŸºäºæ•°æ®åº“çš„ XA åè®®æ¥å®ç° 2PC åˆç§°ä¸º XA æ–¹æ¡ˆ</li></ul><p><strong>XA æ‰§è¡Œæµç¨‹ï¼šï¼ˆä½œè€…æ¯”è¾ƒæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹ï¼‰</strong></p><blockquote><p>æµç¨‹å¯ä»¥å‚çœ‹å¤§ä½¬çš„åšå®¢ï¼š<a href="https://zhuanlan.zhihu.com/p/263555694" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/263555694</a></p></blockquote><p><strong>å…·ä½“å®ç°ï¼š</strong></p><blockquote><p> Javaäº‹åŠ¡APIï¼ˆJTAï¼šJava Transaction APIï¼‰å’Œå®ƒçš„åŒèƒJavaäº‹åŠ¡æœåŠ¡ï¼ˆJTSï¼šJava Transaction Serviceï¼‰ï¼Œä¸ºJ2EEå¹³å°æä¾›äº†åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼ˆdistributed transactionï¼‰çš„èƒ½åŠ›ã€‚ æŸç§ç¨‹åº¦ä¸Šï¼Œå¯ä»¥è®¤ä¸ºJTAè§„èŒƒæ˜¯XAè§„èŒƒçš„Javaç‰ˆï¼Œå…¶æŠŠXAè§„èŒƒä¸­è§„å®šçš„DTPæ¨¡å‹äº¤äº’æ¥å£æŠ½è±¡æˆJavaæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¹¶è§„å®šæ¯ä¸ªæ–¹æ³•è¦å®ç°ä»€ä¹ˆæ ·çš„åŠŸèƒ½ã€‚</p></blockquote><p>ä¸‹é¢çš„ä¾‹å­åŸºäº Atomikos TransactionEssentials å®ç° JTAï¼š </p><p>æ‰€éœ€è¦ä¾èµ–ï¼Œè¿™é‡Œç”¨çš„ Gradleï¼Œç”¨çš„ Maven å®¶äººä»¬å¯ä»¥è‡ªè¡Œæ‰¾ä¸‹ä¾èµ–</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">implementation platform(<span class="string">'org.springframework.boot:spring-boot-dependencies:2.7.5'</span>)</span><br><span class="line">implementation <span class="string">'com.atomikos:transactions-jdbc:6.0.0'</span></span><br><span class="line">implementation <span class="string">'com.atomikos:transactions-jta:6.0.0'</span></span><br><span class="line">implementation <span class="string">'javax.transaction:jta:1.1'</span></span><br><span class="line">implementation <span class="string">'com.alibaba:druid:1.2.18'</span></span><br><span class="line">implementation <span class="string">'org.springframework.boot:spring-boot-starter-web'</span></span><br><span class="line">implementation <span class="string">'org.springframework.boot:spring-boot-test'</span></span><br><span class="line">implementation <span class="string">'org.springframework.boot:spring-boot-starter-test'</span></span><br><span class="line">implementation <span class="string">'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.2.1'</span></span><br><span class="line">implementation <span class="string">'org.springframework.boot:spring-boot'</span></span><br><span class="line">implementation <span class="string">'org.springframework:spring-tx'</span></span><br><span class="line">implementation <span class="string">'mysql:mysql-connector-java:8.0.33'</span></span><br></pre></td></tr></table></figure><p>æ•°æ®åº“é…ç½®ï¼Œè¿™é‡Œæˆ‘åœ¨æœ¬åœ°ä¸­å¯åŠ¨äº†ä¸¤ä¸ª Mysql å®ä¾‹ï¼Œæ•°æ®åº“åªè¦èƒ½æ”¯æŒ XA åè®®å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œç”¨çš„Druidï¼Œå…¶ä»–è¿æ¥æ± åªè¦å®ç°äº†javax.sql.XADataSourceå³å¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DruidXADataSource <span class="title">createDruidXADataSource</span><span class="params">(String url, String username, String password)</span> </span>&#123;</span><br><span class="line">        DruidXADataSource druidXADataSource = <span class="keyword">new</span> DruidXADataSource();</span><br><span class="line">        <span class="comment">//&lt;a href="https://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8"/&gt;</span></span><br><span class="line">        druidXADataSource.setUrl(url);</span><br><span class="line">        druidXADataSource.setUsername(username);</span><br><span class="line">        druidXADataSource.setPassword(password);</span><br><span class="line">        druidXADataSource.setMaxActive(<span class="number">5</span>);</span><br><span class="line">        druidXADataSource.setInitialSize(<span class="number">1</span>);</span><br><span class="line">        druidXADataSource.setMaxWait(<span class="number">15000</span>);</span><br><span class="line">        druidXADataSource.setMinIdle(<span class="number">1</span>);</span><br><span class="line">        druidXADataSource.setTestOnBorrow(<span class="keyword">false</span>);</span><br><span class="line">        druidXADataSource.setTestWhileIdle(<span class="keyword">true</span>);</span><br><span class="line">        druidXADataSource.setValidationQuery(<span class="string">"select 1"</span>);</span><br><span class="line">        druidXADataSource.setTimeBetweenEvictionRunsMillis(<span class="number">60000</span>);</span><br><span class="line">        druidXADataSource.setMinEvictableIdleTimeMillis(<span class="number">300000</span>);</span><br><span class="line">        druidXADataSource.setAsyncInit(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> druidXADataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œæ˜¯3306ç«¯å£çš„å®ä¾‹é…ç½®</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(value = <span class="string">"com.jl.demo.spring.repository.mapper.db3306"</span>, sqlSessionFactoryRef = <span class="string">"sqlSessionFactory3306"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig3306</span> <span class="keyword">extends</span> <span class="title">AbstractDataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource3306</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AtomikosDataSourceBean datasource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        DruidXADataSource druidXADataSource = createDruidXADataSource(<span class="string">"jdbc:mysql://localhost:3306/xa_test"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        datasource.setXaDataSource(druidXADataSource);</span><br><span class="line">        <span class="comment">//atomikosè¦æ±‚ä¸ºæ¯ä¸ªAtomikosDataSourceBeanåç§°</span></span><br><span class="line">        datasource.setUniqueResourceName(<span class="string">"local_3306"</span>);</span><br><span class="line">        <span class="keyword">return</span> datasource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactory3306</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource3306());</span><br><span class="line">        PathMatchingResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">        sqlSessionFactoryBean.setMapperLocations(resolver.getResources(<span class="string">"classpath:/mybatis/db3306/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œæ˜¯3308ç«¯å£çš„å®ä¾‹é…ç½®</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(value = <span class="string">"com.jl.demo.spring.repository.mapper.db3308"</span>, sqlSessionFactoryRef = <span class="string">"sqlSessionFactory3308"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig3308</span> <span class="keyword">extends</span> <span class="title">AbstractDataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource3308</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AtomikosDataSourceBean datasource = <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">        DruidXADataSource druidXADataSource = createDruidXADataSource(<span class="string">"jdbc:mysql://localhost:3308/xa_test"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        datasource.setXaDataSource(druidXADataSource);</span><br><span class="line">        datasource.setUniqueResourceName(<span class="string">"local_3308"</span>);</span><br><span class="line">        <span class="keyword">return</span> datasource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactory3308</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource3308());</span><br><span class="line">        PathMatchingResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">        sqlSessionFactoryBean.setMapperLocations(resolver.getResources(<span class="string">"classpath:/mybatis/db3308/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡ç›¸å…³é…ç½®ï¼Œspring å·²ç»å¸®æˆ‘ä»¬æŠŠ JtaTransactionManager å°è£…å¥½äº†ï¼Œåº•å±‚ä½¿ç”¨çš„æ˜¯æˆ‘ä»¬ä¼ å…¥çš„äº‹åŠ¡ç®¡ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®atomikosäº‹åŠ¡ç®¡ç†å™¨ </span></span><br><span class="line"><span class="comment">     */</span> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserTransactionManager <span class="title">userTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserTransactionManager userTransactionManager = <span class="keyword">new</span> UserTransactionManager();</span><br><span class="line">        userTransactionManager.setForceShutdown(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> userTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®jtaäº‹åŠ¡ç®¡ç†å™¨ï¼Œåº•å±‚ä½¿ç”¨atomikosäº‹åŠ¡ç®¡ç†å™¨ </span></span><br><span class="line"><span class="comment">     */</span> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">jtaTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager();</span><br><span class="line">        jtaTransactionManager.setTransactionManager(userTransactionManager());</span><br><span class="line">        <span class="keyword">return</span> jtaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ç®€å•çœ‹ä¸€ä¸‹ service å±‚ï¼Œç”±äºæœ¬ä¾‹å­ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯• Jta æ˜¯å¦èƒ½æ­£ç¡®å›æ»šä¸¤ä¸ªæ•°æ®åº“å®ä¾‹ï¼Œæ‰€ä»¥ç”¨äº†ä¸¤ä¸ªç›¸åŒçš„è¡¨ï¼Œä¸å«ä¸šåŠ¡å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper3306 userMapper3306;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper3308 userMapper3308;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(transactionManager = <span class="string">"jtaTransactionManager"</span>, rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">insert</span>() </span>&#123;</span><br><span class="line">        User user3306 = <span class="keyword">new</span> User();</span><br><span class="line">        user3306.setName(<span class="string">"111"</span>);</span><br><span class="line">        userMapper3306.insert(user3306);</span><br><span class="line"></span><br><span class="line">        com.jl.demo.spring.repository.model.db3308.User user3308 = <span class="keyword">new</span> com.jl.demo.spring.repository.model.db3308.User();</span><br><span class="line">        user3308.setName(<span class="string">"222"</span>);</span><br><span class="line">        userMapper3308.insert(user3308);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= AtomikosTestApplication<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">UserServiceImplTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userService.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/JerryQTQcjl/distributed-transaction-demo/tree/master/atomikos-xa-demo" target="_blank" rel="noopener">https://github.com/JerryQTQcjl/distributed-transaction-demo/tree/master/atomikos-xa-demo</a></p><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="http://www.tianshouzhi.com/api/tutorials/distributed_transaction/386" target="_blank" rel="noopener">http://www.tianshouzhi.com/api/tutorials/distributed_transaction/386</a></p><p><a href="https://github.com/atomikos/transactions-essentials" target="_blank" rel="noopener">https://github.com/atomikos/transactions-essentials</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åˆšå¼€å§‹å­¦ä¹ åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆå°±æ˜¯ 2PCï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å†™è¿‡ demoï¼Œä¹Ÿæ²¡æœ‰ç”Ÿäº§ä¸­ä½¿ç”¨è¿‡è¿™ç§æ–¹æ¡ˆï¼Œéšæ„æ˜¯æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿã€‚æœ¬æ–‡åªåœ¨å®ç°ä¸€ä¸ª 2PC XAæ–¹æ¡ˆçš„ demoï¼Œä¸‡ä¸€å°†æ¥éœ€è¦ç”¨åˆ°è¿™ç§æ–¹æ¡ˆä¸è‡³äºå°‘ä¹Ÿä¸æ‡‚ã€‚&lt;/p&gt;
&lt;/blockquot</summary>
      
    
    
    
    
    <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://example.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>èŠèŠåŒäº²å§”æ´¾æœºåˆ¶</title>
    <link href="http://example.com/2023/04/30/%E8%81%8A%E8%81%8A%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6/"/>
    <id>http://example.com/2023/04/30/%E8%81%8A%E8%81%8A%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6/</id>
    <published>2023-04-29T17:17:16.000Z</published>
    <updated>2023-04-29T17:29:38.439Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘é‡æ–°çœ‹äº†åŒäº²å§”æ´¾ç›¸å…³çš„çŸ¥è¯†ï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ï¼Œæ–¹ä¾¿ä»¥åé‡æ–°å›é¡¾</p></blockquote><h4 id="Java-ç±»æ˜¯æ€ä¹ˆåŠ è½½"><a href="#Java-ç±»æ˜¯æ€ä¹ˆåŠ è½½" class="headerlink" title="Java ç±»æ˜¯æ€ä¹ˆåŠ è½½"></a>Java ç±»æ˜¯æ€ä¹ˆåŠ è½½</h4><p>Java é€šè¿‡ ClassLoader å®ä¾‹çš„ loadClass æ–¹æ³•å°†å­—èŠ‚ç ï¼ˆ.classï¼‰æ–‡ä»¶åŠ è½½åˆ° JVM çš„æ–¹æ³•åŒºä¸­ã€‚å•¥ä¹Ÿä¸è¯´ï¼Œå…ˆä¸Šä»£ç  (ï½ï¿£â–½ï¿£)ï½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// ä»å·²åŠ è½½çš„ç±»ä¸­å¯»æ‰¾</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//çˆ¶å§”æ´¾æœºåˆ¶</span></span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//æ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¯´æ˜çˆ¶åŠ è½½å™¨æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨</span></span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//æ ¹æ®ç±»åä»æ•°æ®æºæŸ¥æ‰¾å¯¹åº”çš„å­—èŠ‚ç ï¼Œè¯»å–äºŒè¿›åˆ¶æµï¼Œç”Ÿæˆ Class å¯¹è±¡</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                <span class="comment">//å®˜æ–¹æ³¨é‡Šè¯´æ˜¯é“¾æ¥ä¸€ä¸ªç±»ï¼Œè¿™é‡Œæš‚æ—¶æ²¡ç”¨è¿‡ï¼Œä¸‹æ¬¡çœ‹çœ‹</span></span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ­¤å¤„è´´çš„æ˜¯ ClassLoader å­ç±» URLClassLoader çš„ findClass æ–¹æ³•ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„å®ç°</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                        <span class="comment">//æ ¹æ®ç±»åä»èµ„æºè·¯å¾„æŸ¥æ‰¾å¯¹åº”çš„èµ„æº</span></span><br><span class="line">                        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">".class"</span>);</span><br><span class="line">                        Resource res = ucp.getResource(path, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (res != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">//è¯»å–äºŒè¿›åˆ¶æµï¼Œç”Ÿæˆ Class å¯¹è±¡</span></span><br><span class="line">                                <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ° loadClass ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li><strong>æ ¹æ®ç±»åä»èµ„æºè·¯å¾„ï¼ˆæ–‡ä»¶ã€ç½‘ç»œç­‰ï¼‰æŸ¥æ‰¾å¯¹åº”çš„å­—èŠ‚ç èµ„æº</strong></li><li><strong>ä»èµ„æºè·¯å¾„è¯»å–å­—èŠ‚ç äºŒè¿›åˆ¶æµï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ Class å¯¹è±¡ï¼Œå…¶ä¸­åŒ…æ‹¬æƒé™æ ¡éªŒï¼Œå­—èŠ‚ç æ ¡éªŒç­‰ã€‚</strong></li></ol><h4 id="Java-é»˜è®¤çš„ç±»åŠ è½½å™¨"><a href="#Java-é»˜è®¤çš„ç±»åŠ è½½å™¨" class="headerlink" title="Java é»˜è®¤çš„ç±»åŠ è½½å™¨"></a>Java é»˜è®¤çš„ç±»åŠ è½½å™¨</h4><p>JDK9 ä¹‹å‰é»˜è®¤çš„ç±»åŠ è½½å™¨æœ‰ï¼š<strong>AppClassLoaderã€ExtClassLoaderã€BootstrapClassloader</strong></p><ul><li>BootstrapClassLoader: JRE çš„ lib ç›®å½•ä¸‹ jar åŒ…ä¸­çš„ç±»ï¼ˆä»¥åŠç”±è™šæ‹Ÿæœºå‚æ•° -Xbootclasspath æŒ‡å®šçš„ç±»ï¼‰ï¼Œæ³¨æ„ï¼Œä»–ä¸æ˜¯å®šä¹‰åœ¨ Java ä»£ç ä¸­çš„ã€‚</li><li>ExtClassLoaderï¼šå­˜æ”¾åœ¨ JRE çš„ lib/ext ç›®å½•ä¸‹ jar åŒ…ä¸­çš„ç±»ï¼ˆä»¥åŠç”±ç³»ç»Ÿå˜é‡ java.ext.dirs æŒ‡å®šçš„ç±»ï¼‰ã€‚</li><li>AppClassLoaderï¼šè´Ÿè´£åŠ è½½åº”ç”¨ç¨‹åºè·¯å¾„ä¸‹çš„ç±»ï¼ˆè™šæ‹Ÿæœºå‚æ•° -cp/-classpathã€ç³»ç»Ÿå˜é‡ java.class.path æˆ–ç¯å¢ƒå˜é‡ CLASSPATH æ‰€æŒ‡å®šçš„è·¯å¾„ï¼‰</li></ul><p>JDK9 åŠä»¥åé»˜è®¤çš„ç±»åŠ è½½å™¨ï¼š<strong>AppClassLoaderã€PlatformClassLoaderã€BootstrapClassLoader</strong></p><ul><li>PlatformClassLoaderï¼šå…¶å®å°±æ˜¯ä¹‹å‰çš„ ExtClassLoaderï¼Œåªæ˜¯å°†å¤§éƒ¨åˆ†åŸæœ¬ç”± BootstrapClassLoader åŠ è½½çš„ç±»äº¤ç”± PlatformClassLoader åŠ è½½</li></ul><h4 id="Java-ç±»çš„åŠ è½½æ—¶æœºæœ‰å“ªäº›"><a href="#Java-ç±»çš„åŠ è½½æ—¶æœºæœ‰å“ªäº›" class="headerlink" title="Java ç±»çš„åŠ è½½æ—¶æœºæœ‰å“ªäº›"></a>Java ç±»çš„åŠ è½½æ—¶æœºæœ‰å“ªäº›</h4><p>ç±»åŠ è½½çš„æ—¶æœºæœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¸»è¦åˆ—ä¸¾ä¸€äº›æ˜“é”™åœºæ™¯ (ï½ï¿£â–½ï¿£)ï½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoadTimingTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//newä¸€ä¸ªå¯¹è±¡å®ä¾‹</span></span><br><span class="line">        <span class="keyword">new</span> A(); <span class="comment">//åŠ è½½A</span></span><br><span class="line">        <span class="comment">//é€šè¿‡åå°„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">        Class.forName(<span class="string">"com.classloader.demo.char01.A"</span>); <span class="comment">//åŠ è½½A</span></span><br><span class="line">        <span class="comment">//è®¿é—®ç±»çš„é™æ€å˜é‡</span></span><br><span class="line">        System.out.println(A.word);   <span class="comment">//åŠ è½½A</span></span><br><span class="line">        <span class="comment">//è®¿é—®ç±»çš„é™æ€æ–¹æ³•</span></span><br><span class="line">        A.println(); <span class="comment">//åŠ è½½A</span></span><br><span class="line">        <span class="comment">//å­ç±»åˆå§‹åŒ–ä¼šè§¦å‘çˆ¶ç±»åˆå§‹åŒ–</span></span><br><span class="line">        System.out.println(B.word1); <span class="comment">//åŠ è½½Aã€B</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä»¥ä¸‹æƒ…å†µä¸åŠ è½½</span></span><br><span class="line">        System.out.println(B.word); <span class="comment">//åŠ è½½Aï¼Œä¸åŠ è½½B</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºæ•°ç»„ä¸åŠ è½½ç±»</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> A[]&#123;&#125;); <span class="comment">//ä¸åŠ è½½A</span></span><br><span class="line">        <span class="comment">//è®¿é—®å¸¸é‡ä¸åŠ è½½ç±»</span></span><br><span class="line">        System.out.println(A.DEFAULT); <span class="comment">//ä¸åŠ è½½A</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//æ˜“æ··æ·†æƒ…å†µï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šæœ€ç»ˆå˜é‡çš„å€¼ï¼Œæ‰€ä»¥è¿è¡ŒæœŸè¦å»åŠ è½½</span></span><br><span class="line">        System.out.println(A.DEFAULT1); <span class="comment">//åŠ è½½A</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT = <span class="string">"HELLO WORLD"</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT1 = <span class="keyword">new</span> String(<span class="string">"123"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String word = <span class="string">"HELLO WORLD"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"A was loader"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">println</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String word1 = <span class="string">"HELLO WORLD"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"B was loader"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶"><a href="#ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶"></a>ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶</h4><p>ä»”ç»†çš„åŒå­¦åº”è¯¥ä¼šå‘ç°ï¼Œä¸Šé¢åŠ è½½ç±»çš„æ–¹æ³•ä¸­ï¼Œä¼˜å…ˆä¼šè°ƒç”¨ <strong>parent.loadClass</strong> å»åŠ è½½ç±»ï¼Œå¦‚æœæ²¡åŠ è½½åˆ°æ‰ä¼šèµ°ç»§ç»­å¾€ä¸‹èµ°ã€‚</p><p><strong>å…¶å®è¿™å°±æ˜¯ç±»åŠ è½½çš„çˆ¶å§”æ´¾æœºåˆ¶ï¼Œä¼˜å…ˆç”±çˆ¶åŠ è½½å™¨å»åŠ è½½ç±»ï¼Œçˆ¶ç±»åŠ è½½å™¨æ²¡åŠ è½½åˆ°æ‰æœ‰è‡ªèº«å°è¯•å»åŠ è½½ã€‚</strong></p><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶å‘¢ï¼Œè¿˜è®°å¾—ä¸Šé¢æåˆ° JDK8 çš„é»˜è®¤ç±»åŠ è½½å™¨æœ‰ AppClassLoaderã€ExtClassLoaderã€BootstrapClassloaderï¼ŒBootstrapClassloader æ˜¯ ExtClassLoader çš„çˆ¶åŠ è½½å™¨ï¼ŒExtClassLoader æ˜¯ AppClassLoader çš„çˆ¶åŠ è½½å™¨ã€‚å—¯ï¼Œå°±æ˜¯å› ä¸º AppClassLoader æœ‰ä¸€ä¸ªçˆ¸çˆ¸å’Œä¸€ä¸ªçˆ·çˆ·ï¼Œæ‰€ä»¥ç§°ä¸ºåŒäº²å§”æ´¾æœºåˆ¶ã€‚å°±æ˜¯è¿™ä¹ˆç®€å• ï¸¿(ï¿£ï¸¶ï¿£)ï¸¿ã€‚</p><p><strong>é‚£ä¹ˆåŒäº²å§”æ´¾æœºåˆ¶çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Œæˆ‘è®¤ä¸ºæœ‰ä¸¤ç‚¹ï¼š</strong></p><ol><li><strong>é˜²æ­¢åŒä¸€ä¸ªç±»è¢«åŠ è½½åˆ° JVM å¤šæ¬¡</strong></li><li><strong>é¿å… Java å†…éƒ¨çš„ä¸€äº›åŸºç¡€ç±»æ²¡æœ‰è¢«æ­£ç¡®åŠ è½½ï¼Œå¯¼è‡´å‡ºç°éš¾ä»¥æ„æ–™çš„å¼‚å¸¸</strong></li></ol><h4 id="JDBC-çœŸçš„æ‰“ç ´åŒäº²å§”æ´¾äº†å—"><a href="#JDBC-çœŸçš„æ‰“ç ´åŒäº²å§”æ´¾äº†å—" class="headerlink" title="JDBC çœŸçš„æ‰“ç ´åŒäº²å§”æ´¾äº†å—"></a>JDBC çœŸçš„æ‰“ç ´åŒäº²å§”æ´¾äº†å—</h4><p>åœ¨è¯´ JDBC æ˜¯å¦æ‰“ç ´åŒäº²å§”æ´¾ä¹‹å‰æˆ‘ä»¬å…ˆæ¥èŠèŠä»€ä¹ˆæ˜¯æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå—¯ï¼Œå°±æ˜¯è®©ç±»çš„åŠ è½½é¡ºåºä¸åœ¨æ˜¯ <strong>BootstrapClassloader -&gt; ExtClassLoader -&gt; AppClassLoader</strong>ï¼Œå°±æ˜¯å­—é¢ä¸Šçš„æ„æ€ä¸å†è®©çˆ·çˆ·å’Œçˆ¸çˆ¸å…ˆåŠ è½½ï¼Œè€Œæ˜¯å„¿å­è‡ªå·±æƒ³å…ˆåŠ è½½å°±å…ˆåŠ è½½ ï¸¿(ï¿£ï¸¶ï¿£)ï¸¿ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Œæ˜¯ä¸æ˜¯<strong>è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œé‡å†™ä¸‹ loadClass æ–¹æ³•ä¸åœ¨è°ƒç”¨ parent.loadClass å°±å¯ä»¥äº†</strong>ï¼Ÿå—¯ï¼Œæ˜¯çš„ o(ï¿£â–½ï¿£)ï½„ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹çœ‹ JDBC çœŸçš„æ‰“ç ´åŒäº²å§”æ´¾äº†å—ã€‚è€è§„çŸ©ï¼Œçº¿ä¸Šä»£ç  (ï½ï¿£â–½ï¿£)ï½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">AppClassLoaderpublic <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        loadInitialDrivers();</span><br><span class="line">        println(<span class="string">"JDBC DriverManager initialized"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadInitialDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String drivers;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„é©±åŠ¨</span></span><br><span class="line">            drivers = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> System.getProperty(<span class="string">"jdbc.drivers"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            drivers = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//é€šè¿‡SPIæœºåˆ¶åŠ è½½é©±åŠ¨ç±»</span></span><br><span class="line">                ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br><span class="line"></span><br><span class="line">                 */</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span>(driversIterator.hasNext()) &#123;</span><br><span class="line">                        <span class="comment">//è¿™é‡Œé¢ä¼šåŠ è½½é©±åŠ¨ç±»ï¼ˆä¸åˆå§‹åŒ–ï¼‰ï¼Œä½†æ˜¯ä¼šé€šè¿‡åå°„å®ä¾‹åŒ–é©±åŠ¨ç±»ï¼ˆä¼šåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">                        driversIterator.next();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span>(Throwable t) &#123;</span><br><span class="line">                <span class="comment">// Do nothing</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        println(<span class="string">"DriverManager.initialize: jdbc.drivers = "</span> + drivers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drivers == <span class="keyword">null</span> || drivers.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] driversList = drivers.split(<span class="string">":"</span>);</span><br><span class="line">        println(<span class="string">"number of Drivers:"</span> + driversList.length);</span><br><span class="line">        <span class="keyword">for</span> (String aDriver : driversList) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                println(<span class="string">"DriverManager.Initialize: loading "</span> + aDriver);</span><br><span class="line">                <span class="comment">//åŠ è½½é©±åŠ¨ç±»å¹¶åˆå§‹åŒ–</span></span><br><span class="line">                Class.forName(aDriver, <span class="keyword">true</span>,</span><br><span class="line">                        ClassLoader.getSystemClassLoader());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                println(<span class="string">"DriverManager.Initialize: load failed: "</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader loader;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> LazyIterator lookupIterator;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//æ‹¿åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ç±»åŠ è½½å™¨ï¼Œè¿™é‡Œå¦‚æœæœªè®¾ç½®è¿‡è·å–åˆ°çš„æ˜¯ AppClassLoader</span></span><br><span class="line">      ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">      <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒDriverManager é€šè¿‡ SPI æœºåˆ¶ï¼ŒåŠ è½½ Driver é©±åŠ¨ç±»ï¼Œè€Œ ServiceLoader ä¸­å…¶å®åªæ˜¯æ‹¿åˆ°å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„ç±»åŠ è½½å™¨ï¼Œé‚£ä¹ˆèƒ½è¯´ä»–æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶å—ï¼Ÿæˆ‘ä¸ªäººè§‰å¾—æ˜¯ä¸èƒ½çš„ï¼Œå…ˆä¸è¯´å…¶ä»–ï¼Œ<strong>åœ¨æœªæ‰‹åŠ¨è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯ç»§æ‰¿è‡³çˆ¶çº¿ç¨‹çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ AppClassLoaderï¼Œé‚£æ­£å¸¸æƒ…å†µä¸‹ä»–èµ°çš„å°±æ˜¯åŒäº²å§”æ´¾æœºåˆ¶ ï¼ˆï¿£ï¸¶ï¿£ï¼‰â†—ã€‚å°±ç®—æ˜¯å°†è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ”¾å…¥çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œé‚£ä¹Ÿæ˜¯ç”±è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨é€šè¿‡é‡å†™ loadClass æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶å‘€ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸º JDBC è‡ªèº«å¹¶æœªæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ &lt;(ï¿£ï¸¶ï¿£)&gt;ã€‚</strong></p><h4 id="Tomcat-å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾"><a href="#Tomcat-å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾" class="headerlink" title="Tomcat å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾"></a>Tomcat å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾</h4><p>é‚£ä¹ˆ Tomcat æ‰“ç ´äº†å—ï¼Ÿå—¯ï¼Œå®ƒæ‰“ç ´äº† ï½‚ï¼ˆï¿£â–½ï¿£ï¼‰ï½„ï¼ŒTomcat7 åŠä»¥ä¸Šè‡ªå®šä¹‰äº†ç±»åŠ è½½å™¨ ParallelWebappClassLoader å’Œ WebappClassLoaderã€‚å—¯ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼ŒTomcat6 ä»¥ä¸‹çš„ç±»åŠ è½½å™¨æœ‰æ‰€ä¸åŒï¼Œä¸è¿‡åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼ˆå…¶å®æ˜¯æˆ‘å·æ‡’ï¼Œä¸æƒ³æŠŠ Tomcat6 æºç ä¹Ÿçœ‹äº† (â•¯â–½â•°)ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (JreCompat.isGraalAvailable() ? <span class="keyword">this</span> : getClassLoadingLock(name)) &#123;</span><br><span class="line">            </span><br><span class="line">        String resourceName = binaryNameToPath(name, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¿™é‡Œè·å–åˆ° ExtClassLoader</span></span><br><span class="line">        ClassLoader javaseLoader = getJavaseClassLoader();</span><br><span class="line">        <span class="keyword">boolean</span> tryLoadingFromJavaseLoader;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url;</span><br><span class="line">            <span class="keyword">if</span> (securityManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                PrivilegedAction&lt;URL&gt; dp = <span class="keyword">new</span> PrivilegedJavaseGetResource(resourceName);</span><br><span class="line">                url = AccessController.doPrivileged(dp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å…ˆExtClassLoaderå’ŒBoostrapClassLoaderçš„èµ„æºè·¯å¾„ä¸­æŸ¥æ‰¾å­—èŠ‚ç èµ„æº</span></span><br><span class="line">                url = javaseLoader.getResource(resourceName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœèµ„æºå­˜åœ¨åˆ™èµ°ExtClassLoaderå’ŒBoostrapClassLoaderåŠ è½½</span></span><br><span class="line">            tryLoadingFromJavaseLoader = (url != <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            tryLoadingFromJavaseLoader = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tryLoadingFromJavaseLoader) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœèµ„æºå­˜åœ¨åˆ™èµ°ExtClassLoaderå’ŒBoostrapClassLoaderåŠ è½½</span></span><br><span class="line">                clazz = javaseLoader.loadClass(name);</span><br><span class="line">                <span class="comment">//return</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œé»˜è®¤æ˜¯AppClassLoaderï¼Œæˆ–è€…æ˜¯Tomcatå†…éƒ¨çš„ä¸€äº›ç±»</span></span><br><span class="line">        <span class="keyword">boolean</span> delegateLoad = delegate || filter(name, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) Delegate to our parent if requested</span></span><br><span class="line">        <span class="keyword">if</span> (delegateLoad) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                </span><br><span class="line">                clazz = Class.forName(name, <span class="keyword">false</span>, parent);</span><br><span class="line">                <span class="comment">//return</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ä»æœ¬åœ°ç›®å½•ä¸­æŸ¥æ‰¾ç±»å¹¶åŠ è½½</span></span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="comment">//return</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) Delegate to parent unconditionally</span></span><br><span class="line">        <span class="keyword">if</span> (!delegateLoad) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°å°±å§”æ´¾ç»™çˆ¶åŠ è½½å™¨ï¼Œé»˜è®¤æ˜¯AppClassLoader</span></span><br><span class="line">                clazz = Class.forName(name, <span class="keyword">false</span>, parent);</span><br><span class="line">                <span class="comment">//return</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹çœ‹ Tomcat éƒ½æ”¹äº†å•¥ï¼š</p><ol><li>é¦–å…ˆå°è¯•é€šè¿‡ ExtClassLoader åŠ è½½ç±»ï¼Œé˜²æ­¢ java ç›¸å…³çš„ä¸€äº›ç±»è¢«å…ˆåŠ è½½äº†</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œæˆ–è€…æ˜¯æ˜¯å¦æ˜¯Tomcatå†…éƒ¨çš„ä¸€äº›ç±»ï¼Œæ˜¯çš„è¯åˆ™å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨</li><li><strong>ä»æœ¬åœ°ç›®å½•å’Œæ‰©å±•è·¯å¾„ä¸­æŸ¥æ‰¾ç±»å¹¶åŠ è½½ï¼Œè¿˜è®°çš„æ—©èµ·æˆ‘ä»¬ä½¿ç”¨ Tomcat æ—¶ï¼Œä¼šå°†å¤šä¸ª war åŒ…æ”¾åœ¨ webapps å—ï¼Œé‚£ä¹ˆå¦‚æœå¤šä¸ª war ä¸­å®Œå…¨çš„å…¨è·¯å¾„ç±»åï¼Œèµ°é»˜è®¤çš„åŒäº²å§”æ´¾æœºåˆ¶å°±åªæœ‰å…ˆåŠ è½½çš„èƒ½åŠ è½½æˆåŠŸã€‚æ­¤å¤„ä¾¿æ˜¯ Tomcat æ‰“ç ´åŒäº²å§”æ´¾æ„ä¹‰äº†ã€‚</strong></li><li>å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œèµ°åŒäº²å§”æ´¾æœºåˆ¶ã€‚</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼ŒTomcat çš„ç±»åŠ è½½é¡ºåºä¸å†æ˜¯ <strong>BootstrapClassloader -&gt; ExtClassLoader -&gt; AppClassLoader</strong>ï¼Œè€Œæ˜¯åœ¨ <strong>AppClassLoader å‰å…ˆå°è¯•é€šè¿‡ WebappClassLoader åŠ è½½æœ¬åœ°ç›®å½•</strong> ï½‚ï¼ˆï¿£â–½ï¿£ï¼‰ï½„ã€‚</p><h4 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h4><p>ç¯‡å¹…æœ‰ç‚¹é•¿äº†ï¼Œè¿™ä¸ªä¸‹æ¬¡ä¸€å®š â•°(ï¿£â–½ï¿£)â•­</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol><li>Java é€šè¿‡ ClassLoader å®ä¾‹çš„ loadClass æ–¹æ³•å°†å­—èŠ‚ç ï¼ˆ.classï¼‰æ–‡ä»¶åŠ è½½åˆ° JVM çš„æ–¹æ³•åŒºä¸­ã€‚</li><li>JDK9 ä¹‹å‰é»˜è®¤çš„ç±»åŠ è½½å™¨æœ‰ï¼š<strong>AppClassLoaderã€ExtClassLoaderã€BootstrapClassloader</strong> ,JDK9 åŠä»¥åé»˜è®¤çš„ç±»åŠ è½½å™¨ï¼š**AppClassLoaderã€PlatformClassLoaderã€BootstrapClassLoader **ã€‚</li><li>ç±»åŠ è½½æ—¶æœºåŒ…æ‹¬ï¼šnewä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼›åå°„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼›è®¿é—®ç±»çš„é™æ€å˜é‡ã€æ–¹æ³•ï¼›å­ç±»åˆå§‹åŒ–ä¼šè§¦å‘çˆ¶ç±»åˆå§‹åŒ–ï¼›æ–¹æ³•å¥æŸ„è°ƒç”¨åŠ è½½æ–¹æ³•æ‰€åœ¨ç±»ã€‚</li><li>ä¸åŠ è½½æ—¶æœºï¼š<strong>è®¿é—®çˆ¶ç±»é™æ€å˜é‡ï¼Œä¸åŠ è½½å­ç±»ï¼›åˆ›å»ºæ•°ç»„ä¸åŠ è½½ç±»ï¼›è®¿é—®å¸¸é‡ä¸åŠ è½½ç±»ï¼Œä½†æ˜¯å¦‚æœç¼–è¯‘æ˜¯æ— æ³•ç¡®å®šï¼Œè¿è¡ŒæœŸè¿˜æ˜¯ä¼šåŠ è½½ç±»ã€‚</strong></li><li><strong>JVM ä¸ºé˜²æ­¢åŒä¸€ä¸ªç±»è¢«åŠ è½½å¤šæ¬¡</strong>ï¼Œå¼•å…¥åŒäº²å§”æ´¾æœºåˆ¶ï¼ŒåŠ è½½ç±»è¿‡ç¨‹ä¸­ï¼Œå…ˆç”±å…¶çˆ¶ç±»åŠ è½½å™¨åŠ è½½ï¼ŒæœªåŠ è½½åˆ°åœ¨è‡ªå·±åŠ è½½</li><li>JDBC å¹¶æœªæ‰“ç ´åŒäº²å§”æ´¾ï¼Œè€Œ Tomcat é€šè¿‡è‡ªå®šä¹‰ ClassLoader æ‰“ç ´åŒäº²å§”æ´¾ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘é‡æ–°çœ‹äº†åŒäº²å§”æ´¾ç›¸å…³çš„çŸ¥è¯†ï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ï¼Œæ–¹ä¾¿ä»¥åé‡æ–°å›é¡¾&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;Java-ç±»æ˜¯æ€ä¹ˆåŠ è½½&quot;&gt;&lt;a href=&quot;#Java-ç±»æ˜¯æ€ä¹ˆåŠ è½½&quot; class=&quot;headerlink&quot; title=&quot;Java</summary>
      
    
    
    
    
    <category term="jvm" scheme="http://example.com/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>Spring @Validated å¤±æ•ˆåˆ†æ</title>
    <link href="http://example.com/2023/04/22/Spring-Validated-%E5%A4%B1%E6%95%88%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2023/04/22/Spring-Validated-%E5%A4%B1%E6%95%88%E5%88%86%E6%9E%90/</id>
    <published>2023-04-21T17:41:36.000Z</published>
    <updated>2023-04-22T06:07:27.069Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åœ¨è½åœ° DDDï¼Œå¸Œæœ›å¯¹ command è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç”±äºéƒ¨åˆ†æµé‡å…¥å£æ˜¯ MQï¼Œæ‰€ä»¥å¸Œæœ›åœ¨åº”ç”¨å±‚æ˜¯ç”¨ @Validated è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç»“æœã€‚ã€‚ã€‚</p></blockquote><h3 id="Controller-ä¸­ä½¿ç”¨-Validated"><a href="#Controller-ä¸­ä½¿ç”¨-Validated" class="headerlink" title="Controller ä¸­ä½¿ç”¨ @Validated"></a>Controller ä¸­ä½¿ç”¨ @Validated</h3><p>@Validated æ³¨è§£çš„ä½œç”¨è¿™é‡Œå°±ä¸å¤šåšä»‹ç»äº†ï¼Œå…·ä½“ç”¨æ³•åœ¨ç½‘ä¸Šåº”è¯¥æœ‰ä¸å°‘ã€‚</p><p>åœ¨ä¹‹å‰ä½¿ç”¨ MVC æ¶æ„ç¼–ç æ—¶ï¼Œé€šå¸¸æ˜¯å°† @Validated æ³¨è§£æˆ–è€… @Valid é…ç½®åœ¨ Controller çš„æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"common/set"</span>)</span><br><span class="line"><span class="keyword">public</span> Response&lt;?&gt; setCommonSetting(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> SetCommonSettingReqVO reqVO) &#123;</span><br><span class="line">    <span class="comment">//doSomeThings</span></span><br><span class="line">    <span class="keyword">return</span> Response.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨é…ç½®åº”ç”¨å±‚æ ¡éªŒæ—¶ï¼Œå°±æƒ³å½“ç„¶çš„æŒ‰ç…§ç±»ä¼¼çš„å†™æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addClueTrack</span><span class="params">(@Validated AddClueTrackCommand command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//doSomeThings</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¯æƒ³è€ŒçŸ¥ï¼Œ@Validated æ³¨è§£å¹¶ä¸ç”Ÿæ•ˆã€‚</p><h3 id="Validated-æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ"><a href="#Validated-æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ" class="headerlink" title="@Validated æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ"></a>@Validated æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ</h3><p>ç«Ÿç„¶ä¸ç”Ÿæ•ˆï¼Œé‚£ä¹ˆå°±å¼€å§‹åˆ†æåŸå› ã€‚</p><p>é¦–å…ˆå¯ä»¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œç«Ÿç„¶èƒ½åœ¨æ–¹æ³•æ‰§è¡Œå‰å°±æ‹¦æˆªè¿›è¡Œæ ¡éªŒï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯ä½¿ç”¨<strong>åŠ¨æ€ä»£ç†</strong>ã€‚å°±å’Œ @Transactional äº‹åŠ¡æ³¨è§£ä¸€æ ·ï¼Œåº•å±‚éƒ½æ˜¯åŸºäº AOP å®ç°åŠ¨æ€ä»£ç†ã€‚</p><p>æ¥ä¸‹æ¥ä¸ºäº†å°è¯è¿™ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯éœ€è¦æ·±å…¥çœ‹çœ‹ Spring å®ç°çš„ã€‚é€šè¿‡ IDE å¯ä»¥å¾ˆæ–¹ä¾¿çœ‹åˆ°æœ‰å“ªäº›åœ°æ–¹å¼•ç”¨äº† @Validated æ³¨è§£ï¼š</p><img src="/images/95f16571e945fb66855e76053273ccd1.png" alt="æˆªå›¾" style="zoom:100%;" /><p>å…¶ä¸­ä¸€ä¸ªç±»åä¸€ä¸‹å°±å¼•èµ·äº†æˆ‘çš„æ³¨æ„ <strong>MethodValidationPostProcessor</strong>ï¼Œç†Ÿæ‚‰ Spring çš„å°ä¼™ä¼´åº”è¯¥çŸ¥é“ï¼ŒSpring ä¸­æœ‰å¾ˆå¤š BeanPostProcessor ç”¨äºæ‰©å±• Beanï¼ŒAop ä¾¿æ˜¯åŸºäºæ­¤å®ç°åŠ¨æ€ä»£ç†çš„ã€‚ç‚¹è¿›å»ä¸€çœ‹ï¼Œæœä¸å…¶ç„¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodValidationPostProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactoryAwareAdvisingPostProcessor</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Annotation&gt; validatedAnnotationType = Validated<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Validator validator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºåˆ‡ç‚¹</span></span><br><span class="line">        Pointcut pointcut = <span class="keyword">new</span> AnnotationMatchingPointcut(<span class="keyword">this</span>.validatedAnnotationType, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.advisor = <span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, createMethodValidationAdvice(<span class="keyword">this</span>.validator));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Advice <span class="title">createMethodValidationAdvice</span><span class="params">(@Nullable Validator validator)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ‹¦æˆªå™¨</span></span><br><span class="line">        <span class="keyword">return</span> (validator != <span class="keyword">null</span> ? <span class="keyword">new</span> MethodValidationInterceptor(validator) : <span class="keyword">new</span> MethodValidationInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationMatchingPointcut</span> <span class="keyword">implements</span> <span class="title">Pointcut</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassFilter classFilter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodMatcher methodMatcher;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationMatchingPointcut</span><span class="params">(Class&lt;? extends Annotation&gt; classAnnotationType, <span class="keyword">boolean</span> checkInherited)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ‡ç‚¹åªé’ˆå¯¹ç±»çº§åˆ«</span></span><br><span class="line">        <span class="keyword">this</span>.classFilter = <span class="keyword">new</span> AnnotationClassFilter(classAnnotationType, checkInherited);</span><br><span class="line">        <span class="keyword">this</span>.methodMatcher = MethodMatcher.TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MethodValidationPostProcessor ä¸­åˆ›å»ºäº†ä¸€ä¸ªåˆ‡ç‚¹ï¼Œè¿‡æ»¤ç±»ä¸Šæ·»åŠ äº† @Validated çš„ Beanï¼Œåªè¦æ»¡è¶³æ­¤æ¡ä»¶ï¼Œå°±ä¼šæ ¹æ® MethodValidationInterceptor ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»ã€‚å—¯ï¼Œå’Œ @Transactional çš„å®ç°åŸç†å·®ä¸å¤šã€‚</p><p>okï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘å°±åœ¨åº”ç”¨æœåŠ¡å®ç°ä¸Šæ·»åŠ äº† @Validated æ³¨è§£ï¼Œé‚£ä¹ˆæ­¤æ—¶æ³¨è§£ç”Ÿæ•ˆäº†å—ï¼Ÿå“ˆå“ˆï¼Œè¿›åº¦æ¡è¿˜æ²¡è¿‡åŠå‘¢ğŸ˜‚</p><p>ç†è®ºä¸Šç±»ä¸ŠåŠ ä¸Š @Validated æ³¨è§£ï¼Œåº”è¯¥ä¼šç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„ï¼Œç«Ÿç„¶æ²¡æˆåŠŸè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œæˆ‘èƒ½æƒ³åˆ°çš„åŸå› æœ‰äºŒï¼š</p><p><strong>1. MethodValidationPostProcessor æ²¡æ³¨å…¥åˆ° BeanFactory ä¸­ï¼Œæ‰€ä»¥æ²¡ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»</strong><br><strong>2. MethodValidationInterceptor å¯¹è¿˜æœ‰å…¶ä»–éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼Œè€Œç›®å‰è¿˜æœªæ»¡è¶³</strong></p><p>è¿™é‡Œå…ˆå‰§é€ä¸€ä¸‹ï¼Œç­”æ¡ˆæ˜¯ 2 ğŸŒ</p><h3 id="MethodValidationInterceptor-éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶"><a href="#MethodValidationInterceptor-éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶" class="headerlink" title="MethodValidationInterceptor éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶"></a>MethodValidationInterceptor éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶</h3><p>ç«Ÿç„¶ç­”æ¡ˆæ˜¯2ï¼Œé‚£è¿™é‡Œå°±å…ˆè®²ä¸€ä¸‹ MethodValidationInterceptorï¼ŒMethodValidationPostProcessor æ˜¯æ€ä¹ˆæ³¨å†Œåˆ°å®¹å™¨çš„å’±ä»¬åé¢å†æ¥è®²ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ExecutableValidatorpublic <span class="class"><span class="keyword">class</span> <span class="title">MethodValidationInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Validator validator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Standard Bean Validation 1.1 API</span></span><br><span class="line">        ExecutableValidator execVal = <span class="keyword">this</span>.validator.forExecutables();</span><br><span class="line">        Method methodToValidate = invocation.getMethod();</span><br><span class="line">        Set&lt;ConstraintViolation&lt;Object&gt;&gt; result;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–ç±»æœ¬èº«çš„å®ä¾‹ï¼ˆéä»£ç†ç±»ï¼‰ï¼Œè¯·è®°ä½è¿™é‡Œï¼Œè¿™é‡Œå°±æ˜¯å’Œ Controller æœ€å¤§çš„åŒºåˆ«</span></span><br><span class="line">        Object target = invocation.getThis();</span><br><span class="line">        Assert.state(target != <span class="keyword">null</span>, <span class="string">"Target must not be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æ‰§è¡Œå‚æ•°æ ¡éªŒï¼Œæ ¡éªŒçš„æ˜¯å½“å‰ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æ ¡éªŒçš„æ˜¯ Bean å¯¹åº”çš„ç±»</span></span><br><span class="line">            result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            <span class="comment">//doSomeThings</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">        Object returnValue = invocation.proceed();</span><br><span class="line">        <span class="comment">//æ ¡éªŒè¿”å›å€¼</span></span><br><span class="line">        result = execVal.validateReturnValue(target, methodToValidate, returnValue, groups);</span><br><span class="line">        <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¦çœ‹çœ‹ <strong>ExecutableValidator.validateParameters</strong> è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œè¿™é‡Œæˆ‘åªä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ã€‚<strong>æ ¹æ®åŒ…åæˆ‘ä»¬å¤§æ¦‚ä¹Ÿèƒ½çŒœåˆ° ExecutableValidator.validateParameters æ˜¯ hibernate-validator åŒ…æä¾›çš„æ–¹æ³•ï¼Œè€Œ @Validated æ³¨è§£æ˜¯ç”± Spring æä¾›çš„ï¼Œæ‰€ä»¥ä¸ç”Ÿæ•ˆä¹Ÿå°±æ­£å¸¸äº†ã€‚</strong>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œæˆ‘è¿™é‡Œåªè´´éƒ¨åˆ†æ ¸å¿ƒçš„ä»£ç ï¼Œä¸­é—´çš„æ ˆè·¯å¾„å¯ä»¥æ ¹æ®ä»¥ä¸‹è¿™ä¸ªè·¯å¾„å¾€ä¸‹èµ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.engine.ValidatorImpl#validateParameters  </span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManager#getBeanMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManagerImpl#createBeanMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManagerImpl#getBeanConfigurationForHierarchy</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.MetaDataProvider#getBeanConfiguration</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#retrieveBeanConfiguration</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getFieldMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findPropertyMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findConstraints</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findCascadingMetaData</span></span><br><span class="line"><span class="comment"> *  &lt;-- ...</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getMethodMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getConstructorMetaData</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getClassLevelConstraints</span></span><br><span class="line"><span class="comment"> *  &lt;-- ...</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.metadata.aggregated.BeanMetaData#hasConstraints</span></span><br><span class="line"><span class="comment"> *  --&gt; org.hibernate.validator.internal.engine.ValidatorImpl#validateParametersInContext</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorImpl</span> <span class="keyword">implements</span> <span class="title">Validator</span>, <span class="title">ExecutableValidator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateValue(Class&lt;T&gt; beanType, String propertyName, Object value, Class&lt;?&gt;... groups) &#123;</span><br><span class="line">        Contracts.assertNotNull( beanType, MESSAGES.beanTypeCannotBeNull() );</span><br><span class="line">        sanityCheckPropertyPath( propertyName );</span><br><span class="line">        sanityCheckGroups( groups );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å– bean åŠå…¶çˆ¶ç±»ã€è¶…ç±»çš„</span></span><br><span class="line">        BeanMetaData&lt;T&gt; rootBeanMetaData = beanMetaDataManager.getBeanMetaData( beanType );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­è¯¥ bean æ˜¯å¦æœ‰çº¦æŸ</span></span><br><span class="line">        <span class="keyword">if</span> ( !rootBeanMetaData.hasConstraints() ) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PathImpl propertyPath = PathImpl.createPathFromString( propertyName );</span><br><span class="line">        BaseBeanValidationContext&lt;T&gt; validationContext = getValidationContextBuilder().forValidateValue( beanType, rootBeanMetaData, propertyPath );</span><br><span class="line"></span><br><span class="line">        ValidationOrder validationOrder = determineGroupValidationOrder( groups );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ ¡éªŒå‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> validateValueInContext(validationContext, value, propertyPath, validationOrder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘è°ƒè¯•åˆ° <strong>rootBeanMetaData.hasConstraints()</strong> æ—¶ï¼Œåˆ¤æ–­æ²¡æœ‰çº¦æŸï¼Œç„¶åå°±ç›´æ¥è¿”å›äº†æ²¡æœ‰è¿›è¡Œå‚æ•°æ ¡éªŒã€‚æˆ‘å°±æƒ³è¯´çœ‹çœ‹æ˜¯å¦‚ä½•åˆ¤æ–­ Bean æ˜¯å¦æœ‰çº¦æŸçš„ï¼Œäºæ˜¯å°±è¿”å›ä¸Šå±‚è¿›å…¥ beanMetaDataManager.getBeanMetaData ä¸­çœ‹ï¼Œç»“æœå‘ç°é‡Œé¢çš„ä»£ç æœ‰å¤Ÿå¤æ‚çš„ğŸŒš</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationMetaDataProvider</span> <span class="keyword">implements</span> <span class="title">MetaDataProvider</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//è·å–ç±»ä¸Šæ‰€æœ‰çš„çº¦æŸæ¡ä»¶</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">BeanConfiguration&lt;T&gt; <span class="title">retrieveBeanConfiguration</span><span class="params">(Class&lt;T&gt; beanClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è·å–å­—æ®µä¸Šçš„çº¦æŸæ¡ä»¶</span></span><br><span class="line">        Set&lt;ConstrainedElement&gt; constrainedElements = getFieldMetaData( beanClass );</span><br><span class="line">        <span class="comment">//è·å–æ–¹æ³•ä¸Šçš„çº¦æŸæ¡ä»¶ï¼ˆåŒ…æ‹¬å‚æ•°ã€è¿”å›å€¼ï¼‰</span></span><br><span class="line">        constrainedElements.addAll( getMethodMetaData( beanClass ) );</span><br><span class="line">        <span class="comment">//è·å–æ„é€ å‡½æ•°</span></span><br><span class="line">        constrainedElements.addAll( getConstructorMetaData( beanClass ) );</span><br><span class="line">        <span class="comment">//è·å–ç±»ä¸Šçš„çº¦æŸæ¡ä»¶</span></span><br><span class="line">        Set&lt;MetaConstraint&lt;?&gt;&gt; classLevelConstraints = getClassLevelConstraints( beanClass );</span><br><span class="line">        <span class="keyword">if</span> ( !classLevelConstraints.isEmpty() ) &#123;</span><br><span class="line">            ConstrainedType classLevelMetaData =</span><br><span class="line">                <span class="keyword">new</span> ConstrainedType(ConfigurationSource.ANNOTATION, beanClass, classLevelConstraints);</span><br><span class="line">            constrainedElements.add( classLevelMetaData );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BeanConfiguration&lt;&gt;(ConfigurationSource.ANNOTATION, beanClass, constrainedElements, getDefaultGroupSequence( beanClass ), getDefaultGroupSequenceProvider( beanClass ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾çº¦æŸæ³¨è§£</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;A extends Annotation&gt; List&lt;ConstraintDescriptorImpl&lt;?&gt;&gt; findConstraintAnnotations(Constrainable constrainable, A annotation, ConstraintLocationKind type) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//å¦‚æœåŒ…å« "jdk.internal" and "java" ä¸‹çš„æ³¨è§£ï¼Œåˆ™ç›´æ¥ä¸è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line">          <span class="keyword">if</span> ( constraintCreationContext.getConstraintHelper().isJdkAnnotation( annotation.annotationType() ) ) &#123;</span><br><span class="line">          <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      List&lt;Annotation&gt; constraints = newArrayList();</span><br><span class="line">      Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType();</span><br><span class="line">      <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰çº¦æŸæ¡ä»¶ï¼Œä¹Ÿå°±æˆ‘ä»¬ç»å¸¸é…ç½®çš„ @NotNullï¼Œ@Min è¿™ç±»æ³¨è§£</span></span><br><span class="line">      <span class="keyword">if</span> ( constraintCreationContext.getConstraintHelper().isConstraintAnnotation( annotationType ) ) &#123;</span><br><span class="line">          constraints.add( annotation );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//è¿™ä¸ªæ²¡ç”¨è¿‡ï¼Œæš‚æ—¶è·³è¿‡</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( constraintCreationContext.getConstraintHelper().isMultiValueConstraint( annotationType ) ) &#123;</span><br><span class="line">          constraints.addAll( constraintCreationContext.getConstraintHelper().getConstraintsFromMultiValueConstraint( annotation ) );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> constraints.stream()</span><br><span class="line">          .map( c -&gt; buildConstraintDescriptor( constrainable, c, type ) )</span><br><span class="line">          .collect( Collectors.toList() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„å»ºçº§è”å…ƒæ•°æ®æ„é€ å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ @Validï¼Œåœ¨ Bean ä¸­å¦‚æœæˆ‘ä»¬è¦å¯¹å¯¹è±¡å±æ€§è¿›è¡Œæ ¡éªŒï¼Œ</span></span><br><span class="line">    <span class="comment">//éœ€è¦åœ¨è¯¥å±æ€§ä¸Šæ·»åŠ  @Validï¼Œæ­¤å¤„ä¾¿æ˜¯å¦‚æ­¤</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CascadingMetaDataBuilder <span class="title">getCascadingMetaData</span><span class="params">(JavaBeanAnnotatedElement annotatedElement, Map&lt;TypeVariable&lt;?&gt;, CascadingMetaDataBuilder&gt; containerElementTypesCascadingMetaData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CascadingMetaDataBuilder.annotatedObject( annotatedElement.getType(), annotatedElement.isAnnotationPresent( Valid<span class="class">.<span class="keyword">class</span> ),</span></span><br><span class="line"><span class="class">            <span class="title">containerElementTypesCascadingMetaData</span>, <span class="title">getGroupConversions</span>( <span class="title">annotatedElement</span>.<span class="title">getAnnotatedType</span>() ) )</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¡ºç€ä¸Šé¢çš„æ ˆè·¯å¾„ä¸€ç›´å¾€ä¸‹èµ°ï¼Œæœ€ç»ˆå‘ç°æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ–¹æ³•æ˜¯ <strong>getFieldMetaData</strong>ã€<strong>getMethodMetaData</strong>ã€<strong>getConstructorMetaData</strong>ã€<strong>getClassLevelConstraints</strong>ï¼Œè¿™ä¸ªå‡ æ–¹æ³•éƒ½æ˜¯ç”¨äºè·å–çº¦æŸå’Œçº§è”å…ƒæ•°æ®ã€‚é‚£ä¹ˆé‡Œé¢åˆ°åº•æ˜¯æ€ä¹ˆè·å–çº¦æŸå…ƒæ•°æ®çš„å‘¢ï¼Œå’±ç»§ç»­å¾€é‡Œé’»ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨äº† <strong>findConstraintAnnotations</strong> è·å–çº¦æŸå…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„ @NotNullï¼Œ@Min ç­‰æ³¨è§£ï¼Œé€šè¿‡ <strong>getCascadingMetaData</strong> è·å–çº§è”å…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯ @Valid æ³¨è§£ã€‚çœ‹åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼ŒçŸ¥é“æˆ‘åŠ ä¸Š @Valid å°±èƒ½æˆåŠŸæ ¡éªŒäº†å‘¢ï¼Ÿ</p><p>äºæ˜¯æˆ‘å°è¯•äº†ä¸€æ³¢ï¼Œæœç„¶æ²¡é—®é¢˜ã€‚å—¯~ é•¿è§è¯†äº†ğŸ˜‚ã€‚ç”±äºæ—¶é—´æœ‰é™ï¼ŒValidatorImpl.validateParametersInContext() æ–¹æ³•æˆ‘å°±æ²¡æœ‰æ·±å…¥è¿›å»çœ‹äº†ã€‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œå»çœ‹çœ‹ï¼ï¼ğŸŒ</p><h3 id="é‚£ä¹ˆ-Controller-ä¸ºå•¥ç›´æ¥æ·»åŠ -Validated-æˆ–è€…-Valid-å°±å¯ä»¥å‘¢ï¼Ÿ"><a href="#é‚£ä¹ˆ-Controller-ä¸ºå•¥ç›´æ¥æ·»åŠ -Validated-æˆ–è€…-Valid-å°±å¯ä»¥å‘¢ï¼Ÿ" class="headerlink" title="é‚£ä¹ˆ Controller ä¸ºå•¥ç›´æ¥æ·»åŠ  @Validated æˆ–è€… @Valid å°±å¯ä»¥å‘¢ï¼Ÿ"></a>é‚£ä¹ˆ Controller ä¸ºå•¥ç›´æ¥æ·»åŠ  @Validated æˆ–è€… @Valid å°±å¯ä»¥å‘¢ï¼Ÿ</h3><p>æ˜ç™½äº†åœ¨åº”ç”¨æœåŠ¡å®ç°ï¼Œå‡†ç¡®çš„è¯´åº”è¯¥æ˜¯æ™®é€š Bean ä¸­åº”è¯¥æ€ä¹ˆé…ç½®ä¹‹ @Validated å’Œ @Valid ä½¿å…¶ç”Ÿæ•ˆä¹‹åï¼Œæˆ‘å°±å¾ˆå¥½å¥‡ä¸ºå•¥ Controller åªéœ€è¦å•ç‹¬åœ¨æ–¹æ³•ä¸Šé…ç½® @Validated æˆ–è€… @Valid å°±èƒ½æˆåŠŸæ ¡éªŒå‘¢ï¼Ÿ</p><p>è¿˜è®°å¾—ä¸Šé¢é€šè¿‡ IDE æŸ¥çœ‹åº”ç”¨ @Validated æ³¨è§£çš„ç±»æ—¶ï¼Œæˆ‘ä»¬å‘ç°äº† MethodValidationPostProcessorï¼Œè¿˜æœ‰å¦å¤–å‡ ä¸ªç±»ä¸€çœ‹å°±å¾ˆåƒ Controller å‚æ•°è§£æç›¸å…³çš„ç±»ï¼š</p><img src="/images/6a453dcb7830c8ba9ebead61cb4942d9.png" alt="æˆªå›¾" style="zoom:100%;" /><p>æˆ‘åœ¨è¿™å‡ ä¸ªç±»ä¸Šå„æ‰“äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œæœ€ç»ˆè¿›å…¥çš„æ˜¯ AbstractMessageConverterMethodArgumentResolverã€‚</p><p>okï¼Œé‚£å°±çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œåªè´´äº†å¾ˆå‚æ•°æ ¡éªŒç›¸å…³çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMessageConverterMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">validateIfApplicable</span><span class="params">(WebDataBinder binder, MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">        Annotation[] annotations = parameter.getParameterAnnotations();</span><br><span class="line">        <span class="keyword">for</span> (Annotation ann : annotations) &#123;</span><br><span class="line">            <span class="comment">//è·å–åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">            Object[] validationHints = ValidationAnnotationUtils.determineValidationHints(ann);</span><br><span class="line">            <span class="keyword">if</span> (validationHints != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line">                binder.validate(validationHints);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationAnnotationUtils</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object[] determineValidationHints(Annotation ann) &#123;</span><br><span class="line">        Class&lt;? extends Annotation&gt; annotationType = ann.annotationType();</span><br><span class="line">        String annotationName = annotationType.getName();</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ @valid æ³¨è§£ç›´æ¥è¿”å›ä¸€ä¸ªç©ºæ•°ç»„</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"javax.validation.Valid"</span>.equals(annotationName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> EMPTY_OBJECT_ARRAY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ @validated åˆ™è¿”å›å…¶åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">        Validated validatedAnn = AnnotationUtils.getAnnotation(ann, Validated<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (validatedAnn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object hints = validatedAnn.value();</span><br><span class="line">            <span class="keyword">return</span> convertValidationHints(hints);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (annotationType.getSimpleName().startsWith(<span class="string">"Valid"</span>)) &#123;</span><br><span class="line">            Object hints = AnnotationUtils.getValue(ann);</span><br><span class="line">            <span class="keyword">return</span> convertValidationHints(hints);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinder</span> <span class="keyword">implements</span> <span class="title">PropertyEditorRegistry</span>, <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object... validationHints)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ˜¯å…³é”®æ‰€åœ¨ï¼Œè¿™é‡Œè·å–çš„æ˜¯å‚æ•°ï¼ï¼ï¼å’Œæ™®é€šçš„ Bean è·å–åˆ°çš„å´æ˜¯ Bean æœ¬èº«</span></span><br><span class="line">        Object target = getTarget();</span><br><span class="line">        Assert.state(target != <span class="keyword">null</span>, <span class="string">"No target to validate"</span>);</span><br><span class="line">        BindingResult bindingResult = getBindingResult();</span><br><span class="line">        <span class="comment">// Call each validator with the same binding result</span></span><br><span class="line">        <span class="keyword">for</span> (Validator validator : getValidators()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ObjectUtils.isEmpty(validationHints) &amp;&amp; validator <span class="keyword">instanceof</span> SmartValidator) &#123;</span><br><span class="line">                ((SmartValidator) validator).validate(target, bindingResult, validationHints);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (validator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                validator.validate(target, bindingResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº Controller ä¸è®ºæ˜¯ç›´æ¥åœ¨å‚æ•°ä¸ŠåŠ ä¸Š @Validated æˆ–è€… @Valid æ³¨è§£ï¼Œéƒ½ä¼šè¿›å…¥åˆ°æ ¡éªŒæ–¹æ³•ï¼Œ<strong>è€Œä¸”æ ¡éªŒçš„å°±æ˜¯å‚æ•°ï¼ï¼ï¼è€Œ Bean æ ¡éªŒçš„å´æ˜¯ Bean æœ¬èº«ï¼ï¼ï¼</strong></p><h3 id="MethodValidationPostProcessor-å’Œ-AbstractMessageConverterMethodArgumentResolver-æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ°-BeanFactory-çš„ï¼Ÿ"><a href="#MethodValidationPostProcessor-å’Œ-AbstractMessageConverterMethodArgumentResolver-æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ°-BeanFactory-çš„ï¼Ÿ" class="headerlink" title="MethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ï¼Ÿ"></a>MethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ï¼Ÿ</h3><p>æ˜ç™½äº† @Validated çš„æ‹¦æˆªå®ç°çš„åŸç†åï¼Œé‚£ä¹ˆå°±åªå‰©æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼ŒMethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ã€‚</p><p>å…¶å®ä¸ç”¨çœ‹æºç å¤§æ¦‚æœ‰ä¹Ÿèƒ½çŒœåˆ°æ˜¯ Spring Boot è‡ªåŠ¨è£…é…çš„ã€‚ä¸ºäº†å°è¯ä¸€ä¸‹ï¼Œæˆ‘è¿˜æ˜¯è´´ä¸€ä¸‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(ExecutableValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnResource</span>(<span class="title">resources</span> </span>= <span class="string">"classpath:META-INF/services/javax.validation.spi.ValidationProvider"</span>)</span><br><span class="line"><span class="meta">@Import</span>(PrimaryDefaultValidatorPostProcessor<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ValidationAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodValidationPostProcessor <span class="title">methodValidationPostProcessor</span><span class="params">(Environment environment, @Lazy Validator validator, ObjectProvider&lt;MethodValidationExcludeFilter&gt; excludeFilters)</span> </span>&#123;</span><br><span class="line">        FilteredMethodValidationPostProcessor processor = <span class="keyword">new</span> FilteredMethodValidationPostProcessor(excludeFilters.orderedStream());</span><br><span class="line">        <span class="keyword">boolean</span> proxyTargetClass = environment.getProperty(<span class="string">"spring.aop.proxy-target-class"</span>, Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">true</span>)</span>;</span><br><span class="line">        processor.setProxyTargetClass(proxyTargetClass);</span><br><span class="line">        processor.setValidator(validator);</span><br><span class="line">        <span class="keyword">return</span> processor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–å°±æ˜¯ AbstractMessageConverterMethodArgumentResolver çš„å‡ ä¸ªå®ç°ç±»ï¼Œå‡ç”± RequestMappingHandlerAdapter å®ä¾‹åŒ–ï¼Œè€Œ RequestMappingHandlerAdapter å¤§å®¶çŸ¥é“æœ‰ WebMvcAutoConfiguration è‡ªåŠ¨è£…é…ï¼Œæ—¶é—´åŸå› ï¼Œè¿™å°±ä¸çœ‹äº†ã€‚</p><img src="/images/2848df20caae7fcdd6277d991b9f98d2.png" alt="æˆªå›¾" style="zoom:100%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMethodAdapter</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class="title">getDefaultArgumentResolvers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Annotation-based argument resolution</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">false</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PathVariableMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PathVariableMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MatrixVariableMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MatrixVariableMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">false</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestPartMethodArgumentResolver(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestHeaderMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> SessionAttributeMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestAttributeMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Type-based argument resolution</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletRequestMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletResponseMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RedirectAttributesMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ModelMethodProcessor());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MapMethodProcessor());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ErrorsMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> SessionStatusMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> UriComponentsBuilderMethodArgumentResolver());</span><br><span class="line">        <span class="keyword">if</span> (KotlinDetector.isKotlinPresent()) &#123;</span><br><span class="line">            resolvers.add(<span class="keyword">new</span> ContinuationHandlerMethodArgumentResolver());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Custom arguments</span></span><br><span class="line">        <span class="keyword">if</span> (getCustomArgumentResolvers() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvers.addAll(getCustomArgumentResolvers());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Catch-all</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PrincipalMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">true</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resolvers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>1ã€åœ¨æ™®é€š Bean ä¸­å¦‚æœè¦é€šè¿‡æ³¨è§£çš„æ–¹å¼ä½¿ç”¨ hibernate-validator è¿›è¡Œæ ¡éªŒçš„è¯ï¼Œéœ€è¦åœ¨ç±»ä¸Šæ·»åŠ  @Validated æ³¨è§£ï¼ŒåŒæ—¶åœ¨æ–¹æ³•ä¸Šæ·»åŠ  @Valid æ³¨è§£ã€‚æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ @NotNull ç­‰æ³¨è§£ã€‚</p><p>2ã€æ™®é€š Bean ä½¿ç”¨ @Validated æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆçš„ã€‚å…·ä½“çš„æ‹¦æˆªå™¨ä¾¿æ˜¯ä»– MethodValidationInterceptorã€‚</p><p>3ã€Controller å±‚ä¹‹æ‰€ä»¥èƒ½ @Validated å’Œ @Valid äºŒé€‰ä¸€ï¼Œæ˜¯å› ä¸ºæ ¡éªŒçš„æ˜¯å‚æ•°æœ¬èº«ï¼Œè€Œæ™®é€š Bean æ ¡éªŒçš„æ˜¯ Bean æœ¬èº«ã€‚</p><p>4ã€è‡³æ­¤ï¼Œç›¸ä¿¡å¤§å®¶å°±ä¸ä¼šæ²¡é…ç½®å¥½ @Validated å¯¼è‡´å¤±æ•ˆäº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åœ¨è½åœ° DDDï¼Œå¸Œæœ›å¯¹ command è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç”±äºéƒ¨åˆ†æµé‡å…¥å£æ˜¯ MQï¼Œæ‰€ä»¥å¸Œæœ›åœ¨åº”ç”¨å±‚æ˜¯ç”¨ @Validated è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç»“æœã€‚ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;Controller-ä¸­ä½¿ç”¨-Valida</summary>
      
    
    
    
    
    <category term="spring" scheme="http://example.com/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>kafka æ¶ˆè´¹è€…é«˜ cpu é—®é¢˜æ’æŸ¥</title>
    <link href="http://example.com/2023/04/14/kafka-%E6%B6%88%E8%B4%B9%E8%80%85%E9%AB%98-cpu-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    <id>http://example.com/2023/04/14/kafka-%E6%B6%88%E8%B4%B9%E8%80%85%E9%AB%98-cpu-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</id>
    <published>2023-04-14T15:31:22.000Z</published>
    <updated>2023-04-14T15:48:38.289Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©æœ¬æ¥æ‰“ç®—æ„‰å¿«çš„åˆ’æ°´ï¼Œè¿ç»´å°å“¥çªç„¶æ‰¾æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåº”ç”¨ cpu ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œæˆ‘ä¸€çœ‹å‘Šè­¦è¿˜çœŸæ˜¯â€¦</p></blockquote><h3 id="cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯"><a href="#cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯" class="headerlink" title="cpu é«˜é—®é¢˜æ’æŸ¥æ€è·¯"></a>cpu é«˜é—®é¢˜æ’æŸ¥æ€è·¯</h3><h4 id="é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š"><a href="#é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š" class="headerlink" title="é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š"></a>é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š</h4><ol><li>å…ˆæŸ¥çœ‹ cpu é«˜çš„çº¿ç¨‹æ˜¯å“ªäº›</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -Hp &lt;pid&gt;</span><br></pre></td></tr></table></figure><img src="/images/9a05c976-5255-48db-918a-2cf6e7f8047d.png" alt="æˆªå›¾" style="zoom:100%"><ol start="2"><li>æŸ¥çœ‹çº¿ç¨‹çš„å †æ ˆä¿¡æ¯</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//å°†çº¿ç¨‹ id è½¬æ¢ä¸º 16 è¿›åˆ¶</span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> &lt;tid&gt;</span><br><span class="line"></span><br><span class="line">//è·å–çº¿ç¨‹å·å 50 è¡Œå †æ ˆä¿¡æ¯</span><br><span class="line">jstack &lt;pid&gt; | grep &lt;tid&gt; -A 50</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å°±ç›´æ¥ç”¨çº¿ç¨‹åç§°å»æŸ¥äº†ã€‚</p><img src="/images/dccda0a5-30a3-443e-a5b7-62ba3f83d12d.png" alt="æˆªå›¾" style="zoom:100%"><p>çœ‹å †æ ˆä¿¡æ¯å®šä½åˆ°æ˜¯ kafka æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¯¼è‡´ cpu å±…é«˜ä¸ä¸‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ kafka æ¶ˆè´¹è€… cpu é£šé«˜éƒ½æ˜¯æœ‰å¤§é‡çš„æ¶ˆæ¯ï¼Œæˆ‘ç¬¬ä¸€ä¸ªæ„Ÿè§‰å°±æ˜¯æµ‹è¯•åœ¨è¿›è¡Œå‹æµ‹ï¼Œç»“æœä¸€çœ‹ï¼Œæ‰“è„¸äº†ğŸ¤”ã€‚</p><img src="/images/2ebfeb48-41ce-460f-bd4e-14ef2824b82e.png" alt="æˆªå›¾" style="zoom:100%"><p>å¯ä»¥çœ‹åˆ°ï¼Œlag æ˜¯ 0 æˆ–è€…è´Ÿæ•°ï¼Œæˆ‘åˆåˆ·æ–°äº†å‡ æ¬¡åŸºæœ¬ä¸Šæ²¡æœ‰å¤šå°‘æ¶ˆæ¯ï¼Œ<strong>è¿™é‡Œç•™ä¸ªå¿ƒçœ¼ï¼Œåé¢æˆ‘ä»¬åœ¨å¥½å¥½å” å” </strong>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ²¡æœ‰æ¶ˆæ¯ä¸ºå•¥æ¶ˆè´¹è€… cpu ä¼šé£šé«˜â€¦ çªç„¶çµæœºä¸€åŠ¨ï¼Œä¼šä¸ä¼šæ˜¯æ¶ˆè´¹è€…æ•°å¤ªå¤šäº†ï¼Œå¯¼è‡´å¾ªç¯å»è°ƒç”¨ poll æ–¹æ³•ï¼Œé€ æˆæ•´ä¸ªèŠ‚ç‚¹ cpu é£šé«˜ã€‚ç„¶åå°±å±é¢ å±é¢ çš„æŠŠæ‰€æœ‰ä¸»é¢˜çš„æ¶ˆè´¹è€…æ•°è°ƒå°äº†ï¼Œç„¶é¹…æƒ³æƒ³å¾ˆç¾å¥½ï¼Œç°å®å¾ˆéª¨æ„Ÿâ€¦ é‡å¯åèŠ‚ç‚¹çš„ cpu ä¾ç„¶å±…é«˜ä¸ä¸‹ã€‚</p><h4 id="é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜"><a href="#é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜" class="headerlink" title="é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜"></a>é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜</h4><p>åœ¨ç½‘ä¸Šé€›äº†ä¸€åœˆï¼Œçœ‹åˆ°è®¸å¤šç›¸ä¼¼çš„åœºæ™¯ï¼Œå„ç§æ“ä½œéƒ½è¯•äº†ä¸€éï¼Œè¿˜æ˜¯æ²¡ä»€ä¹ˆç”¨ğŸ™ƒï¼Œkafka çš„ github ä»“åº“æˆ‘ä¹Ÿå»é€›äº†ä¸€åœˆï¼Œå‘ç°ä¹Ÿæœ‰å¾ˆå¤š cpu é«˜å¾—åœºæ™¯ï¼Œå¤§å¤šæ•°éƒ½æ˜¯å»ºè®®å‡çº§å®¢æˆ·ç«¯ç‰ˆæœ¬ï¼Œå¿˜äº†è¯´æˆ‘å¸ç›®å‰ç”¨çš„è¿˜æ˜¯ <strong>0.11.2</strong>ï¼Œæ€»ä¹‹é€›äº†ä¸€åœˆæ²¡æœ‰èµ·åˆ°å¤ªå¤§çš„å¸®åŠ©ã€‚</p><p>æ¥ç€å°±æ˜¯ä¸€æ³¢è™¾çš®æ“ä½œï¼Œæ˜¾ç¤ºç”Ÿæˆäº†ç«ç„°å›¾ï¼Œçœ‹çœ‹ consumer poll åˆ°åº•ä¸ºå•¥ä¸€ç›´å ç”¨ cpuï¼Œä¸‹é¢æ˜¯ä¸€å¼ ç«ç„°å›¾ï¼š</p><img src="/images/6a2a9517-818a-4a3e-a9be-2b5b40dac23e.png" alt="æˆªå›¾" style="zoom:100%"><p>è™½ç„¶ poll æ–¹æ³•å ç”¨ cpu è€—æ—¶å¾ˆé•¿ï¼Œä½†æ˜¯ä»”ç»†çœ‹åˆè§‰å¾—æ²¡å•¥é—®é¢˜ï¼Œæ˜¯æ­£å¸¸çš„åœ¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ç”šè‡³ä¸€åº¦æ€€ç–‘æ˜¯ kafka å®¢æˆ·ç«¯çš„ bug ğŸ˜‚ã€‚</p><h3 id="æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³"><a href="#æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³" class="headerlink" title="æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³"></a>æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³</h3><p>è¿˜è®°çš„æˆ‘ä»¬ä¹‹å‰æäº†ä¸€å˜´é‚£å¼ æˆªå›¾å—ï¼Œæ²¡é”™å°±æ˜¯ä¸‹é¢è¿™å¼ </p><img src="/images/2ebfeb48-41ce-460f-bd4e-14ef2824b82e.png" alt="æˆªå›¾" style="zoom:100%"><p>å›¾ä¸­ lag å‡ºç°è´Ÿæ•°ï¼Œå…¶å® lag å‡ºç°è´Ÿæ•°è¿˜æ˜¯å¾ˆå¸¸è§çš„ï¼Œä½†é—®é¢˜å°±å‡ºåœ¨æˆ‘æ’æŸ¥äº†è¿™ä¹ˆä¹…å›¾ä¸­çš„ lag å¥½åƒæ²¡å˜åŒ–è¿‡ï¼Œè€Œä¸”ä¸€ç›´æ˜¯è´Ÿæ•°ï¼Œé‚£å°±å¾ˆå€¼å¾—æ³¨æ„äº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯å…ˆè¯´è¯´ lag æ˜¯æ€ä¹ˆè®¡ç®—çš„</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lag = HW - consumerOffset</span><br></pre></td></tr></table></figure><p><strong>HW: é«˜æ°´ä½ï¼Œé€šå¸¸ç­‰äºæ‰€æœ‰ ISR ä¸­æœ€å°çš„ LEOï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹çœ‹<a href="https://www.cnblogs.com/koktlzz/p/14580109.html" target="_blank" rel="noopener">å¤§ä½¬çš„åšå®¢</a></strong></p><p><strong>consumerOffset: è¡¨ç¤ºæ¶ˆè´¹è€…æäº¤çš„æ¶ˆè´¹ä½ç§»</strong></p><p>é‚£ä¹ˆ lag ä¸ºå•¥ä¼šå‡ºç°è´Ÿæ•°å‘¢ï¼Œç”±äºæˆ‘æœ¬èº«å¹¶æœªçœ‹è¿‡æºç ï¼Œæ‰€ä»¥ä»ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒæ˜¯èƒ½è¯´çš„é€šçš„è§£é‡Š:</p><blockquote><p>Producer çš„ offset æ˜¯é€šè¿‡ JMX è½®è¯¢è·å¾—çš„ï¼ŒConsumer çš„ offset æ˜¯ä» kafka å†…çš„ __consumer_offsets çš„ topic ä¸­ç›´æ¥è¯»å–åˆ°çš„ï¼Œå¾ˆæ˜æ˜¾è½®è¯¢è·å– offset æ¯” ç›´æ¥ä» topic æ‹¿ offset æ…¢ä¸€ç‚¹ï¼Œä¹Ÿå°±å¯èƒ½ä¼šå‡ºç° Lag è®¡ç®—åä¸ºè´Ÿæ•°çš„æƒ…å†µã€‚</p></blockquote><p>OKï¼Œå›åˆ°æ­£é¢˜ï¼Œlag é•¿æ—¶é—´æ˜¯è´Ÿæ•°è¯´æ˜ consumerOffset ä¸€ç›´å¤§äº HWï¼Œé‚£ä¹ˆå‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› å¤§æ¦‚ç‡æ˜¯ HW ä¸€ç›´ä¸æ›´æ–°ï¼Œå› ä¸º HW åªè¦æ›´æ–°å…¶å® lag å¾ˆå¿«å°±èƒ½å˜å› 0ã€‚é‚£ä¹ˆ HW æ˜¯ä»€ä¹ˆæ—¶å€™æ›´æ–°çš„å‘¢ï¼Œ<strong>å…¶å®æ˜¯ Follower å‰¯æœ¬åŒæ­¥ Leader å‰¯æœ¬æ•°æ®æ—¶ï¼ŒLeader å‰¯æœ¬ä¼šå¯¹æ¯” Follower æ‹‰å–æ•°æ®çš„ offset å’Œ Leader è‡ªèº«çš„ LEO å»æ›´æ–° HWï¼Œæ‰€ä»¥é€šå¸¸ HW éœ€è¦ Follower å¤šåŒæ­¥ä¸€è½®æ‰ä¼šæ›´æ–°</strong>ã€‚</p><p><strong>é‚£ä¹ˆ HW ä¸æ›´æ–°ï¼Œåªèƒ½è¯´æ˜ Follower æ²¡æœ‰å»åŒæ­¥æ•°æ®</strong>ï¼Œæƒ³åˆ°è¿™ï¼Œæˆ‘ç«‹é©¬å»çœ‹äº†ä¸‹æ¶ˆè´¹ç»„çš„å‰¯æœ¬çŠ¶æ€ï¼Œå‘ç°æœ‰ä¸€ä¸ª broker æ‰€æœ‰çš„åˆ†åŒºå‰¯æœ¬éƒ½ä¸åœ¨ ISR ä¸­ã€‚é‚£ä¹ˆåŸºæœ¬ä¸Šç¡®å®šè¿™ä¸ª broker æ˜¯å‡ºç°é—®é¢˜äº†ï¼Œä½†æ˜¯è¿™å’Œæˆ‘æ¶ˆè´¹è€… cpu é«˜æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p><img src="/images/382ce5cb-4dfe-481f-88ca-fc2cd9313431.png" alt="æˆªå›¾" style="zoom:100%"><p>è¿™æ—¶è¿ç»´å°å“¥å‘Šè¯‰æˆ‘ï¼Œpoll å¹³å‡æ¯ 3ms å°±è¯·æ±‚ä¸€æ¬¡ï¼Œå¯¼è‡´ cpu é£šé«˜ã€‚çº³å°¼ï¼Ÿï¼Ÿï¼Ÿæˆ‘çš„ poll timeout æ˜æ˜æ˜¯ 100msï¼Œæ€ä¹ˆ 3ms ä¸€æ¬¡å‘¢ï¼Œè¿™æ˜æ˜¾æœ‰é—®é¢˜å‘€ï¼Œè¿ç»´å°å“¥å‘äº†ä¸€ä¸‹æŠ“åŒ…çš„æˆªå›¾ç»™æˆ‘ï¼š</p><img src="/images/16814578551784.png" alt="æˆªå›¾" style="zoom:100%"><p><strong>kafka broker response ä¸­æç¤º Not Leader For Partition</strong>ï¼Œè¿™ä¸å°±å’Œä¸Šé¢çš„çŒœæƒ³å¯¹ä¸Šäº†å—ï¼Œçœ‹çœ‹ chatgpt ç»™å‡ºçš„è§£é‡Š:</p><img src="/images/16b2e8bc-06a3-4166-bf25-6815077beb93.png" alt="æˆªå›¾" style="zoom:100%"><p>è‡³æ­¤é—®é¢˜å°±æ’æŸ¥äº†å·®ä¸å¤šäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è§£å†³ã€‚ç”±äºæ˜¯åœ¨æµ‹è¯•ç¯å¢ƒå‘ç°çš„ï¼Œè§£å†³æ–¹å¼ä¹Ÿå¾ˆç²—æš´ï¼Œå°±æ˜¯ç›´æ¥æŠŠ topic ç›´æ¥åˆ é™¤äº†ï¼Œç„¶åé‡æ–°åˆ›å»ºã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ol><li>é‡åˆ°æ¶‰åŠç½‘ç»œç›¸å…³çš„é—®é¢˜ï¼Œå¯ä»¥æŠ“ä¸ªåŒ…ç§ç§ï¼Œè¯´ä¸å®šæ€è·¯ä¸€ä¸‹å°±æ‰“å¼€äº†ã€‚</li><li>å¦‚æœå®åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°è¿™ç±»é—®é¢˜ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆå¤„ç† broker å‘¢ï¼Œè¿™ä¸ªå¾—å¥½å¥½ç¢ç£¨ç¢ç£¨ï¼Œç›®å‰æ€è·¯æ˜¯ä» controller ä¸‹æ‰‹ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä»Šå¤©æœ¬æ¥æ‰“ç®—æ„‰å¿«çš„åˆ’æ°´ï¼Œè¿ç»´å°å“¥çªç„¶æ‰¾æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåº”ç”¨ cpu ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œæˆ‘ä¸€çœ‹å‘Šè­¦è¿˜çœŸæ˜¯â€¦&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯&quot;&gt;&lt;a href=&quot;#cpu-é«˜é—®é¢˜æ’æŸ¥æ€è·¯&quot; class=&quot;header</summary>
      
    
    
    
    
    <category term="kafka" scheme="http://example.com/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>wireshark æŠ“åŒ… javaåº”ç”¨ä¸­çš„ https è¯·æ±‚</title>
    <link href="http://example.com/2023/04/03/wireshark-%E6%8A%93%E5%8C%85-java%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84-https-%E8%AF%B7%E6%B1%82/"/>
    <id>http://example.com/2023/04/03/wireshark-%E6%8A%93%E5%8C%85-java%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84-https-%E8%AF%B7%E6%B1%82/</id>
    <published>2023-04-03T07:08:41.000Z</published>
    <updated>2023-04-03T07:12:39.504Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘ç”Ÿäº§ä¸­è¯·æ±‚ç¬¬ä¸‰æ–¹æ¥å£çš„æœåŠ¡é¢‘ç¹å‘Šè­¦ï¼Œæ¥å£å“åº”è¿‡æ…¢ï¼Œæˆ‘ä»¬è¿™è¾¹ä½¿ç”¨çš„ httpclient è¿æ¥æ± ï¼Œå„é¡¹é…ç½®çœ‹èµ·æ¥éƒ½æ²¡å¤ªå¤§çš„é—®é¢˜ï¼Œäºæ˜¯å°±æƒ³ç€è¯´æŠ“åŒ…çœ‹çœ‹æ˜¯å¦æœ‰ç½‘ç»œå±‚é¢çš„é—®é¢˜è¿˜æ˜¯çš„ç¡®æ˜¯ç¬¬ä¸‰æ–¹æ¥å£æ…¢ã€‚</p></blockquote><h2 id="é€šè¿‡-jsslkeylog-è·å–-sslkeylog"><a href="#é€šè¿‡-jsslkeylog-è·å–-sslkeylog" class="headerlink" title="é€šè¿‡ jsslkeylog è·å– sslkeylog"></a>é€šè¿‡ <a href="https://github.com/jsslkeylog/jsslkeylog" target="_blank" rel="noopener">jsslkeylog</a> è·å– sslkeylog</h2><h3 id="wireshark-ä¸­-https-æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­"><a href="#wireshark-ä¸­-https-æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­" class="headerlink" title="wireshark ä¸­ https æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­"></a>wireshark ä¸­ https æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­</h3><p>æœ‰ç”¨è¿‡ wireshark æŠ“åŒ… https çš„å¤§ä½¬åº”è¯¥éƒ½çŸ¥é“ï¼Œhttps æ˜¯æœ‰åŠ å¯†çš„ï¼Œç›´æ¥ç”¨ wireshark æŠ“åŒ…å±•ç¤ºçš„å…¨éƒ½æ˜¯å¯†æ–‡ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/images/9e5440f2db4de1185099e8c1e91edfc.png" alt="æˆªå›¾" style="zoom:100%"><br>å¯ä»¥çœ‹åˆ°ï¼Œå…·ä½“çš„ https è¯·æ±‚æ•°æ®éƒ½è¢«åŠ å¯†äº†ã€‚</p><h3 id="å¦‚ä½•è®©-https-åœ¨-wireshark-æ˜¾ç¤ºæ˜æ–‡"><a href="#å¦‚ä½•è®©-https-åœ¨-wireshark-æ˜¾ç¤ºæ˜æ–‡" class="headerlink" title="å¦‚ä½•è®© https åœ¨ wireshark æ˜¾ç¤ºæ˜æ–‡"></a>å¦‚ä½•è®© https åœ¨ wireshark æ˜¾ç¤ºæ˜æ–‡</h3><p>wireshark ä¸­è§£å¯† https è¯·æ±‚çš„<a href="https://www.google.com.hk/search?q=wireshark+%E8%A7%A3%E5%AF%86+https&newwindow=1&sxsrf=APwXEdfQwqHE-Fyw3B1hnQNyxby131_KyA:1680505936629&ei=UHwqZJj6Je3f2roPovmx8A4&ved=0ahUKEwiY4pS7lI3-AhXtr1YBHaJ8DO4Q4dUDCA8&uact=5&oq=wireshark+%E8%A7%A3%E5%AF%86+https&gs_lcp=Cgxnd3Mtd2l6LXNlcnAQAzIHCAAQgAQQDDIHCAAQgAQQDDIHCAAQgAQQDDoECCMQJzoFCAAQgAQ6CAgAEAgQBBAeSgQIQRgAUABYowpgtgxoAHABeACAAc4CiAH5DJIBBzAuMS41LjGYAQCgAQHAAQE&sclient=gws-wiz-serp" target="_blank" rel="noopener">æ–¹å¼</a>æœ‰å¤šç§ï¼Œè¿™é‡Œä½¿ç”¨çš„æ–¹å¼æ˜¯è·å– https è¯·æ±‚æ—¶çš„ sslkeylogï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª javaagent å·¥å…· <a href="https://github.com/jsslkeylog/jsslkeylog" target="_blank" rel="noopener">jsslkeylog</a>ï¼Œé€šè¿‡ä¿®æ”¹å­—èŠ‚ç è¾¾åˆ°å‘é€ https è¯·æ±‚æ—¶å°†ä½¿ç”¨åˆ°çš„ sslkeylog å†™å…¥åˆ°æœ¬åœ°ç£ç›˜çš„æ•ˆæœã€‚<br>å…·ä½“æµç¨‹ä¹Ÿå¾ˆç®€å•ï¼š<br>1ã€ä¸‹è½½ jsslkeylog jar åŒ…<br>2ã€å¯åŠ¨å‘½ä»¤ä¸­åŠ å…¥ -javaagent:/path_to_jar/jSSLKeyLog.jar=/path_to_log/sslkeylog.log<br>3ã€å¯åŠ¨åº”ç”¨å‘èµ· https è¯·æ±‚<br>4ã€ä¹‹ååº”è¯¥å°±ä¼šåœ¨é…ç½®çš„ /path_to_log ä¸­çœ‹åˆ°å¯¹åº”çš„ sslkeylog<br><img src="/images/05a6bf5febf9f1b4673920a5d1697bdc.png" alt="æˆªå›¾" style="zoom:100%"><br>5ã€ä¹‹åå°† log é…ç½®åˆ° wireshark ä¸­ï¼Œprfferences -&gt; protocols -&gt; tls<br><img src="/images/3b0485a52fcfe450902e8cb06b8b3ca1.png" alt="æˆªå›¾" style="zoom:100%"><br>é…ç½®å®Œæˆä¹‹åï¼Œå°±èƒ½çœ‹åˆ°åŸæœ¬çš„å¯†æ–‡å·²ç»å˜æˆæ˜æ–‡äº†ï¼Œä¹‹åå°±èƒ½æ„‰å¿«çš„åˆ†æäº†ğŸŒ<br><img src="/images/ba3709b43b60602fc22efe0525515d0e.png" alt="æˆªå›¾" style="zoom:100%"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘ç”Ÿäº§ä¸­è¯·æ±‚ç¬¬ä¸‰æ–¹æ¥å£çš„æœåŠ¡é¢‘ç¹å‘Šè­¦ï¼Œæ¥å£å“åº”è¿‡æ…¢ï¼Œæˆ‘ä»¬è¿™è¾¹ä½¿ç”¨çš„ httpclient è¿æ¥æ± ï¼Œå„é¡¹é…ç½®çœ‹èµ·æ¥éƒ½æ²¡å¤ªå¤§çš„é—®é¢˜ï¼Œäºæ˜¯å°±æƒ³ç€è¯´æŠ“åŒ…çœ‹çœ‹æ˜¯å¦æœ‰ç½‘ç»œå±‚é¢çš„é—®é¢˜è¿˜æ˜¯çš„ç¡®æ˜¯ç¬¬ä¸‰æ–¹æ¥å£æ…¢ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;</summary>
      
    
    
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="http://example.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>k8s æ­å»º</title>
    <link href="http://example.com/2023/03/31/k8s-%E6%90%AD%E5%BB%BA/"/>
    <id>http://example.com/2023/03/31/k8s-%E6%90%AD%E5%BB%BA/</id>
    <published>2023-03-31T15:45:37.000Z</published>
    <updated>2023-03-31T15:46:40.276Z</updated>
    
    <content type="html"><![CDATA[<h2 id="k8sæ­å»º"><a href="#k8sæ­å»º" class="headerlink" title="k8sæ­å»º"></a>k8sæ­å»º</h2><h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><p>æœ¬æ–‡ç³»æ­å»º kubernetes v1.21.3 ç‰ˆæœ¬é›†ç¾¤ç¬”è®°ï¼Œä½¿ç”¨ä¸‰å°è™šæ‹Ÿæœºä½œä¸º CentOS7.9 ç³»ç»Ÿæµ‹è¯•æœºï¼Œå®‰è£… kubeadmã€kubeletã€kubectl å‡ä½¿ç”¨ yum å®‰è£…ï¼Œç½‘ç»œç»„ä»¶é€‰ç”¨çš„æ˜¯ flannelã€‚</p><hr><h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>éƒ¨ç½²é›†ç¾¤æ²¡æœ‰ç‰¹æ®Šè¯´æ˜å‡ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ã€‚</p><p>2.1 ç¡¬ä»¶ä¿¡æ¯</p><table><thead><tr><th>ip</th><th>hostname</th><th>mem</th><th>disk</th><th>explain</th></tr></thead><tbody><tr><td>192.168.85.2</td><td>192.168.85.2</td><td>2G</td><td>40GB</td><td>k8s æ§åˆ¶å¹³é¢èŠ‚ç‚¹</td></tr><tr><td>192.168.85.3</td><td>192.168.85.3</td><td>2G</td><td>40GB</td><td>k8s æ‰§è¡ŒèŠ‚ç‚¹1</td></tr><tr><td>192.168.85.4</td><td>192.168.85.4</td><td>2G</td><td>40GB</td><td>k8s æ‰§è¡ŒèŠ‚ç‚¹2</td></tr></tbody></table><p>2.2 è½¯ä»¶ä¿¡æ¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">software    version</span><br><span class="line">CentOS    CentOS Linux release 7.9.2009 (Core)</span><br><span class="line">Kubernetes    1.21.3</span><br><span class="line">Docker    20.10.8</span><br><span class="line">Kernel    5.4.138-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure><p>2.3 ç¦ç”¨ swap<br>swap ä»…å½“å†…å­˜ä¸å¤Ÿæ—¶ä¼šä½¿ç”¨ç¡¬ç›˜å—å……å½“é¢å¤–å†…å­˜ï¼Œç¡¬ç›˜çš„ io è¾ƒå†…å­˜å·®è·æå¤§ï¼Œç¦ç”¨ swap ä»¥æé«˜æ€§èƒ½å„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a </span><br><span class="line">cp /etc/fstab  /etc/fstab.bak</span><br><span class="line">cat /etc/fstab.bak | grep -v swap &gt; /etc/fstab</span><br></pre></td></tr></table></figure><p>2.4 å…³é—­ SELinux</p><p>å…³é—­ SELinuxï¼Œå¦åˆ™ kubelet æŒ‚è½½ç›®å½•æ—¶å¯èƒ½æŠ¥é”™ Permission deniedï¼Œå¯ä»¥è®¾ç½®ä¸º permissive æˆ– disabledï¼Œpermissive ä¼šæç¤º warn ä¿¡æ¯å„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 </span><br><span class="line">sed -i <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><p>2.5 è®¾ç½®æ—¶åŒºã€åŒæ­¥æ—¶é—´</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai </span><br><span class="line">systemctl <span class="built_in">enable</span> --now chronyd</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹åŒæ­¥çŠ¶æ€ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl status</span><br></pre></td></tr></table></figure><p>2.6 å…³é—­é˜²ç«å¢™</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><br/><h3 id="å®‰è£…å¿…è¦ä¾èµ–"><a href="#å®‰è£…å¿…è¦ä¾èµ–" class="headerlink" title="å®‰è£…å¿…è¦ä¾èµ–"></a>å®‰è£…å¿…è¦ä¾èµ–</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure><p>3.1 æ·»åŠ  aliyun docker-ce yum æº </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p> é‡å»º yum ç¼“å­˜ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><p>3.2 å®‰è£… Docker</p><p>æŸ¥çœ‹å¯ç”¨ docker ç‰ˆæœ¬ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce.x86_64 --showduplicates | sort -r</span><br></pre></td></tr></table></figure><p><strong>==å®‰è£…æŒ‡å®šç‰ˆæœ¬ Docker==</strong></p><p>yum install -y docker-ce-20.10.14-3.el7</p><p>è¿™é‡Œä»¥å®‰è£… 20.10.14 ç‰ˆæœ¬ä¸¾ä¾‹ï¼Œæ³¨æ„ç‰ˆæœ¬å·ä¸åŒ…å« : ä¸ä¹‹å‰çš„æ•°å­—ã€‚</p><p>3.3 ç¡®ä¿ç½‘ç»œæ¨¡å—å¼€æœºè‡ªåŠ¨åŠ è½½</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep overlay </span><br><span class="line">lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure><p>è‹¥ä¸Šé¢å‘½ä»¤æ— è¿”å›å€¼è¾“å‡ºæˆ–æç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/docker.conf &lt;&lt;EOF </span><br><span class="line">overlay </span><br><span class="line">br_netfilter </span><br><span class="line">EOF</span><br><span class="line">modprobe overlay </span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure><p>3.4 ä½¿æ¡¥æ¥æµé‡å¯¹ iptables å¯è§<br>å„ä¸ªèŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF </span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><p>éªŒè¯æ˜¯å¦ç”Ÿæ•ˆï¼Œå‡è¿”å› 1 å³æ­£ç¡®ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl -n net.bridge.bridge-nf-call-iptables </span><br><span class="line">sysctl -n net.bridge.bridge-nf-call-ip6tables</span><br></pre></td></tr></table></figure><p>3.5 é…ç½® Docker</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ cgroup é©±åŠ¨ä¸º systemd [k8så®˜æ–¹æ¨è]ã€é™åˆ¶å®¹å™¨æ—¥å¿—é‡ã€ä¿®æ”¹å­˜å‚¨ç±»å‹ï¼Œæœ€åçš„ docker å®¶ç›®å½•å¯ä¿®æ”¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">  <span class="string">"storage-opts"</span>: [</span><br><span class="line">    <span class="string">"overlay2.override_kernel_check=true"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://gp8745ui.mirror.aliyuncs.com"</span>],</span><br><span class="line">  <span class="string">"data-root"</span>: <span class="string">"/data/docker"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>æœåŠ¡è„šæœ¬ç¬¬ 13 è¡Œä¿®æ”¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --default-ulimit core=0:0</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>æ·»åŠ å¼€æœºè‡ªå¯ï¼Œç«‹å³å¯åŠ¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure><p>3.6 éªŒè¯ Docker æ˜¯å¦æ­£å¸¸</p><p>æŸ¥çœ‹dockerä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦ä¸é…ç½®ä¸€è‡´</p><br/><h3 id="éƒ¨ç½²-Kubernetes-é›†ç¾¤"><a href="#éƒ¨ç½²-Kubernetes-é›†ç¾¤" class="headerlink" title="éƒ¨ç½² Kubernetes é›†ç¾¤"></a>éƒ¨ç½² Kubernetes é›†ç¾¤</h3><p>å¦‚æœªè¯´æ˜ï¼Œå„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š</p><p>4.1 æ·»åŠ  kubernetes æº</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>é‡å»ºyumç¼“å­˜ï¼Œè¾“å…¥yæ·»åŠ è¯ä¹¦è®¤è¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><p>4.2 å®‰è£… kubeadmã€kubeletã€kubectl<br>å„èŠ‚ç‚¹å‡éœ€å®‰è£… kubeadmã€kubelet</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce.x86_64 --showduplicates | sort -r</span><br><span class="line">version=1.21.3-0</span><br><span class="line">yum install -y kubelet-v1.21.0 kubeadm-v1.21.0 kubectl-v1.21.0</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet --now</span><br></pre></td></tr></table></figure><p>4.3 é…ç½®è‡ªåŠ¨è¡¥å…¨å‘½ä»¤</p><p>å®‰è£… bash è‡ªåŠ¨è¡¥å…¨æ’ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br></pre></td></tr></table></figure><p>è®¾ç½® kubectl ä¸ kubeadm å‘½ä»¤è¡¥å…¨ï¼Œä¸‹æ¬¡ login ç”Ÿæ•ˆ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl completion bash &gt;/etc/bash_completion.d/kubectl</span><br><span class="line">kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br></pre></td></tr></table></figure><p>4.4 ä¸º Docker è®¾å®šä½¿ç”¨çš„ä»£ç†æœåŠ¡(æš‚è·³è¿‡è¯¥æ­¥éª¤ï¼Œç”±é˜¿é‡Œäº‘é•œåƒè§£å†³)<br>Kubeadm éƒ¨ç½² Kubernetes é›†ç¾¤çš„è¿‡ç¨‹ä¸­ï¼Œé»˜è®¤ä½¿ç”¨ Google çš„ Registry æœåŠ¡ k8s.gcr.io ä¸Šçš„é•œåƒï¼Œä¾‹å¦‚k8s.grc.io/kube-apiserver ç­‰ï¼Œä½†å›½å†…æ— æ³•è®¿é—®åˆ°è¯¥æœåŠ¡ã€‚å¿…è¦æ—¶ï¼Œå¯è‡ªè¡Œè®¾ç½®åˆé€‚çš„ä»£ç†æ¥è·å–ç›¸å…³é•œåƒï¼Œæˆ–è€…ä» Dockerhub ä¸Šä¸‹è½½é•œåƒè‡³æœ¬åœ°åè‡ªè¡Œå¯¹é•œåƒæ‰“æ ‡ç­¾ã€‚</p><p>è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹è®¾ç½®ä»£ç†æœåŠ¡çš„æ–¹æ³•ã€‚ç¼–è¾‘ /lib/systemd/system/docker.service æ–‡ä»¶ï¼Œåœ¨ [Service] é…ç½®æ®µä¸­æ·»åŠ ç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼Œå…¶ä¸­çš„ PROXY_SERVER_IP å’Œ PROXY_PORT è¦æŒ‰ç…§å®é™…æƒ…å†µä¿®æ”¹ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Environment=<span class="string">"HTTP_PROXY=http://<span class="variable">$PROXY_SERVER_IP</span>:<span class="variable">$PROXY_PORT</span>"</span></span><br><span class="line">Environment=<span class="string">"HTTPS_PROXY=https://<span class="variable">$PROXY_SERVER_IP</span>:<span class="variable">$PROXY_PORT</span>"</span></span><br><span class="line">Environment=<span class="string">"NO_PROXY=192.168.4.0/24"</span></span><br></pre></td></tr></table></figure><p>é…ç½®å®Œæˆåéœ€è¦é‡è½½ systemdï¼Œå¹¶é‡æ–°å¯åŠ¨ docker æœåŠ¡ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure><p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œç”± kubeadm éƒ¨ç½²çš„ Kubernetes é›†ç¾¤ä¸Šï¼Œé›†ç¾¤æ ¸å¿ƒç»„ä»¶ kube-apiserverã€kube-controller-managerã€kube-scheduler å’Œ etcd ç­‰å‡ä¼šä»¥é™æ€ Pod çš„å½¢å¼è¿è¡Œï¼Œå®ƒä»¬æ‰€ä¾èµ–çš„é•œåƒæ–‡ä»¶é»˜è®¤æ¥è‡ªäº k8s.gcr.io è¿™ä¸€ Registry æœåŠ¡ä¹‹ä¸Šã€‚ä½†æˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®è¯¥æœåŠ¡ï¼Œå¸¸ç”¨çš„è§£å†³åŠæ³•æœ‰å¦‚ä¸‹ä¸¤ç§ï¼Œæœ¬ç¤ºä¾‹å°†é€‰æ‹©ä½¿ç”¨æ›´æ˜“äºä½¿ç”¨çš„å‰ä¸€ç§æ–¹å¼ï¼š</p><p>ä½¿ç”¨èƒ½å¤Ÿåˆ°è¾¾è¯¥æœåŠ¡çš„ä»£ç†æœåŠ¡<br>ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡å™¨ä¸Šçš„æœåŠ¡ï¼Œä¾‹å¦‚ gcr.azk8s.cn/google_containers å’Œ registry.aliyuncs.com/google_containers ç­‰ï¼ˆç»æµ‹è¯•ï¼Œv1.22.0 ç‰ˆæœ¬å·²åœç”¨ï¼‰<br>4.5 æŸ¥çœ‹æŒ‡å®š k8s ç‰ˆæœ¬éœ€è¦å“ªäº›é•œåƒ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list --kubernetes-version v1.21.0</span><br><span class="line"></span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.21.0</span><br><span class="line">k8s.gcr.io/pause:3.4.1</span><br><span class="line">k8s.gcr.io/etcd:3.4.13-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.0</span><br></pre></td></tr></table></figure><p>4.6 æ‹‰å–é•œåƒ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim pullimages.sh</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># pull images</span></span><br><span class="line"> </span><br><span class="line">ver=v1.21.0</span><br><span class="line">registry=registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">images=`kubeadm config images list --kubernetes-version=<span class="variable">$ver</span> |awk -F <span class="string">'/'</span> <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$images</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$image</span> != coredns ];<span class="keyword">then</span></span><br><span class="line">    docker pull <span class="variable">$&#123;registry&#125;</span>/<span class="variable">$image</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        docker tag <span class="variable">$&#123;registry&#125;</span>/<span class="variable">$image</span> k8s.gcr.io/<span class="variable">$image</span></span><br><span class="line">        docker rmi <span class="variable">$&#123;registry&#125;</span>/<span class="variable">$image</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ERROR: ä¸‹è½½é•œåƒæŠ¥é”™ï¼Œ<span class="variable">$image</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    docker pull coredns/coredns:1.8.0</span><br><span class="line">    docker tag coredns/coredns:1.8.0  k8s.gcr.io/coredns/coredns:v1.8.0</span><br><span class="line">    docker rmi coredns/coredns:1.8.0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>4.7 ä¿®æ”¹ kubelet é…ç½®é»˜è®¤ cgroup driver</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/kubelet</span><br><span class="line">cat &gt; /var/lib/kubelet/config.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>4.8 åˆå§‹åŒ– master èŠ‚ç‚¹<br>ä»… 192.168.85.2 èŠ‚ç‚¹éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤ã€‚</p><p>4.8.1 ç”Ÿæˆ kubeadm åˆå§‹åŒ–é…ç½®æ–‡ä»¶<br>[å¯é€‰] ä»…å½“éœ€è‡ªå®šä¹‰åˆå§‹åŒ–é…ç½®æ—¶ç”¨ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm-config.yaml</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 1.2.3.4</span><br></pre></td></tr></table></figure><p> æ›¿æ¢ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.85.2</span><br><span class="line">  name: 192.168.85.2</span><br><span class="line">kubernetesVersion: 1.21.0</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br></pre></td></tr></table></figure><p>æ›¿æ¢ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubernetesVersion: 1.21.0</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: <span class="string">"10.244.0.0/16"</span></span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br></pre></td></tr></table></figure><p>4.8.2 æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­£å¸¸</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init phase preflight</span><br></pre></td></tr></table></figure><p>4.8.3 åˆå§‹åŒ– master<br>10.244.0.0/16 æ˜¯ flannel å›ºå®šä½¿ç”¨çš„ IP æ®µï¼Œè®¾ç½®å–å†³äºç½‘ç»œç»„ä»¶è¦æ±‚ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-config.yaml --ignore-preflight-errors=2 --upload-certs | tee kubeadm-init.log</span><br></pre></td></tr></table></figure><p>4.8.4 ä¸ºæ—¥å¸¸ä½¿ç”¨é›†ç¾¤çš„ç”¨æˆ·æ·»åŠ  kubectl ä½¿ç”¨æƒé™</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">su - iuskye</span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/admin.conf</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/admin.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export KUBECONFIG=<span class="variable">$HOME</span>/.kube/admin.conf"</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>4.8.5 é…ç½® master è®¤è¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export KUBECONFIG=/etc/kubernetes/admin.conf'</span> &gt;&gt; /etc/profile </span><br><span class="line">. /etc/profile</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸é…ç½®è¿™ä¸ªï¼Œä¼šæç¤ºå¦‚ä¸‹è¾“å‡ºï¼šThe connection to the server localhost:8080 was refused - did you specify the right host or port?<br>æ­¤æ—¶ master èŠ‚ç‚¹å·²ç»åˆå§‹åŒ–æˆåŠŸï¼Œä½†æ˜¯è¿˜æœªå®‰è£…ç½‘ç»œç»„ä»¶ï¼Œè¿˜æ— æ³•ä¸å…¶ä»–èŠ‚ç‚¹é€šè®¯ã€‚</p><p>4.8.6 å®‰è£…ç½‘ç»œç»„ä»¶<br>ä»¥ flannel ä¸ºä¾‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -o kube-flannel.yml https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml    <span class="comment"># è¿™é‡Œä¸‹è½½é•œåƒéå¸¸æ…¢ï¼Œæˆ‘è¿˜æ˜¯å…ˆæ‰‹åŠ¨æ‹‰ä¸‹æ¥å§ï¼Œä¸è¡Œå°±å¤šè¯•å‡ æ¬¡</span></span><br><span class="line">docker pull quay.io/coreos/flannel:v0.14.0</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p>4.8.7 æŸ¥çœ‹ 192.168.85.2 èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">192.168.85.2   Ready    control-plane,master   15d   v1.21.0</span><br><span class="line">192.168.85.3   Ready    &lt;none&gt;                 15d   v1.21.0</span><br><span class="line">192.168.85.4   Ready    &lt;none&gt;                 15d   v1.21.0</span><br></pre></td></tr></table></figure><p>å¦‚æœ STATUS æç¤º NotReadyï¼Œå¯ä»¥é€šè¿‡ kubectl describe node 192.168.85.2 æŸ¥çœ‹å…·ä½“çš„æè¿°ä¿¡æ¯ï¼Œæ€§èƒ½å·®çš„æœåŠ¡å™¨åˆ°è¾¾ Ready çŠ¶æ€æ—¶é—´ä¼šé•¿äº›ã€‚</p><p>4.9 åˆå§‹åŒ– node èŠ‚ç‚¹å¹¶åŠ å…¥é›†ç¾¤<br>4.9.1 è·å–åŠ å…¥ kubernetes çš„å‘½ä»¤<br>è®¿é—® 192.168.85.2 è¾“å…¥åˆ›å»ºæ–° token å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br></pre></td></tr></table></figure><p>åŒæ—¶è¾“å‡ºåŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.85.2:6443 --token zukr14.dg1pxt9k9gndzqkl --discovery-token-ca-cert-hash sha256:0b57947ccd86cea8b7af2490fde858f3870e63bf35bbb0a567c702029376e9e5</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª token ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šè¿° master ä¸Šæ‰§è¡Œçš„åˆå§‹åŒ–è¾“å‡ºç»“æœã€‚</p><p>4.9.2 åœ¨ node èŠ‚ç‚¹ä¸Šæ‰§è¡ŒåŠ å…¥é›†ç¾¤çš„å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.85.2:6443 --token zukr14.dg1pxt9k9gndzqkl --discovery-token-ca-cert-hash sha256:0b57947ccd86cea8b7af2490fde858f3870e63bf35bbb0a567c702029376e9e5</span><br></pre></td></tr></table></figure><p>4.10 æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">192.168.85.2   Ready    control-plane,master   15d   v1.21.0</span><br><span class="line">192.168.85.3   Ready    &lt;none&gt;                 15d   v1.21.0</span><br><span class="line">192.168.85.4   Ready    &lt;none&gt;                 15d   v1.21.0</span><br></pre></td></tr></table></figure><p>4.11 éƒ¨ç½² Dashboard<br>4.11.1 éƒ¨ç½²</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o recommended.yaml https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><p>é»˜è®¤ Dashboard åªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹ Service ä¸º NodePort ç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vi recommended.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30001</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f recommended.yaml    <span class="comment"># è¿™é‡Œä¸‹è½½é•œåƒéå¸¸æ…¢ï¼Œæˆ‘è¿˜æ˜¯å…ˆæ‰‹åŠ¨æ‹‰ä¸‹æ¥å§ï¼Œä¸è¡Œå°±å¤šè¯•å‡ æ¬¡</span></span><br><span class="line">docker pull kubernetesui/dashboard:v2.3.1</span><br><span class="line">docker pull kubernetesui/metrics-scraper:v1.0.6</span><br><span class="line"></span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods,svc -n kubernetes-dashboard</span><br><span class="line">NAME                                             READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-856586f554-nb68k   0/1     ContainerCreating   0          52s</span><br><span class="line">pod/kubernetes-dashboard-67484c44f6-shtz7        0/1     ContainerCreating   0          52s</span><br><span class="line">NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.96.188.208   &lt;none&gt;        8000/TCP        52s</span><br><span class="line">service/kubernetes-dashboard        NodePort    10.97.164.152   &lt;none&gt;        443:30001/TCP   53s</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹çŠ¶æ€æ­£åœ¨åˆ›å»ºå®¹å™¨ä¸­ï¼Œç¨åå†æ¬¡æŸ¥çœ‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-856586f554-nb68k   1/1     Running   0          2m11s</span><br><span class="line">pod/kubernetes-dashboard-67484c44f6-shtz7        1/1     Running   0          2m11s</span><br><span class="line">NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.96.188.208   &lt;none&gt;        8000/TCP        2m11s</span><br><span class="line">service/kubernetes-dashboard        NodePort    10.97.164.152   &lt;none&gt;        443:30001/TCP   2m12s</span><br></pre></td></tr></table></figure><p>è®¿é—®åœ°å€ï¼š<a href="https://NodeIP:30001ï¼›ä½¿ç”¨">https://NodeIP:30001ï¼›ä½¿ç”¨</a> Firefox æµè§ˆå™¨ï¼ŒChrome æµè§ˆå™¨æ‰“ä¸å¼€ä¸ä¿¡ä»» SSL è¯ä¹¦çš„ç½‘ç«™ã€‚</p><p>åˆ›å»º service account å¹¶ç»‘å®šé»˜è®¤ cluster-admin ç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class="line">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk <span class="string">'/dashboard-admin/&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„ç²˜è´´çš„æ—¶å€™æœ‰å¯èƒ½è¢«æ¢è¡Œï¼Œå¦‚æœè¢«æ¢è¡Œï¼Œå¯åœ¨è®°äº‹æœ¬ä¸­è®¾ç½®ä¸ºä¸€è¡Œã€‚</p><p>ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚</p><br/><h3 id="é—®é¢˜è§£å†³"><a href="#é—®é¢˜è§£å†³" class="headerlink" title="é—®é¢˜è§£å†³"></a>é—®é¢˜è§£å†³</h3><p>1ã€dial tcp 10.96.0.1:443: connect: no route to host</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br><span class="line">systemctl stop kubelet</span><br><span class="line">iptables --flush</span><br><span class="line">iptables -tnat --flush</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><p>2ã€failed to delegate add: failed to set bridge addr: â€œcni0â€œ already has an IP address different from 1</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/weixin_42562106/article/details/123749291</span><br></pre></td></tr></table></figure><p>3ã€failed to add vxlanRoute (10.244.0.0/24 -&gt; 10.244.0.0): network is down</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip link delete flannel.1</span><br><span class="line">systemctl restart network</span><br><span class="line">kubectl delete -f kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p>4ã€Get <a href="http://10.244.0.3:8181/ready" target="_blank" rel="noopener">http://10.244.0.3:8181/ready</a>: dial tcp 10.244.0.3:8181: connect: connection refused</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é‡æ–°coredns</span></span><br><span class="line">kubectl -n kube-system rollout restart deployment/coredns</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡ ä¸ªé—®é¢˜é‡åˆ°å¯ä»¥å…ˆå°è¯•é‡å¯æ‰€æœ‰çš„æœºå™¨ï¼Œå¦‚æœä¸è¡Œåœ¨é€šè¿‡ä¸Šè¿°æ–¹æ¡ˆè§£å†³</p><blockquote><p>å‚è€ƒï¼š<a href="https://">https://www.iuskye.com/2021/08/10/k8s-kubeadm-1213.html</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;k8sæ­å»º&quot;&gt;&lt;a href=&quot;#k8sæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;k8sæ­å»º&quot;&gt;&lt;/a&gt;k8sæ­å»º&lt;/h2&gt;&lt;h3 id=&quot;è¯´æ˜&quot;&gt;&lt;a href=&quot;#è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;è¯´æ˜&quot;&gt;&lt;/a&gt;è¯´</summary>
      
    
    
    
    
    <category term="è¿ç»´" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="k8s" scheme="http://example.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>redisson3.15.2 å…¬å¹³é”ä»»åŠ¡ä¸¢å¤±</title>
    <link href="http://example.com/2023/03/31/redisson3.15.2%20%E5%85%AC%E5%B9%B3%E9%94%81%E4%BB%BB%E5%8A%A1%E4%B8%A2%E5%A4%B1/"/>
    <id>http://example.com/2023/03/31/redisson3.15.2%20%E5%85%AC%E5%B9%B3%E9%94%81%E4%BB%BB%E5%8A%A1%E4%B8%A2%E5%A4%B1/</id>
    <published>2023-03-31T15:22:45.000Z</published>
    <updated>2023-03-31T15:37:33.829Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åœºæ™¯ï¼š</p><p>çº¿ç´¢æµè½¬æ”¹æˆ redisson å…¬å¹³é”ï¼Œä»»åŠ¡è€—æ—¶é•¿ï¼Œå¯¼è‡´éƒ¨åˆ†ä»»åŠ¡ä¸¢å¤±ã€‚</p></blockquote><h4 id="ä¸€ã€redisson-å…¬å¹³é”å®ç°"><a href="#ä¸€ã€redisson-å…¬å¹³é”å®ç°" class="headerlink" title="ä¸€ã€redisson å…¬å¹³é”å®ç°"></a><strong>ä¸€ã€redisson å…¬å¹³é”å®ç°</strong></h4><h5 id="1ã€redis-ä¸­çš„-K-V"><a href="#1ã€redis-ä¸­çš„-K-V" class="headerlink" title="1ã€redis ä¸­çš„ K/V"></a>1ã€redis ä¸­çš„ K/V</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">list:</span> <span class="string">redisson_lock_queue:&#123;test&#125;</span>    </span><br><span class="line"><span class="attr">elem:</span> <span class="string">UUID:threadId</span></span><br><span class="line"><span class="attr">zset:</span> <span class="string">redisson_lock_timeout:&#123;key&#125;</span>   </span><br><span class="line"><span class="attr">elem:</span> <span class="string">UUID:threadId</span>  </span><br><span class="line"><span class="attr">score:</span> <span class="string">timeout</span> <span class="string">=</span> <span class="string">ttl</span> <span class="string">+</span> <span class="string">çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms)</span> <span class="string">+</span> <span class="string">å½“å‰æ—¶é—´æˆ³</span></span><br><span class="line"><span class="attr">hset:</span> <span class="string">key</span> </span><br><span class="line">  <span class="attr">hashKey:</span> <span class="string">UUID:threadId</span> </span><br><span class="line">  <span class="attr">hashVal:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h5 id="2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰"><a href="#2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰" class="headerlink" title="2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰"></a>2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰</h5><blockquote><p>org.redisson.RedissonFairLock#tryLockInnerAsync</p></blockquote><ul><li>æ¸…é™¤ redisson_lock_timeout:{key} ä¸­ score å°äºå½“å‰æ—¶é—´æˆ³çš„elemï¼ŒåŒæ—¶æ¸…é™¤å¯¹åº” redisson_lock_queue:{test} ä¸­çš„ elem</li><li>å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹å ç”¨é”ï¼Œåˆ™ä¸Šé” (ttl = watchdogtimeout)ï¼ŒåŒæ—¶redisson_lock_timeout:{key} ä¸­æ‰€æœ‰çš„ score - çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms)</li><li>å¦‚æœå­˜åœ¨é”ï¼Œä¸”æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼Œåˆ™ hashVal åŠ ä¸€</li><li>å¦‚æœå­˜åœ¨é”ï¼Œä¸”ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼ŒåŒæ—¶å·²ç»åŠ å…¥è¿‡ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™è¿”å›å½“å‰çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„ ttl</li><li>å¦‚æœå­˜åœ¨é”ï¼Œä¸”ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼Œå¹¶ä¸”æœªåŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œtimeout= ttl + çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms) + å½“å‰æ—¶é—´æˆ³ï¼Œttl ä¸ºé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„ timeout - current æˆ–è€… é”çš„è¶…æ—¶æ—¶é—´</li></ul><h5 id="3ã€è®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId"><a href="#3ã€è®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId" class="headerlink" title="3ã€è®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId"></a>3ã€è®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId</h5><p>æ­¤å¤„é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯å‘é€ä¸ºæ­¢</p><h5 id="4ã€è§£é”æµç¨‹"><a href="#4ã€è§£é”æµç¨‹" class="headerlink" title="4ã€è§£é”æµç¨‹"></a>4ã€è§£é”æµç¨‹</h5><ul><li>æ¸…é™¤ redisson_lock_timeout:{key} ä¸­ score å°äºå½“å‰æ—¶é—´æˆ³çš„elemï¼ŒåŒæ—¶æ¸…é™¤å¯¹åº” redisson_lock_queue:{test}   ä¸­çš„ elem</li><li>åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜é”å·²ç»è¢«é‡Šæ”¾äº†ï¼Œåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰elemï¼Œæœ‰çš„è¯å–å‡ºç¬¬ä¸€ä¸ª publish message</li><li>å¦‚æœé”å­˜åœ¨ï¼Œä¸”éæœ¬çº¿ç¨‹æŒæœ‰ï¼Œåˆ™ç›´æ¥è¿”å› null</li><li>å¦‚æœæ‰€å­˜åœ¨ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¹¶ä¸”è·å–æ‰€æ¬¡æ•°å¤§äº 1ï¼Œåˆ™ hashValå‡ä¸€ï¼Œæ›´æ–°é”è¶…æ—¶æ—¶é—´</li><li>å¦‚æœæ‰€å­˜åœ¨ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œé‡Šæ”¾é”ï¼Œåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰elemï¼Œæœ‰çš„è¯å–å‡ºç¬¬ä¸€ä¸ª publish message</li></ul><h5 id="5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId"><a href="#5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜…-redisson-lock-channel-fairLock-UUID-threadId" class="headerlink" title="5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId"></a>5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId</h5><hr><h4 id="äºŒã€é—®é¢˜åˆ†æ"><a href="#äºŒã€é—®é¢˜åˆ†æ" class="headerlink" title="äºŒã€é—®é¢˜åˆ†æ"></a><strong>äºŒã€é—®é¢˜åˆ†æ</strong></h4><p>1ã€ç”±äºæµ‹è¯•ç¯å¢ƒç¬¬ä¸‰æ–¹é‰´æƒæ¥å£è¾ƒæ…¢ï¼Œæ¯åˆ†é…ä¸€æ¡çº¿ç´¢éœ€è¦3-4s</p><p>2ã€å­˜é‡çº¿ç´¢æœ‰ 1500+ æ¡ï¼Œæ¯ 200 æ¡ä½œä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œæ€»å…±æ‹†åˆ† 8 ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éœ€è¦æ‰§è¡Œ 200*3 = 600+ s</p><p>3ã€redisson å…¬å¹³é”çº¿ç¨‹ç­‰å¾…æ—¶é—´ (5*60000ms)ï¼Œä¹Ÿå°±æ˜¯è¯´å•ä¸ªä»»åŠ¡æ‰§è¡Œå®Œè‡³å°‘ä¼šæœ‰ä¸€ä¸ªä»»åŠ¡è¿‡æœŸï¼Œåœ¨ unlock æˆ–è€… lock æ“ä½œæ˜¯ä¼šå…ˆæ¸…é™¤è¿‡æœŸä»»åŠ¡</p><p>4ã€ç”±äºè·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹ä¼šè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadIdï¼Œé˜»å¡çŸ¥é“æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œåˆç”±äºç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹è¢«æ¸…äº†ï¼Œè¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ°¸è¿œä¸ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸€ç›´é˜»å¡ï¼Œä¸”ä»»åŠ¡æ— æ³•æ‰§è¡Œï¼Œèµ„æºè¢«å ç”¨ã€‚</p><p>5ã€ä»£ç æ¨¡æ‹Ÿï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">"redis://127.0.0.1:6379"</span>);</span><br><span class="line">        Redisson redissonClient = (Redisson) Redisson.create(config);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">10</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//RedissonFairLock lock = (RedissonFairLock) redissonClient.getFairLock("test");</span></span><br><span class="line">                RedissonFairLock lock = <span class="keyword">new</span> RedissonFairLock(redissonClient.getCommandExecutor(), <span class="string">"test"</span>, <span class="number">2000</span>);</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="comment">//æœ€ç»ˆè¾“å‡ºæ¬¡æ•°å°äº10</span></span><br><span class="line">                System.out.println(i);</span><br><span class="line">                ThreadUtil.sleep(<span class="number">10000</span>);</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/maybesuch/p/16012674.html" target="_blank" rel="noopener">å‚è€ƒ: Redissonåˆ†å¸ƒå¼é”ä¹‹å…¬å¹³é”åŸç†</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åœºæ™¯ï¼š&lt;/p&gt;
&lt;p&gt;çº¿ç´¢æµè½¬æ”¹æˆ redisson å…¬å¹³é”ï¼Œä»»åŠ¡è€—æ—¶é•¿ï¼Œå¯¼è‡´éƒ¨åˆ†ä»»åŠ¡ä¸¢å¤±ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;ä¸€ã€redisson-å…¬å¹³é”å®ç°&quot;&gt;&lt;a href=&quot;#ä¸€ã€redisson-å…¬å¹³é”å®ç°&quot; class</summary>
      
    
    
    
    <category term="redisson" scheme="http://example.com/categories/redisson/"/>
    
    
    <category term="redisson" scheme="http://example.com/tags/redisson/"/>
    
    <category term="æ¡†æ¶" scheme="http://example.com/tags/%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>apollo é›†ç¾¤æ¶æ„</title>
    <link href="http://example.com/2023/03/26/apollo-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/"/>
    <id>http://example.com/2023/03/26/apollo-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/</id>
    <published>2023-03-25T18:25:23.000Z</published>
    <updated>2023-03-31T15:44:48.277Z</updated>
    
    <content type="html"><![CDATA[<h1 id="apollo-é›†ç¾¤æ¶æ„"><a href="#apollo-é›†ç¾¤æ¶æ„" class="headerlink" title="apollo é›†ç¾¤æ¶æ„"></a>apollo é›†ç¾¤æ¶æ„</h1><h3 id="apollo-ç»„æˆç»“æ„"><a href="#apollo-ç»„æˆç»“æ„" class="headerlink" title="apollo ç»„æˆç»“æ„"></a>apollo ç»„æˆç»“æ„</h3><p>apollo é›†ç¾¤ä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œconfig-serviceï¼Œadmin-serviceï¼Œportal</p><ul><li>config-service: ä¸»è¦ä¸ºåº”ç”¨å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬é…ç½®çš„è¯»å–ã€æ¨é€ç­‰åŠŸèƒ½ï¼Œconfig-service å†…ç½® eurekaï¼Œå·²æä¾› admin-service, portal çš„æœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œ</li><li>admin-service: ä¸»è¦ä¸º apollo-portal æä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬åº”ç”¨é…ç½®ç®¡ç†ã€å‘å¸ƒç­‰åŠŸèƒ½</li><li>portal: æ˜¯ apollo æä¾›çš„æœåŠ¡é…ç½®å‰ç«¯é¡µé¢</li></ul><h3 id="apollo-éƒ¨ç½²æ–¹æ¡ˆ"><a href="#apollo-éƒ¨ç½²æ–¹æ¡ˆ" class="headerlink" title="apollo éƒ¨ç½²æ–¹æ¡ˆ"></a>apollo éƒ¨ç½²æ–¹æ¡ˆ</h3><p><img src="/images/283b123b3a2d818fb3f732c9a1b75a5d.png" alt="æˆªå›¾" style="zoom:100%" />è¿™ä¸ªå®˜ç½‘æä¾›çš„é«˜å¯ç”¨åŒç¯å¢ƒæ¶æ„ï¼Œæ›´å¤šçš„æ¶æ„æ–¹æ¡ˆå¯<a href="https://www.apolloconfig.com/#/zh/deployment/deployment-architecture?id=_34-%e9%ab%98%e5%8f%af%e7%94%a8%ef%bc%8c%e5%a4%9a%e4%b8%aa%e7%8e%af%e5%a2%83" target="_blank" rel="noopener">å‚è€ƒ</a></p><h3 id="docker-compose-éƒ¨ç½²-apollo-é›†ç¾¤"><a href="#docker-compose-éƒ¨ç½²-apollo-é›†ç¾¤" class="headerlink" title="docker-compose éƒ¨ç½² apollo é›†ç¾¤"></a>docker-compose éƒ¨ç½² apollo é›†ç¾¤</h3><ol><li>æ‰§è¡Œ <a href="https://github.com/apolloconfig/apollo-quick-start/tree/master/sql" target="_blank" rel="noopener">sql è„šæœ¬</a>ï¼Œç”Ÿæˆ apollo éœ€è¦çš„ db è¡¨</li><li>ç¼–å†™ docker-compose æ–‡ä»¶ï¼Œæœ¬æ¬¡åªæ­å»ºå¼€å‘ç¯å¢ƒæ¨¡æ‹Ÿå•æœºå•ç¯å¢ƒï¼Œconfig-serviceï¼Œadmin-serviceï¼Œportal éƒ½å„è‡ªéƒ¨ç½²ä¸€ä¸ªå®¹å™¨</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">net:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment">#å¼€å‘ç¯å¢ƒconfigServiceï¼Œeureka</span></span><br><span class="line">  <span class="attr">apollo-configservice-dev:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apolloconfig/apollo-configservice</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">configservice-dev</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloConfigDB?characterEncoding=utf8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">eureka.instance.ip-address=192.168.0.103</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">apollo-adminservice-dev:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apolloconfig/apollo-adminservice</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">adminservice-dev</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8090</span><span class="string">:8090</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloConfigDB?characterEncoding=utf8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=123456</span></span><br><span class="line">      <span class="comment">#è¿™é‡Œéœ€è¦é…ç½®å¼€ç¯ç¯å¢ƒçš„configService</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">eureka.service.url=http://configservice-dev:8080/eureka/</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apollo-configservice-dev</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">apollo-portal:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apolloconfig/apollo-portal</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">apollo-portal</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8070</span><span class="string">:8070</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloPortalDB?characterEncoding=utf8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spring.profiles.active=auth</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">APOLLO_PORTAL_ENVS=dev,fat,pre,gray,pro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEV_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="comment"># ä»¥ä¸‹è¿™äº›æš‚æ—¶ä½¿ç”¨å¼€å‘ç¯å¢ƒçš„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FAT_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PRE_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GRAY_META=http://configservice-dev:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PRO_META=http://configservice-dev:8080</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apollo-adminservice-dev</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;apollo-é›†ç¾¤æ¶æ„&quot;&gt;&lt;a href=&quot;#apollo-é›†ç¾¤æ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;apollo é›†ç¾¤æ¶æ„&quot;&gt;&lt;/a&gt;apollo é›†ç¾¤æ¶æ„&lt;/h1&gt;&lt;h3 id=&quot;apollo-ç»„æˆç»“æ„&quot;&gt;&lt;a href=&quot;#apollo</summary>
      
    
    
    
    
    <category term="apollo" scheme="http://example.com/tags/apollo/"/>
    
    <category term="è¿ç»´" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>consul é›†ç¾¤æ­å»ºåŠæ³¨æ„äº‹é¡¹</title>
    <link href="http://example.com/2023/03/26/consul-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/"/>
    <id>http://example.com/2023/03/26/consul-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</id>
    <published>2023-03-25T17:16:50.000Z</published>
    <updated>2023-03-31T15:45:02.909Z</updated>
    
    <content type="html"><![CDATA[<h3 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h3><p><em>æœ¬æ¬¡åˆ©ç”¨ docker æ­å»º consul é›†ç¾¤ï¼Œåˆ©ç”¨ docker-compose ç»Ÿä¸€ç®¡ç†</em></p><p><em>é›†ç¾¤åŒ…å«ä¸‰ä¸ª server agent: node1ã€node2ã€node3</em></p><p><em>é›†ç¾¤åŒ…å«ä¸¤ä¸ª client agent: node4ã€node5ï¼Œclient agent æä¾› ui</em></p><p>**1ã€ä¸‹è½½ docker é•œåƒ **</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker</span><br></pre></td></tr></table></figure><p><strong>2ã€ç¼–è¾‘ docker-compose.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">byfn:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">consul1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node1</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-bootstrap-expect=3</span> <span class="string">-node=node1</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node2</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-retry-join=node1</span> <span class="string">-node=node2</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul1</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node3</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-retry-join=node1</span> <span class="string">-node=node3</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul1</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul4:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node4</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-retry-join=node1</span> <span class="string">-node=ndoe4</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span> <span class="string">-ui</span> </span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8500</span><span class="string">:8500</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">consul3</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">consul5:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node5</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-retry-join=node1</span> <span class="string">-node=ndoe5</span> <span class="string">-bind=0.0.0.0</span> <span class="string">-client=0.0.0.0</span> <span class="string">-datacenter=dc1</span> <span class="string">-ui</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8501</span><span class="string">:8500</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul3</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">byfn</span></span><br></pre></td></tr></table></figure><h3 id="å‘½ä»¤è¡Œå‚æ•°"><a href="#å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="å‘½ä»¤è¡Œå‚æ•°"></a>å‘½ä»¤è¡Œå‚æ•°</h3><p>-serverï¼šè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„ server æ¨¡å¼ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™è¡¨ç¤ºæ˜¯ client æ¨¡å¼ã€‚</p><p>-nodeï¼šæŒ‡å®šå½“å‰èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­çš„åç§°ã€‚</p><p>-config-dirï¼šæŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå®šä¹‰æœåŠ¡çš„ï¼›è·¯å¾„ä¸‹é¢çš„æ‰€æœ‰ .json ç»“å°¾çš„æ–‡ä»¶éƒ½è¢«è®¿é—®ï¼›ç¼ºçœå€¼ä¸ºï¼š/consul/configã€‚</p><p>-data-dirï¼š consul å­˜å‚¨æ•°æ®çš„ç›®å½•ï¼›ç¼ºçœå€¼ä¸ºï¼š/consul/dataã€‚</p><p>-datacenterï¼šæ•°æ®ä¸­å¿ƒåç§°ï¼Œç¼ºçœå€¼ä¸º dc1ã€‚</p><p>-uiï¼šä½¿ç”¨ consul è‡ªå¸¦çš„ web UI ç•Œé¢ ã€‚</p><p>-joinï¼šåŠ å…¥åˆ°å·²æœ‰çš„é›†ç¾¤ä¸­ã€‚</p><p>-retry-joinï¼šä¸ -join ç±»ä¼¼ï¼Œä½†å…è®¸é‡è¯•è¿æ¥ï¼Œç›´åˆ°è¿æ¥æˆåŠŸã€‚ä¸€æ—¦æˆåŠŸåŠ å…¥æˆå‘˜åˆ—è¡¨ä¸­çš„æˆå‘˜ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šå°è¯•å†æ¬¡åŠ å…¥ã€‚ç„¶åï¼Œä»£ç†å•†å°†ä»…é€šè¿‡å…«å¦ç»´æŒå…¶ä¼šå‘˜èµ„æ ¼ã€‚å…è®¸é…ç½®å¤šä¸ª -retry-joinï¼Œç„¶åèŠ‚ç‚¹ä¼šæŒ‰ç…§é¡ºåºåŠ å…¥å’Œé‡è¯•ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸã€‚</p><p>-enable-script-checksï¼š æ£€æŸ¥æœåŠ¡æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç±»ä¼¼å¼€å¯å¿ƒè·³ã€‚</p><p>-advertiseï¼šé€šå‘Šåœ°å€ç”¨äºæ›´æ”¹æˆ‘ä»¬å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹é€šå‘Šçš„åœ°å€ã€‚ç›¸å½“äº -bind ä¸å¯ç”¨æ—¶æ›´æ”¹ -bind åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸º -bind çš„ä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆã€‚</p><p>-bindï¼š ç»‘å®šæœåŠ¡å™¨çš„ ip åœ°å€ï¼Œç¼ºçœå€¼ï¼šâ€œ0.0.0.0â€ï¼Œè¿™æ„å‘³ç€ consul å°†ç»‘å®šåˆ°æœ¬åœ°æœºå™¨ä¸Šçš„æ‰€æœ‰åœ°å€ï¼Œå¹¶å°†ç§æœ‰ IPv4 åœ°å€é€šå‘Šç»™é›†ç¾¤çš„å…¶ä½™èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å¤šä¸ªç§æœ‰ IPv4 åœ°å€å¯ç”¨ï¼Œconsul å°†åœ¨å¯åŠ¨æ—¶é€€å‡ºå¹¶æŠ¥é”™ã€‚consul 1.1.0 ä¹‹åï¼Œå¯ä»¥ç»“åˆ go-sockaddr templateä½¿ç”¨ï¼Œä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ consul agent -bind &#39;&#123;&#123; GetPrivateInterfaces | include &quot;network&quot; &quot;10.0.0.0&#x2F;8&quot; | attr &quot;address&quot; &#125;&#125;&#39;</span><br></pre></td></tr></table></figure><p>-clientï¼šå®¢æˆ·ç«¯å¯è®¿é—® ipï¼Œç¼ºçœå€¼ä¸ºï¼šâ€œ127.0.0.1â€ï¼Œå³ä»…å…è®¸ç¯å›è¿æ¥ã€‚</p><p>-bootstrap-expectï¼šåœ¨ä¸€ä¸ª datacenter ä¸­æœŸæœ›çš„ server èŠ‚ç‚¹æ•°ç›®ï¼Œconsul å¯åŠ¨æ—¶ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¾¾åˆ°è¿™ä¸ªæ•°ç›®çš„serveræ‰ä¼šå¼•å¯¼æ•´ä¸ªé›†ç¾¤ã€‚è¿™ä¸ªå‚æ•°çš„å€¼åœ¨åŒä¸€ä¸ª datacenter çš„æ‰€æœ‰serverèŠ‚ç‚¹ä¸Šå¿…é¡»ä¿æŒä¸€è‡´ã€‚</p><p>-bootstrapï¼šç”¨æ¥æ§åˆ¶ä¸€ä¸ª server æ˜¯å¦è¿è¡Œåœ¨ bootstrap æ¨¡å¼ï¼šå½“ä¸€ä¸ª server å¤„äº bootstrap æ¨¡å¼æ—¶ï¼Œå®ƒå¯ä»¥é€‰ä¸¾è‡ªå·±ä¸º leaderï¼›æ³¨æ„åœ¨ä¸€ä¸ª datacenter ä¸­åªèƒ½æœ‰ä¸€ä¸ª server å¤„äº bootstrap æ¨¡å¼ã€‚æ‰€ä»¥è¿™ä¸ªå‚æ•°ä¸€èˆ¬åªèƒ½ç”¨åœ¨åªæœ‰ä¸€ä¸ª server çš„å¼€å‘ç¯å¢ƒä¸­ï¼Œåœ¨æœ‰å¤šä¸ª server çš„ cluster äº§å“ç¯å¢ƒä¸­ï¼Œä¸èƒ½ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œå¦åˆ™å¦‚æœå¤šä¸ª server éƒ½æ ‡è®°è‡ªå·±ä¸º leader é‚£ä¹ˆä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å¦å¤–è¯¥æ ‡è®°ä¸èƒ½å’Œ -bootstrap-expect åŒæ—¶æŒ‡å®šã€‚</p><h3 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h3><p><strong>1ã€é€šè¿‡ config-file æ³¨å†ŒæœåŠ¡</strong>ï¼Œç¼–è¾‘ xxx.jsonï¼Œç„¶åæ”¾åœ¨ /consul/config ç›®å½•ä¸‹ï¼ˆé»˜è®¤æƒ…å†µï¼‰,å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ <a href="https://www.consul.io/commands/config/write" target="_blank" rel="noopener">consul å‘½ä»¤è¡Œ</a>åŠ è½½é…ç½®ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;                                                                                                                                                   </span><br><span class="line">  <span class="attr">"services"</span>: [                                                                                                                                     </span><br><span class="line">    &#123;                                                                                                                                               </span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"hertz-demo-001"</span>,                                                                                                                       </span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"hertz-demo"</span>,                                                                                                                         </span><br><span class="line">      <span class="attr">"tags"</span>: [                                                                                                                                     </span><br><span class="line">      ],                                                                                                                                            </span><br><span class="line">      <span class="attr">"address"</span>: <span class="string">"192.168.0.103"</span>,                                                                                                                       </span><br><span class="line">      <span class="attr">"port"</span>: <span class="number">5000</span>,                                                                                                                                 </span><br><span class="line">      <span class="attr">"checks"</span>: [                                                                                                                                   </span><br><span class="line">        &#123;                                                                                                                                           </span><br><span class="line">        <span class="attr">"http"</span>: <span class="string">"http://192.168.0.103:5000/ping"</span>,                                                                                                       </span><br><span class="line">        <span class="attr">"tlsSkipVerify"</span>: <span class="literal">false</span>,                                                                                                                   </span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"GET"</span>,                                                                                                                            </span><br><span class="line">        <span class="attr">"interval"</span>: <span class="string">"10s"</span>,                                                                                                                          </span><br><span class="line">        <span class="attr">"timeout"</span>: <span class="string">"1s"</span>,                                                                                                                             </span><br><span class="line">        <span class="attr">"deregisterCriticalServiceAfter"</span>: <span class="string">"30s"</span></span><br><span class="line">        &#125;                                                                                                                                           </span><br><span class="line">      ]                                                                                                                                             </span><br><span class="line">    &#125;                                                                                                                                               </span><br><span class="line">  ]                                                                                                                                                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2ã€æ‰§è¡Œ consul å‘½ä»¤é‡è½½é…ç½®æ–‡ä»¶</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul reload</span><br></pre></td></tr></table></figure><p><strong>3ã€å¯åŠ¨ web æœåŠ¡</strong>ï¼Œè¿™é‡Œä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡å³å¯ï¼Œè¿™é‡Œç”¨çš„æ˜¯ go http æ¡†æ¶ hertz:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/app"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/app/server"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/common/utils"</span></span><br><span class="line"><span class="string">"github.com/cloudwego/hertz/pkg/protocol/consts"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := server.Default(</span><br><span class="line">server.WithHostPorts(<span class="string">"192.168.0.103:5000"</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">s.GET(<span class="string">"/ping"</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req *app.RequestContext)</span></span> &#123;</span><br><span class="line">log.Print(req.ClientIP(), <span class="string">" ping"</span>)</span><br><span class="line">req.JSON(consts.StatusOK, utils.H&#123;<span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">s.Spin()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4ã€æŸ¥çœ‹æœåŠ¡å¥åº·ä¿¡æ¯</strong>ï¼Œpassing å‚æ•°è¡¨ç¤ºæ˜¯å¦è¿‡æ»¤ä¸å¥åº·çš„æœåŠ¡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:8500/v1/health/service/hertz-demo\?passing\=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>5ã€æ³¨é”€æœåŠ¡</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --request PUT 127.0.0.1:8501/v1/agent/service/deregister/hertz-demo-001</span><br></pre></td></tr></table></figure><p><strong>6ã€consul ui ç•Œé¢ä¸Šæ˜¾ç¤ºå¦‚ä¸‹ï¼š</strong></p><img src="/images/15a776f6a2dd3e8cd4405101c5e47f9c.png" alt="æˆªå›¾" style="zoom:0%" /><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>1ã€æ³¨å†ŒæœåŠ¡æ—¶ï¼Œcheck å‚æ•° method GET æ³¨æ„ GET éœ€è¦å¤§å†™ï¼Œå¦åˆ™å¥åº·æ£€æŸ¥ä¼šå¤±è´¥</p><p>2ã€æœåŠ¡æ³¨å†Œçš„ client agent æŒ‚äº†ï¼Œé‚£ä¹ˆ consul ä¼šè®¤ä¸ºæœåŠ¡ä¹ŸæŒ‚äº†ï¼Œå¹¶ä¸ä¼šåšæ•…éšœè½¬ç§»ï¼Œä¹Ÿä¸ä¼šåŒæ­¥åŸæœ¬ client agent ä¸‹çš„æœåŠ¡ä¿¡æ¯</p><p>3ã€æœåŠ¡æ³¨å†Œéœ€è¦ç¡®ä¿ç½‘ç»œèƒ½è”é€š</p><h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><p><strong>1ã€å®˜æ–¹æ¨èçš„æ¶æ„æ–¹å¼</strong></p><p>å®˜æ–¹å»ºè®®ä¸€ä¸ªé›†ç¾¤éƒ¨ç½² 3-5 ä¸ª server agentï¼Œæ¯ä¸ªæœåŠ¡çš„æœåŠ¡å™¨éƒ¨ç½²ä¸€ä¸ª client agentï¼Œå¦‚ä¸‹å¦‚æ‰€ç¤ºï¼š</p><img src="/images/d54b9c5750f98deb333af08e95cd8c74.png" alt="æˆªå›¾" style="zoom:100%;" /><p><strong>2ã€å¦‚æ˜¯æƒ³è¦ç»Ÿä¸€ç®¡ç† consul agent</strong>ï¼Œé‚£å¯ä»¥å‚è€ƒå¦ä¸€ç§æ¶æ„æ–¹å¼ï¼š</p><img src="/images/46d62fa92deb1760cdec0d06f983dd1d.png" alt="æˆªå›¾" style="zoom:100%" /><br/><br/><blockquote><p>å‚è€ƒï¼š<br><a href="https://mp.weixin.qq.com/s/ecmqqWuMho2a0xhaF1vFNA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ecmqqWuMho2a0xhaF1vFNA</a><br><a href="https://www.cnblogs.com/brady-wang/p/14440649.html/" target="_blank" rel="noopener">https://www.cnblogs.com/brady-wang/p/14440649.html</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;é›†ç¾¤æ­å»º&quot;&gt;&lt;a href=&quot;#é›†ç¾¤æ­å»º&quot; class=&quot;headerlink&quot; title=&quot;é›†ç¾¤æ­å»º&quot;&gt;&lt;/a&gt;é›†ç¾¤æ­å»º&lt;/h3&gt;&lt;p&gt;&lt;em&gt;æœ¬æ¬¡åˆ©ç”¨ docker æ­å»º consul é›†ç¾¤ï¼Œåˆ©ç”¨ docker-compose ç»Ÿä¸€ç®¡ç†&lt;/em&gt;&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="consul" scheme="http://example.com/tags/consul/"/>
    
    <category term="è¿ç»´" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://example.com/2023/03/26/hello-world/"/>
    <id>http://example.com/2023/03/26/hello-world/</id>
    <published>2023-03-25T16:04:15.447Z</published>
    <updated>2023-03-25T16:04:15.447Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>mysql å•æœºå¤šå®ä¾‹</title>
    <link href="http://example.com/2022/12/16/mysql-%E5%8D%95%E6%9C%BA%E5%A4%9A%E5%AE%9E%E4%BE%8B/"/>
    <id>http://example.com/2022/12/16/mysql-%E5%8D%95%E6%9C%BA%E5%A4%9A%E5%AE%9E%E4%BE%8B/</id>
    <published>2022-12-16T09:26:58.000Z</published>
    <updated>2024-06-27T09:41:04.715Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºå•ç‹¬çš„é…ç½®æ–‡ä»¶åŠæ•°æ®ç›®å½•</p><p><img src="/images/1719480537871.jpg" alt="æˆªå›¾"></p><p><img src="/images/1719480578049.jpg" alt="æˆªå›¾"></p></li><li><p>my.cnf é…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">socket = /usr/<span class="built_in">local</span>/mysql/instance/3306/data/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/<span class="built_in">local</span>/mysql</span><br><span class="line">datadir = /usr/<span class="built_in">local</span>/mysql/instance/3306/data</span><br><span class="line">port = 3306</span><br><span class="line">socket = /usr/<span class="built_in">local</span>/mysql/instance/3306/data/mysql.sock</span><br><span class="line">log_error = /usr/<span class="built_in">local</span>/mysql/instance/3306/data/mysql-error</span><br><span class="line">pid_file = /usr/<span class="built_in">local</span>/mysql/instance/3306/data/mysql.pid</span><br></pre></td></tr></table></figure></li><li><p>åˆå§‹åŒ– data ç›®å½•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/usr/<span class="built_in">local</span>/mysql/instance/3308/data</span><br><span class="line"></span><br><span class="line">2022-12-14T15:14:26.003364Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> more details).</span><br><span class="line">2022-12-14T15:14:26.005452Z 0 [Warning] Setting lower_case_table_names=2 because file system <span class="keyword">for</span> /usr/<span class="built_in">local</span>/mysql/instance/3308/data/ is <span class="keyword">case</span> insensitive</span><br><span class="line">2022-12-14T15:14:26.129712Z 0 [Warning] InnoDB: New <span class="built_in">log</span> files created, LSN=45790</span><br><span class="line">2022-12-14T15:14:26.151110Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2022-12-14T15:14:26.218698Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: ff66d330-7bc1-11ed-9e9b-119ad045e8ba.</span><br><span class="line">2022-12-14T15:14:26.249279Z 0 [Warning] Gtid table is not ready to be used. Table <span class="string">'mysql.gtid_executed'</span> cannot be opened.</span><br><span class="line">2022-12-14T15:14:26.884182Z 0 [Warning] CA certificate ca.pem is self signed.</span><br><span class="line">2022-12-14T15:14:26.977637Z 1 [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: phbSZ0nOis=e</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ mysql æœåŠ¡ç«¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --defaults-file=/usr/<span class="built_in">local</span>/mysql/instance/3308/my.cnf &amp;</span><br></pre></td></tr></table></figure></li><li><p>mysql å®¢æˆ·ç«¯ä¸­æ›´æ”¹ç”¨æˆ·å¯†ç ï¼Œåˆå§‹å¯†ç åœ¨åˆå§‹åŒ–æ—¶èƒ½è·å–ï¼ˆå¿˜è®°äº†å¯ä»¥åœ¨ç½‘ä¸Šæœæœè·³è¿‡è®¤è¯æµç¨‹ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p -S /usr/<span class="built_in">local</span>/mysql/instance/3308/data/mysql.sock</span><br></pre></td></tr></table></figure></li><li><p>å°†å¯åŠ¨å‘½ä»¤å­˜åˆ°</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> mysqld3306=<span class="string">"mysqld --defaults-file=/usr/local/mysql/instance/3306/my.cnf &amp;"</span></span><br><span class="line"><span class="built_in">alias</span> mysqld3307=<span class="string">"mysqld --defaults-file=/usr/local/mysql/instance/3307/my.cnf &amp;"</span></span><br><span class="line"><span class="built_in">alias</span> mysqld3308=<span class="string">"mysqld --defaults-file=/usr/local/mysql/instance/3308/my.cnf &amp;"</span></span><br><span class="line"><span class="built_in">alias</span> mysql3306=<span class="string">"mysql -u root -p -S /usr/local/mysql/instance/3306/data/mysql.sock"</span></span><br><span class="line"><span class="built_in">alias</span> mysql3307=<span class="string">"mysql -u root -p -S /usr/local/mysql/instance/3307/data/mysql.sock"</span></span><br><span class="line"><span class="built_in">alias</span> mysql3308=<span class="string">"mysql -u root -p -S /usr/local/mysql/instance/3308/data/mysql.sock"</span></span><br><span class="line"><span class="built_in">alias</span> mysqlkill3306=<span class="string">"mysqladmin -uroot -p -S /usr/local/mysql/instance/3306/data/mysql.sock shutdown"</span></span><br><span class="line"><span class="built_in">alias</span> mysqlkill3307=<span class="string">"mysqladmin -uroot -p -S /usr/local/mysql/instance/3307/data/mysql.sock shutdown"</span></span><br><span class="line"><span class="built_in">alias</span> mysqlkill3308=<span class="string">"mysqladmin -uroot -p -S /usr/local/mysql/instance/3308/data/mysql.sock shutdown"</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºå•ç‹¬çš„é…ç½®æ–‡ä»¶åŠæ•°æ®ç›®å½•&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/1719480537871.jpg&quot; alt=&quot;æˆªå›¾&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/1719480578049.jpg&quot; alt=&quot;æˆªå›¾&quot;&gt;&lt;</summary>
      
    
    
    
    
    <category term="mysql" scheme="http://example.com/tags/mysql/"/>
    
  </entry>
  
</feed>
