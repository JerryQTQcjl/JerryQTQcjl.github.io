{"meta":{"title":"Jerry Chan","subtitle":"","description":"","author":"Jerry Chan","url":"http://example.com","root":"/"},"pages":[{"title":"categories","date":"2023-03-25T16:16:19.000Z","updated":"2023-03-25T16:17:15.844Z","comments":false,"path":"categories/index.html","permalink":"http://example.com/categories/index.html","excerpt":"","text":""},{"title":"tags","date":"2023-03-25T16:15:37.000Z","updated":"2023-03-25T16:16:54.923Z","comments":false,"path":"tags/index.html","permalink":"http://example.com/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Spring @Validated å¤±æ•ˆåˆ†æ","slug":"Spring-Validated-å¤±æ•ˆåˆ†æ","date":"2023-04-21T17:41:36.000Z","updated":"2023-04-22T05:07:49.668Z","comments":true,"path":"2023/04/22/Spring-Validated-å¤±æ•ˆåˆ†æ/","link":"","permalink":"http://example.com/2023/04/22/Spring-Validated-%E5%A4%B1%E6%95%88%E5%88%86%E6%9E%90/","excerpt":"","text":"æœ€è¿‘åœ¨è½åœ° DDDï¼Œå¸Œæœ›å¯¹ command è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç”±äºéƒ¨åˆ†æµé‡å…¥å£æ˜¯ MQï¼Œæ‰€ä»¥å¸Œæœ›åœ¨åº”ç”¨å±‚æ˜¯ç”¨ @Validated è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œç»“æœã€‚ã€‚ã€‚ Controller ä¸­ä½¿ç”¨ @Validated@Validated æ³¨è§£çš„ä½œç”¨è¿™é‡Œå°±ä¸å¤šåšä»‹ç»äº†ï¼Œå…·ä½“ç”¨æ³•åœ¨ç½‘ä¸Šåº”è¯¥æœ‰ä¸å°‘ã€‚ åœ¨ä¹‹å‰ä½¿ç”¨ MVC æ¶æ„ç¼–ç æ—¶ï¼Œé€šå¸¸æ˜¯å°† @Validated æ³¨è§£æˆ–è€… @Valid é…ç½®åœ¨ Controller çš„æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š 12345@PostMapping(\"common/set\")public Response&lt;?&gt; setCommonSetting(@RequestBody @Validated SetCommonSettingReqVO reqVO) &#123; //doSomeThings return Response.success();&#125; æ‰€ä»¥åœ¨é…ç½®åº”ç”¨å±‚æ ¡éªŒæ—¶ï¼Œå°±æƒ³å½“ç„¶çš„æŒ‰ç…§ç±»ä¼¼çš„å†™æ³•ï¼š 123public void addClueTrack(@Validated AddClueTrackCommand command) &#123; //doSomeThings&#125; ç»“æœå¯æƒ³è€ŒçŸ¥ï¼Œ@Validated æ³¨è§£å¹¶ä¸ç”Ÿæ•ˆã€‚ @Validated æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿç«Ÿç„¶ä¸ç”Ÿæ•ˆï¼Œé‚£ä¹ˆå°±å¼€å§‹åˆ†æåŸå› ã€‚ é¦–å…ˆå¯ä»¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œç«Ÿç„¶èƒ½åœ¨æ–¹æ³•æ‰§è¡Œå‰å°±æ‹¦æˆªè¿›è¡Œæ ¡éªŒï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯ä½¿ç”¨åŠ¨æ€ä»£ç†ã€‚å°±å’Œ @Transactional äº‹åŠ¡æ³¨è§£ä¸€æ ·ï¼Œåº•å±‚éƒ½æ˜¯åŸºäº AOP å®ç°åŠ¨æ€ä»£ç†ã€‚ æ¥ä¸‹æ¥ä¸ºäº†å°è¯è¿™ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯éœ€è¦æ·±å…¥çœ‹çœ‹ Spring å®ç°çš„ã€‚é€šè¿‡ IDE å¯ä»¥å¾ˆæ–¹ä¾¿çœ‹åˆ°æœ‰å“ªäº›åœ°æ–¹å¼•ç”¨äº† @Validated æ³¨è§£ï¼š å…¶ä¸­ä¸€ä¸ªç±»åä¸€ä¸‹å°±å¼•èµ·äº†æˆ‘çš„æ³¨æ„ MethodValidationPostProcessorï¼Œç†Ÿæ‚‰ Spring çš„å°ä¼™ä¼´åº”è¯¥çŸ¥é“ï¼ŒSpring ä¸­æœ‰å¾ˆå¤š BeanPostProcessor ç”¨äºæ‰©å±• Beanï¼ŒAop ä¾¿æ˜¯åŸºäºæ­¤å®ç°åŠ¨æ€ä»£ç†çš„ã€‚ç‚¹è¿›å»ä¸€çœ‹ï¼Œæœä¸å…¶ç„¶ï¼š 123456789101112131415161718192021222324252627282930313233343536public class MethodValidationPostProcessor extends AbstractBeanFactoryAwareAdvisingPostProcessor implements InitializingBean &#123; private Class&lt;? extends Annotation&gt; validatedAnnotationType = Validated.class; @Nullable private Validator validator; //... @Override public void afterPropertiesSet() &#123; //åˆ›å»ºåˆ‡ç‚¹ Pointcut pointcut = new AnnotationMatchingPointcut(this.validatedAnnotationType, true); this.advisor = new DefaultPointcutAdvisor(pointcut, createMethodValidationAdvice(this.validator)); &#125; protected Advice createMethodValidationAdvice(@Nullable Validator validator) &#123; //åˆ›å»ºæ‹¦æˆªå™¨ return (validator != null ? new MethodValidationInterceptor(validator) : new MethodValidationInterceptor()); &#125;&#125;public class AnnotationMatchingPointcut implements Pointcut &#123; private final ClassFilter classFilter; private final MethodMatcher methodMatcher; public AnnotationMatchingPointcut(Class&lt;? extends Annotation&gt; classAnnotationType, boolean checkInherited) &#123; //åˆ‡ç‚¹åªé’ˆå¯¹ç±»çº§åˆ« this.classFilter = new AnnotationClassFilter(classAnnotationType, checkInherited); this.methodMatcher = MethodMatcher.TRUE; &#125; //...&#125; MethodValidationPostProcessor ä¸­åˆ›å»ºäº†ä¸€ä¸ªåˆ‡ç‚¹ï¼Œè¿‡æ»¤ç±»ä¸Šæ·»åŠ äº† @Validated çš„ Beanï¼Œåªè¦æ»¡è¶³æ­¤æ¡ä»¶ï¼Œå°±ä¼šæ ¹æ® MethodValidationInterceptor ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»ã€‚å—¯ï¼Œå’Œ @Transactional çš„å®ç°åŸç†å·®ä¸å¤šã€‚ okï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘å°±åœ¨åº”ç”¨æœåŠ¡å®ç°ä¸Šæ·»åŠ äº† @Validated æ³¨è§£ï¼Œé‚£ä¹ˆæ­¤æ—¶æ³¨è§£ç”Ÿæ•ˆäº†å—ï¼Ÿå“ˆå“ˆï¼Œè¿›åº¦æ¡è¿˜æ²¡è¿‡åŠå‘¢ğŸ˜‚ ç†è®ºä¸Šç±»ä¸ŠåŠ ä¸Š @Validated æ³¨è§£ï¼Œåº”è¯¥ä¼šç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„ï¼Œç«Ÿç„¶æ²¡æˆåŠŸè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œæˆ‘èƒ½æƒ³åˆ°çš„åŸå› æœ‰äºŒï¼š 1. MethodValidationPostProcessor æ²¡æ³¨å…¥åˆ° BeanFactory ä¸­ï¼Œæ‰€ä»¥æ²¡ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»2. MethodValidationInterceptor å¯¹è¿˜æœ‰å…¶ä»–éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼Œè€Œç›®å‰è¿˜æœªæ»¡è¶³ è¿™é‡Œå…ˆå‰§é€ä¸€ä¸‹ï¼Œç­”æ¡ˆæ˜¯ 2 ğŸŒ MethodValidationInterceptor éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ç«Ÿç„¶ç­”æ¡ˆæ˜¯2ï¼Œé‚£è¿™é‡Œå°±å…ˆè®²ä¸€ä¸‹ MethodValidationInterceptorï¼ŒMethodValidationPostProcessor æ˜¯æ€ä¹ˆæ³¨å†Œåˆ°å®¹å™¨çš„å’±ä»¬åé¢å†æ¥è®²ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839ExecutableValidatorpublic class MethodValidationInterceptor implements MethodInterceptor &#123; private final Validator validator; @Override @Nullable public Object invoke(MethodInvocation invocation) throws Throwable &#123; // Standard Bean Validation 1.1 API ExecutableValidator execVal = this.validator.forExecutables(); Method methodToValidate = invocation.getMethod(); Set&lt;ConstraintViolation&lt;Object&gt;&gt; result; //è·å–ç±»æœ¬èº«çš„å®ä¾‹ï¼ˆéä»£ç†ç±»ï¼‰ï¼Œè¯·è®°ä½è¿™é‡Œï¼Œè¿™é‡Œå°±æ˜¯å’Œ Controller æœ€å¤§çš„åŒºåˆ« Object target = invocation.getThis(); Assert.state(target != null, \"Target must not be null\"); try &#123; //æ‰§è¡Œå‚æ•°æ ¡éªŒï¼Œæ ¡éªŒçš„æ˜¯å½“å‰ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æ ¡éªŒçš„æ˜¯ Bean å¯¹åº”çš„ç±» result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups); &#125; catch (IllegalArgumentException ex) &#123; //doSomeThings &#125; if (!result.isEmpty()) &#123; throw new ConstraintViolationException(result); &#125; //æ‰§è¡Œæ–¹æ³• Object returnValue = invocation.proceed(); //æ ¡éªŒè¿”å›å€¼ result = execVal.validateReturnValue(target, methodToValidate, returnValue, groups); if (!result.isEmpty()) &#123; throw new ConstraintViolationException(result); &#125; return returnValue; &#125;&#125; æ¥ä¸‹æ¥å°±è¦çœ‹çœ‹ ExecutableValidator.validateParameters è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œè¿™é‡Œæˆ‘åªä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ã€‚æ ¹æ®åŒ…åæˆ‘ä»¬å¤§æ¦‚ä¹Ÿèƒ½çŒœåˆ° ExecutableValidator.validateParameters æ˜¯ hibernate-validator åŒ…æä¾›çš„æ–¹æ³•ï¼Œè€Œ @Validated æ³¨è§£æ˜¯ç”± Spring æä¾›çš„ï¼Œæ‰€ä»¥ä¸ç”Ÿæ•ˆä¹Ÿå°±æ­£å¸¸äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œæˆ‘è¿™é‡Œåªè´´éƒ¨åˆ†æ ¸å¿ƒçš„ä»£ç ï¼Œä¸­é—´çš„æ ˆè·¯å¾„å¯ä»¥æ ¹æ®ä»¥ä¸‹è¿™ä¸ªè·¯å¾„å¾€ä¸‹èµ°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * --&gt; org.hibernate.validator.internal.engine.ValidatorImpl#validateParameters * --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManager#getBeanMetaData * --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManagerImpl#createBeanMetaData * --&gt; org.hibernate.validator.internal.metadata.BeanMetaDataManagerImpl#getBeanConfigurationForHierarchy * --&gt; org.hibernate.validator.internal.metadata.provider.MetaDataProvider#getBeanConfiguration * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#retrieveBeanConfiguration * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getFieldMetaData * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findPropertyMetaData * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findConstraints * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findCascadingMetaData * &lt;-- ... * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getMethodMetaData * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getConstructorMetaData * --&gt; org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#getClassLevelConstraints * &lt;-- ... * --&gt; org.hibernate.validator.internal.metadata.aggregated.BeanMetaData#hasConstraints * --&gt; org.hibernate.validator.internal.engine.ValidatorImpl#validateParametersInContext * */public class ValidatorImpl implements Validator, ExecutableValidator &#123; @Override public final &lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateValue(Class&lt;T&gt; beanType, String propertyName, Object value, Class&lt;?&gt;... groups) &#123; Contracts.assertNotNull( beanType, MESSAGES.beanTypeCannotBeNull() ); sanityCheckPropertyPath( propertyName ); sanityCheckGroups( groups ); //è·å– bean åŠå…¶çˆ¶ç±»ã€è¶…ç±»çš„ BeanMetaData&lt;T&gt; rootBeanMetaData = beanMetaDataManager.getBeanMetaData( beanType ); //åˆ¤æ–­è¯¥ bean æ˜¯å¦æœ‰çº¦æŸ if ( !rootBeanMetaData.hasConstraints() ) &#123; return Collections.emptySet(); &#125; PathImpl propertyPath = PathImpl.createPathFromString( propertyName ); BaseBeanValidationContext&lt;T&gt; validationContext = getValidationContextBuilder().forValidateValue( beanType, rootBeanMetaData, propertyPath ); ValidationOrder validationOrder = determineGroupValidationOrder( groups ); //æ ¡éªŒå‚æ•° return validateValueInContext( validationContext, value, propertyPath, validationOrder ); &#125; //...&#125; å½“æˆ‘è°ƒè¯•åˆ°** rootBeanMetaData.hasConstraints()** æ—¶ï¼Œåˆ¤æ–­æ²¡æœ‰çº¦æŸï¼Œç„¶åå°±ç›´æ¥è¿”å›äº†æ²¡æœ‰è¿›è¡Œå‚æ•°æ ¡éªŒã€‚æˆ‘å°±æƒ³è¯´çœ‹çœ‹æ˜¯å¦‚ä½•åˆ¤æ–­ Bean æ˜¯å¦æœ‰çº¦æŸçš„ï¼Œäºæ˜¯å°±è¿”å›ä¸Šå±‚è¿›å…¥ beanMetaDataManager.getBeanMetaData ä¸­çœ‹ï¼Œç»“æœå‘ç°é‡Œé¢çš„ä»£ç æœ‰å¤Ÿå¤æ‚çš„ğŸŒš 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566public class AnnotationMetaDataProvider implements MetaDataProvider &#123; //è·å–ç±»ä¸Šæ‰€æœ‰çš„çº¦æŸæ¡ä»¶ private &lt;T&gt; BeanConfiguration&lt;T&gt; retrieveBeanConfiguration(Class&lt;T&gt; beanClass) &#123; //è·å–å­—æ®µä¸Šçš„çº¦æŸæ¡ä»¶ Set&lt;ConstrainedElement&gt; constrainedElements = getFieldMetaData( beanClass ); //è·å–æ–¹æ³•ä¸Šçš„çº¦æŸæ¡ä»¶ï¼ˆåŒ…æ‹¬å‚æ•°ã€è¿”å›å€¼ï¼‰ constrainedElements.addAll( getMethodMetaData( beanClass ) ); //è·å–æ„é€ å‡½æ•° constrainedElements.addAll( getConstructorMetaData( beanClass ) ); //è·å–ç±»ä¸Šçš„çº¦æŸæ¡ä»¶ Set&lt;MetaConstraint&lt;?&gt;&gt; classLevelConstraints = getClassLevelConstraints( beanClass ); if ( !classLevelConstraints.isEmpty() ) &#123; ConstrainedType classLevelMetaData = new ConstrainedType( ConfigurationSource.ANNOTATION, beanClass, classLevelConstraints ); constrainedElements.add( classLevelMetaData ); &#125; return new BeanConfiguration&lt;&gt;( ConfigurationSource.ANNOTATION, beanClass, constrainedElements, getDefaultGroupSequence( beanClass ), getDefaultGroupSequenceProvider( beanClass ) ); &#125; //æŸ¥æ‰¾çº¦æŸæ³¨è§£ protected &lt;A extends Annotation&gt; List&lt;ConstraintDescriptorImpl&lt;?&gt;&gt; findConstraintAnnotations( Constrainable constrainable, A annotation, ConstraintLocationKind type) &#123; //å¦‚æœåŒ…å« \"jdk.internal\" and \"java\" ä¸‹çš„æ³¨è§£ï¼Œåˆ™ç›´æ¥ä¸è¿›è¡Œæ ¡éªŒ if ( constraintCreationContext.getConstraintHelper().isJdkAnnotation( annotation.annotationType() ) ) &#123; return Collections.emptyList(); &#125; List&lt;Annotation&gt; constraints = newArrayList(); Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType(); //åˆ¤æ–­æ˜¯å¦æœ‰çº¦æŸæ¡ä»¶ï¼Œä¹Ÿå°±æˆ‘ä»¬ç»å¸¸é…ç½®çš„ @NotNullï¼Œ@Min è¿™ç±»æ³¨è§£ if ( constraintCreationContext.getConstraintHelper().isConstraintAnnotation( annotationType ) ) &#123; constraints.add( annotation ); &#125; //è¿™ä¸ªæ²¡ç”¨è¿‡ï¼Œæš‚æ—¶è·³è¿‡ else if ( constraintCreationContext.getConstraintHelper().isMultiValueConstraint( annotationType ) ) &#123; constraints.addAll( constraintCreationContext.getConstraintHelper().getConstraintsFromMultiValueConstraint( annotation ) ); &#125; return constraints.stream() .map( c -&gt; buildConstraintDescriptor( constrainable, c, type ) ) .collect( Collectors.toList() ); &#125; //æ„å»ºçº§è”å…ƒæ•°æ®æ„é€ å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ @Validï¼Œåœ¨ Bean ä¸­å¦‚æœæˆ‘ä»¬è¦å¯¹å¯¹è±¡å±æ€§è¿›è¡Œæ ¡éªŒï¼Œ //éœ€è¦åœ¨è¯¥å±æ€§ä¸Šæ·»åŠ  @Validï¼Œæ­¤å¤„ä¾¿æ˜¯å¦‚æ­¤ private CascadingMetaDataBuilder getCascadingMetaData(JavaBeanAnnotatedElement annotatedElement, Map&lt;TypeVariable&lt;?&gt;, CascadingMetaDataBuilder&gt; containerElementTypesCascadingMetaData) &#123; return CascadingMetaDataBuilder.annotatedObject( annotatedElement.getType(), annotatedElement.isAnnotationPresent( Valid.class ), containerElementTypesCascadingMetaData, getGroupConversions( annotatedElement.getAnnotatedType() ) ); &#125;&#125; é¡ºç€ä¸Šé¢çš„æ ˆè·¯å¾„ä¸€ç›´å¾€ä¸‹èµ°ï¼Œæœ€ç»ˆå‘ç°æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ–¹æ³•æ˜¯ getFieldMetaDataã€getMethodMetaDataã€getConstructorMetaDataã€getClassLevelConstraintsï¼Œè¿™ä¸ªå‡ æ–¹æ³•éƒ½æ˜¯ç”¨äºè·å–çº¦æŸå’Œçº§è”å…ƒæ•°æ®ã€‚é‚£ä¹ˆé‡Œé¢åˆ°åº•æ˜¯æ€ä¹ˆè·å–çº¦æŸå…ƒæ•°æ®çš„å‘¢ï¼Œå’±ç»§ç»­å¾€é‡Œé’»ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨äº† findConstraintAnnotations è·å–çº¦æŸå…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„ @NotNullï¼Œ@Min ç­‰æ³¨è§£ï¼Œé€šè¿‡ getCascadingMetaData è·å–çº§è”å…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯ @Valid æ³¨è§£ã€‚çœ‹åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼ŒçŸ¥é“æˆ‘åŠ ä¸Š @Valid å°±èƒ½æˆåŠŸæ ¡éªŒäº†å‘¢ï¼Ÿ äºæ˜¯æˆ‘å°è¯•äº†ä¸€æ³¢ï¼Œæœç„¶æ²¡é—®é¢˜ã€‚å—¯~ é•¿è§è¯†äº†ğŸ˜‚ã€‚ç”±äºæ—¶é—´æœ‰é™ï¼ŒValidatorImpl.validateParametersInContext() æ–¹æ³•æˆ‘å°±æ²¡æœ‰æ·±å…¥è¿›å»çœ‹äº†ã€‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œå»çœ‹çœ‹ï¼ï¼ğŸŒ é‚£ä¹ˆ Controller ä¸ºå•¥ç›´æ¥æ·»åŠ  @Validated æˆ–è€… @Valid å°±å¯ä»¥å‘¢ï¼Ÿæ˜ç™½äº†åœ¨åº”ç”¨æœåŠ¡å®ç°ï¼Œå‡†ç¡®çš„è¯´åº”è¯¥æ˜¯æ™®é€š Bean ä¸­åº”è¯¥æ€ä¹ˆé…ç½®ä¹‹ @Validated å’Œ @Valid ä½¿å…¶ç”Ÿæ•ˆä¹‹åï¼Œæˆ‘å°±å¾ˆå¥½å¥‡ä¸ºå•¥ Controller åªéœ€è¦å•ç‹¬åœ¨æ–¹æ³•ä¸Šé…ç½® @Validated æˆ–è€… @Valid å°±èƒ½æˆåŠŸæ ¡éªŒå‘¢ï¼Ÿ è¿˜è®°å¾—ä¸Šé¢é€šè¿‡ IDE æŸ¥çœ‹åº”ç”¨ @Validated æ³¨è§£çš„ç±»æ—¶ï¼Œæˆ‘ä»¬å‘ç°äº† MethodValidationPostProcessorï¼Œè¿˜æœ‰å¦å¤–å‡ ä¸ªç±»ä¸€çœ‹å°±å¾ˆåƒ Controller å‚æ•°è§£æç›¸å…³çš„ç±»ï¼š æˆ‘åœ¨è¿™å‡ ä¸ªç±»ä¸Šå„æ‰“äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œæœ€ç»ˆè¿›å…¥çš„æ˜¯ AbstractMessageConverterMethodArgumentResolverã€‚ okï¼Œé‚£å°±çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œåªè´´äº†å¾ˆå‚æ•°æ ¡éªŒç›¸å…³çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public abstract class AbstractMessageConverterMethodArgumentResolver implements HandlerMethodArgumentResolver &#123; protected void validateIfApplicable(WebDataBinder binder, MethodParameter parameter) &#123; Annotation[] annotations = parameter.getParameterAnnotations(); for (Annotation ann : annotations) &#123; //è·å–åˆ†ç»„ä¿¡æ¯ Object[] validationHints = ValidationAnnotationUtils.determineValidationHints(ann); if (validationHints != null) &#123; //è¿›è¡Œæ ¡éªŒ binder.validate(validationHints); break; &#125; &#125; &#125;&#125;public abstract class ValidationAnnotationUtils &#123; @Nullable public static Object[] determineValidationHints(Annotation ann) &#123; Class&lt;? extends Annotation&gt; annotationType = ann.annotationType(); String annotationName = annotationType.getName(); //å¦‚æœæ˜¯ @valid æ³¨è§£ç›´æ¥è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ if (\"javax.validation.Valid\".equals(annotationName)) &#123; return EMPTY_OBJECT_ARRAY; &#125; //å¦‚æœæ˜¯ @validated åˆ™è¿”å›å…¶åˆ†ç»„ä¿¡æ¯ Validated validatedAnn = AnnotationUtils.getAnnotation(ann, Validated.class); if (validatedAnn != null) &#123; Object hints = validatedAnn.value(); return convertValidationHints(hints); &#125; if (annotationType.getSimpleName().startsWith(\"Valid\")) &#123; Object hints = AnnotationUtils.getValue(ann); return convertValidationHints(hints); &#125; return null; &#125;&#125;public class DataBinder implements PropertyEditorRegistry, TypeConverter &#123; public void validate(Object... validationHints) &#123; //æ­¤å¤„æ˜¯å…³é”®æ‰€åœ¨ï¼Œè¿™é‡Œè·å–çš„æ˜¯å‚æ•°ï¼ï¼ï¼å’Œæ™®é€šçš„ Bean è·å–åˆ°çš„å´æ˜¯ Bean æœ¬èº« Object target = getTarget(); Assert.state(target != null, \"No target to validate\"); BindingResult bindingResult = getBindingResult(); // Call each validator with the same binding result for (Validator validator : getValidators()) &#123; if (!ObjectUtils.isEmpty(validationHints) &amp;&amp; validator instanceof SmartValidator) &#123; ((SmartValidator) validator).validate(target, bindingResult, validationHints); &#125; else if (validator != null) &#123; validator.validate(target, bindingResult); &#125; &#125; &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº Controller ä¸è®ºæ˜¯ç›´æ¥åœ¨å‚æ•°ä¸ŠåŠ ä¸Š @Validated æˆ–è€… @Valid æ³¨è§£ï¼Œéƒ½ä¼šè¿›å…¥åˆ°æ ¡éªŒæ–¹æ³•ï¼Œè€Œä¸”æ ¡éªŒçš„å°±æ˜¯å‚æ•°ï¼ï¼ï¼è€Œ Bean æ ¡éªŒçš„å´æ˜¯ Bean æœ¬èº«ï¼ï¼ï¼ MethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ï¼Ÿæ˜ç™½äº† @Validated çš„æ‹¦æˆªå®ç°çš„åŸç†åï¼Œé‚£ä¹ˆå°±åªå‰©æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼ŒMethodValidationPostProcessor å’Œ AbstractMessageConverterMethodArgumentResolver æ˜¯æ€ä¹ˆè¢«æ³¨å†Œåˆ° BeanFactory çš„ã€‚ å…¶å®ä¸ç”¨çœ‹æºç å¤§æ¦‚æœ‰ä¹Ÿèƒ½çŒœåˆ°æ˜¯ Spring Boot è‡ªåŠ¨è£…é…çš„ã€‚ä¸ºäº†å°è¯ä¸€ä¸‹ï¼Œæˆ‘è¿˜æ˜¯è´´ä¸€ä¸‹æºç ï¼š 1234567891011121314151617181920@Configuration(proxyBeanMethods = false)@ConditionalOnClass(ExecutableValidator.class)@ConditionalOnResource(resources = \"classpath:META-INF/services/javax.validation.spi.ValidationProvider\")@Import(PrimaryDefaultValidatorPostProcessor.class)public class ValidationAutoConfiguration &#123; //... @Bean @ConditionalOnMissingBean public static MethodValidationPostProcessor methodValidationPostProcessor(Environment environment, @Lazy Validator validator, ObjectProvider&lt;MethodValidationExcludeFilter&gt; excludeFilters) &#123; FilteredMethodValidationPostProcessor processor = new FilteredMethodValidationPostProcessor( excludeFilters.orderedStream()); boolean proxyTargetClass = environment.getProperty(\"spring.aop.proxy-target-class\", Boolean.class, true); processor.setProxyTargetClass(proxyTargetClass); processor.setValidator(validator); return processor; &#125;&#125; å¦å¤–å°±æ˜¯ AbstractMessageConverterMethodArgumentResolver çš„å‡ ä¸ªå®ç°ç±»ï¼Œå‡ç”± RequestMappingHandlerAdapter å®ä¾‹åŒ–ï¼Œè€Œ RequestMappingHandlerAdapter å¤§å®¶çŸ¥é“æœ‰ WebMvcAutoConfiguration è‡ªåŠ¨è£…é…ï¼Œæ—¶é—´åŸå› ï¼Œè¿™å°±ä¸çœ‹äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class RequestMappingHandlerAdapter extends AbstractHandlerMethodAdapter implements BeanFactoryAware, InitializingBean &#123; private List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;&gt;(30); // Annotation-based argument resolution resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false)); resolvers.add(new RequestParamMapMethodArgumentResolver()); resolvers.add(new PathVariableMethodArgumentResolver()); resolvers.add(new PathVariableMapMethodArgumentResolver()); resolvers.add(new MatrixVariableMethodArgumentResolver()); resolvers.add(new MatrixVariableMapMethodArgumentResolver()); resolvers.add(new ServletModelAttributeMethodProcessor(false)); resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice)); resolvers.add(new RequestPartMethodArgumentResolver(getMessageConverters(), this.requestResponseBodyAdvice)); resolvers.add(new RequestHeaderMethodArgumentResolver(getBeanFactory())); resolvers.add(new RequestHeaderMapMethodArgumentResolver()); resolvers.add(new ServletCookieValueMethodArgumentResolver(getBeanFactory())); resolvers.add(new ExpressionValueMethodArgumentResolver(getBeanFactory())); resolvers.add(new SessionAttributeMethodArgumentResolver()); resolvers.add(new RequestAttributeMethodArgumentResolver()); // Type-based argument resolution resolvers.add(new ServletRequestMethodArgumentResolver()); resolvers.add(new ServletResponseMethodArgumentResolver()); resolvers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice)); resolvers.add(new RedirectAttributesMethodArgumentResolver()); resolvers.add(new ModelMethodProcessor()); resolvers.add(new MapMethodProcessor()); resolvers.add(new ErrorsMethodArgumentResolver()); resolvers.add(new SessionStatusMethodArgumentResolver()); resolvers.add(new UriComponentsBuilderMethodArgumentResolver()); if (KotlinDetector.isKotlinPresent()) &#123; resolvers.add(new ContinuationHandlerMethodArgumentResolver()); &#125; // Custom arguments if (getCustomArgumentResolvers() != null) &#123; resolvers.addAll(getCustomArgumentResolvers()); &#125; // Catch-all resolvers.add(new PrincipalMethodArgumentResolver()); resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), true)); resolvers.add(new ServletModelAttributeMethodProcessor(true)); return resolvers; &#125;&#125; å°ç»“1ã€åœ¨æ™®é€š Bean ä¸­å¦‚æœè¦é€šè¿‡æ³¨è§£çš„æ–¹å¼ä½¿ç”¨ hibernate-validator è¿›è¡Œæ ¡éªŒçš„è¯ï¼Œéœ€è¦åœ¨ç±»ä¸Šæ·»åŠ  @Validated æ³¨è§£ï¼ŒåŒæ—¶åœ¨æ–¹æ³•ä¸Šæ·»åŠ  @Valid æ³¨è§£ã€‚æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ @NotNull ç­‰æ³¨è§£ã€‚ 2ã€æ™®é€š Bean ä½¿ç”¨ @Validated æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆçš„ã€‚å…·ä½“çš„æ‹¦æˆªå™¨ä¾¿æ˜¯ä»– MethodValidationInterceptorã€‚ 3ã€Controller å±‚ä¹‹æ‰€ä»¥èƒ½ @Validated å’Œ @Valid äºŒé€‰ä¸€ï¼Œæ˜¯å› ä¸ºæ ¡éªŒçš„æ˜¯å‚æ•°æœ¬èº«ï¼Œè€Œæ™®é€š Bean æ ¡éªŒçš„æ˜¯ Bean æœ¬èº«ã€‚ 4ã€è‡³æ­¤ï¼Œç›¸ä¿¡å¤§å®¶å°±ä¸ä¼šæ²¡é…ç½®å¥½ @Validated å¯¼è‡´å¤±æ•ˆäº†ã€‚","categories":[],"tags":[{"name":"spring","slug":"spring","permalink":"http://example.com/tags/spring/"}]},{"title":"kafka æ¶ˆè´¹è€…é«˜ cpu é—®é¢˜æ’æŸ¥","slug":"kafka-æ¶ˆè´¹è€…é«˜-cpu-é—®é¢˜æ’æŸ¥","date":"2023-04-14T15:31:22.000Z","updated":"2023-04-14T15:48:38.289Z","comments":true,"path":"2023/04/14/kafka-æ¶ˆè´¹è€…é«˜-cpu-é—®é¢˜æ’æŸ¥/","link":"","permalink":"http://example.com/2023/04/14/kafka-%E6%B6%88%E8%B4%B9%E8%80%85%E9%AB%98-cpu-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/","excerpt":"","text":"ä»Šå¤©æœ¬æ¥æ‰“ç®—æ„‰å¿«çš„åˆ’æ°´ï¼Œè¿ç»´å°å“¥çªç„¶æ‰¾æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåº”ç”¨ cpu ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œæˆ‘ä¸€çœ‹å‘Šè­¦è¿˜çœŸæ˜¯â€¦ cpu é«˜é—®é¢˜æ’æŸ¥æ€è·¯é¦–å…ˆè¿˜æ˜¯è€å¥—è·¯ï¼š å…ˆæŸ¥çœ‹ cpu é«˜çš„çº¿ç¨‹æ˜¯å“ªäº› 1top -Hp &lt;pid&gt; æŸ¥çœ‹çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ 12345//å°†çº¿ç¨‹ id è½¬æ¢ä¸º 16 è¿›åˆ¶printf '%x\\n' &lt;tid&gt;//è·å–çº¿ç¨‹å·å 50 è¡Œå †æ ˆä¿¡æ¯jstack &lt;pid&gt; | grep &lt;tid&gt; -A 50 è¿™é‡Œæˆ‘å°±ç›´æ¥ç”¨çº¿ç¨‹åç§°å»æŸ¥äº†ã€‚ çœ‹å †æ ˆä¿¡æ¯å®šä½åˆ°æ˜¯ kafka æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¯¼è‡´ cpu å±…é«˜ä¸ä¸‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ kafka æ¶ˆè´¹è€… cpu é£šé«˜éƒ½æ˜¯æœ‰å¤§é‡çš„æ¶ˆæ¯ï¼Œæˆ‘ç¬¬ä¸€ä¸ªæ„Ÿè§‰å°±æ˜¯æµ‹è¯•åœ¨è¿›è¡Œå‹æµ‹ï¼Œç»“æœä¸€çœ‹ï¼Œæ‰“è„¸äº†ğŸ¤”ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œlag æ˜¯ 0 æˆ–è€…è´Ÿæ•°ï¼Œæˆ‘åˆåˆ·æ–°äº†å‡ æ¬¡åŸºæœ¬ä¸Šæ²¡æœ‰å¤šå°‘æ¶ˆæ¯ï¼Œè¿™é‡Œç•™ä¸ªå¿ƒçœ¼ï¼Œåé¢æˆ‘ä»¬åœ¨å¥½å¥½å” å” ã€‚ é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ²¡æœ‰æ¶ˆæ¯ä¸ºå•¥æ¶ˆè´¹è€… cpu ä¼šé£šé«˜â€¦ çªç„¶çµæœºä¸€åŠ¨ï¼Œä¼šä¸ä¼šæ˜¯æ¶ˆè´¹è€…æ•°å¤ªå¤šäº†ï¼Œå¯¼è‡´å¾ªç¯å»è°ƒç”¨ poll æ–¹æ³•ï¼Œé€ æˆæ•´ä¸ªèŠ‚ç‚¹ cpu é£šé«˜ã€‚ç„¶åå°±å±é¢ å±é¢ çš„æŠŠæ‰€æœ‰ä¸»é¢˜çš„æ¶ˆè´¹è€…æ•°è°ƒå°äº†ï¼Œç„¶é¹…æƒ³æƒ³å¾ˆç¾å¥½ï¼Œç°å®å¾ˆéª¨æ„Ÿâ€¦ é‡å¯åèŠ‚ç‚¹çš„ cpu ä¾ç„¶å±…é«˜ä¸ä¸‹ã€‚ é‡åˆ°ä¸æ‡‚å°±é—®åº¦å¨˜åœ¨ç½‘ä¸Šé€›äº†ä¸€åœˆï¼Œçœ‹åˆ°è®¸å¤šç›¸ä¼¼çš„åœºæ™¯ï¼Œå„ç§æ“ä½œéƒ½è¯•äº†ä¸€éï¼Œè¿˜æ˜¯æ²¡ä»€ä¹ˆç”¨ğŸ™ƒï¼Œkafka çš„ github ä»“åº“æˆ‘ä¹Ÿå»é€›äº†ä¸€åœˆï¼Œå‘ç°ä¹Ÿæœ‰å¾ˆå¤š cpu é«˜å¾—åœºæ™¯ï¼Œå¤§å¤šæ•°éƒ½æ˜¯å»ºè®®å‡çº§å®¢æˆ·ç«¯ç‰ˆæœ¬ï¼Œå¿˜äº†è¯´æˆ‘å¸ç›®å‰ç”¨çš„è¿˜æ˜¯ 0.11.2ï¼Œæ€»ä¹‹é€›äº†ä¸€åœˆæ²¡æœ‰èµ·åˆ°å¤ªå¤§çš„å¸®åŠ©ã€‚ æ¥ç€å°±æ˜¯ä¸€æ³¢è™¾çš®æ“ä½œï¼Œæ˜¾ç¤ºç”Ÿæˆäº†ç«ç„°å›¾ï¼Œçœ‹çœ‹ consumer poll åˆ°åº•ä¸ºå•¥ä¸€ç›´å ç”¨ cpuï¼Œä¸‹é¢æ˜¯ä¸€å¼ ç«ç„°å›¾ï¼š è™½ç„¶ poll æ–¹æ³•å ç”¨ cpu è€—æ—¶å¾ˆé•¿ï¼Œä½†æ˜¯ä»”ç»†çœ‹åˆè§‰å¾—æ²¡å•¥é—®é¢˜ï¼Œæ˜¯æ­£å¸¸çš„åœ¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ç”šè‡³ä¸€åº¦æ€€ç–‘æ˜¯ kafka å®¢æˆ·ç«¯çš„ bug ğŸ˜‚ã€‚ æœ‰è€å¿ƒé—®é¢˜è¿Ÿæ—©èƒ½è§£å†³è¿˜è®°çš„æˆ‘ä»¬ä¹‹å‰æäº†ä¸€å˜´é‚£å¼ æˆªå›¾å—ï¼Œæ²¡é”™å°±æ˜¯ä¸‹é¢è¿™å¼  å›¾ä¸­ lag å‡ºç°è´Ÿæ•°ï¼Œå…¶å® lag å‡ºç°è´Ÿæ•°è¿˜æ˜¯å¾ˆå¸¸è§çš„ï¼Œä½†é—®é¢˜å°±å‡ºåœ¨æˆ‘æ’æŸ¥äº†è¿™ä¹ˆä¹…å›¾ä¸­çš„ lag å¥½åƒæ²¡å˜åŒ–è¿‡ï¼Œè€Œä¸”ä¸€ç›´æ˜¯è´Ÿæ•°ï¼Œé‚£å°±å¾ˆå€¼å¾—æ³¨æ„äº†ã€‚ æˆ‘ä»¬è¿˜æ˜¯å…ˆè¯´è¯´ lag æ˜¯æ€ä¹ˆè®¡ç®—çš„ 1lag = HW - consumerOffset HW: é«˜æ°´ä½ï¼Œé€šå¸¸ç­‰äºæ‰€æœ‰ ISR ä¸­æœ€å°çš„ LEOï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹çœ‹å¤§ä½¬çš„åšå®¢ consumerOffset: è¡¨ç¤ºæ¶ˆè´¹è€…æäº¤çš„æ¶ˆè´¹ä½ç§» é‚£ä¹ˆ lag ä¸ºå•¥ä¼šå‡ºç°è´Ÿæ•°å‘¢ï¼Œç”±äºæˆ‘æœ¬èº«å¹¶æœªçœ‹è¿‡æºç ï¼Œæ‰€ä»¥ä»ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒæ˜¯èƒ½è¯´çš„é€šçš„è§£é‡Š: Producer çš„ offset æ˜¯é€šè¿‡ JMX è½®è¯¢è·å¾—çš„ï¼ŒConsumer çš„ offset æ˜¯ä» kafka å†…çš„ __consumer_offsets çš„ topic ä¸­ç›´æ¥è¯»å–åˆ°çš„ï¼Œå¾ˆæ˜æ˜¾è½®è¯¢è·å– offset æ¯” ç›´æ¥ä» topic æ‹¿ offset æ…¢ä¸€ç‚¹ï¼Œä¹Ÿå°±å¯èƒ½ä¼šå‡ºç° Lag è®¡ç®—åä¸ºè´Ÿæ•°çš„æƒ…å†µã€‚ OKï¼Œå›åˆ°æ­£é¢˜ï¼Œlag é•¿æ—¶é—´æ˜¯è´Ÿæ•°è¯´æ˜ consumerOffset ä¸€ç›´å¤§äº HWï¼Œé‚£ä¹ˆå‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› å¤§æ¦‚ç‡æ˜¯ HW ä¸€ç›´ä¸æ›´æ–°ï¼Œå› ä¸º HW åªè¦æ›´æ–°å…¶å® lag å¾ˆå¿«å°±èƒ½å˜å› 0ã€‚é‚£ä¹ˆ HW æ˜¯ä»€ä¹ˆæ—¶å€™æ›´æ–°çš„å‘¢ï¼Œå…¶å®æ˜¯ Follower å‰¯æœ¬åŒæ­¥ Leader å‰¯æœ¬æ•°æ®æ—¶ï¼ŒLeader å‰¯æœ¬ä¼šå¯¹æ¯” Follower æ‹‰å–æ•°æ®çš„ offset å’Œ Leader è‡ªèº«çš„ LEO å»æ›´æ–° HWï¼Œæ‰€ä»¥é€šå¸¸ HW éœ€è¦ Follower å¤šåŒæ­¥ä¸€è½®æ‰ä¼šæ›´æ–°ã€‚ é‚£ä¹ˆ HW ä¸æ›´æ–°ï¼Œåªèƒ½è¯´æ˜ Follower æ²¡æœ‰å»åŒæ­¥æ•°æ®ï¼Œæƒ³åˆ°è¿™ï¼Œæˆ‘ç«‹é©¬å»çœ‹äº†ä¸‹æ¶ˆè´¹ç»„çš„å‰¯æœ¬çŠ¶æ€ï¼Œå‘ç°æœ‰ä¸€ä¸ª broker æ‰€æœ‰çš„åˆ†åŒºå‰¯æœ¬éƒ½ä¸åœ¨ ISR ä¸­ã€‚é‚£ä¹ˆåŸºæœ¬ä¸Šç¡®å®šè¿™ä¸ª broker æ˜¯å‡ºç°é—®é¢˜äº†ï¼Œä½†æ˜¯è¿™å’Œæˆ‘æ¶ˆè´¹è€… cpu é«˜æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ è¿™æ—¶è¿ç»´å°å“¥å‘Šè¯‰æˆ‘ï¼Œpoll å¹³å‡æ¯ 3ms å°±è¯·æ±‚ä¸€æ¬¡ï¼Œå¯¼è‡´ cpu é£šé«˜ã€‚çº³å°¼ï¼Ÿï¼Ÿï¼Ÿæˆ‘çš„ poll timeout æ˜æ˜æ˜¯ 100msï¼Œæ€ä¹ˆ 3ms ä¸€æ¬¡å‘¢ï¼Œè¿™æ˜æ˜¾æœ‰é—®é¢˜å‘€ï¼Œè¿ç»´å°å“¥å‘äº†ä¸€ä¸‹æŠ“åŒ…çš„æˆªå›¾ç»™æˆ‘ï¼š kafka broker response ä¸­æç¤º Not Leader For Partitionï¼Œè¿™ä¸å°±å’Œä¸Šé¢çš„çŒœæƒ³å¯¹ä¸Šäº†å—ï¼Œçœ‹çœ‹ chatgpt ç»™å‡ºçš„è§£é‡Š: è‡³æ­¤é—®é¢˜å°±æ’æŸ¥äº†å·®ä¸å¤šäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è§£å†³ã€‚ç”±äºæ˜¯åœ¨æµ‹è¯•ç¯å¢ƒå‘ç°çš„ï¼Œè§£å†³æ–¹å¼ä¹Ÿå¾ˆç²—æš´ï¼Œå°±æ˜¯ç›´æ¥æŠŠ topic ç›´æ¥åˆ é™¤äº†ï¼Œç„¶åé‡æ–°åˆ›å»ºã€‚ å°ç»“ é‡åˆ°æ¶‰åŠç½‘ç»œç›¸å…³çš„é—®é¢˜ï¼Œå¯ä»¥æŠ“ä¸ªåŒ…ç§ç§ï¼Œè¯´ä¸å®šæ€è·¯ä¸€ä¸‹å°±æ‰“å¼€äº†ã€‚ å¦‚æœå®åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°è¿™ç±»é—®é¢˜ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆå¤„ç† broker å‘¢ï¼Œè¿™ä¸ªå¾—å¥½å¥½ç¢ç£¨ç¢ç£¨ï¼Œç›®å‰æ€è·¯æ˜¯ä» controller ä¸‹æ‰‹ã€‚","categories":[],"tags":[{"name":"kafka","slug":"kafka","permalink":"http://example.com/tags/kafka/"}]},{"title":"wireshark æŠ“åŒ… javaåº”ç”¨ä¸­çš„ https è¯·æ±‚","slug":"wireshark-æŠ“åŒ…-javaåº”ç”¨ä¸­çš„-https-è¯·æ±‚","date":"2023-04-03T07:08:41.000Z","updated":"2023-04-03T07:12:39.504Z","comments":true,"path":"2023/04/03/wireshark-æŠ“åŒ…-javaåº”ç”¨ä¸­çš„-https-è¯·æ±‚/","link":"","permalink":"http://example.com/2023/04/03/wireshark-%E6%8A%93%E5%8C%85-java%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84-https-%E8%AF%B7%E6%B1%82/","excerpt":"","text":"æœ€è¿‘ç”Ÿäº§ä¸­è¯·æ±‚ç¬¬ä¸‰æ–¹æ¥å£çš„æœåŠ¡é¢‘ç¹å‘Šè­¦ï¼Œæ¥å£å“åº”è¿‡æ…¢ï¼Œæˆ‘ä»¬è¿™è¾¹ä½¿ç”¨çš„ httpclient è¿æ¥æ± ï¼Œå„é¡¹é…ç½®çœ‹èµ·æ¥éƒ½æ²¡å¤ªå¤§çš„é—®é¢˜ï¼Œäºæ˜¯å°±æƒ³ç€è¯´æŠ“åŒ…çœ‹çœ‹æ˜¯å¦æœ‰ç½‘ç»œå±‚é¢çš„é—®é¢˜è¿˜æ˜¯çš„ç¡®æ˜¯ç¬¬ä¸‰æ–¹æ¥å£æ…¢ã€‚ é€šè¿‡ jsslkeylog è·å– sslkeylogwireshark ä¸­ https æ˜¾ç¤ºå¯†æ–‡çš„æ ·å­æœ‰ç”¨è¿‡ wireshark æŠ“åŒ… https çš„å¤§ä½¬åº”è¯¥éƒ½çŸ¥é“ï¼Œhttps æ˜¯æœ‰åŠ å¯†çš„ï¼Œç›´æ¥ç”¨ wireshark æŠ“åŒ…å±•ç¤ºçš„å…¨éƒ½æ˜¯å¯†æ–‡ï¼Œå¦‚ä¸‹å›¾ï¼šå¯ä»¥çœ‹åˆ°ï¼Œå…·ä½“çš„ https è¯·æ±‚æ•°æ®éƒ½è¢«åŠ å¯†äº†ã€‚ å¦‚ä½•è®© https åœ¨ wireshark æ˜¾ç¤ºæ˜æ–‡wireshark ä¸­è§£å¯† https è¯·æ±‚çš„æ–¹å¼æœ‰å¤šç§ï¼Œè¿™é‡Œä½¿ç”¨çš„æ–¹å¼æ˜¯è·å– https è¯·æ±‚æ—¶çš„ sslkeylogï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª javaagent å·¥å…· jsslkeylogï¼Œé€šè¿‡ä¿®æ”¹å­—èŠ‚ç è¾¾åˆ°å‘é€ https è¯·æ±‚æ—¶å°†ä½¿ç”¨åˆ°çš„ sslkeylog å†™å…¥åˆ°æœ¬åœ°ç£ç›˜çš„æ•ˆæœã€‚å…·ä½“æµç¨‹ä¹Ÿå¾ˆç®€å•ï¼š1ã€ä¸‹è½½ jsslkeylog jar åŒ…2ã€å¯åŠ¨å‘½ä»¤ä¸­åŠ å…¥ -javaagent:/path_to_jar/jSSLKeyLog.jar=/path_to_log/sslkeylog.log3ã€å¯åŠ¨åº”ç”¨å‘èµ· https è¯·æ±‚4ã€ä¹‹ååº”è¯¥å°±ä¼šåœ¨é…ç½®çš„ /path_to_log ä¸­çœ‹åˆ°å¯¹åº”çš„ sslkeylog5ã€ä¹‹åå°† log é…ç½®åˆ° wireshark ä¸­ï¼Œprfferences -&gt; protocols -&gt; tlsé…ç½®å®Œæˆä¹‹åï¼Œå°±èƒ½çœ‹åˆ°åŸæœ¬çš„å¯†æ–‡å·²ç»å˜æˆæ˜æ–‡äº†ï¼Œä¹‹åå°±èƒ½æ„‰å¿«çš„åˆ†æäº†ğŸŒ","categories":[],"tags":[{"name":"java","slug":"java","permalink":"http://example.com/tags/java/"},{"name":"è®¡ç®—æœºç½‘ç»œ","slug":"è®¡ç®—æœºç½‘ç»œ","permalink":"http://example.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"}]},{"title":"k8s æ­å»º","slug":"k8s-æ­å»º","date":"2023-03-31T15:45:37.000Z","updated":"2023-03-31T15:46:40.276Z","comments":true,"path":"2023/03/31/k8s-æ­å»º/","link":"","permalink":"http://example.com/2023/03/31/k8s-%E6%90%AD%E5%BB%BA/","excerpt":"","text":"k8sæ­å»ºè¯´æ˜æœ¬æ–‡ç³»æ­å»º kubernetes v1.21.3 ç‰ˆæœ¬é›†ç¾¤ç¬”è®°ï¼Œä½¿ç”¨ä¸‰å°è™šæ‹Ÿæœºä½œä¸º CentOS7.9 ç³»ç»Ÿæµ‹è¯•æœºï¼Œå®‰è£… kubeadmã€kubeletã€kubectl å‡ä½¿ç”¨ yum å®‰è£…ï¼Œç½‘ç»œç»„ä»¶é€‰ç”¨çš„æ˜¯ flannelã€‚ ç¯å¢ƒå‡†å¤‡éƒ¨ç½²é›†ç¾¤æ²¡æœ‰ç‰¹æ®Šè¯´æ˜å‡ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ã€‚ 2.1 ç¡¬ä»¶ä¿¡æ¯ ip hostname mem disk explain 192.168.85.2 192.168.85.2 2G 40GB k8s æ§åˆ¶å¹³é¢èŠ‚ç‚¹ 192.168.85.3 192.168.85.3 2G 40GB k8s æ‰§è¡ŒèŠ‚ç‚¹1 192.168.85.4 192.168.85.4 2G 40GB k8s æ‰§è¡ŒèŠ‚ç‚¹2 2.2 è½¯ä»¶ä¿¡æ¯ 12345software versionCentOS CentOS Linux release 7.9.2009 (Core)Kubernetes 1.21.3Docker 20.10.8Kernel 5.4.138-1.el7.elrepo.x86_64 2.3 ç¦ç”¨ swapswap ä»…å½“å†…å­˜ä¸å¤Ÿæ—¶ä¼šä½¿ç”¨ç¡¬ç›˜å—å……å½“é¢å¤–å†…å­˜ï¼Œç¡¬ç›˜çš„ io è¾ƒå†…å­˜å·®è·æå¤§ï¼Œç¦ç”¨ swap ä»¥æé«˜æ€§èƒ½å„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š 123swapoff -a cp /etc/fstab /etc/fstab.bakcat /etc/fstab.bak | grep -v swap &gt; /etc/fstab 2.4 å…³é—­ SELinux å…³é—­ SELinuxï¼Œå¦åˆ™ kubelet æŒ‚è½½ç›®å½•æ—¶å¯èƒ½æŠ¥é”™ Permission deniedï¼Œå¯ä»¥è®¾ç½®ä¸º permissive æˆ– disabledï¼Œpermissive ä¼šæç¤º warn ä¿¡æ¯å„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š 12setenforce 0 sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config 2.5 è®¾ç½®æ—¶åŒºã€åŒæ­¥æ—¶é—´ 12timedatectl set-timezone Asia/Shanghai systemctl enable --now chronyd æŸ¥çœ‹åŒæ­¥çŠ¶æ€ï¼š 1timedatectl status 2.6 å…³é—­é˜²ç«å¢™ 12systemctl stop firewalldsystemctl disable firewalld å®‰è£…å¿…è¦ä¾èµ–1yum install -y yum-utils device-mapper-persistent-data lvm2 3.1 æ·»åŠ  aliyun docker-ce yum æº 1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo é‡å»º yum ç¼“å­˜ 1yum makecache fast 3.2 å®‰è£… Docker æŸ¥çœ‹å¯ç”¨ docker ç‰ˆæœ¬ 1yum list docker-ce.x86_64 --showduplicates | sort -r ==å®‰è£…æŒ‡å®šç‰ˆæœ¬ Docker== yum install -y docker-ce-20.10.14-3.el7 è¿™é‡Œä»¥å®‰è£… 20.10.14 ç‰ˆæœ¬ä¸¾ä¾‹ï¼Œæ³¨æ„ç‰ˆæœ¬å·ä¸åŒ…å« : ä¸ä¹‹å‰çš„æ•°å­—ã€‚ 3.3 ç¡®ä¿ç½‘ç»œæ¨¡å—å¼€æœºè‡ªåŠ¨åŠ è½½ 12lsmod | grep overlay lsmod | grep br_netfilter è‹¥ä¸Šé¢å‘½ä»¤æ— è¿”å›å€¼è¾“å‡ºæˆ–æç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 123456cat &gt; /etc/modules-load.d/docker.conf &lt;&lt;EOF overlay br_netfilter EOFmodprobe overlay modprobe br_netfilter 3.4 ä½¿æ¡¥æ¥æµé‡å¯¹ iptables å¯è§å„ä¸ªèŠ‚ç‚¹å‡éœ€æ‰§è¡Œï¼š 12345cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF net.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1EOFsysctl --system éªŒè¯æ˜¯å¦ç”Ÿæ•ˆï¼Œå‡è¿”å› 1 å³æ­£ç¡®ã€‚ 12sysctl -n net.bridge.bridge-nf-call-iptables sysctl -n net.bridge.bridge-nf-call-ip6tables 3.5 é…ç½® Docker 1mkdir /etc/docker ä¿®æ”¹ cgroup é©±åŠ¨ä¸º systemd [k8så®˜æ–¹æ¨è]ã€é™åˆ¶å®¹å™¨æ—¥å¿—é‡ã€ä¿®æ”¹å­˜å‚¨ç±»å‹ï¼Œæœ€åçš„ docker å®¶ç›®å½•å¯ä¿®æ”¹ï¼š 123456789101112131415cat &gt; /etc/docker/daemon.json &lt;&lt;EOF&#123; \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"log-driver\": \"json-file\", \"log-opts\": &#123; \"max-size\": \"100m\" &#125;, \"storage-driver\": \"overlay2\", \"storage-opts\": [ \"overlay2.override_kernel_check=true\" ], \"registry-mirrors\": [\"https://gp8745ui.mirror.aliyuncs.com\"], \"data-root\": \"/data/docker\"&#125;EOF æœåŠ¡è„šæœ¬ç¬¬ 13 è¡Œä¿®æ”¹ï¼š 123vim /lib/systemd/system/docker.serviceExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --default-ulimit core=0:0systemctl daemon-reload æ·»åŠ å¼€æœºè‡ªå¯ï¼Œç«‹å³å¯åŠ¨ï¼š 1systemctl enable --now docker 3.6 éªŒè¯ Docker æ˜¯å¦æ­£å¸¸ æŸ¥çœ‹dockerä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦ä¸é…ç½®ä¸€è‡´ éƒ¨ç½² Kubernetes é›†ç¾¤å¦‚æœªè¯´æ˜ï¼Œå„èŠ‚ç‚¹å‡éœ€æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š 4.1 æ·»åŠ  kubernetes æº 123456789cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF é‡å»ºyumç¼“å­˜ï¼Œè¾“å…¥yæ·»åŠ è¯ä¹¦è®¤è¯ 1yum makecache fast 4.2 å®‰è£… kubeadmã€kubeletã€kubectlå„èŠ‚ç‚¹å‡éœ€å®‰è£… kubeadmã€kubelet 12345yum list docker-ce.x86_64 --showduplicates | sort -rversion=1.21.3-0yum install -y kubelet-v1.21.0 kubeadm-v1.21.0 kubectl-v1.21.0systemctl enable kubelet --now 4.3 é…ç½®è‡ªåŠ¨è¡¥å…¨å‘½ä»¤ å®‰è£… bash è‡ªåŠ¨è¡¥å…¨æ’ä»¶ 1yum install bash-completion -y è®¾ç½® kubectl ä¸ kubeadm å‘½ä»¤è¡¥å…¨ï¼Œä¸‹æ¬¡ login ç”Ÿæ•ˆ 12kubectl completion bash &gt;/etc/bash_completion.d/kubectlkubeadm completion bash &gt; /etc/bash_completion.d/kubeadm 4.4 ä¸º Docker è®¾å®šä½¿ç”¨çš„ä»£ç†æœåŠ¡(æš‚è·³è¿‡è¯¥æ­¥éª¤ï¼Œç”±é˜¿é‡Œäº‘é•œåƒè§£å†³)Kubeadm éƒ¨ç½² Kubernetes é›†ç¾¤çš„è¿‡ç¨‹ä¸­ï¼Œé»˜è®¤ä½¿ç”¨ Google çš„ Registry æœåŠ¡ k8s.gcr.io ä¸Šçš„é•œåƒï¼Œä¾‹å¦‚k8s.grc.io/kube-apiserver ç­‰ï¼Œä½†å›½å†…æ— æ³•è®¿é—®åˆ°è¯¥æœåŠ¡ã€‚å¿…è¦æ—¶ï¼Œå¯è‡ªè¡Œè®¾ç½®åˆé€‚çš„ä»£ç†æ¥è·å–ç›¸å…³é•œåƒï¼Œæˆ–è€…ä» Dockerhub ä¸Šä¸‹è½½é•œåƒè‡³æœ¬åœ°åè‡ªè¡Œå¯¹é•œåƒæ‰“æ ‡ç­¾ã€‚ è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹è®¾ç½®ä»£ç†æœåŠ¡çš„æ–¹æ³•ã€‚ç¼–è¾‘ /lib/systemd/system/docker.service æ–‡ä»¶ï¼Œåœ¨ [Service] é…ç½®æ®µä¸­æ·»åŠ ç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼Œå…¶ä¸­çš„ PROXY_SERVER_IP å’Œ PROXY_PORT è¦æŒ‰ç…§å®é™…æƒ…å†µä¿®æ”¹ã€‚ 123Environment=\"HTTP_PROXY=http://$PROXY_SERVER_IP:$PROXY_PORT\"Environment=\"HTTPS_PROXY=https://$PROXY_SERVER_IP:$PROXY_PORT\"Environment=\"NO_PROXY=192.168.4.0/24\" é…ç½®å®Œæˆåéœ€è¦é‡è½½ systemdï¼Œå¹¶é‡æ–°å¯åŠ¨ docker æœåŠ¡ï¼š 12systemctl daemon-reloadsystemctl restart docker.service éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œç”± kubeadm éƒ¨ç½²çš„ Kubernetes é›†ç¾¤ä¸Šï¼Œé›†ç¾¤æ ¸å¿ƒç»„ä»¶ kube-apiserverã€kube-controller-managerã€kube-scheduler å’Œ etcd ç­‰å‡ä¼šä»¥é™æ€ Pod çš„å½¢å¼è¿è¡Œï¼Œå®ƒä»¬æ‰€ä¾èµ–çš„é•œåƒæ–‡ä»¶é»˜è®¤æ¥è‡ªäº k8s.gcr.io è¿™ä¸€ Registry æœåŠ¡ä¹‹ä¸Šã€‚ä½†æˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®è¯¥æœåŠ¡ï¼Œå¸¸ç”¨çš„è§£å†³åŠæ³•æœ‰å¦‚ä¸‹ä¸¤ç§ï¼Œæœ¬ç¤ºä¾‹å°†é€‰æ‹©ä½¿ç”¨æ›´æ˜“äºä½¿ç”¨çš„å‰ä¸€ç§æ–¹å¼ï¼š ä½¿ç”¨èƒ½å¤Ÿåˆ°è¾¾è¯¥æœåŠ¡çš„ä»£ç†æœåŠ¡ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡å™¨ä¸Šçš„æœåŠ¡ï¼Œä¾‹å¦‚ gcr.azk8s.cn/google_containers å’Œ registry.aliyuncs.com/google_containers ç­‰ï¼ˆç»æµ‹è¯•ï¼Œv1.22.0 ç‰ˆæœ¬å·²åœç”¨ï¼‰4.5 æŸ¥çœ‹æŒ‡å®š k8s ç‰ˆæœ¬éœ€è¦å“ªäº›é•œåƒ 123456789kubeadm config images list --kubernetes-version v1.21.0k8s.gcr.io/kube-apiserver:v1.21.0k8s.gcr.io/kube-controller-manager:v1.21.0k8s.gcr.io/kube-scheduler:v1.21.0k8s.gcr.io/kube-proxy:v1.21.0k8s.gcr.io/pause:3.4.1k8s.gcr.io/etcd:3.4.13-0k8s.gcr.io/coredns/coredns:v1.8.0 4.6 æ‹‰å–é•œåƒ 1vim pullimages.sh 1234567891011121314151617181920212223#!/bin/bash# pull images ver=v1.21.0registry=registry.cn-hangzhou.aliyuncs.com/google_containersimages=`kubeadm config images list --kubernetes-version=$ver |awk -F '/' '&#123;print $2&#125;'` for image in $imagesdoif [ $image != coredns ];then docker pull $&#123;registry&#125;/$image if [ $? -eq 0 ];then docker tag $&#123;registry&#125;/$image k8s.gcr.io/$image docker rmi $&#123;registry&#125;/$image else echo \"ERROR: ä¸‹è½½é•œåƒæŠ¥é”™ï¼Œ$image\" fielse docker pull coredns/coredns:1.8.0 docker tag coredns/coredns:1.8.0 k8s.gcr.io/coredns/coredns:v1.8.0 docker rmi coredns/coredns:1.8.0fidone 4.7 ä¿®æ”¹ kubelet é…ç½®é»˜è®¤ cgroup driver 123456mkdir /var/lib/kubeletcat &gt; /var/lib/kubelet/config.yaml &lt;&lt;EOFapiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemdEOF 4.8 åˆå§‹åŒ– master èŠ‚ç‚¹ä»… 192.168.85.2 èŠ‚ç‚¹éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤ã€‚ 4.8.1 ç”Ÿæˆ kubeadm åˆå§‹åŒ–é…ç½®æ–‡ä»¶[å¯é€‰] ä»…å½“éœ€è‡ªå®šä¹‰åˆå§‹åŒ–é…ç½®æ—¶ç”¨ã€‚ 1kubeadm config print init-defaults &gt; kubeadm-config.yaml ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š 12localAPIEndpoint: advertiseAddress: 1.2.3.4 æ›¿æ¢ä¸ºï¼š 1234localAPIEndpoint: advertiseAddress: 192.168.85.2 name: 192.168.85.2kubernetesVersion: 1.21.0 123networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 æ›¿æ¢ä¸ºï¼š 1234kubernetesVersion: 1.21.0networking: podSubnet: \"10.244.0.0/16\" serviceSubnet: 10.96.0.0/12 4.8.2 æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­£å¸¸ 1kubeadm init phase preflight 4.8.3 åˆå§‹åŒ– master10.244.0.0/16 æ˜¯ flannel å›ºå®šä½¿ç”¨çš„ IP æ®µï¼Œè®¾ç½®å–å†³äºç½‘ç»œç»„ä»¶è¦æ±‚ã€‚ 1kubeadm init --config=kubeadm-config.yaml --ignore-preflight-errors=2 --upload-certs | tee kubeadm-init.log 4.8.4 ä¸ºæ—¥å¸¸ä½¿ç”¨é›†ç¾¤çš„ç”¨æˆ·æ·»åŠ  kubectl ä½¿ç”¨æƒé™ 123456su - iuskyemkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/admin.confsudo chown $(id -u):$(id -g) $HOME/.kube/admin.confecho \"export KUBECONFIG=$HOME/.kube/admin.conf\" &gt;&gt; ~/.bashrcexit 4.8.5 é…ç½® master è®¤è¯ 12echo 'export KUBECONFIG=/etc/kubernetes/admin.conf' &gt;&gt; /etc/profile . /etc/profile å¦‚æœä¸é…ç½®è¿™ä¸ªï¼Œä¼šæç¤ºå¦‚ä¸‹è¾“å‡ºï¼šThe connection to the server localhost:8080 was refused - did you specify the right host or port?æ­¤æ—¶ master èŠ‚ç‚¹å·²ç»åˆå§‹åŒ–æˆåŠŸï¼Œä½†æ˜¯è¿˜æœªå®‰è£…ç½‘ç»œç»„ä»¶ï¼Œè¿˜æ— æ³•ä¸å…¶ä»–èŠ‚ç‚¹é€šè®¯ã€‚ 4.8.6 å®‰è£…ç½‘ç»œç»„ä»¶ä»¥ flannel ä¸ºä¾‹ï¼š 1234curl -o kube-flannel.yml https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlkubectl apply -f kube-flannel.yml # è¿™é‡Œä¸‹è½½é•œåƒéå¸¸æ…¢ï¼Œæˆ‘è¿˜æ˜¯å…ˆæ‰‹åŠ¨æ‹‰ä¸‹æ¥å§ï¼Œä¸è¡Œå°±å¤šè¯•å‡ æ¬¡docker pull quay.io/coreos/flannel:v0.14.0kubectl apply -f kube-flannel.yml 4.8.7 æŸ¥çœ‹ 192.168.85.2 èŠ‚ç‚¹çŠ¶æ€ 123456kubectl get nodesNAME STATUS ROLES AGE VERSION192.168.85.2 Ready control-plane,master 15d v1.21.0192.168.85.3 Ready &lt;none&gt; 15d v1.21.0192.168.85.4 Ready &lt;none&gt; 15d v1.21.0 å¦‚æœ STATUS æç¤º NotReadyï¼Œå¯ä»¥é€šè¿‡ kubectl describe node 192.168.85.2 æŸ¥çœ‹å…·ä½“çš„æè¿°ä¿¡æ¯ï¼Œæ€§èƒ½å·®çš„æœåŠ¡å™¨åˆ°è¾¾ Ready çŠ¶æ€æ—¶é—´ä¼šé•¿äº›ã€‚ 4.9 åˆå§‹åŒ– node èŠ‚ç‚¹å¹¶åŠ å…¥é›†ç¾¤4.9.1 è·å–åŠ å…¥ kubernetes çš„å‘½ä»¤è®¿é—® 192.168.85.2 è¾“å…¥åˆ›å»ºæ–° token å‘½ä»¤ï¼š 1kubeadm token create --print-join-command åŒæ—¶è¾“å‡ºåŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼š 1kubeadm join 192.168.85.2:6443 --token zukr14.dg1pxt9k9gndzqkl --discovery-token-ca-cert-hash sha256:0b57947ccd86cea8b7af2490fde858f3870e63bf35bbb0a567c702029376e9e5 è¿™ä¸ª token ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šè¿° master ä¸Šæ‰§è¡Œçš„åˆå§‹åŒ–è¾“å‡ºç»“æœã€‚ 4.9.2 åœ¨ node èŠ‚ç‚¹ä¸Šæ‰§è¡ŒåŠ å…¥é›†ç¾¤çš„å‘½ä»¤ 1kubeadm join 192.168.85.2:6443 --token zukr14.dg1pxt9k9gndzqkl --discovery-token-ca-cert-hash sha256:0b57947ccd86cea8b7af2490fde858f3870e63bf35bbb0a567c702029376e9e5 4.10 æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ 123456kubectl get nodesNAME STATUS ROLES AGE VERSION192.168.85.2 Ready control-plane,master 15d v1.21.0192.168.85.3 Ready &lt;none&gt; 15d v1.21.0192.168.85.4 Ready &lt;none&gt; 15d v1.21.0 4.11 éƒ¨ç½² Dashboard4.11.1 éƒ¨ç½² 1curl -o recommended.yaml https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml é»˜è®¤ Dashboard åªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹ Service ä¸º NodePort ç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š 12345678910111213141516vi recommended.yamlkind: ServiceapiVersion: v1metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kubernetes-dashboardspec: ports: - port: 443 targetPort: 8443 nodePort: 30001 type: NodePort selector: k8s-app: kubernetes-dashboard 12345678910111213kubectl apply -f recommended.yaml # è¿™é‡Œä¸‹è½½é•œåƒéå¸¸æ…¢ï¼Œæˆ‘è¿˜æ˜¯å…ˆæ‰‹åŠ¨æ‹‰ä¸‹æ¥å§ï¼Œä¸è¡Œå°±å¤šè¯•å‡ æ¬¡docker pull kubernetesui/dashboard:v2.3.1docker pull kubernetesui/metrics-scraper:v1.0.6kubectl apply -f recommended.yamlkubectl get pods,svc -n kubernetes-dashboardNAME READY STATUS RESTARTS AGEpod/dashboard-metrics-scraper-856586f554-nb68k 0/1 ContainerCreating 0 52spod/kubernetes-dashboard-67484c44f6-shtz7 0/1 ContainerCreating 0 52sNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEservice/dashboard-metrics-scraper ClusterIP 10.96.188.208 &lt;none&gt; 8000/TCP 52sservice/kubernetes-dashboard NodePort 10.97.164.152 &lt;none&gt; 443:30001/TCP 53s æŸ¥çœ‹çŠ¶æ€æ­£åœ¨åˆ›å»ºå®¹å™¨ä¸­ï¼Œç¨åå†æ¬¡æŸ¥çœ‹ï¼š 123456NAME READY STATUS RESTARTS AGEpod/dashboard-metrics-scraper-856586f554-nb68k 1/1 Running 0 2m11spod/kubernetes-dashboard-67484c44f6-shtz7 1/1 Running 0 2m11sNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEservice/dashboard-metrics-scraper ClusterIP 10.96.188.208 &lt;none&gt; 8000/TCP 2m11sservice/kubernetes-dashboard NodePort 10.97.164.152 &lt;none&gt; 443:30001/TCP 2m12s è®¿é—®åœ°å€ï¼šhttps://NodeIP:30001ï¼›ä½¿ç”¨ Firefox æµè§ˆå™¨ï¼ŒChrome æµè§ˆå™¨æ‰“ä¸å¼€ä¸ä¿¡ä»» SSL è¯ä¹¦çš„ç½‘ç«™ã€‚ åˆ›å»º service account å¹¶ç»‘å®šé»˜è®¤ cluster-admin ç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š 123kubectl create serviceaccount dashboard-admin -n kube-systemkubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-adminkubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/&#123;print $1&#125;') è¿™é‡Œéœ€è¦æ³¨æ„ç²˜è´´çš„æ—¶å€™æœ‰å¯èƒ½è¢«æ¢è¡Œï¼Œå¦‚æœè¢«æ¢è¡Œï¼Œå¯åœ¨è®°äº‹æœ¬ä¸­è®¾ç½®ä¸ºä¸€è¡Œã€‚ ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚ é—®é¢˜è§£å†³1ã€dial tcp 10.96.0.1:443: connect: no route to host 123456systemctl stop dockersystemctl stop kubeletiptables --flushiptables -tnat --flushsystemctl start kubeletsystemctl start docker 2ã€failed to delegate add: failed to set bridge addr: â€œcni0â€œ already has an IP address different from 1 1https://blog.csdn.net/weixin_42562106/article/details/123749291 3ã€failed to add vxlanRoute (10.244.0.0/24 -&gt; 10.244.0.0): network is down 1234ip link delete flannel.1systemctl restart networkkubectl delete -f kube-flannel.ymlkubectl apply -f kube-flannel.yml 4ã€Get http://10.244.0.3:8181/ready: dial tcp 10.244.0.3:8181: connect: connection refused 12#é‡æ–°corednskubectl -n kube-system rollout restart deployment/coredns ä»¥ä¸Šå‡ ä¸ªé—®é¢˜é‡åˆ°å¯ä»¥å…ˆå°è¯•é‡å¯æ‰€æœ‰çš„æœºå™¨ï¼Œå¦‚æœä¸è¡Œåœ¨é€šè¿‡ä¸Šè¿°æ–¹æ¡ˆè§£å†³ å‚è€ƒï¼šhttps://www.iuskye.com/2021/08/10/k8s-kubeadm-1213.html","categories":[],"tags":[{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"http://example.com/tags/%E8%BF%90%E7%BB%B4/"},{"name":"k8s","slug":"k8s","permalink":"http://example.com/tags/k8s/"}]},{"title":"redisson3.15.2 å…¬å¹³é”ä»»åŠ¡ä¸¢å¤±","slug":"redisson3.15.2 å…¬å¹³é”ä»»åŠ¡ä¸¢å¤±","date":"2023-03-31T15:22:45.000Z","updated":"2023-03-31T15:37:33.829Z","comments":true,"path":"2023/03/31/redisson3.15.2 å…¬å¹³é”ä»»åŠ¡ä¸¢å¤±/","link":"","permalink":"http://example.com/2023/03/31/redisson3.15.2%20%E5%85%AC%E5%B9%B3%E9%94%81%E4%BB%BB%E5%8A%A1%E4%B8%A2%E5%A4%B1/","excerpt":"","text":"åœºæ™¯ï¼š çº¿ç´¢æµè½¬æ”¹æˆ redisson å…¬å¹³é”ï¼Œä»»åŠ¡è€—æ—¶é•¿ï¼Œå¯¼è‡´éƒ¨åˆ†ä»»åŠ¡ä¸¢å¤±ã€‚ ä¸€ã€redisson å…¬å¹³é”å®ç°1ã€redis ä¸­çš„ K/V12345678list: redisson_lock_queue:&#123;test&#125; elem: UUID:threadIdzset: redisson_lock_timeout:&#123;key&#125; elem: UUID:threadId score: timeout = ttl + çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms) + å½“å‰æ—¶é—´æˆ³hset: key hashKey: UUID:threadId hashVal: 1 2ã€ä¸Šé”æµç¨‹ï¼ˆè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼‰ org.redisson.RedissonFairLock#tryLockInnerAsync æ¸…é™¤ redisson_lock_timeout:{key} ä¸­ score å°äºå½“å‰æ—¶é—´æˆ³çš„elemï¼ŒåŒæ—¶æ¸…é™¤å¯¹åº” redisson_lock_queue:{test} ä¸­çš„ elem å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹å ç”¨é”ï¼Œåˆ™ä¸Šé” (ttl = watchdogtimeout)ï¼ŒåŒæ—¶redisson_lock_timeout:{key} ä¸­æ‰€æœ‰çš„ score - çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms) å¦‚æœå­˜åœ¨é”ï¼Œä¸”æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼Œåˆ™ hashVal åŠ ä¸€ å¦‚æœå­˜åœ¨é”ï¼Œä¸”ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼ŒåŒæ—¶å·²ç»åŠ å…¥è¿‡ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™è¿”å›å½“å‰çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„ ttl å¦‚æœå­˜åœ¨é”ï¼Œä¸”ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹å ç”¨çš„ï¼Œå¹¶ä¸”æœªåŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œtimeout= ttl + çº¿ç¨‹ç­‰å¾…æ—¶é—´(5*60000ms) + å½“å‰æ—¶é—´æˆ³ï¼Œttl ä¸ºé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„ timeout - current æˆ–è€… é”çš„è¶…æ—¶æ—¶é—´ 3ã€è®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadIdæ­¤å¤„é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯å‘é€ä¸ºæ­¢ 4ã€è§£é”æµç¨‹ æ¸…é™¤ redisson_lock_timeout:{key} ä¸­ score å°äºå½“å‰æ—¶é—´æˆ³çš„elemï¼ŒåŒæ—¶æ¸…é™¤å¯¹åº” redisson_lock_queue:{test} ä¸­çš„ elem åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜é”å·²ç»è¢«é‡Šæ”¾äº†ï¼Œåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰elemï¼Œæœ‰çš„è¯å–å‡ºç¬¬ä¸€ä¸ª publish message å¦‚æœé”å­˜åœ¨ï¼Œä¸”éæœ¬çº¿ç¨‹æŒæœ‰ï¼Œåˆ™ç›´æ¥è¿”å› null å¦‚æœæ‰€å­˜åœ¨ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¹¶ä¸”è·å–æ‰€æ¬¡æ•°å¤§äº 1ï¼Œåˆ™ hashValå‡ä¸€ï¼Œæ›´æ–°é”è¶…æ—¶æ—¶é—´ å¦‚æœæ‰€å­˜åœ¨ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œé‡Šæ”¾é”ï¼Œåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰elemï¼Œæœ‰çš„è¯å–å‡ºç¬¬ä¸€ä¸ª publish message 5ã€è·å–åˆ°é”ä¹‹åï¼Œå–æ¶ˆè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadId äºŒã€é—®é¢˜åˆ†æ1ã€ç”±äºæµ‹è¯•ç¯å¢ƒç¬¬ä¸‰æ–¹é‰´æƒæ¥å£è¾ƒæ…¢ï¼Œæ¯åˆ†é…ä¸€æ¡çº¿ç´¢éœ€è¦3-4s 2ã€å­˜é‡çº¿ç´¢æœ‰ 1500+ æ¡ï¼Œæ¯ 200 æ¡ä½œä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œæ€»å…±æ‹†åˆ† 8 ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éœ€è¦æ‰§è¡Œ 200*3 = 600+ s 3ã€redisson å…¬å¹³é”çº¿ç¨‹ç­‰å¾…æ—¶é—´ (5*60000ms)ï¼Œä¹Ÿå°±æ˜¯è¯´å•ä¸ªä»»åŠ¡æ‰§è¡Œå®Œè‡³å°‘ä¼šæœ‰ä¸€ä¸ªä»»åŠ¡è¿‡æœŸï¼Œåœ¨ unlock æˆ–è€… lock æ“ä½œæ˜¯ä¼šå…ˆæ¸…é™¤è¿‡æœŸä»»åŠ¡ 4ã€ç”±äºè·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹ä¼šè®¢é˜… redisson_lock__channel:{fairLock}:UUID:threadIdï¼Œé˜»å¡çŸ¥é“æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œåˆç”±äºç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹è¢«æ¸…äº†ï¼Œè¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ°¸è¿œä¸ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸€ç›´é˜»å¡ï¼Œä¸”ä»»åŠ¡æ— æ³•æ‰§è¡Œï¼Œèµ„æºè¢«å ç”¨ã€‚ 5ã€ä»£ç æ¨¡æ‹Ÿï¼š 1234567891011121314151617public static void main(String[] args) &#123; Config config = new Config(); config.useSingleServer().setAddress(\"redis://127.0.0.1:6379\"); Redisson redissonClient = (Redisson) Redisson.create(config); IntStream.range(0, 10).forEach(i -&gt; &#123; new Thread(() -&gt; &#123; //RedissonFairLock lock = (RedissonFairLock) redissonClient.getFairLock(\"test\"); RedissonFairLock lock = new RedissonFairLock(redissonClient.getCommandExecutor(), \"test\", 2000); lock.lock(); //æœ€ç»ˆè¾“å‡ºæ¬¡æ•°å°äº10 System.out.println(i); ThreadUtil.sleep(10000); lock.unlock(); &#125;).start(); &#125;); &#125; å‚è€ƒ: Redissonåˆ†å¸ƒå¼é”ä¹‹å…¬å¹³é”åŸç†","categories":[{"name":"redisson","slug":"redisson","permalink":"http://example.com/categories/redisson/"}],"tags":[{"name":"redisson","slug":"redisson","permalink":"http://example.com/tags/redisson/"},{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"http://example.com/tags/%E6%A1%86%E6%9E%B6/"}]},{"title":"apollo é›†ç¾¤æ¶æ„","slug":"apollo-é›†ç¾¤æ¶æ„","date":"2023-03-25T18:25:23.000Z","updated":"2023-03-31T15:44:48.277Z","comments":true,"path":"2023/03/26/apollo-é›†ç¾¤æ¶æ„/","link":"","permalink":"http://example.com/2023/03/26/apollo-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/","excerpt":"","text":"apollo é›†ç¾¤æ¶æ„apollo ç»„æˆç»“æ„apollo é›†ç¾¤ä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œconfig-serviceï¼Œadmin-serviceï¼Œportal config-service: ä¸»è¦ä¸ºåº”ç”¨å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬é…ç½®çš„è¯»å–ã€æ¨é€ç­‰åŠŸèƒ½ï¼Œconfig-service å†…ç½® eurekaï¼Œå·²æä¾› admin-service, portal çš„æœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œ admin-service: ä¸»è¦ä¸º apollo-portal æä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬åº”ç”¨é…ç½®ç®¡ç†ã€å‘å¸ƒç­‰åŠŸèƒ½ portal: æ˜¯ apollo æä¾›çš„æœåŠ¡é…ç½®å‰ç«¯é¡µé¢ apollo éƒ¨ç½²æ–¹æ¡ˆè¿™ä¸ªå®˜ç½‘æä¾›çš„é«˜å¯ç”¨åŒç¯å¢ƒæ¶æ„ï¼Œæ›´å¤šçš„æ¶æ„æ–¹æ¡ˆå¯å‚è€ƒ docker-compose éƒ¨ç½² apollo é›†ç¾¤ æ‰§è¡Œ sql è„šæœ¬ï¼Œç”Ÿæˆ apollo éœ€è¦çš„ db è¡¨ ç¼–å†™ docker-compose æ–‡ä»¶ï¼Œæœ¬æ¬¡åªæ­å»ºå¼€å‘ç¯å¢ƒæ¨¡æ‹Ÿå•æœºå•ç¯å¢ƒï¼Œconfig-serviceï¼Œadmin-serviceï¼Œportal éƒ½å„è‡ªéƒ¨ç½²ä¸€ä¸ªå®¹å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556version: '2'networks: net:services: #å¼€å‘ç¯å¢ƒconfigServiceï¼Œeureka apollo-configservice-dev: image: apolloconfig/apollo-configservice container_name: configservice-dev ports: - 8080:8080 environment: - SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloConfigDB?characterEncoding=utf8 - SPRING_DATASOURCE_USERNAME=root - SPRING_DATASOURCE_PASSWORD=123456 - eureka.instance.ip-address=192.168.0.103 networks: - net apollo-adminservice-dev: image: apolloconfig/apollo-adminservice container_name: adminservice-dev ports: - 8090:8090 environment: - SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloConfigDB?characterEncoding=utf8 - SPRING_DATASOURCE_USERNAME=root - SPRING_DATASOURCE_PASSWORD=123456 #è¿™é‡Œéœ€è¦é…ç½®å¼€ç¯ç¯å¢ƒçš„configService - eureka.service.url=http://configservice-dev:8080/eureka/ depends_on: - apollo-configservice-dev networks: - net apollo-portal: image: apolloconfig/apollo-portal container_name: apollo-portal ports: - 8070:8070 environment: - SPRING_DATASOURCE_URL=jdbc:mysql://192.168.0.103:3306/ApolloPortalDB?characterEncoding=utf8 - SPRING_DATASOURCE_USERNAME=root - SPRING_DATASOURCE_PASSWORD=123456 - spring.profiles.active=auth - APOLLO_PORTAL_ENVS=dev,fat,pre,gray,pro - DEV_META=http://configservice-dev:8080 # ä»¥ä¸‹è¿™äº›æš‚æ—¶ä½¿ç”¨å¼€å‘ç¯å¢ƒçš„ - FAT_META=http://configservice-dev:8080 - PRE_META=http://configservice-dev:8080 - GRAY_META=http://configservice-dev:8080 - PRO_META=http://configservice-dev:8080 depends_on: - apollo-adminservice-dev networks: - net","categories":[],"tags":[{"name":"apollo","slug":"apollo","permalink":"http://example.com/tags/apollo/"},{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"http://example.com/tags/%E8%BF%90%E7%BB%B4/"}]},{"title":"consul é›†ç¾¤æ­å»ºåŠæ³¨æ„äº‹é¡¹","slug":"consul-é›†ç¾¤æ­å»ºåŠæ³¨æ„äº‹é¡¹","date":"2023-03-25T17:16:50.000Z","updated":"2023-03-31T15:45:02.909Z","comments":true,"path":"2023/03/26/consul-é›†ç¾¤æ­å»ºåŠæ³¨æ„äº‹é¡¹/","link":"","permalink":"http://example.com/2023/03/26/consul-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/","excerpt":"","text":"é›†ç¾¤æ­å»ºæœ¬æ¬¡åˆ©ç”¨ docker æ­å»º consul é›†ç¾¤ï¼Œåˆ©ç”¨ docker-compose ç»Ÿä¸€ç®¡ç† é›†ç¾¤åŒ…å«ä¸‰ä¸ª server agent: node1ã€node2ã€node3 é›†ç¾¤åŒ…å«ä¸¤ä¸ª client agent: node4ã€node5ï¼Œclient agent æä¾› ui **1ã€ä¸‹è½½ docker é•œåƒ ** 1docker pull docker 2ã€ç¼–è¾‘ docker-compose.yml 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253version: '2'networks: byfn:services: consul1: image: consul container_name: node1 command: agent -server -bootstrap-expect=3 -node=node1 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 networks: - byfn consul2: image: consul container_name: node2 command: agent -server -retry-join=node1 -node=node2 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 depends_on: - consul1 networks: - byfn consul3: image: consul container_name: node3 command: agent -server -retry-join=node1 -node=node3 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 depends_on: - consul1 networks: - byfn consul4: image: consul container_name: node4 command: agent -retry-join=node1 -node=ndoe4 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 -ui ports: - 8500:8500 depends_on: - consul2 - consul3 networks: - byfn consul5: image: consul container_name: node5 command: agent -retry-join=node1 -node=ndoe5 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 -ui ports: - 8501:8500 depends_on: - consul2 - consul3 networks: - byfn å‘½ä»¤è¡Œå‚æ•°-serverï¼šè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„ server æ¨¡å¼ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™è¡¨ç¤ºæ˜¯ client æ¨¡å¼ã€‚ -nodeï¼šæŒ‡å®šå½“å‰èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­çš„åç§°ã€‚ -config-dirï¼šæŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå®šä¹‰æœåŠ¡çš„ï¼›è·¯å¾„ä¸‹é¢çš„æ‰€æœ‰ .json ç»“å°¾çš„æ–‡ä»¶éƒ½è¢«è®¿é—®ï¼›ç¼ºçœå€¼ä¸ºï¼š/consul/configã€‚ -data-dirï¼š consul å­˜å‚¨æ•°æ®çš„ç›®å½•ï¼›ç¼ºçœå€¼ä¸ºï¼š/consul/dataã€‚ -datacenterï¼šæ•°æ®ä¸­å¿ƒåç§°ï¼Œç¼ºçœå€¼ä¸º dc1ã€‚ -uiï¼šä½¿ç”¨ consul è‡ªå¸¦çš„ web UI ç•Œé¢ ã€‚ -joinï¼šåŠ å…¥åˆ°å·²æœ‰çš„é›†ç¾¤ä¸­ã€‚ -retry-joinï¼šä¸ -join ç±»ä¼¼ï¼Œä½†å…è®¸é‡è¯•è¿æ¥ï¼Œç›´åˆ°è¿æ¥æˆåŠŸã€‚ä¸€æ—¦æˆåŠŸåŠ å…¥æˆå‘˜åˆ—è¡¨ä¸­çš„æˆå‘˜ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šå°è¯•å†æ¬¡åŠ å…¥ã€‚ç„¶åï¼Œä»£ç†å•†å°†ä»…é€šè¿‡å…«å¦ç»´æŒå…¶ä¼šå‘˜èµ„æ ¼ã€‚å…è®¸é…ç½®å¤šä¸ª -retry-joinï¼Œç„¶åèŠ‚ç‚¹ä¼šæŒ‰ç…§é¡ºåºåŠ å…¥å’Œé‡è¯•ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸã€‚ -enable-script-checksï¼š æ£€æŸ¥æœåŠ¡æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç±»ä¼¼å¼€å¯å¿ƒè·³ã€‚ -advertiseï¼šé€šå‘Šåœ°å€ç”¨äºæ›´æ”¹æˆ‘ä»¬å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹é€šå‘Šçš„åœ°å€ã€‚ç›¸å½“äº -bind ä¸å¯ç”¨æ—¶æ›´æ”¹ -bind åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸º -bind çš„ä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆã€‚ -bindï¼š ç»‘å®šæœåŠ¡å™¨çš„ ip åœ°å€ï¼Œç¼ºçœå€¼ï¼šâ€œ0.0.0.0â€ï¼Œè¿™æ„å‘³ç€ consul å°†ç»‘å®šåˆ°æœ¬åœ°æœºå™¨ä¸Šçš„æ‰€æœ‰åœ°å€ï¼Œå¹¶å°†ç§æœ‰ IPv4 åœ°å€é€šå‘Šç»™é›†ç¾¤çš„å…¶ä½™èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å¤šä¸ªç§æœ‰ IPv4 åœ°å€å¯ç”¨ï¼Œconsul å°†åœ¨å¯åŠ¨æ—¶é€€å‡ºå¹¶æŠ¥é”™ã€‚consul 1.1.0 ä¹‹åï¼Œå¯ä»¥ç»“åˆ go-sockaddr templateä½¿ç”¨ï¼Œä¾‹å¦‚ 1$ consul agent -bind &#39;&#123;&#123; GetPrivateInterfaces | include &quot;network&quot; &quot;10.0.0.0&#x2F;8&quot; | attr &quot;address&quot; &#125;&#125;&#39; -clientï¼šå®¢æˆ·ç«¯å¯è®¿é—® ipï¼Œç¼ºçœå€¼ä¸ºï¼šâ€œ127.0.0.1â€ï¼Œå³ä»…å…è®¸ç¯å›è¿æ¥ã€‚ -bootstrap-expectï¼šåœ¨ä¸€ä¸ª datacenter ä¸­æœŸæœ›çš„ server èŠ‚ç‚¹æ•°ç›®ï¼Œconsul å¯åŠ¨æ—¶ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¾¾åˆ°è¿™ä¸ªæ•°ç›®çš„serveræ‰ä¼šå¼•å¯¼æ•´ä¸ªé›†ç¾¤ã€‚è¿™ä¸ªå‚æ•°çš„å€¼åœ¨åŒä¸€ä¸ª datacenter çš„æ‰€æœ‰serverèŠ‚ç‚¹ä¸Šå¿…é¡»ä¿æŒä¸€è‡´ã€‚ -bootstrapï¼šç”¨æ¥æ§åˆ¶ä¸€ä¸ª server æ˜¯å¦è¿è¡Œåœ¨ bootstrap æ¨¡å¼ï¼šå½“ä¸€ä¸ª server å¤„äº bootstrap æ¨¡å¼æ—¶ï¼Œå®ƒå¯ä»¥é€‰ä¸¾è‡ªå·±ä¸º leaderï¼›æ³¨æ„åœ¨ä¸€ä¸ª datacenter ä¸­åªèƒ½æœ‰ä¸€ä¸ª server å¤„äº bootstrap æ¨¡å¼ã€‚æ‰€ä»¥è¿™ä¸ªå‚æ•°ä¸€èˆ¬åªèƒ½ç”¨åœ¨åªæœ‰ä¸€ä¸ª server çš„å¼€å‘ç¯å¢ƒä¸­ï¼Œåœ¨æœ‰å¤šä¸ª server çš„ cluster äº§å“ç¯å¢ƒä¸­ï¼Œä¸èƒ½ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œå¦åˆ™å¦‚æœå¤šä¸ª server éƒ½æ ‡è®°è‡ªå·±ä¸º leader é‚£ä¹ˆä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å¦å¤–è¯¥æ ‡è®°ä¸èƒ½å’Œ -bootstrap-expect åŒæ—¶æŒ‡å®šã€‚ æœåŠ¡æ³¨å†Œ1ã€é€šè¿‡ config-file æ³¨å†ŒæœåŠ¡ï¼Œç¼–è¾‘ xxx.jsonï¼Œç„¶åæ”¾åœ¨ /consul/config ç›®å½•ä¸‹ï¼ˆé»˜è®¤æƒ…å†µï¼‰,å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ consul å‘½ä»¤è¡ŒåŠ è½½é…ç½®ã€‚ 12345678910111213141516171819202122&#123; \"services\": [ &#123; \"id\": \"hertz-demo-001\", \"name\": \"hertz-demo\", \"tags\": [ ], \"address\": \"192.168.0.103\", \"port\": 5000, \"checks\": [ &#123; \"http\": \"http://192.168.0.103:5000/ping\", \"tlsSkipVerify\": false, \"method\": \"GET\", \"interval\": \"10s\", \"timeout\": \"1s\", \"deregisterCriticalServiceAfter\": \"30s\" &#125; ] &#125; ] &#125; 2ã€æ‰§è¡Œ consul å‘½ä»¤é‡è½½é…ç½®æ–‡ä»¶ 1consul reload 3ã€å¯åŠ¨ web æœåŠ¡ï¼Œè¿™é‡Œä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡å³å¯ï¼Œè¿™é‡Œç”¨çš„æ˜¯ go http æ¡†æ¶ hertz: 1234567891011121314151617181920212223package mainimport ( \"context\" \"github.com/cloudwego/hertz/pkg/app\" \"github.com/cloudwego/hertz/pkg/app/server\" \"github.com/cloudwego/hertz/pkg/common/utils\" \"github.com/cloudwego/hertz/pkg/protocol/consts\" \"log\")func main() &#123; s := server.Default( server.WithHostPorts(\"192.168.0.103:5000\"), ) s.GET(\"/ping\", func(ctx context.Context, req *app.RequestContext) &#123; log.Print(req.ClientIP(), \" ping\") req.JSON(consts.StatusOK, utils.H&#123;\"ping\": \"pong\"&#125;) &#125;) s.Spin()&#125; 4ã€æŸ¥çœ‹æœåŠ¡å¥åº·ä¿¡æ¯ï¼Œpassing å‚æ•°è¡¨ç¤ºæ˜¯å¦è¿‡æ»¤ä¸å¥åº·çš„æœåŠ¡ 1curl http://127.0.0.1:8500/v1/health/service/hertz-demo\\?passing\\=true 5ã€æ³¨é”€æœåŠ¡ 1curl --request PUT 127.0.0.1:8501/v1/agent/service/deregister/hertz-demo-001 6ã€consul ui ç•Œé¢ä¸Šæ˜¾ç¤ºå¦‚ä¸‹ï¼š æ³¨æ„äº‹é¡¹1ã€æ³¨å†ŒæœåŠ¡æ—¶ï¼Œcheck å‚æ•° method GET æ³¨æ„ GET éœ€è¦å¤§å†™ï¼Œå¦åˆ™å¥åº·æ£€æŸ¥ä¼šå¤±è´¥ 2ã€æœåŠ¡æ³¨å†Œçš„ client agent æŒ‚äº†ï¼Œé‚£ä¹ˆ consul ä¼šè®¤ä¸ºæœåŠ¡ä¹ŸæŒ‚äº†ï¼Œå¹¶ä¸ä¼šåšæ•…éšœè½¬ç§»ï¼Œä¹Ÿä¸ä¼šåŒæ­¥åŸæœ¬ client agent ä¸‹çš„æœåŠ¡ä¿¡æ¯ 3ã€æœåŠ¡æ³¨å†Œéœ€è¦ç¡®ä¿ç½‘ç»œèƒ½è”é€š æ‰©å±•1ã€å®˜æ–¹æ¨èçš„æ¶æ„æ–¹å¼ å®˜æ–¹å»ºè®®ä¸€ä¸ªé›†ç¾¤éƒ¨ç½² 3-5 ä¸ª server agentï¼Œæ¯ä¸ªæœåŠ¡çš„æœåŠ¡å™¨éƒ¨ç½²ä¸€ä¸ª client agentï¼Œå¦‚ä¸‹å¦‚æ‰€ç¤ºï¼š 2ã€å¦‚æ˜¯æƒ³è¦ç»Ÿä¸€ç®¡ç† consul agentï¼Œé‚£å¯ä»¥å‚è€ƒå¦ä¸€ç§æ¶æ„æ–¹å¼ï¼š å‚è€ƒï¼šhttps://mp.weixin.qq.com/s/ecmqqWuMho2a0xhaF1vFNAhttps://www.cnblogs.com/brady-wang/p/14440649.html","categories":[],"tags":[{"name":"consul","slug":"consul","permalink":"http://example.com/tags/consul/"},{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"http://example.com/tags/%E8%BF%90%E7%BB%B4/"}]},{"title":"Hello World","slug":"hello-world","date":"2023-03-25T16:04:15.447Z","updated":"2023-03-25T16:04:15.447Z","comments":true,"path":"2023/03/26/hello-world/","link":"","permalink":"http://example.com/2023/03/26/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[]}],"categories":[{"name":"redisson","slug":"redisson","permalink":"http://example.com/categories/redisson/"}],"tags":[{"name":"spring","slug":"spring","permalink":"http://example.com/tags/spring/"},{"name":"kafka","slug":"kafka","permalink":"http://example.com/tags/kafka/"},{"name":"java","slug":"java","permalink":"http://example.com/tags/java/"},{"name":"è®¡ç®—æœºç½‘ç»œ","slug":"è®¡ç®—æœºç½‘ç»œ","permalink":"http://example.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"http://example.com/tags/%E8%BF%90%E7%BB%B4/"},{"name":"k8s","slug":"k8s","permalink":"http://example.com/tags/k8s/"},{"name":"redisson","slug":"redisson","permalink":"http://example.com/tags/redisson/"},{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"http://example.com/tags/%E6%A1%86%E6%9E%B6/"},{"name":"apollo","slug":"apollo","permalink":"http://example.com/tags/apollo/"},{"name":"consul","slug":"consul","permalink":"http://example.com/tags/consul/"}]}